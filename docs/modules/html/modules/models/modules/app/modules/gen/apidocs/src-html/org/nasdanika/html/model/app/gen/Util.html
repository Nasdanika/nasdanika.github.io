<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"> 
 <head> 
  <title>Source code</title> 
  <link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">  
  <script src="../../../../../../../../../../../../../../../../search-documents.js"></script>  
  <script src="https://unpkg.com/lunr/lunr.js"></script>  
  <script>
// Script for full-text search of JsTree

window.nsdJsTreeSearchCallback = function(str, node) { 
    var sf = new $.vakata.search(str, true, { caseSensitive : false, fuzzy : false }); 
    if (sf.search(node.text).isMatch) {
		return true;
	} 
    let searchResult = this.search(str); 
    for (const sr in searchResult) {
        if (searchResult[sr].ref === node.original['data-nsd-action-uuid']) {
            return true;
        } 
    } 
    return false; 
}.bind(lunr(function () {
			  this.ref('id');
			  this.field('title');
			  this.field('content');

			  for (const key in searchDocuments) {
				  let doc = searchDocuments[key];
				this.add({
					id: doc['action-uuid'],
					title: doc.title,
					path: doc.path,
					content: doc.content
				});  
			  }
			}));
</script> 
 </head> 
 <body> 
  <div class="sourceContainer"> 
   <pre><span class="sourceLineNo">001</span>package org.nasdanika.html.model.app.gen;<a name="line.1"></a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span>import static org.nasdanika.common.Util.isBlank;<a name="line.3"></a>
<span class="sourceLineNo">004</span><a name="line.4"></a>
<span class="sourceLineNo">005</span>import java.io.ByteArrayInputStream;<a name="line.5"></a>
<span class="sourceLineNo">006</span>import java.io.ByteArrayOutputStream;<a name="line.6"></a>
<span class="sourceLineNo">007</span>import java.io.File;<a name="line.7"></a>
<span class="sourceLineNo">008</span>import java.io.FileOutputStream;<a name="line.8"></a>
<span class="sourceLineNo">009</span>import java.io.IOException;<a name="line.9"></a>
<span class="sourceLineNo">010</span>import java.io.OutputStream;<a name="line.10"></a>
<span class="sourceLineNo">011</span>import java.io.OutputStreamWriter;<a name="line.11"></a>
<span class="sourceLineNo">012</span>import java.io.Writer;<a name="line.12"></a>
<span class="sourceLineNo">013</span>import java.net.URLDecoder;<a name="line.13"></a>
<span class="sourceLineNo">014</span>import java.net.URLEncoder;<a name="line.14"></a>
<span class="sourceLineNo">015</span>import java.nio.charset.StandardCharsets;<a name="line.15"></a>
<span class="sourceLineNo">016</span>import java.util.ArrayList;<a name="line.16"></a>
<span class="sourceLineNo">017</span>import java.util.Collections;<a name="line.17"></a>
<span class="sourceLineNo">018</span>import java.util.HashMap;<a name="line.18"></a>
<span class="sourceLineNo">019</span>import java.util.List;<a name="line.19"></a>
<span class="sourceLineNo">020</span>import java.util.ListIterator;<a name="line.20"></a>
<span class="sourceLineNo">021</span>import java.util.Map;<a name="line.21"></a>
<span class="sourceLineNo">022</span>import java.util.Map.Entry;<a name="line.22"></a>
<span class="sourceLineNo">023</span>import java.util.Objects;<a name="line.23"></a>
<span class="sourceLineNo">024</span>import java.util.UUID;<a name="line.24"></a>
<span class="sourceLineNo">025</span>import java.util.function.BiFunction;<a name="line.25"></a>
<span class="sourceLineNo">026</span>import java.util.function.Consumer;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import java.util.function.Function;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import java.util.function.Predicate;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.util.stream.Collectors;<a name="line.29"></a>
<span class="sourceLineNo">030</span>import java.util.zip.Deflater;<a name="line.30"></a>
<span class="sourceLineNo">031</span>import java.util.zip.DeflaterOutputStream;<a name="line.31"></a>
<span class="sourceLineNo">032</span>import java.util.zip.Inflater;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import java.util.zip.InflaterOutputStream;<a name="line.33"></a>
<span class="sourceLineNo">034</span><a name="line.34"></a>
<span class="sourceLineNo">035</span>import org.apache.commons.codec.binary.Base64;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import org.apache.commons.text.StringEscapeUtils;<a name="line.36"></a>
<span class="sourceLineNo">037</span>import org.eclipse.emf.common.util.EList;<a name="line.37"></a>
<span class="sourceLineNo">038</span>import org.eclipse.emf.common.util.URI;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import org.eclipse.emf.ecore.EObject;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import org.eclipse.emf.ecore.util.EcoreUtil;<a name="line.40"></a>
<span class="sourceLineNo">041</span>import org.json.JSONObject;<a name="line.41"></a>
<span class="sourceLineNo">042</span>import org.jsoup.Jsoup;<a name="line.42"></a>
<span class="sourceLineNo">043</span>import org.jsoup.nodes.Document;<a name="line.43"></a>
<span class="sourceLineNo">044</span>import org.jsoup.nodes.Element;<a name="line.44"></a>
<span class="sourceLineNo">045</span>import org.jsoup.select.Elements;<a name="line.45"></a>
<span class="sourceLineNo">046</span>import org.nasdanika.common.Context;<a name="line.46"></a>
<span class="sourceLineNo">047</span>import org.nasdanika.common.MutableContext;<a name="line.47"></a>
<span class="sourceLineNo">048</span>import org.nasdanika.common.NasdanikaException;<a name="line.48"></a>
<span class="sourceLineNo">049</span>import org.nasdanika.common.ProgressMonitor;<a name="line.49"></a>
<span class="sourceLineNo">050</span>import org.nasdanika.exec.content.ContentFactory;<a name="line.50"></a>
<span class="sourceLineNo">051</span>import org.nasdanika.exec.content.Text;<a name="line.51"></a>
<span class="sourceLineNo">052</span>import org.nasdanika.exec.resources.Container;<a name="line.52"></a>
<span class="sourceLineNo">053</span>import org.nasdanika.html.Button;<a name="line.53"></a>
<span class="sourceLineNo">054</span>import org.nasdanika.html.HTMLFactory;<a name="line.54"></a>
<span class="sourceLineNo">055</span>import org.nasdanika.html.Tag;<a name="line.55"></a>
<span class="sourceLineNo">056</span>import org.nasdanika.html.TagName;<a name="line.56"></a>
<span class="sourceLineNo">057</span>import org.nasdanika.html.bootstrap.BootstrapFactory;<a name="line.57"></a>
<span class="sourceLineNo">058</span>import org.nasdanika.html.bootstrap.Breakpoint;<a name="line.58"></a>
<span class="sourceLineNo">059</span>import org.nasdanika.html.bootstrap.Color;<a name="line.59"></a>
<span class="sourceLineNo">060</span>import org.nasdanika.html.model.app.Action;<a name="line.60"></a>
<span class="sourceLineNo">061</span>import org.nasdanika.html.model.app.ActionReference;<a name="line.61"></a>
<span class="sourceLineNo">062</span>import org.nasdanika.html.model.app.AppFactory;<a name="line.62"></a>
<span class="sourceLineNo">063</span>import org.nasdanika.html.model.app.AppPackage;<a name="line.63"></a>
<span class="sourceLineNo">064</span>import org.nasdanika.html.model.app.ContentPanel;<a name="line.64"></a>
<span class="sourceLineNo">065</span>import org.nasdanika.html.model.app.Footer;<a name="line.65"></a>
<span class="sourceLineNo">066</span>import org.nasdanika.html.model.app.Header;<a name="line.66"></a>
<span class="sourceLineNo">067</span>import org.nasdanika.html.model.app.Label;<a name="line.67"></a>
<span class="sourceLineNo">068</span>import org.nasdanika.html.model.app.Link;<a name="line.68"></a>
<span class="sourceLineNo">069</span>import org.nasdanika.html.model.app.NavigationBar;<a name="line.69"></a>
<span class="sourceLineNo">070</span>import org.nasdanika.html.model.app.NavigationPanel;<a name="line.70"></a>
<span class="sourceLineNo">071</span>import org.nasdanika.html.model.app.SectionStyle;<a name="line.71"></a>
<span class="sourceLineNo">072</span>import org.nasdanika.html.model.bootstrap.Appearance;<a name="line.72"></a>
<span class="sourceLineNo">073</span>import org.nasdanika.html.model.bootstrap.Item;<a name="line.73"></a>
<span class="sourceLineNo">074</span>import org.nasdanika.html.model.bootstrap.Modal;<a name="line.74"></a>
<span class="sourceLineNo">075</span>import org.w3c.dom.Node;<a name="line.75"></a>
<span class="sourceLineNo">076</span>import org.w3c.dom.NodeList;<a name="line.76"></a>
<span class="sourceLineNo">077</span><a name="line.77"></a>
<span class="sourceLineNo">078</span>import com.mxgraph.io.mxCodec;<a name="line.78"></a>
<span class="sourceLineNo">079</span>import com.mxgraph.model.mxGraphModel;<a name="line.79"></a>
<span class="sourceLineNo">080</span>import com.mxgraph.model.mxICell;<a name="line.80"></a>
<span class="sourceLineNo">081</span>import com.mxgraph.util.mxXmlUtils;<a name="line.81"></a>
<span class="sourceLineNo">082</span><a name="line.82"></a>
<span class="sourceLineNo">083</span><a name="line.83"></a>
<span class="sourceLineNo">084</span>public final class Util {<a name="line.84"></a>
<span class="sourceLineNo">085</span>        <a name="line.85"></a>
<span class="sourceLineNo">086</span>        public static final String DATA_NSD_ACTION_UUID_ATTRIBUTE = "data-nsd-action-uuid";<a name="line.86"></a>
<span class="sourceLineNo">087</span><a name="line.87"></a>
<span class="sourceLineNo">088</span>        // Util<a name="line.88"></a>
<span class="sourceLineNo">089</span>        private Util() {<a name="line.89"></a>
<span class="sourceLineNo">090</span>                throw new UnsupportedOperationException("Utility class, not to be instantiated");<a name="line.90"></a>
<span class="sourceLineNo">091</span>        }<a name="line.91"></a>
<span class="sourceLineNo">092</span><a name="line.92"></a>
<span class="sourceLineNo">093</span>        /**<a name="line.93"></a>
<span class="sourceLineNo">094</span>         * Creates Bootstrap Navs from a list of items.<a name="line.94"></a>
<span class="sourceLineNo">095</span>         * @param items<a name="line.95"></a>
<span class="sourceLineNo">096</span>         * @param bootstrapFactory<a name="line.96"></a>
<span class="sourceLineNo">097</span>         * @return<a name="line.97"></a>
<span class="sourceLineNo">098</span>         */<a name="line.98"></a>
<span class="sourceLineNo">099</span>        public static Tag navs(List&lt;Object&gt; items, BootstrapFactory bootstrapFactory) {<a name="line.99"></a>
<span class="sourceLineNo">100</span>                HTMLFactory htmlFactory = bootstrapFactory.getHTMLFactory();<a name="line.100"></a>
<span class="sourceLineNo">101</span>                Tag navs = htmlFactory.tag(TagName.ul).addClass("nav");<a name="line.101"></a>
<span class="sourceLineNo">102</span>                for (Object item: items) {<a name="line.102"></a>
<span class="sourceLineNo">103</span>                        Tag li = htmlFactory.tag(TagName.li, item).addClass("nav-item");<a name="line.103"></a>
<span class="sourceLineNo">104</span>                        navs.accept(li);<a name="line.104"></a>
<span class="sourceLineNo">105</span>                        if (item instanceof Tag) {<a name="line.105"></a>
<span class="sourceLineNo">106</span>                                Tag itemTag = (Tag) item;<a name="line.106"></a>
<span class="sourceLineNo">107</span>                                if (TagName.a.name().equalsIgnoreCase(itemTag.getTagName())) {<a name="line.107"></a>
<span class="sourceLineNo">108</span>                                        itemTag.addClass("nav-link");<a name="line.108"></a>
<span class="sourceLineNo">109</span>                                        Object data = itemTag.getData();<a name="line.109"></a>
<span class="sourceLineNo">110</span>                                        if (data instanceof Item) {<a name="line.110"></a>
<span class="sourceLineNo">111</span>                                                Item itemData = (Item) data;<a name="line.111"></a>
<span class="sourceLineNo">112</span>                                                if (itemData.isActive()) {<a name="line.112"></a>
<span class="sourceLineNo">113</span>                                                        itemTag.addClass("active");<a name="line.113"></a>
<span class="sourceLineNo">114</span>                                                } else if (itemData.isDisabled()) {<a name="line.114"></a>
<span class="sourceLineNo">115</span>                                                        itemTag.addClass("disabled");<a name="line.115"></a>
<span class="sourceLineNo">116</span>                                                }<a name="line.116"></a>
<span class="sourceLineNo">117</span>                                        }<a name="line.117"></a>
<span class="sourceLineNo">118</span>                                } else if (TagName.span.name().equalsIgnoreCase(itemTag.getTagName())) {<a name="line.118"></a>
<span class="sourceLineNo">119</span>                                        itemTag.addClass("navbar-text");<a name="line.119"></a>
<span class="sourceLineNo">120</span>                                }<a name="line.120"></a>
<span class="sourceLineNo">121</span>                        }<a name="line.121"></a>
<span class="sourceLineNo">122</span>                }<a name="line.122"></a>
<span class="sourceLineNo">123</span>                return navs;<a name="line.123"></a>
<span class="sourceLineNo">124</span>        }<a name="line.124"></a>
<span class="sourceLineNo">125</span>        <a name="line.125"></a>
<span class="sourceLineNo">126</span>        /**<a name="line.126"></a>
<span class="sourceLineNo">127</span>         * Creates Bootstrap Navs from a list of items.<a name="line.127"></a>
<span class="sourceLineNo">128</span>         * @param items<a name="line.128"></a>
<span class="sourceLineNo">129</span>         * @param bootstrapFactory<a name="line.129"></a>
<span class="sourceLineNo">130</span>         * @return<a name="line.130"></a>
<span class="sourceLineNo">131</span>         */<a name="line.131"></a>
<span class="sourceLineNo">132</span>        public static Tag navbar(<a name="line.132"></a>
<span class="sourceLineNo">133</span>                        Tag brand, <a name="line.133"></a>
<span class="sourceLineNo">134</span>                        List&lt;Object&gt; items,<a name="line.134"></a>
<span class="sourceLineNo">135</span>                        Breakpoint expand, <a name="line.135"></a>
<span class="sourceLineNo">136</span>                        boolean dark,<a name="line.136"></a>
<span class="sourceLineNo">137</span>                        Color background,<a name="line.137"></a>
<span class="sourceLineNo">138</span>                        BootstrapFactory bootstrapFactory) {<a name="line.138"></a>
<span class="sourceLineNo">139</span>                HTMLFactory htmlFactory = bootstrapFactory.getHTMLFactory();<a name="line.139"></a>
<span class="sourceLineNo">140</span>                Tag navbar = htmlFactory.tag(TagName.ul).addClass("navbar", dark ? "navbar-dark" : "navbar-light");<a name="line.140"></a>
<span class="sourceLineNo">141</span>                if (expand != null) {<a name="line.141"></a>
<span class="sourceLineNo">142</span>                        navbar.addClass("navbar-expand-" + expand.code);<a name="line.142"></a>
<span class="sourceLineNo">143</span>                }<a name="line.143"></a>
<span class="sourceLineNo">144</span>                if (background != null) {<a name="line.144"></a>
<span class="sourceLineNo">145</span>                        navbar.addClass("bg-" + background.code);<a name="line.145"></a>
<span class="sourceLineNo">146</span>                }<a name="line.146"></a>
<span class="sourceLineNo">147</span>                if (brand != null) {<a name="line.147"></a>
<span class="sourceLineNo">148</span>                        brand.addClass("navbar-brand");<a name="line.148"></a>
<span class="sourceLineNo">149</span>                        navbar.accept(brand);<a name="line.149"></a>
<span class="sourceLineNo">150</span>                }<a name="line.150"></a>
<span class="sourceLineNo">151</span>                String navbarContentId = htmlFactory.nextId();<a name="line.151"></a>
<span class="sourceLineNo">152</span>                Button toggler = htmlFactory.button(htmlFactory.span().addClass("navbar-toggler-icon"));<a name="line.152"></a>
<span class="sourceLineNo">153</span>                toggler<a name="line.153"></a>
<span class="sourceLineNo">154</span>                        .addClass("navbar-toggler")<a name="line.154"></a>
<span class="sourceLineNo">155</span>                        .attribute("type", "button")<a name="line.155"></a>
<span class="sourceLineNo">156</span>                        .attribute("data-toggle", "collapse")<a name="line.156"></a>
<span class="sourceLineNo">157</span>                        .attribute("data-target", "#" + navbarContentId)<a name="line.157"></a>
<span class="sourceLineNo">158</span>                        .attribute("aria-expanded", "false")<a name="line.158"></a>
<span class="sourceLineNo">159</span>                        .attribute("aria-label", "Toggle navigation");<a name="line.159"></a>
<span class="sourceLineNo">160</span>                navbar.accept(toggler);<a name="line.160"></a>
<span class="sourceLineNo">161</span>                <a name="line.161"></a>
<span class="sourceLineNo">162</span>                Tag content = htmlFactory.div().addClass("collapse", "navbar-collapse").id(navbarContentId);<a name="line.162"></a>
<span class="sourceLineNo">163</span>                navbar.accept(content);<a name="line.163"></a>
<span class="sourceLineNo">164</span>                if (items != null &amp;&amp; !items.isEmpty()) {<a name="line.164"></a>
<span class="sourceLineNo">165</span>                        Tag navs = navs(items, bootstrapFactory);<a name="line.165"></a>
<span class="sourceLineNo">166</span>                        navs.removeClass("nav").addClass("navbar-nav", "mr-auto");<a name="line.166"></a>
<span class="sourceLineNo">167</span>                        content.accept(navs);<a name="line.167"></a>
<span class="sourceLineNo">168</span>                }<a name="line.168"></a>
<span class="sourceLineNo">169</span>                return navbar;<a name="line.169"></a>
<span class="sourceLineNo">170</span>        }<a name="line.170"></a>
<span class="sourceLineNo">171</span>        <a name="line.171"></a>
<span class="sourceLineNo">172</span>        /**<a name="line.172"></a>
<span class="sourceLineNo">173</span>         * Generates application site from an {@link Action} model root. <a name="line.173"></a>
<span class="sourceLineNo">174</span>         * @param root Root action to generate header and footer. Can be null.<a name="line.174"></a>
<span class="sourceLineNo">175</span>         * @param pageTemplate Page template.<a name="line.175"></a>
<span class="sourceLineNo">176</span>         * @param context Context used for uri resolution - interpolation of action locations and names. can be null.<a name="line.176"></a>
<span class="sourceLineNo">177</span>         * @param container Receiver of generated resources.<a name="line.177"></a>
<span class="sourceLineNo">178</span>         * @param progressMonitor Progress monitor.<a name="line.178"></a>
<span class="sourceLineNo">179</span>         * @throws Exception <a name="line.179"></a>
<span class="sourceLineNo">180</span>         */<a name="line.180"></a>
<span class="sourceLineNo">181</span>        public static void generateSite(<a name="line.181"></a>
<span class="sourceLineNo">182</span>                        Label root, <a name="line.182"></a>
<span class="sourceLineNo">183</span>                        org.nasdanika.html.model.bootstrap.Page pageTemplate,<a name="line.183"></a>
<span class="sourceLineNo">184</span>                        Container container,<a name="line.184"></a>
<span class="sourceLineNo">185</span>                        ActionContentProvider.Factory actionContentProviderFactory,<a name="line.185"></a>
<span class="sourceLineNo">186</span>                        PageContentProvider.Factory pageContentProviderFactory,<a name="line.186"></a>
<span class="sourceLineNo">187</span>                        Context context,<a name="line.187"></a>
<span class="sourceLineNo">188</span>                        ProgressMonitor progressMonitor) throws Exception {<a name="line.188"></a>
<span class="sourceLineNo">189</span>        <a name="line.189"></a>
<span class="sourceLineNo">190</span>                Label principal = null;<a name="line.190"></a>
<span class="sourceLineNo">191</span>                EList&lt;EObject&gt; rootChildren = root.getChildren();<a name="line.191"></a>
<span class="sourceLineNo">192</span>                if (rootChildren.size() &gt; 0) {<a name="line.192"></a>
<span class="sourceLineNo">193</span>                        EObject firstChild = root.getChildren().get(0);<a name="line.193"></a>
<span class="sourceLineNo">194</span>                        if (firstChild instanceof Action) {<a name="line.194"></a>
<span class="sourceLineNo">195</span>                                principal = (Action) firstChild;<a name="line.195"></a>
<span class="sourceLineNo">196</span>                        } else if (firstChild instanceof ActionReference) {<a name="line.196"></a>
<span class="sourceLineNo">197</span>                                principal = ((ActionReference) firstChild).getTarget();<a name="line.197"></a>
<span class="sourceLineNo">198</span>                        }<a name="line.198"></a>
<span class="sourceLineNo">199</span>                }<a name="line.199"></a>
<span class="sourceLineNo">200</span>                <a name="line.200"></a>
<span class="sourceLineNo">201</span>                generateSite(root, principal, root, Collections.emptyList(), pageTemplate, container, actionContentProviderFactory, pageContentProviderFactory, context, progressMonitor);<a name="line.201"></a>
<span class="sourceLineNo">202</span>        }<a name="line.202"></a>
<span class="sourceLineNo">203</span>        <a name="line.203"></a>
<span class="sourceLineNo">204</span>        /**<a name="line.204"></a>
<span class="sourceLineNo">205</span>         * Generates application site from an {@link Action} model using a random base URI and a caching URI resolver created from the argument context with base-uri injected.<a name="line.205"></a>
<span class="sourceLineNo">206</span>         * @param root Root action to generate header and footer. Can be null.<a name="line.206"></a>
<span class="sourceLineNo">207</span>         * @param principal Principal action to generate navigation bar and navigation panel. Can be null.<a name="line.207"></a>
<span class="sourceLineNo">208</span>         * @param activeAction Active action to generate the content panel if instance of action.<a name="line.208"></a>
<span class="sourceLineNo">209</span>         * @param actionPath Action path to show in breadcrumbs.<a name="line.209"></a>
<span class="sourceLineNo">210</span>         * @param pageTemplate Page template.<a name="line.210"></a>
<span class="sourceLineNo">211</span>         * @param context Context used for uri resolution - interpolation of action locations and names. can be null.<a name="line.211"></a>
<span class="sourceLineNo">212</span>         * @param container Receiver of generated resources.<a name="line.212"></a>
<span class="sourceLineNo">213</span>         * @param progressMonitor Progress monitor.<a name="line.213"></a>
<span class="sourceLineNo">214</span>         * @throws Exception <a name="line.214"></a>
<span class="sourceLineNo">215</span>         */<a name="line.215"></a>
<span class="sourceLineNo">216</span>        public static void generateSite(<a name="line.216"></a>
<span class="sourceLineNo">217</span>                        Label root, <a name="line.217"></a>
<span class="sourceLineNo">218</span>                        Label principal, <a name="line.218"></a>
<span class="sourceLineNo">219</span>                        Label activeAction, <a name="line.219"></a>
<span class="sourceLineNo">220</span>                        List&lt;Label&gt; actionPath,<a name="line.220"></a>
<span class="sourceLineNo">221</span>                        org.nasdanika.html.model.bootstrap.Page pageTemplate,<a name="line.221"></a>
<span class="sourceLineNo">222</span>                        Container container,<a name="line.222"></a>
<span class="sourceLineNo">223</span>                        ActionContentProvider.Factory contentProviderFactory,<a name="line.223"></a>
<span class="sourceLineNo">224</span>                        PageContentProvider.Factory pageProviderFactory,<a name="line.224"></a>
<span class="sourceLineNo">225</span>                        Context context,<a name="line.225"></a>
<span class="sourceLineNo">226</span>                        ProgressMonitor progressMonitor) throws Exception {<a name="line.226"></a>
<span class="sourceLineNo">227</span>        <a name="line.227"></a>
<span class="sourceLineNo">228</span>                if (context == null) {<a name="line.228"></a>
<span class="sourceLineNo">229</span>                        context = Context.EMPTY_CONTEXT;<a name="line.229"></a>
<span class="sourceLineNo">230</span>                }<a name="line.230"></a>
<span class="sourceLineNo">231</span>                if (context.get(Context.BASE_URI_PROPERTY) == null) {<a name="line.231"></a>
<span class="sourceLineNo">232</span>                        context = context.fork();<a name="line.232"></a>
<span class="sourceLineNo">233</span>                        ((MutableContext) context).put(Context.BASE_URI_PROPERTY, URI.createURI("temp://" + UUID.randomUUID() + "/" + UUID.randomUUID() + "/"));<a name="line.233"></a>
<span class="sourceLineNo">234</span>                }<a name="line.234"></a>
<span class="sourceLineNo">235</span>                BiFunction&lt;Label, URI, URI&gt; uriResolver = uriResolver(root, context);           <a name="line.235"></a>
<span class="sourceLineNo">236</span>                generateSite(<a name="line.236"></a>
<span class="sourceLineNo">237</span>                                root, <a name="line.237"></a>
<span class="sourceLineNo">238</span>                                principal, <a name="line.238"></a>
<span class="sourceLineNo">239</span>                                activeAction,<a name="line.239"></a>
<span class="sourceLineNo">240</span>                                actionPath,<a name="line.240"></a>
<span class="sourceLineNo">241</span>                                pageTemplate,<a name="line.241"></a>
<span class="sourceLineNo">242</span>                                uriResolver, <a name="line.242"></a>
<span class="sourceLineNo">243</span>                                (URI) context.get(Context.BASE_URI_PROPERTY), <a name="line.243"></a>
<span class="sourceLineNo">244</span>                                container, <a name="line.244"></a>
<span class="sourceLineNo">245</span>                                contentProviderFactory == null ? null : contentProviderFactory.create(context),<a name="line.245"></a>
<span class="sourceLineNo">246</span>                                pageProviderFactory == null ? null : pageProviderFactory.create(context),                                               <a name="line.246"></a>
<span class="sourceLineNo">247</span>                                progressMonitor);<a name="line.247"></a>
<span class="sourceLineNo">248</span>        }<a name="line.248"></a>
<span class="sourceLineNo">249</span>        <a name="line.249"></a>
<span class="sourceLineNo">250</span>        /**<a name="line.250"></a>
<span class="sourceLineNo">251</span>         * Generates application site from an {@link Action} model<a name="line.251"></a>
<span class="sourceLineNo">252</span>         * @param root Root action to generate header and footer. Can be null.<a name="line.252"></a>
<span class="sourceLineNo">253</span>         * @param principal Principal action to generate navigation bar and navigation panel. Can be null.<a name="line.253"></a>
<span class="sourceLineNo">254</span>         * @param activeAction Active action to generate the content panel.<a name="line.254"></a>
<span class="sourceLineNo">255</span>         * @param pageTemplate Page template.<a name="line.255"></a>
<span class="sourceLineNo">256</span>         * @param uriResolver Resolves {@link Action} to {@link URI}.<a name="line.256"></a>
<span class="sourceLineNo">257</span>         * @param baseURI Base URI for resolution, specifically to create relative URI's.<a name="line.257"></a>
<span class="sourceLineNo">258</span>         * @param container Receiver of generated resources.<a name="line.258"></a>
<span class="sourceLineNo">259</span>         * @param progressMonitor Progress monitor.<a name="line.259"></a>
<span class="sourceLineNo">260</span>         * @throws Exception <a name="line.260"></a>
<span class="sourceLineNo">261</span>         */<a name="line.261"></a>
<span class="sourceLineNo">262</span>        public static void generateSite(<a name="line.262"></a>
<span class="sourceLineNo">263</span>                        Label root, <a name="line.263"></a>
<span class="sourceLineNo">264</span>                        Label principal, <a name="line.264"></a>
<span class="sourceLineNo">265</span>                        Label activeAction, <a name="line.265"></a>
<span class="sourceLineNo">266</span>                        List&lt;Label&gt; actionPath,<a name="line.266"></a>
<span class="sourceLineNo">267</span>                        org.nasdanika.html.model.bootstrap.Page pageTemplate,<a name="line.267"></a>
<span class="sourceLineNo">268</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.268"></a>
<span class="sourceLineNo">269</span>                        URI baseURI,<a name="line.269"></a>
<span class="sourceLineNo">270</span>                        Container container,<a name="line.270"></a>
<span class="sourceLineNo">271</span>                        ActionContentProvider actionContentProvider,    <a name="line.271"></a>
<span class="sourceLineNo">272</span>                        PageContentProvider pageContentProvider,<a name="line.272"></a>
<span class="sourceLineNo">273</span>                        ProgressMonitor progressMonitor) throws Exception {<a name="line.273"></a>
<span class="sourceLineNo">274</span>                <a name="line.274"></a>
<span class="sourceLineNo">275</span>                if (activeAction instanceof Action &amp;&amp; activeAction.eContainmentFeature() != AppPackage.Literals.ACTION__SECTIONS) {<a name="line.275"></a>
<span class="sourceLineNo">276</span>                        URI uri = uriResolver.apply(activeAction, baseURI);                             <a name="line.276"></a>
<span class="sourceLineNo">277</span>                        if (uri != null &amp;&amp; uri.isRelative()) {<a name="line.277"></a>
<span class="sourceLineNo">278</span>                                org.nasdanika.exec.resources.File file = container.getFile(uri.toString());<a name="line.278"></a>
<span class="sourceLineNo">279</span>                                if (file != null) {<a name="line.279"></a>
<span class="sourceLineNo">280</span>                                        org.nasdanika.html.model.bootstrap.Page bootstrapPage = EcoreUtil.copy(pageTemplate);<a name="line.280"></a>
<span class="sourceLineNo">281</span>                                        bootstrapPage.setName(activeAction.getText());<a name="line.281"></a>
<span class="sourceLineNo">282</span>                                        if (bootstrapPage.getBody().isEmpty()) {<a name="line.282"></a>
<span class="sourceLineNo">283</span>                                                bootstrapPage.getBody().add(AppFactory.eINSTANCE.createPage());<a name="line.283"></a>
<span class="sourceLineNo">284</span>                                        }<a name="line.284"></a>
<span class="sourceLineNo">285</span>                                        for (EObject be: bootstrapPage.getBody()) {<a name="line.285"></a>
<span class="sourceLineNo">286</span>                                                if (be instanceof org.nasdanika.html.model.app.Page) {<a name="line.286"></a>
<span class="sourceLineNo">287</span>                                                        buildAppPage(root, principal, (Action) activeAction, actionPath, (org.nasdanika.html.model.app.Page) be, uriResolver, actionContentProvider, progressMonitor);                                          <a name="line.287"></a>
<span class="sourceLineNo">288</span>                                                }<a name="line.288"></a>
<span class="sourceLineNo">289</span>                                        }<a name="line.289"></a>
<span class="sourceLineNo">290</span>                                        file.getContents().add(pageContentProvider == null ? bootstrapPage : pageContentProvider.getPageContent(bootstrapPage, baseURI, uriResolver, progressMonitor));<a name="line.290"></a>
<span class="sourceLineNo">291</span>                                        <a name="line.291"></a>
<span class="sourceLineNo">292</span>                                        if (activeAction instanceof Action) {<a name="line.292"></a>
<span class="sourceLineNo">293</span>                                                for (org.nasdanika.exec.resources.Resource res: ((Action) activeAction).getResources()) {<a name="line.293"></a>
<span class="sourceLineNo">294</span>                                                        ((Container) file.eContainer()).getContents().add(EcoreUtil.copy(res));                                 <a name="line.294"></a>
<span class="sourceLineNo">295</span>                                                }<a name="line.295"></a>
<span class="sourceLineNo">296</span>                                        }<a name="line.296"></a>
<span class="sourceLineNo">297</span>                                }<a name="line.297"></a>
<span class="sourceLineNo">298</span>                        }<a name="line.298"></a>
<span class="sourceLineNo">299</span>                }<a name="line.299"></a>
<span class="sourceLineNo">300</span>                <a name="line.300"></a>
<span class="sourceLineNo">301</span>                List&lt;Label&gt; subActionPath = new ArrayList&lt;&gt;(actionPath);<a name="line.301"></a>
<span class="sourceLineNo">302</span>                if (activeAction != root &amp;&amp; activeAction != principal) {<a name="line.302"></a>
<span class="sourceLineNo">303</span>                        subActionPath.add(activeAction);<a name="line.303"></a>
<span class="sourceLineNo">304</span>                }<a name="line.304"></a>
<span class="sourceLineNo">305</span>                <a name="line.305"></a>
<span class="sourceLineNo">306</span>                for (EObject child: resolveActionReferences(activeAction.getChildren())) {<a name="line.306"></a>
<span class="sourceLineNo">307</span>                        if (child instanceof Action) {<a name="line.307"></a>
<span class="sourceLineNo">308</span>                                generateSite(root, principal, (Action) child, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);<a name="line.308"></a>
<span class="sourceLineNo">309</span>                        }<a name="line.309"></a>
<span class="sourceLineNo">310</span>                }<a name="line.310"></a>
<span class="sourceLineNo">311</span>                                <a name="line.311"></a>
<span class="sourceLineNo">312</span>                if (activeAction instanceof Action) {<a name="line.312"></a>
<span class="sourceLineNo">313</span>                        Action theActiveAction = (Action) activeAction;<a name="line.313"></a>
<span class="sourceLineNo">314</span>                        for (Action section: theActiveAction.getSections()) {<a name="line.314"></a>
<span class="sourceLineNo">315</span>                                generateSite(root, principal, (Action) section, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);<a name="line.315"></a>
<span class="sourceLineNo">316</span>                        }<a name="line.316"></a>
<span class="sourceLineNo">317</span>                        <a name="line.317"></a>
<span class="sourceLineNo">318</span>                        for (EObject navigation: resolveActionReferences(theActiveAction.getNavigation())) {<a name="line.318"></a>
<span class="sourceLineNo">319</span>                                if (navigation instanceof Action) {<a name="line.319"></a>
<span class="sourceLineNo">320</span>                                        generateSite(root, principal, (Action) navigation, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);<a name="line.320"></a>
<span class="sourceLineNo">321</span>                                }<a name="line.321"></a>
<span class="sourceLineNo">322</span>                        }<a name="line.322"></a>
<span class="sourceLineNo">323</span>                        <a name="line.323"></a>
<span class="sourceLineNo">324</span>                        for (Action anonymous: theActiveAction.getAnonymous()) {<a name="line.324"></a>
<span class="sourceLineNo">325</span>                                generateSite(root, principal, anonymous, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);<a name="line.325"></a>
<span class="sourceLineNo">326</span>                        }<a name="line.326"></a>
<span class="sourceLineNo">327</span>                        <a name="line.327"></a>
<span class="sourceLineNo">328</span>                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getFloatLeftNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);<a name="line.328"></a>
<span class="sourceLineNo">329</span>                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getFloatRightNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);<a name="line.329"></a>
<span class="sourceLineNo">330</span>                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getLeftNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);<a name="line.330"></a>
<span class="sourceLineNo">331</span>                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getRightNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);<a name="line.331"></a>
<span class="sourceLineNo">332</span>                }<a name="line.332"></a>
<span class="sourceLineNo">333</span>        }<a name="line.333"></a>
<span class="sourceLineNo">334</span>        <a name="line.334"></a>
<span class="sourceLineNo">335</span>        private static void buildAppPage(<a name="line.335"></a>
<span class="sourceLineNo">336</span>                        Label root, <a name="line.336"></a>
<span class="sourceLineNo">337</span>                        Label principal, <a name="line.337"></a>
<span class="sourceLineNo">338</span>                        Action activeAction, <a name="line.338"></a>
<span class="sourceLineNo">339</span>                        List&lt;Label&gt; actionPath,<a name="line.339"></a>
<span class="sourceLineNo">340</span>                        org.nasdanika.html.model.app.Page appPage,<a name="line.340"></a>
<span class="sourceLineNo">341</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.341"></a>
<span class="sourceLineNo">342</span>                        ActionContentProvider contentProvider,                  <a name="line.342"></a>
<span class="sourceLineNo">343</span>                        ProgressMonitor progressMonitor) throws Exception {<a name="line.343"></a>
<span class="sourceLineNo">344</span>                <a name="line.344"></a>
<span class="sourceLineNo">345</span>                if (root != null) {<a name="line.345"></a>
<span class="sourceLineNo">346</span>                        Label title = createLabel(root, activeAction, uriResolver, null, "header/title", false, false);<a name="line.346"></a>
<span class="sourceLineNo">347</span>                        EList&lt;EObject&gt; rootChildren = root.getChildren();<a name="line.347"></a>
<span class="sourceLineNo">348</span>                        if (title != null || rootChildren.size() &gt; 1) {<a name="line.348"></a>
<span class="sourceLineNo">349</span>                                // Header<a name="line.349"></a>
<span class="sourceLineNo">350</span>                                Header header = appPage.getHeader();<a name="line.350"></a>
<span class="sourceLineNo">351</span>                                if (header == null) {<a name="line.351"></a>
<span class="sourceLineNo">352</span>                                        header = AppFactory.eINSTANCE.createHeader();<a name="line.352"></a>
<span class="sourceLineNo">353</span>                                        appPage.setHeader(header);<a name="line.353"></a>
<span class="sourceLineNo">354</span>                                }<a name="line.354"></a>
<span class="sourceLineNo">355</span>                                if (title != null) {<a name="line.355"></a>
<span class="sourceLineNo">356</span>                                        header.setTitle(title);<a name="line.356"></a>
<span class="sourceLineNo">357</span>                                }<a name="line.357"></a>
<span class="sourceLineNo">358</span>                                List&lt;EObject&gt; headerItems = header.getItems();<a name="line.358"></a>
<span class="sourceLineNo">359</span>                                rootChildren.listIterator(1).forEachRemaining(rac -&gt; {<a name="line.359"></a>
<span class="sourceLineNo">360</span>                                        if (rac instanceof Action) {<a name="line.360"></a>
<span class="sourceLineNo">361</span>                                                headerItems.add(createLabel((Action) rac, activeAction, uriResolver, null, "header/navigation", true, false));<a name="line.361"></a>
<span class="sourceLineNo">362</span>                                        } else {<a name="line.362"></a>
<span class="sourceLineNo">363</span>                                                headerItems.add(EcoreUtil.copy(rac));<a name="line.363"></a>
<span class="sourceLineNo">364</span>                                        }<a name="line.364"></a>
<span class="sourceLineNo">365</span>                                });<a name="line.365"></a>
<span class="sourceLineNo">366</span>                        }<a name="line.366"></a>
<span class="sourceLineNo">367</span>                        <a name="line.367"></a>
<span class="sourceLineNo">368</span>                        if (root instanceof Action) {<a name="line.368"></a>
<span class="sourceLineNo">369</span>                                List&lt;EObject&gt; rootNavigation = resolveActionReferences(((Action) root).getNavigation());<a name="line.369"></a>
<span class="sourceLineNo">370</span>                                if (!rootNavigation.isEmpty()) {<a name="line.370"></a>
<span class="sourceLineNo">371</span>                                        Footer footer = appPage.getFooter();<a name="line.371"></a>
<span class="sourceLineNo">372</span>                                        if (footer == null) {<a name="line.372"></a>
<span class="sourceLineNo">373</span>                                                footer = AppFactory.eINSTANCE.createFooter();<a name="line.373"></a>
<span class="sourceLineNo">374</span>                                                appPage.setFooter(footer);<a name="line.374"></a>
<span class="sourceLineNo">375</span>                                        }<a name="line.375"></a>
<span class="sourceLineNo">376</span>                                        EList&lt;EObject&gt; footerItems = footer.getItems();<a name="line.376"></a>
<span class="sourceLineNo">377</span>                                        rootNavigation.forEach(ran -&gt; {<a name="line.377"></a>
<span class="sourceLineNo">378</span>                                                if (ran instanceof Action) {<a name="line.378"></a>
<span class="sourceLineNo">379</span>                                                        footerItems.add(createLabel((Action) ran, activeAction, uriResolver, null, "footer/navigation", true, false));<a name="line.379"></a>
<span class="sourceLineNo">380</span>                                                } else {<a name="line.380"></a>
<span class="sourceLineNo">381</span>                                                        footerItems.add(EcoreUtil.copy(ran));<a name="line.381"></a>
<span class="sourceLineNo">382</span>                                                }<a name="line.382"></a>
<span class="sourceLineNo">383</span>                                        });<a name="line.383"></a>
<span class="sourceLineNo">384</span>                                        <a name="line.384"></a>
<span class="sourceLineNo">385</span>                                }<a name="line.385"></a>
<span class="sourceLineNo">386</span>                        }<a name="line.386"></a>
<span class="sourceLineNo">387</span>                }<a name="line.387"></a>
<span class="sourceLineNo">388</span>                <a name="line.388"></a>
<span class="sourceLineNo">389</span>                if (principal != null) {<a name="line.389"></a>
<span class="sourceLineNo">390</span>                        // Navbar <a name="line.390"></a>
<span class="sourceLineNo">391</span>                        Label brand = createLabel(principal, activeAction, uriResolver, null, "navbar/brand", false, false);<a name="line.391"></a>
<span class="sourceLineNo">392</span>                        if (principal instanceof Action) {<a name="line.392"></a>
<span class="sourceLineNo">393</span>                                List&lt;EObject&gt; principalNavigation = resolveActionReferences(((Action) principal).getNavigation());<a name="line.393"></a>
<span class="sourceLineNo">394</span>                                if (brand != null || !principalNavigation.isEmpty()) {<a name="line.394"></a>
<span class="sourceLineNo">395</span>                                        NavigationBar navBar = appPage.getNavigationBar();<a name="line.395"></a>
<span class="sourceLineNo">396</span>                                        if (navBar == null) {<a name="line.396"></a>
<span class="sourceLineNo">397</span>                                                navBar = AppFactory.eINSTANCE.createNavigationBar();<a name="line.397"></a>
<span class="sourceLineNo">398</span>                                                appPage.setNavigationBar(navBar);<a name="line.398"></a>
<span class="sourceLineNo">399</span>                                        }<a name="line.399"></a>
<span class="sourceLineNo">400</span>                                        if (brand != null) {<a name="line.400"></a>
<span class="sourceLineNo">401</span>                                                navBar.setBrand(brand);<a name="line.401"></a>
<span class="sourceLineNo">402</span>                                        }<a name="line.402"></a>
<span class="sourceLineNo">403</span>                                        EList&lt;EObject&gt; navBarItems = navBar.getItems();<a name="line.403"></a>
<span class="sourceLineNo">404</span>                                        principalNavigation.forEach(principalNavigationElement -&gt; {<a name="line.404"></a>
<span class="sourceLineNo">405</span>                                                if (principalNavigationElement instanceof Action) {<a name="line.405"></a>
<span class="sourceLineNo">406</span>                                                        navBarItems.add(createLabel((Action) principalNavigationElement, activeAction, uriResolver, null, "navbar/item", true, false));<a name="line.406"></a>
<span class="sourceLineNo">407</span>                                                } else {<a name="line.407"></a>
<span class="sourceLineNo">408</span>                                                        navBarItems.add(EcoreUtil.copy(principalNavigationElement));<a name="line.408"></a>
<span class="sourceLineNo">409</span>                                                }<a name="line.409"></a>
<span class="sourceLineNo">410</span>                                        });<a name="line.410"></a>
<span class="sourceLineNo">411</span>                                }<a name="line.411"></a>
<span class="sourceLineNo">412</span>                        }<a name="line.412"></a>
<span class="sourceLineNo">413</span>                        <a name="line.413"></a>
<span class="sourceLineNo">414</span>                        // Navigation panel<a name="line.414"></a>
<span class="sourceLineNo">415</span>                        List&lt;EObject&gt; principalChildren = resolveActionReferences(principal.getChildren());<a name="line.415"></a>
<span class="sourceLineNo">416</span>                        if (!principalChildren.isEmpty()) {<a name="line.416"></a>
<span class="sourceLineNo">417</span>                                NavigationPanel navPanel = appPage.getNavigationPanel();<a name="line.417"></a>
<span class="sourceLineNo">418</span>                                if (navPanel == null) {<a name="line.418"></a>
<span class="sourceLineNo">419</span>                                        navPanel = AppFactory.eINSTANCE.createNavigationPanel();<a name="line.419"></a>
<span class="sourceLineNo">420</span>                                        appPage.setNavigationPanel(navPanel);<a name="line.420"></a>
<span class="sourceLineNo">421</span>                                }<a name="line.421"></a>
<span class="sourceLineNo">422</span>                                if (isBlank(navPanel.getId())) {<a name="line.422"></a>
<span class="sourceLineNo">423</span>                                        navPanel.setId(principal.getId() + "-navigation-panel");<a name="line.423"></a>
<span class="sourceLineNo">424</span>                                }<a name="line.424"></a>
<span class="sourceLineNo">425</span>                                Function&lt;Label, String&gt; navItemIdProvider = na -&gt; isBlank(na.getId()) ? null : "nsd-app-nav-item-" + na.getId();<a name="line.425"></a>
<span class="sourceLineNo">426</span>                                List&lt;EObject&gt; navPanelItems = navPanel.getItems();<a name="line.426"></a>
<span class="sourceLineNo">427</span>                                principalChildren.forEach(principalChild -&gt; {<a name="line.427"></a>
<span class="sourceLineNo">428</span>                                        if (principalChild instanceof Label) {<a name="line.428"></a>
<span class="sourceLineNo">429</span>                                                navPanelItems.add(createLabel((Label) principalChild, activeAction, uriResolver, navItemIdProvider, "nav-panel", true, true));<a name="line.429"></a>
<span class="sourceLineNo">430</span>                                        } else {<a name="line.430"></a>
<span class="sourceLineNo">431</span>                                                navPanelItems.add(EcoreUtil.copy(principalChild));<a name="line.431"></a>
<span class="sourceLineNo">432</span>                                        }<a name="line.432"></a>
<span class="sourceLineNo">433</span>                                });<a name="line.433"></a>
<span class="sourceLineNo">434</span>                                <a name="line.434"></a>
<span class="sourceLineNo">435</span>                        }<a name="line.435"></a>
<span class="sourceLineNo">436</span>                }<a name="line.436"></a>
<span class="sourceLineNo">437</span>                <a name="line.437"></a>
<span class="sourceLineNo">438</span>                // Content panel<a name="line.438"></a>
<span class="sourceLineNo">439</span>                ContentPanel contentPanel = appPage.getContentPanel();<a name="line.439"></a>
<span class="sourceLineNo">440</span>                if (contentPanel == null) {<a name="line.440"></a>
<span class="sourceLineNo">441</span>                        contentPanel = AppFactory.eINSTANCE.createContentPanel();<a name="line.441"></a>
<span class="sourceLineNo">442</span>                        appPage.setContentPanel(contentPanel);<a name="line.442"></a>
<span class="sourceLineNo">443</span>                }<a name="line.443"></a>
<span class="sourceLineNo">444</span>                if  (activeAction != null) {<a name="line.444"></a>
<span class="sourceLineNo">445</span>                        String activeActionUUID = activeAction.getUuid();<a name="line.445"></a>
<span class="sourceLineNo">446</span>                        if (!org.nasdanika.common.Util.isBlank(activeActionUUID)) {<a name="line.446"></a>
<span class="sourceLineNo">447</span>                                Text text = ContentFactory.eINSTANCE.createText();<a name="line.447"></a>
<span class="sourceLineNo">448</span>                                text.setContent(activeActionUUID);<a name="line.448"></a>
<span class="sourceLineNo">449</span>                                contentPanel.getAttributes().put(DATA_NSD_ACTION_UUID_ATTRIBUTE, text);<a name="line.449"></a>
<span class="sourceLineNo">450</span>                        }<a name="line.450"></a>
<span class="sourceLineNo">451</span>                }<a name="line.451"></a>
<span class="sourceLineNo">452</span>                <a name="line.452"></a>
<span class="sourceLineNo">453</span>                buildContentPanel(activeAction, actionPath, activeAction == root || activeAction == principal, contentPanel, uriResolver, contentProvider, progressMonitor);    <a name="line.453"></a>
<span class="sourceLineNo">454</span>        }<a name="line.454"></a>
<span class="sourceLineNo">455</span>        <a name="line.455"></a>
<span class="sourceLineNo">456</span>        private static void buildContentPanel(<a name="line.456"></a>
<span class="sourceLineNo">457</span>                        Action action, <a name="line.457"></a>
<span class="sourceLineNo">458</span>                        List&lt;Label&gt; path,<a name="line.458"></a>
<span class="sourceLineNo">459</span>                        boolean rootOrPrincipal,<a name="line.459"></a>
<span class="sourceLineNo">460</span>                        ContentPanel contentPanel,<a name="line.460"></a>
<span class="sourceLineNo">461</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.461"></a>
<span class="sourceLineNo">462</span>                        ActionContentProvider contentProvider,<a name="line.462"></a>
<span class="sourceLineNo">463</span>                        ProgressMonitor progressMonitor) throws Exception {<a name="line.463"></a>
<span class="sourceLineNo">464</span>                <a name="line.464"></a>
<span class="sourceLineNo">465</span>                if (!rootOrPrincipal) {<a name="line.465"></a>
<span class="sourceLineNo">466</span>                        if (path != null &amp;&amp; !path.isEmpty()) {<a name="line.466"></a>
<span class="sourceLineNo">467</span>                                EList&lt;Label&gt; breadcrumb = contentPanel.getBreadcrumb();<a name="line.467"></a>
<span class="sourceLineNo">468</span>                                path.forEach(pathElement -&gt; {<a name="line.468"></a>
<span class="sourceLineNo">469</span>                                        Label element = createLabel(pathElement, action, uriResolver, null, "content-panel/breadcrumb", false, false);<a name="line.469"></a>
<span class="sourceLineNo">470</span>                                        if (element != null) {<a name="line.470"></a>
<span class="sourceLineNo">471</span>                                                breadcrumb.add(element);<a name="line.471"></a>
<span class="sourceLineNo">472</span>                                        }<a name="line.472"></a>
<span class="sourceLineNo">473</span>                                });<a name="line.473"></a>
<span class="sourceLineNo">474</span>                                Label tail = createLabel(action, action, uriResolver, null, "content-panel/breadcrumb", false, false);          <a name="line.474"></a>
<span class="sourceLineNo">475</span>                                tail.setActive(true);<a name="line.475"></a>
<span class="sourceLineNo">476</span>                                breadcrumb.add(tail);<a name="line.476"></a>
<span class="sourceLineNo">477</span>                        }<a name="line.477"></a>
<span class="sourceLineNo">478</span>        <a name="line.478"></a>
<span class="sourceLineNo">479</span>                        if (!isBlank(action.getText()) || !isBlank(action.getIcon())) {<a name="line.479"></a>
<span class="sourceLineNo">480</span>                                Label title = org.nasdanika.common.Util.isBlank(action.getName()) ? AppFactory.eINSTANCE.createLabel() : AppFactory.eINSTANCE.createLink(); <a name="line.480"></a>
<span class="sourceLineNo">481</span>                                configureLabel(action, action, uriResolver, null, "content-panel/title", title, false, false);<a name="line.481"></a>
<span class="sourceLineNo">482</span>                                contentPanel.setTitle(title);<a name="line.482"></a>
<span class="sourceLineNo">483</span>                        }<a name="line.483"></a>
<span class="sourceLineNo">484</span>                                        <a name="line.484"></a>
<span class="sourceLineNo">485</span>                        List&lt;EObject&gt; navigation = resolveActionReferences(action.getNavigation());<a name="line.485"></a>
<span class="sourceLineNo">486</span>                        EList&lt;EObject&gt; navigationItems = contentPanel.getItems();<a name="line.486"></a>
<span class="sourceLineNo">487</span>                        navigation.forEach(navigationElement -&gt; {<a name="line.487"></a>
<span class="sourceLineNo">488</span>                                if (navigationElement instanceof Label) {<a name="line.488"></a>
<span class="sourceLineNo">489</span>                                        navigationItems.add(createLabel((Label) navigationElement, action, uriResolver, null, "content-panel/navigation-item", true, false));<a name="line.489"></a>
<span class="sourceLineNo">490</span>                                } else {<a name="line.490"></a>
<span class="sourceLineNo">491</span>                                        navigationItems.add(EcoreUtil.copy(navigationElement));<a name="line.491"></a>
<span class="sourceLineNo">492</span>                                }<a name="line.492"></a>
<span class="sourceLineNo">493</span>                        });<a name="line.493"></a>
<span class="sourceLineNo">494</span>                }<a name="line.494"></a>
<span class="sourceLineNo">495</span>                <a name="line.495"></a>
<span class="sourceLineNo">496</span>                int sectionColumns = action.getSectionColumns();<a name="line.496"></a>
<span class="sourceLineNo">497</span>                if (sectionColumns &gt; 0) {<a name="line.497"></a>
<span class="sourceLineNo">498</span>                        contentPanel.setSectionColumns(sectionColumns);<a name="line.498"></a>
<span class="sourceLineNo">499</span>                }<a name="line.499"></a>
<span class="sourceLineNo">500</span>                SectionStyle sectionStyle = action.getSectionStyle();<a name="line.500"></a>
<span class="sourceLineNo">501</span>                if (sectionStyle != null) {<a name="line.501"></a>
<span class="sourceLineNo">502</span>                        contentPanel.setSectionStyle(sectionStyle);<a name="line.502"></a>
<span class="sourceLineNo">503</span>                }<a name="line.503"></a>
<span class="sourceLineNo">504</span>                <a name="line.504"></a>
<span class="sourceLineNo">505</span>                EList&lt;ContentPanel&gt; cpSections = contentPanel.getSections();<a name="line.505"></a>
<span class="sourceLineNo">506</span>                for (Action section: action.getSections()) {<a name="line.506"></a>
<span class="sourceLineNo">507</span>                        ContentPanel sectionPanel = AppFactory.eINSTANCE.createContentPanel();<a name="line.507"></a>
<span class="sourceLineNo">508</span>                        cpSections.add(sectionPanel);<a name="line.508"></a>
<span class="sourceLineNo">509</span>                        buildContentPanel(section, null, false, sectionPanel, uriResolver, contentProvider, progressMonitor);<a name="line.509"></a>
<span class="sourceLineNo">510</span>                }<a name="line.510"></a>
<span class="sourceLineNo">511</span><a name="line.511"></a>
<span class="sourceLineNo">512</span>                contentPanel.setFloatLeftNavigation(createNavigationPanel(action.getFloatLeftNavigation()));<a name="line.512"></a>
<span class="sourceLineNo">513</span>                contentPanel.setFloatRightNavigation(createNavigationPanel(action.getFloatRightNavigation()));<a name="line.513"></a>
<span class="sourceLineNo">514</span>                contentPanel.setLeftNavigation(createNavigationPanel(action.getLeftNavigation()));              <a name="line.514"></a>
<span class="sourceLineNo">515</span>                contentPanel.setRightNavigation(createNavigationPanel(action.getRightNavigation()));<a name="line.515"></a>
<span class="sourceLineNo">516</span>                <a name="line.516"></a>
<span class="sourceLineNo">517</span>                contentPanel.getContent().addAll(contentProvider == null ? EcoreUtil.copyAll(action.getContent()) : contentProvider.getActionContent(action, uriResolver, progressMonitor));<a name="line.517"></a>
<span class="sourceLineNo">518</span>        }<a name="line.518"></a>
<span class="sourceLineNo">519</span>        <a name="line.519"></a>
<span class="sourceLineNo">520</span>        /**<a name="line.520"></a>
<span class="sourceLineNo">521</span>         * Creates a copy of a panel if not null and replaces action references with links.<a name="line.521"></a>
<span class="sourceLineNo">522</span>         * @param panel<a name="line.522"></a>
<span class="sourceLineNo">523</span>         * @return<a name="line.523"></a>
<span class="sourceLineNo">524</span>         */<a name="line.524"></a>
<span class="sourceLineNo">525</span>        private static NavigationPanel createNavigationPanel(NavigationPanel panel) {<a name="line.525"></a>
<span class="sourceLineNo">526</span>                if (panel == null) {<a name="line.526"></a>
<span class="sourceLineNo">527</span>                        return null;<a name="line.527"></a>
<span class="sourceLineNo">528</span>                }<a name="line.528"></a>
<span class="sourceLineNo">529</span>                NavigationPanel ret = EcoreUtil.copy(panel);<a name="line.529"></a>
<span class="sourceLineNo">530</span>                ListIterator&lt;EObject&gt; iit = ret.getItems().listIterator();<a name="line.530"></a>
<span class="sourceLineNo">531</span>                while (iit.hasNext()) {<a name="line.531"></a>
<span class="sourceLineNo">532</span>                        EObject next = iit.next();<a name="line.532"></a>
<span class="sourceLineNo">533</span>                        if (next instanceof ActionReference) {<a name="line.533"></a>
<span class="sourceLineNo">534</span>                                iit.set(EcoreUtil.copy(((ActionReference) next).getTarget()));<a name="line.534"></a>
<span class="sourceLineNo">535</span>                        }<a name="line.535"></a>
<span class="sourceLineNo">536</span>                }<a name="line.536"></a>
<span class="sourceLineNo">537</span>                return ret;<a name="line.537"></a>
<span class="sourceLineNo">538</span>        }<a name="line.538"></a>
<span class="sourceLineNo">539</span><a name="line.539"></a>
<span class="sourceLineNo">540</span>        private static boolean isLink(Label label, URI uri) {<a name="line.540"></a>
<span class="sourceLineNo">541</span>                if (uri != null) {<a name="line.541"></a>
<span class="sourceLineNo">542</span>                        return true;<a name="line.542"></a>
<span class="sourceLineNo">543</span>                }<a name="line.543"></a>
<span class="sourceLineNo">544</span>                <a name="line.544"></a>
<span class="sourceLineNo">545</span>                if (label instanceof Link) {<a name="line.545"></a>
<span class="sourceLineNo">546</span>                        Link link = (Link) label;<a name="line.546"></a>
<span class="sourceLineNo">547</span>                        return !isBlank(link.getScript()) || link.getModal() != null || !isBlank(link.getName());<a name="line.547"></a>
<span class="sourceLineNo">548</span>                }<a name="line.548"></a>
<span class="sourceLineNo">549</span>                <a name="line.549"></a>
<span class="sourceLineNo">550</span>                return false;<a name="line.550"></a>
<span class="sourceLineNo">551</span>        }<a name="line.551"></a>
<span class="sourceLineNo">552</span>        <a name="line.552"></a>
<span class="sourceLineNo">553</span>        /**<a name="line.553"></a>
<span class="sourceLineNo">554</span>         * @param action<a name="line.554"></a>
<span class="sourceLineNo">555</span>         * @param activeAction<a name="line.555"></a>
<span class="sourceLineNo">556</span>         * @return true if this action is active or one of its anonymous or navigation descendants is active.<a name="line.556"></a>
<span class="sourceLineNo">557</span>         */<a name="line.557"></a>
<span class="sourceLineNo">558</span>        private static boolean isActiveAction(Action action, Label activeAction, boolean inspectChildren) {<a name="line.558"></a>
<span class="sourceLineNo">559</span>                if (action == activeAction) {<a name="line.559"></a>
<span class="sourceLineNo">560</span>                        return true;<a name="line.560"></a>
<span class="sourceLineNo">561</span>                }<a name="line.561"></a>
<span class="sourceLineNo">562</span>                <a name="line.562"></a>
<span class="sourceLineNo">563</span>                for (Action ac: action.getAnonymous()) {<a name="line.563"></a>
<span class="sourceLineNo">564</span>                        if (isActiveAction(ac, activeAction, inspectChildren)) {<a name="line.564"></a>
<span class="sourceLineNo">565</span>                                return true;<a name="line.565"></a>
<span class="sourceLineNo">566</span>                        }<a name="line.566"></a>
<span class="sourceLineNo">567</span>                }<a name="line.567"></a>
<span class="sourceLineNo">568</span>                <a name="line.568"></a>
<span class="sourceLineNo">569</span>                for (Action ac: action.getSections()) {<a name="line.569"></a>
<span class="sourceLineNo">570</span>                        if (isActiveAction(ac, activeAction, inspectChildren)) {<a name="line.570"></a>
<span class="sourceLineNo">571</span>                                return true;<a name="line.571"></a>
<span class="sourceLineNo">572</span>                        }<a name="line.572"></a>
<span class="sourceLineNo">573</span>                }               <a name="line.573"></a>
<span class="sourceLineNo">574</span>                <a name="line.574"></a>
<span class="sourceLineNo">575</span>                for (EObject nc: action.getNavigation()) {<a name="line.575"></a>
<span class="sourceLineNo">576</span>                        if (nc instanceof Action &amp;&amp; isActiveAction((Action) nc, activeAction, inspectChildren)) {<a name="line.576"></a>
<span class="sourceLineNo">577</span>                                return true;<a name="line.577"></a>
<span class="sourceLineNo">578</span>                        }<a name="line.578"></a>
<span class="sourceLineNo">579</span>                }<a name="line.579"></a>
<span class="sourceLineNo">580</span>                <a name="line.580"></a>
<span class="sourceLineNo">581</span>                if (inspectChildren) {<a name="line.581"></a>
<span class="sourceLineNo">582</span>                        for (EObject child: action.getChildren()) {<a name="line.582"></a>
<span class="sourceLineNo">583</span>                                if (child instanceof Action &amp;&amp; isActiveAction((Action) child, activeAction, inspectChildren)) {<a name="line.583"></a>
<span class="sourceLineNo">584</span>                                        return true;<a name="line.584"></a>
<span class="sourceLineNo">585</span>                                }<a name="line.585"></a>
<span class="sourceLineNo">586</span>                        }<a name="line.586"></a>
<span class="sourceLineNo">587</span>                }<a name="line.587"></a>
<span class="sourceLineNo">588</span>                <a name="line.588"></a>
<span class="sourceLineNo">589</span>                return false;<a name="line.589"></a>
<span class="sourceLineNo">590</span>        }<a name="line.590"></a>
<span class="sourceLineNo">591</span>        <a name="line.591"></a>
<span class="sourceLineNo">592</span>        private static void configureLabel(<a name="line.592"></a>
<span class="sourceLineNo">593</span>                        Label source, <a name="line.593"></a>
<span class="sourceLineNo">594</span>                        Label activeAction, <a name="line.594"></a>
<span class="sourceLineNo">595</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.595"></a>
<span class="sourceLineNo">596</span>                        Function&lt;Label, String&gt; idProvider, <a name="line.596"></a>
<span class="sourceLineNo">597</span>                        String appearancePath, <a name="line.597"></a>
<span class="sourceLineNo">598</span>                        Label label, <a name="line.598"></a>
<span class="sourceLineNo">599</span>                        boolean recursive,<a name="line.599"></a>
<span class="sourceLineNo">600</span>                        boolean inNavPanel) {<a name="line.600"></a>
<span class="sourceLineNo">601</span>                Appearance aa = source.getAppearance();<a name="line.601"></a>
<span class="sourceLineNo">602</span>                if (aa != null) {<a name="line.602"></a>
<span class="sourceLineNo">603</span>                        label.setAppearance(aa.effectiveAppearance(appearancePath));<a name="line.603"></a>
<span class="sourceLineNo">604</span>                }<a name="line.604"></a>
<span class="sourceLineNo">605</span><a name="line.605"></a>
<span class="sourceLineNo">606</span>                label.setColor(source.getColor());<a name="line.606"></a>
<span class="sourceLineNo">607</span>                label.setDescription(source.getDescription());<a name="line.607"></a>
<span class="sourceLineNo">608</span>                label.setDisabled(source.isDisabled());<a name="line.608"></a>
<span class="sourceLineNo">609</span>                Modal help = source.getHelp();<a name="line.609"></a>
<span class="sourceLineNo">610</span>                if (help != null) {<a name="line.610"></a>
<span class="sourceLineNo">611</span>//              label.setHelp(value); TODO - make links in help relative.<a name="line.611"></a>
<span class="sourceLineNo">612</span>                        throw new UnsupportedOperationException("Help modals not supported yet");<a name="line.612"></a>
<span class="sourceLineNo">613</span>                }<a name="line.613"></a>
<span class="sourceLineNo">614</span>                label.setIcon(source.getIcon());<a name="line.614"></a>
<span class="sourceLineNo">615</span>                if (idProvider != null) {<a name="line.615"></a>
<span class="sourceLineNo">616</span>                        label.setId(idProvider.apply(source));<a name="line.616"></a>
<span class="sourceLineNo">617</span>                }<a name="line.617"></a>
<span class="sourceLineNo">618</span>//              label.setId(action.getId());            <a name="line.618"></a>
<span class="sourceLineNo">619</span>                label.setNotification(source.getNotification());<a name="line.619"></a>
<span class="sourceLineNo">620</span>                label.setOutline(source.isOutline());<a name="line.620"></a>
<span class="sourceLineNo">621</span>                label.setText(source.getText());<a name="line.621"></a>
<span class="sourceLineNo">622</span>                label.setTooltip(source.getTooltip());<a name="line.622"></a>
<span class="sourceLineNo">623</span><a name="line.623"></a>
<span class="sourceLineNo">624</span>                if (source instanceof Action) {<a name="line.624"></a>
<span class="sourceLineNo">625</span>                        String sourceUUID = source.getUuid();<a name="line.625"></a>
<span class="sourceLineNo">626</span>                        if (!org.nasdanika.common.Util.isBlank(sourceUUID)) {<a name="line.626"></a>
<span class="sourceLineNo">627</span>                                Text text = ContentFactory.eINSTANCE.createText();<a name="line.627"></a>
<span class="sourceLineNo">628</span>                                text.setContent(sourceUUID);                    <a name="line.628"></a>
<span class="sourceLineNo">629</span>                                label.getAttributes().put(DATA_NSD_ACTION_UUID_ATTRIBUTE, text);<a name="line.629"></a>
<span class="sourceLineNo">630</span>                        }<a name="line.630"></a>
<span class="sourceLineNo">631</span>                }<a name="line.631"></a>
<span class="sourceLineNo">632</span>                <a name="line.632"></a>
<span class="sourceLineNo">633</span>                for (Entry&lt;String, EObject&gt; ae: source.getAttributes().entrySet()) {            <a name="line.633"></a>
<span class="sourceLineNo">634</span>                        label.getAttributes().put(ae.getKey(), EcoreUtil.copy(ae.getValue()));<a name="line.634"></a>
<span class="sourceLineNo">635</span>                }<a name="line.635"></a>
<span class="sourceLineNo">636</span>                <a name="line.636"></a>
<span class="sourceLineNo">637</span>                if (label instanceof Link) {<a name="line.637"></a>
<span class="sourceLineNo">638</span>                        configureLink(source, activeAction, uriResolver, (Link) label);<a name="line.638"></a>
<span class="sourceLineNo">639</span>                }<a name="line.639"></a>
<span class="sourceLineNo">640</span>                <a name="line.640"></a>
<span class="sourceLineNo">641</span>                if (recursive) {<a name="line.641"></a>
<span class="sourceLineNo">642</span>                        EList&lt;EObject&gt; labelChildren = label.getChildren();<a name="line.642"></a>
<span class="sourceLineNo">643</span>                        for (EObject actionChild: source.getChildren()) {<a name="line.643"></a>
<span class="sourceLineNo">644</span>                                if (actionChild instanceof ActionReference) {<a name="line.644"></a>
<span class="sourceLineNo">645</span>                                        actionChild = ((ActionReference) actionChild).getTarget();<a name="line.645"></a>
<span class="sourceLineNo">646</span>                                }<a name="line.646"></a>
<span class="sourceLineNo">647</span>                                if (actionChild instanceof Action) {<a name="line.647"></a>
<span class="sourceLineNo">648</span>                                        Action childAction = (Action) actionChild;<a name="line.648"></a>
<span class="sourceLineNo">649</span>                                        labelChildren.add(createLabel(childAction, activeAction, uriResolver, idProvider, "header/navigation", recursive, inNavPanel));<a name="line.649"></a>
<span class="sourceLineNo">650</span>                                        <a name="line.650"></a>
<span class="sourceLineNo">651</span>                                        // Second level - headers, separators.<a name="line.651"></a>
<span class="sourceLineNo">652</span>                                } else {<a name="line.652"></a>
<span class="sourceLineNo">653</span>                                        labelChildren.add(EcoreUtil.copy(actionChild));<a name="line.653"></a>
<span class="sourceLineNo">654</span>                                }                                                       <a name="line.654"></a>
<span class="sourceLineNo">655</span>                        }                       <a name="line.655"></a>
<span class="sourceLineNo">656</span>                }<a name="line.656"></a>
<span class="sourceLineNo">657</span>                <a name="line.657"></a>
<span class="sourceLineNo">658</span>                label.setActive(source instanceof Action &amp;&amp; inNavPanel ? isActiveAction((Action) source, activeAction, !hasActiveChildren(label)) : source.isActive());         <a name="line.658"></a>
<span class="sourceLineNo">659</span>        }<a name="line.659"></a>
<span class="sourceLineNo">660</span>        <a name="line.660"></a>
<span class="sourceLineNo">661</span>        private static boolean hasActiveChildren(Label label) {<a name="line.661"></a>
<span class="sourceLineNo">662</span>                for (EObject child: label.getChildren()) {<a name="line.662"></a>
<span class="sourceLineNo">663</span>                        if (child instanceof Label) {<a name="line.663"></a>
<span class="sourceLineNo">664</span>                                Label cl = (Label) child;<a name="line.664"></a>
<span class="sourceLineNo">665</span>                                if (cl.isActive() || hasActiveChildren(cl)) {<a name="line.665"></a>
<span class="sourceLineNo">666</span>                                        return true;<a name="line.666"></a>
<span class="sourceLineNo">667</span>                                }<a name="line.667"></a>
<span class="sourceLineNo">668</span>                        }<a name="line.668"></a>
<span class="sourceLineNo">669</span>                }<a name="line.669"></a>
<span class="sourceLineNo">670</span>                return false;<a name="line.670"></a>
<span class="sourceLineNo">671</span>        }<a name="line.671"></a>
<span class="sourceLineNo">672</span>        <a name="line.672"></a>
<span class="sourceLineNo">673</span>        private static void configureLink(<a name="line.673"></a>
<span class="sourceLineNo">674</span>                        Label source, <a name="line.674"></a>
<span class="sourceLineNo">675</span>                        Label activeAction, <a name="line.675"></a>
<span class="sourceLineNo">676</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.676"></a>
<span class="sourceLineNo">677</span>                        Link target) {<a name="line.677"></a>
<span class="sourceLineNo">678</span>                <a name="line.678"></a>
<span class="sourceLineNo">679</span>                URI activeActionURI = uriResolver.apply(activeAction, null);<a name="line.679"></a>
<span class="sourceLineNo">680</span>                URI uri = uriResolver.apply(source, activeActionURI);<a name="line.680"></a>
<span class="sourceLineNo">681</span>                <a name="line.681"></a>
<span class="sourceLineNo">682</span>                if (uri != null) {<a name="line.682"></a>
<span class="sourceLineNo">683</span>                        target.setLocation(uri.toString());<a name="line.683"></a>
<span class="sourceLineNo">684</span>                }<a name="line.684"></a>
<span class="sourceLineNo">685</span>                if (source instanceof Link) {<a name="line.685"></a>
<span class="sourceLineNo">686</span>                        Link sourceLink = (Link) source;<a name="line.686"></a>
<span class="sourceLineNo">687</span>                        target.setConfirmation(sourceLink.getConfirmation());<a name="line.687"></a>
<span class="sourceLineNo">688</span>                        if (sourceLink.getModal() != null) {<a name="line.688"></a>
<span class="sourceLineNo">689</span>        //              link.setModal(value); TODO - contextualization of links - relativization of URI's. Token expansion with a property computer? something like ${relative-uri/&lt;uri here&gt;}? <a name="line.689"></a>
<span class="sourceLineNo">690</span>        //              Support of sub-tokens e.g. ${{relative-uri/${token}}} recognizes ${token} as a sub-token to be expanded to result in ${relative-uri/&lt;token value&gt;}.<a name="line.690"></a>
<span class="sourceLineNo">691</span>                                throw new UnsupportedOperationException("Modals are not supported yet");<a name="line.691"></a>
<span class="sourceLineNo">692</span>                        }<a name="line.692"></a>
<span class="sourceLineNo">693</span>                        target.setName(sourceLink.getName());<a name="line.693"></a>
<span class="sourceLineNo">694</span>                        target.setScript(sourceLink.getScript());<a name="line.694"></a>
<span class="sourceLineNo">695</span>                        target.setTarget(sourceLink.getTarget());               <a name="line.695"></a>
<span class="sourceLineNo">696</span>                }<a name="line.696"></a>
<span class="sourceLineNo">697</span>                if (source instanceof Action) {<a name="line.697"></a>
<span class="sourceLineNo">698</span>                        Action action = (Action) source;<a name="line.698"></a>
<span class="sourceLineNo">699</span>                        if (action.isModalActivator()) {<a name="line.699"></a>
<span class="sourceLineNo">700</span>                                throw new UnsupportedOperationException("Modals are not supported yet");<a name="line.700"></a>
<span class="sourceLineNo">701</span>                        }<a name="line.701"></a>
<span class="sourceLineNo">702</span>                        if (action.isInline()) {<a name="line.702"></a>
<span class="sourceLineNo">703</span>                                throw new UnsupportedOperationException("Inline actions are not supported yet");                        <a name="line.703"></a>
<span class="sourceLineNo">704</span>                        }<a name="line.704"></a>
<span class="sourceLineNo">705</span>                }<a name="line.705"></a>
<span class="sourceLineNo">706</span>        }<a name="line.706"></a>
<span class="sourceLineNo">707</span>        <a name="line.707"></a>
<span class="sourceLineNo">708</span>        /**<a name="line.708"></a>
<span class="sourceLineNo">709</span>         * Creates a {@link Link} from {@link Action} with a relative location for locations.<a name="line.709"></a>
<span class="sourceLineNo">710</span>         * @param source<a name="line.710"></a>
<span class="sourceLineNo">711</span>         * @param uri<a name="line.711"></a>
<span class="sourceLineNo">712</span>         * @param active <a name="line.712"></a>
<span class="sourceLineNo">713</span>         * @param appearancePath <a name="line.713"></a>
<span class="sourceLineNo">714</span>         * @return<a name="line.714"></a>
<span class="sourceLineNo">715</span>         */<a name="line.715"></a>
<span class="sourceLineNo">716</span>        private static Label createLabel(<a name="line.716"></a>
<span class="sourceLineNo">717</span>                        Label source, <a name="line.717"></a>
<span class="sourceLineNo">718</span>                        Label activeAction, <a name="line.718"></a>
<span class="sourceLineNo">719</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.719"></a>
<span class="sourceLineNo">720</span>                        Function&lt;Label, String&gt; idProvider, <a name="line.720"></a>
<span class="sourceLineNo">721</span>                        String appearancePath,<a name="line.721"></a>
<span class="sourceLineNo">722</span>                        boolean recursive,<a name="line.722"></a>
<span class="sourceLineNo">723</span>                        boolean inNavPanel) {<a name="line.723"></a>
<span class="sourceLineNo">724</span>                <a name="line.724"></a>
<span class="sourceLineNo">725</span>                URI activeActionURI = uriResolver.apply(activeAction, null);<a name="line.725"></a>
<span class="sourceLineNo">726</span>                URI uri = uriResolver.apply(source, activeActionURI);<a name="line.726"></a>
<span class="sourceLineNo">727</span>                <a name="line.727"></a>
<span class="sourceLineNo">728</span>                if (isBlank(source.getText()) &amp;&amp; isBlank(source.getIcon()) &amp;&amp; !recursive) {<a name="line.728"></a>
<span class="sourceLineNo">729</span>                        return null;<a name="line.729"></a>
<span class="sourceLineNo">730</span>                }<a name="line.730"></a>
<span class="sourceLineNo">731</span>                Label label = isLink(source, uri) ? AppFactory.eINSTANCE.createLink() : AppFactory.eINSTANCE.createLabel();<a name="line.731"></a>
<span class="sourceLineNo">732</span>                configureLabel(source, activeAction, uriResolver, idProvider, appearancePath, label, recursive, inNavPanel);<a name="line.732"></a>
<span class="sourceLineNo">733</span>                                <a name="line.733"></a>
<span class="sourceLineNo">734</span>                return label;<a name="line.734"></a>
<span class="sourceLineNo">735</span>        }<a name="line.735"></a>
<span class="sourceLineNo">736</span>        <a name="line.736"></a>
<span class="sourceLineNo">737</span>        private static void generateNavigationPanel(<a name="line.737"></a>
<span class="sourceLineNo">738</span>                        Label root, <a name="line.738"></a>
<span class="sourceLineNo">739</span>                        Label principal, <a name="line.739"></a>
<span class="sourceLineNo">740</span>                        List&lt;Label&gt; actionPath,<a name="line.740"></a>
<span class="sourceLineNo">741</span>                        NavigationPanel navigationPanel,<a name="line.741"></a>
<span class="sourceLineNo">742</span>                        org.nasdanika.html.model.bootstrap.Page pageTemplate,<a name="line.742"></a>
<span class="sourceLineNo">743</span>                        BiFunction&lt;Label, URI, URI&gt; uriResolver, <a name="line.743"></a>
<span class="sourceLineNo">744</span>                        URI baseURI, <a name="line.744"></a>
<span class="sourceLineNo">745</span>                        Container container,<a name="line.745"></a>
<span class="sourceLineNo">746</span>                        ActionContentProvider actionContentProvider,<a name="line.746"></a>
<span class="sourceLineNo">747</span>                        PageContentProvider pageContentProvider,<a name="line.747"></a>
<span class="sourceLineNo">748</span>                        ProgressMonitor progressMonitor) throws Exception {<a name="line.748"></a>
<span class="sourceLineNo">749</span>                <a name="line.749"></a>
<span class="sourceLineNo">750</span>                if (navigationPanel != null) {<a name="line.750"></a>
<span class="sourceLineNo">751</span>                        for (EObject item: resolveActionReferences(navigationPanel.getItems())) {<a name="line.751"></a>
<span class="sourceLineNo">752</span>                                if (item instanceof Label) {<a name="line.752"></a>
<span class="sourceLineNo">753</span>                                        generateSite(root, principal, (Label) item, actionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);<a name="line.753"></a>
<span class="sourceLineNo">754</span>                                }<a name="line.754"></a>
<span class="sourceLineNo">755</span>                        }                       <a name="line.755"></a>
<span class="sourceLineNo">756</span>                }<a name="line.756"></a>
<span class="sourceLineNo">757</span>        }<a name="line.757"></a>
<span class="sourceLineNo">758</span>        <a name="line.758"></a>
<span class="sourceLineNo">759</span>        /**<a name="line.759"></a>
<span class="sourceLineNo">760</span>         * Resolves URI's by traversing containment references from the root Action taking {@link ActionReference} into account.<a name="line.760"></a>
<span class="sourceLineNo">761</span>         * @param context<a name="line.761"></a>
<span class="sourceLineNo">762</span>         * @return A function resolving {@link URI} for the argument {@link Action}. Caches results.<a name="line.762"></a>
<span class="sourceLineNo">763</span>         */<a name="line.763"></a>
<span class="sourceLineNo">764</span>        public static BiFunction&lt;Label,URI,URI&gt; uriResolver(Label root, Context context) {              <a name="line.764"></a>
<span class="sourceLineNo">765</span>                Map&lt;String, URI&gt; cache = new HashMap&lt;&gt;();<a name="line.765"></a>
<span class="sourceLineNo">766</span>                traverse(root, context.get(Context.BASE_URI_PROPERTY, URI.class), context, cache);<a name="line.766"></a>
<span class="sourceLineNo">767</span>                <a name="line.767"></a>
<span class="sourceLineNo">768</span>                return new BiFunction&lt;Label, URI, URI&gt;() {<a name="line.768"></a>
<span class="sourceLineNo">769</span>                        <a name="line.769"></a>
<span class="sourceLineNo">770</span>                        @Override<a name="line.770"></a>
<span class="sourceLineNo">771</span>                        public URI apply(Label label, URI base) {<a name="line.771"></a>
<span class="sourceLineNo">772</span>                                URI uri = cache.get(label.getUuid());           <a name="line.772"></a>
<span class="sourceLineNo">773</span>                                return base == null || uri == null ? uri : uri.deresolve(base, true, true, true);<a name="line.773"></a>
<span class="sourceLineNo">774</span>                        }<a name="line.774"></a>
<span class="sourceLineNo">775</span>                <a name="line.775"></a>
<span class="sourceLineNo">776</span>                };<a name="line.776"></a>
<span class="sourceLineNo">777</span>        }<a name="line.777"></a>
<span class="sourceLineNo">778</span>        <a name="line.778"></a>
<span class="sourceLineNo">779</span>        private static void traverse(Label label, URI base, Context context, Map&lt;String, URI&gt; cache) {<a name="line.779"></a>
<span class="sourceLineNo">780</span>                URI linkURI = compute(label, base, context);<a name="line.780"></a>
<span class="sourceLineNo">781</span>                cache.put(label.getUuid(), linkURI);<a name="line.781"></a>
<span class="sourceLineNo">782</span>                <a name="line.782"></a>
<span class="sourceLineNo">783</span>                for (EObject child: resolveActionReferences(label.getChildren())) {<a name="line.783"></a>
<span class="sourceLineNo">784</span>                        if (child instanceof Action) {<a name="line.784"></a>
<span class="sourceLineNo">785</span>                                traverse((Action) child, linkURI == null ? base : linkURI, context, cache);<a name="line.785"></a>
<span class="sourceLineNo">786</span>                        }<a name="line.786"></a>
<span class="sourceLineNo">787</span>                }<a name="line.787"></a>
<span class="sourceLineNo">788</span>                <a name="line.788"></a>
<span class="sourceLineNo">789</span>                if (label instanceof Action) {<a name="line.789"></a>
<span class="sourceLineNo">790</span>                        Action action = (Action) label;<a name="line.790"></a>
<span class="sourceLineNo">791</span>                        for (EObject item: resolveActionReferences(action.getNavigation())) {<a name="line.791"></a>
<span class="sourceLineNo">792</span>                                if (item instanceof Link) {<a name="line.792"></a>
<span class="sourceLineNo">793</span>                                        traverse((Link) item, linkURI == null ? base : linkURI, context, cache);<a name="line.793"></a>
<span class="sourceLineNo">794</span>                                }<a name="line.794"></a>
<span class="sourceLineNo">795</span>                        }<a name="line.795"></a>
<span class="sourceLineNo">796</span>                        for (Action section: action.getSections()) {<a name="line.796"></a>
<span class="sourceLineNo">797</span>                                traverse(section, linkURI == null ? base : linkURI, context, cache);<a name="line.797"></a>
<span class="sourceLineNo">798</span>                        }<a name="line.798"></a>
<span class="sourceLineNo">799</span>                        for (Action anonymous: action.getAnonymous()) {<a name="line.799"></a>
<span class="sourceLineNo">800</span>                                traverse(anonymous, linkURI == null ? base : linkURI, context, cache);<a name="line.800"></a>
<span class="sourceLineNo">801</span>                        }<a name="line.801"></a>
<span class="sourceLineNo">802</span>                }<a name="line.802"></a>
<span class="sourceLineNo">803</span>                <a name="line.803"></a>
<span class="sourceLineNo">804</span>                // TODO - nav panels?<a name="line.804"></a>
<span class="sourceLineNo">805</span>        }<a name="line.805"></a>
<span class="sourceLineNo">806</span><a name="line.806"></a>
<span class="sourceLineNo">807</span>        private static URI compute(Label label, URI base, Context context) {<a name="line.807"></a>
<span class="sourceLineNo">808</span>                if (label instanceof Link) {<a name="line.808"></a>
<span class="sourceLineNo">809</span>                        Link link = (Link) label;<a name="line.809"></a>
<span class="sourceLineNo">810</span>                        String uriString;<a name="line.810"></a>
<span class="sourceLineNo">811</span>                        if (link.eContainmentFeature() == AppPackage.Literals.ACTION__SECTIONS) {<a name="line.811"></a>
<span class="sourceLineNo">812</span>                                String aName = context.interpolateToString(link.getLocation());<a name="line.812"></a>
<span class="sourceLineNo">813</span>                                if (isBlank(aName)) {<a name="line.813"></a>
<span class="sourceLineNo">814</span>                                        return null;<a name="line.814"></a>
<span class="sourceLineNo">815</span>                                }<a name="line.815"></a>
<span class="sourceLineNo">816</span>                                uriString = "#" + aName;<a name="line.816"></a>
<span class="sourceLineNo">817</span>                        } else {                                <a name="line.817"></a>
<span class="sourceLineNo">818</span>                                uriString = context.interpolateToString(link.getLocation());<a name="line.818"></a>
<span class="sourceLineNo">819</span>                                if (isBlank(uriString)) {<a name="line.819"></a>
<span class="sourceLineNo">820</span>                                        return null;<a name="line.820"></a>
<span class="sourceLineNo">821</span>                                }<a name="line.821"></a>
<span class="sourceLineNo">822</span>                        }<a name="line.822"></a>
<span class="sourceLineNo">823</span>                        URI uri = URI.createURI(uriString);<a name="line.823"></a>
<span class="sourceLineNo">824</span>                        if (uri.isRelative() &amp;&amp; base != null) {<a name="line.824"></a>
<span class="sourceLineNo">825</span>                                return uri.resolve(base);<a name="line.825"></a>
<span class="sourceLineNo">826</span>                        }<a name="line.826"></a>
<span class="sourceLineNo">827</span>                        return uri;<a name="line.827"></a>
<span class="sourceLineNo">828</span>                } <a name="line.828"></a>
<span class="sourceLineNo">829</span>                <a name="line.829"></a>
<span class="sourceLineNo">830</span>                return null;<a name="line.830"></a>
<span class="sourceLineNo">831</span>        }<a name="line.831"></a>
<span class="sourceLineNo">832</span>        <a name="line.832"></a>
<span class="sourceLineNo">833</span>        private static EObject resolveActionReference(EObject obj) {<a name="line.833"></a>
<span class="sourceLineNo">834</span>                return obj instanceof ActionReference ? ((ActionReference) obj).getTarget() : obj;<a name="line.834"></a>
<span class="sourceLineNo">835</span>        }<a name="line.835"></a>
<span class="sourceLineNo">836</span>        <a name="line.836"></a>
<span class="sourceLineNo">837</span>        private static List&lt;EObject&gt; resolveActionReferences(EList&lt;EObject&gt; objs) {<a name="line.837"></a>
<span class="sourceLineNo">838</span>                return objs.stream().map((Function&lt;EObject, EObject&gt;) Util::resolveActionReference).collect(Collectors.toList());<a name="line.838"></a>
<span class="sourceLineNo">839</span>        }<a name="line.839"></a>
<span class="sourceLineNo">840</span>        <a name="line.840"></a>
<span class="sourceLineNo">841</span>        public static JSONObject createSearchDocument(String path, File file) throws IOException {<a name="line.841"></a>
<span class="sourceLineNo">842</span>                return createSearchDocument(path, file, null, null);<a name="line.842"></a>
<span class="sourceLineNo">843</span>        }<a name="line.843"></a>
<span class="sourceLineNo">844</span>        <a name="line.844"></a>
<span class="sourceLineNo">845</span>        /**<a name="line.845"></a>
<span class="sourceLineNo">846</span>         * For Nasdanika App pages extracts page title, breadcrumbs and content text into a JSONObject to add to a collector and then<a name="line.846"></a>
<span class="sourceLineNo">847</span>         * to use for constructing search indices. <a name="line.847"></a>
<span class="sourceLineNo">848</span>         * @param path<a name="line.848"></a>
<span class="sourceLineNo">849</span>         * @param file<a name="line.849"></a>
<span class="sourceLineNo">850</span>         * @param contentConsumer Consumer of content elements which can be used to analyze page contents, e.g. find dead links. Can be null.  <a name="line.850"></a>
<span class="sourceLineNo">851</span>         * @param processor If not null the document is passed to the processor. If the processor returns true that means that the document was manipulated by the processor and shall be saved to the source file.<a name="line.851"></a>
<span class="sourceLineNo">852</span>         * @return Search document object for non-empty Nasdanika App pages, null otherwise.<a name="line.852"></a>
<span class="sourceLineNo">853</span>         * @throws IOException<a name="line.853"></a>
<span class="sourceLineNo">854</span>         */<a name="line.854"></a>
<span class="sourceLineNo">855</span>        public static JSONObject createSearchDocument(String path, File file, Consumer&lt;? super Element&gt; contentConsumer, BiFunction&lt;String, Document, Boolean&gt; processor) throws IOException {<a name="line.855"></a>
<span class="sourceLineNo">856</span>                Document document = Jsoup.parse(file, "UTF-8");<a name="line.856"></a>
<span class="sourceLineNo">857</span>                if (processor != null &amp;&amp; processor.apply(path, document)) {<a name="line.857"></a>
<span class="sourceLineNo">858</span>                        try (Writer writer = new OutputStreamWriter(new FileOutputStream(file), "UTF-8")) {<a name="line.858"></a>
<span class="sourceLineNo">859</span>                                writer.write(document.outerHtml());<a name="line.859"></a>
<span class="sourceLineNo">860</span>                        }<a name="line.860"></a>
<span class="sourceLineNo">861</span>                }<a name="line.861"></a>
<span class="sourceLineNo">862</span>                Elements contentPanelQuery = document.select("body &gt; div &gt; div.row.nsd-app-content-row &gt; div.col.nsd-app-content-panel");                                                                                                     <a name="line.862"></a>
<span class="sourceLineNo">863</span>                if (contentPanelQuery.isEmpty()) {<a name="line.863"></a>
<span class="sourceLineNo">864</span>                        return null;<a name="line.864"></a>
<span class="sourceLineNo">865</span>                }<a name="line.865"></a>
<span class="sourceLineNo">866</span>                Elements contentQuery = contentPanelQuery.select("div &gt; div.row.nsd-app-content-panel-content-row");<a name="line.866"></a>
<span class="sourceLineNo">867</span>                if (contentQuery.isEmpty()) {<a name="line.867"></a>
<span class="sourceLineNo">868</span>                        return null;<a name="line.868"></a>
<span class="sourceLineNo">869</span>                }<a name="line.869"></a>
<span class="sourceLineNo">870</span>                if (contentConsumer != null) {<a name="line.870"></a>
<span class="sourceLineNo">871</span>                        contentQuery.forEach(contentConsumer);<a name="line.871"></a>
<span class="sourceLineNo">872</span>                }<a name="line.872"></a>
<span class="sourceLineNo">873</span>                <a name="line.873"></a>
<span class="sourceLineNo">874</span>                StringBuilder contentText = new StringBuilder(contentQuery.text());<a name="line.874"></a>
<span class="sourceLineNo">875</span>                <a name="line.875"></a>
<span class="sourceLineNo">876</span>                // Drawio diagrams labels<a name="line.876"></a>
<span class="sourceLineNo">877</span>                for (Element diagramDiv: contentQuery.select("div.mxgraph")) {<a name="line.877"></a>
<span class="sourceLineNo">878</span>                        traverseMxGraphModel(diagramDiv, cell -&gt; {<a name="line.878"></a>
<span class="sourceLineNo">879</span>                                Object cellValue = cell.getValue();<a name="line.879"></a>
<span class="sourceLineNo">880</span>                                if (cellValue instanceof org.w3c.dom.Element) {<a name="line.880"></a>
<span class="sourceLineNo">881</span>                                        String label = ((org.w3c.dom.Element) cellValue).getAttribute("label");<a name="line.881"></a>
<span class="sourceLineNo">882</span>                                        if (!org.nasdanika.common.Util.isBlank(label)) {<a name="line.882"></a>
<span class="sourceLineNo">883</span>                                                String labelText = Jsoup.parse(label).text();<a name="line.883"></a>
<span class="sourceLineNo">884</span>                                                contentText.append(" ").append(labelText);<a name="line.884"></a>
<span class="sourceLineNo">885</span>                                        }<a name="line.885"></a>
<span class="sourceLineNo">886</span>                                } else if (cellValue != null) {<a name="line.886"></a>
<span class="sourceLineNo">887</span>                                        String text = Jsoup.parse(cellValue.toString()).text();<a name="line.887"></a>
<span class="sourceLineNo">888</span>                                        contentText.append(" ").append(text);                                   <a name="line.888"></a>
<span class="sourceLineNo">889</span>                                }<a name="line.889"></a>
<span class="sourceLineNo">890</span>                        });<a name="line.890"></a>
<span class="sourceLineNo">891</span>                }<a name="line.891"></a>
<span class="sourceLineNo">892</span>                <a name="line.892"></a>
<span class="sourceLineNo">893</span>                if (org.nasdanika.common.Util.isBlank(contentText.toString())) {<a name="line.893"></a>
<span class="sourceLineNo">894</span>                        return null;<a name="line.894"></a>
<span class="sourceLineNo">895</span>                }<a name="line.895"></a>
<span class="sourceLineNo">896</span>                <a name="line.896"></a>
<span class="sourceLineNo">897</span>                JSONObject searchDocument = new JSONObject();<a name="line.897"></a>
<span class="sourceLineNo">898</span>                searchDocument.put("content", StringEscapeUtils.escapeHtml4(contentText.toString()));<a name="line.898"></a>
<span class="sourceLineNo">899</span>                Elements titleQuery = contentPanelQuery.select("div &gt; div.row.nsd-app-content-panel-title-and-items-row &gt; div.col-auto &gt; h1");<a name="line.899"></a>
<span class="sourceLineNo">900</span>                if (titleQuery.size() == 1) {<a name="line.900"></a>
<span class="sourceLineNo">901</span>                        searchDocument.put("title", StringEscapeUtils.escapeHtml4(titleQuery.get(0).text()));<a name="line.901"></a>
<span class="sourceLineNo">902</span>                } else {<a name="line.902"></a>
<span class="sourceLineNo">903</span>                        searchDocument.put("title", document.title());<a name="line.903"></a>
<span class="sourceLineNo">904</span>                }<a name="line.904"></a>
<span class="sourceLineNo">905</span>                Elements breadcrumbQuery = contentPanelQuery.select("div &gt; div.row.nsd-app-content-panel-breadcrumb-row &gt; div &gt; nav &gt; ol &gt; li");<a name="line.905"></a>
<span class="sourceLineNo">906</span>                if (breadcrumbQuery.size() &gt; 0) {<a name="line.906"></a>
<span class="sourceLineNo">907</span>                        searchDocument.put("path", String.join("/", breadcrumbQuery.stream().map(e -&gt; StringEscapeUtils.escapeHtml4(e.text())).collect(Collectors.toList())));<a name="line.907"></a>
<span class="sourceLineNo">908</span>                }<a name="line.908"></a>
<span class="sourceLineNo">909</span>                for (Element element: contentPanelQuery) {<a name="line.909"></a>
<span class="sourceLineNo">910</span>                        String actionUUID = element.attr(DATA_NSD_ACTION_UUID_ATTRIBUTE);<a name="line.910"></a>
<span class="sourceLineNo">911</span>                        if (!org.nasdanika.common.Util.isBlank(actionUUID)) {<a name="line.911"></a>
<span class="sourceLineNo">912</span>                                searchDocument.put("action-uuid", actionUUID);<a name="line.912"></a>
<span class="sourceLineNo">913</span>                                break;<a name="line.913"></a>
<span class="sourceLineNo">914</span>                        }<a name="line.914"></a>
<span class="sourceLineNo">915</span>                }<a name="line.915"></a>
<span class="sourceLineNo">916</span>                <a name="line.916"></a>
<span class="sourceLineNo">917</span>                return searchDocument;<a name="line.917"></a>
<span class="sourceLineNo">918</span>        }<a name="line.918"></a>
<span class="sourceLineNo">919</span>        <a name="line.919"></a>
<span class="sourceLineNo">920</span>        /**<a name="line.920"></a>
<span class="sourceLineNo">921</span>         * Loads {@link mxGraphModel} from mxgraph div.<a name="line.921"></a>
<span class="sourceLineNo">922</span>         * @param mxGraphDiv<a name="line.922"></a>
<span class="sourceLineNo">923</span>         * @return<a name="line.923"></a>
<span class="sourceLineNo">924</span>         */<a name="line.924"></a>
<span class="sourceLineNo">925</span>        public static mxGraphModel loadMxGraphModel(Element mxGraphDiv) {<a name="line.925"></a>
<span class="sourceLineNo">926</span>                String data = mxGraphDiv.attr("data-mxgraph");<a name="line.926"></a>
<span class="sourceLineNo">927</span>                if (data != null) {<a name="line.927"></a>
<span class="sourceLineNo">928</span>                        JSONObject jsonData = new JSONObject(data);<a name="line.928"></a>
<span class="sourceLineNo">929</span>                        Object xml = jsonData.get("xml");<a name="line.929"></a>
<span class="sourceLineNo">930</span>                        if (xml instanceof String) {<a name="line.930"></a>
<span class="sourceLineNo">931</span>                                return parseMxGraphModel(xml);<a name="line.931"></a>
<span class="sourceLineNo">932</span>                        }<a name="line.932"></a>
<span class="sourceLineNo">933</span>                }<a name="line.933"></a>
<span class="sourceLineNo">934</span>                return null;<a name="line.934"></a>
<span class="sourceLineNo">935</span>        }<a name="line.935"></a>
<span class="sourceLineNo">936</span><a name="line.936"></a>
<span class="sourceLineNo">937</span>        public static mxGraphModel parseMxGraphModel(Object xml) {<a name="line.937"></a>
<span class="sourceLineNo">938</span>                org.w3c.dom.Document xmlDocument = mxXmlUtils.parseXml((String) xml);<a name="line.938"></a>
<span class="sourceLineNo">939</span>                org.w3c.dom.Element mxfileElement = xmlDocument.getDocumentElement(); // mxfile<a name="line.939"></a>
<span class="sourceLineNo">940</span>                org.w3c.dom.Element diagramElement = getChildElement(mxfileElement, "diagram");<a name="line.940"></a>
<span class="sourceLineNo">941</span>                org.w3c.dom.Element mxGraphModelElement = getChildElement(diagramElement, "mxGraphModel");<a name="line.941"></a>
<span class="sourceLineNo">942</span>                if (mxGraphModelElement == null) {<a name="line.942"></a>
<span class="sourceLineNo">943</span>                        try {<a name="line.943"></a>
<span class="sourceLineNo">944</span>                                String textContent = diagramElement.getTextContent();<a name="line.944"></a>
<span class="sourceLineNo">945</span>                                if (!Base64.isBase64(textContent)) {<a name="line.945"></a>
<span class="sourceLineNo">946</span>                                        throw new NasdanikaException("Compressed diagram is not Base64 encoded");<a name="line.946"></a>
<span class="sourceLineNo">947</span>                                }<a name="line.947"></a>
<span class="sourceLineNo">948</span>                            byte[] compressed = Base64.decodeBase64(textContent);<a name="line.948"></a>
<span class="sourceLineNo">949</span>                            byte[] decompressed = inflate(compressed);<a name="line.949"></a>
<span class="sourceLineNo">950</span>                            String decompressedStr = new String(decompressed, StandardCharsets.UTF_8);<a name="line.950"></a>
<span class="sourceLineNo">951</span>                            String decodedStr = URLDecoder.decode(decompressedStr, StandardCharsets.UTF_8.name());<a name="line.951"></a>
<span class="sourceLineNo">952</span>                            org.w3c.dom.Document modelDoc = mxXmlUtils.parseXml(decodedStr);<a name="line.952"></a>
<span class="sourceLineNo">953</span>                                mxCodec codec = new mxCodec(modelDoc);<a name="line.953"></a>
<span class="sourceLineNo">954</span>                                return Objects.requireNonNull((mxGraphModel) codec.decode(modelDoc.getDocumentElement()), "Graph model is null for " + decodedStr);<a name="line.954"></a>
<span class="sourceLineNo">955</span>                        } catch (IOException e) {<a name="line.955"></a>
<span class="sourceLineNo">956</span>                                throw new NasdanikaException("Error decoding a drwaio diagram: " + e, e);<a name="line.956"></a>
<span class="sourceLineNo">957</span>                        }<a name="line.957"></a>
<span class="sourceLineNo">958</span>                }<a name="line.958"></a>
<span class="sourceLineNo">959</span>                <a name="line.959"></a>
<span class="sourceLineNo">960</span>                mxCodec codec = new mxCodec(xmlDocument);<a name="line.960"></a>
<span class="sourceLineNo">961</span>                org.w3c.dom.Element graphModelElement = Objects.requireNonNull(mxGraphModelElement, "No mxGraphModel element: " + xml);<a name="line.961"></a>
<span class="sourceLineNo">962</span>                return Objects.requireNonNull((mxGraphModel) codec.decode(graphModelElement), "Graph model is null for " + xml);                        <a name="line.962"></a>
<span class="sourceLineNo">963</span>        }<a name="line.963"></a>
<span class="sourceLineNo">964</span>        <a name="line.964"></a>
<span class="sourceLineNo">965</span>        private static  byte[] inflate(byte[] content) throws IOException {<a name="line.965"></a>
<span class="sourceLineNo">966</span>                ByteArrayOutputStream baos = new ByteArrayOutputStream();<a name="line.966"></a>
<span class="sourceLineNo">967</span>                try (ByteArrayInputStream source = new ByteArrayInputStream(content); OutputStream target = new InflaterOutputStream(baos, new Inflater(true))) {<a name="line.967"></a>
<span class="sourceLineNo">968</span>                byte[] buf = new byte[8192];<a name="line.968"></a>
<span class="sourceLineNo">969</span>                int length;<a name="line.969"></a>
<span class="sourceLineNo">970</span>                while ((length = source.read(buf)) &gt; 0) {<a name="line.970"></a>
<span class="sourceLineNo">971</span>                    target.write(buf, 0, length);<a name="line.971"></a>
<span class="sourceLineNo">972</span>                }<a name="line.972"></a>
<span class="sourceLineNo">973</span>                }<a name="line.973"></a>
<span class="sourceLineNo">974</span>                <a name="line.974"></a>
<span class="sourceLineNo">975</span>                return baos.toByteArray();<a name="line.975"></a>
<span class="sourceLineNo">976</span>        }<a name="line.976"></a>
<span class="sourceLineNo">977</span>        <a name="line.977"></a>
<span class="sourceLineNo">978</span>        private static  byte[] deflate(byte[] content) throws IOException {<a name="line.978"></a>
<span class="sourceLineNo">979</span>                ByteArrayOutputStream baos = new ByteArrayOutputStream();<a name="line.979"></a>
<span class="sourceLineNo">980</span>                try (ByteArrayInputStream source = new ByteArrayInputStream(content); OutputStream target = new DeflaterOutputStream(baos, new Deflater(Deflater.DEFAULT_COMPRESSION, true))) {<a name="line.980"></a>
<span class="sourceLineNo">981</span>                byte[] buf = new byte[8192];<a name="line.981"></a>
<span class="sourceLineNo">982</span>                int length;<a name="line.982"></a>
<span class="sourceLineNo">983</span>                while ((length = source.read(buf)) &gt; 0) {<a name="line.983"></a>
<span class="sourceLineNo">984</span>                    target.write(buf, 0, length);<a name="line.984"></a>
<span class="sourceLineNo">985</span>                }<a name="line.985"></a>
<span class="sourceLineNo">986</span>                }<a name="line.986"></a>
<span class="sourceLineNo">987</span>                <a name="line.987"></a>
<span class="sourceLineNo">988</span>                return baos.toByteArray();<a name="line.988"></a>
<span class="sourceLineNo">989</span>        }<a name="line.989"></a>
<span class="sourceLineNo">990</span>        <a name="line.990"></a>
<span class="sourceLineNo">991</span>        public static void traverseMxGraphModel(Element mxGraphDiv, Consumer&lt;mxICell&gt; visitor) {<a name="line.991"></a>
<span class="sourceLineNo">992</span>                mxGraphModel graphModel = loadMxGraphModel(mxGraphDiv);<a name="line.992"></a>
<span class="sourceLineNo">993</span>                if (graphModel != null) {<a name="line.993"></a>
<span class="sourceLineNo">994</span>                        Object root = graphModel.getRoot();<a name="line.994"></a>
<span class="sourceLineNo">995</span>                        if (root instanceof mxICell) {<a name="line.995"></a>
<span class="sourceLineNo">996</span>                                visit((mxICell) root, visitor);<a name="line.996"></a>
<span class="sourceLineNo">997</span>                        }<a name="line.997"></a>
<span class="sourceLineNo">998</span>                }               <a name="line.998"></a>
<span class="sourceLineNo">999</span>        }<a name="line.999"></a>
<span class="sourceLineNo">1000</span>        <a name="line.1000"></a>
<span class="sourceLineNo">1001</span>        private static org.w3c.dom.Element getChildElement(org.w3c.dom.Element parent, String name) {<a name="line.1001"></a>
<span class="sourceLineNo">1002</span>                NodeList children = parent.getChildNodes();<a name="line.1002"></a>
<span class="sourceLineNo">1003</span>                for (int i = 0; i &lt; children.getLength(); ++i) {<a name="line.1003"></a>
<span class="sourceLineNo">1004</span>                        Node child = children.item(i);<a name="line.1004"></a>
<span class="sourceLineNo">1005</span>                        if (child instanceof org.w3c.dom.Element &amp;&amp; ((org.w3c.dom.Element) child).getTagName().equals(name)) {<a name="line.1005"></a>
<span class="sourceLineNo">1006</span>                                return (org.w3c.dom.Element) child;<a name="line.1006"></a>
<span class="sourceLineNo">1007</span>                        }<a name="line.1007"></a>
<span class="sourceLineNo">1008</span>                }<a name="line.1008"></a>
<span class="sourceLineNo">1009</span>                return null;<a name="line.1009"></a>
<span class="sourceLineNo">1010</span>        }<a name="line.1010"></a>
<span class="sourceLineNo">1011</span>        <a name="line.1011"></a>
<span class="sourceLineNo">1012</span>        /**<a name="line.1012"></a>
<span class="sourceLineNo">1013</span>         * Loads graph model, traverses all cells and then saves and returns the model.<a name="line.1013"></a>
<span class="sourceLineNo">1014</span>         * @param spec<a name="line.1014"></a>
<span class="sourceLineNo">1015</span>         * @param cellVisitor<a name="line.1015"></a>
<span class="sourceLineNo">1016</span>         * @return<a name="line.1016"></a>
<span class="sourceLineNo">1017</span>         */<a name="line.1017"></a>
<span class="sourceLineNo">1018</span>        public static String filterMxGraphModel(String spec, Consumer&lt;mxICell&gt; cellVisitor) throws Exception {<a name="line.1018"></a>
<span class="sourceLineNo">1019</span>                org.w3c.dom.Document xmlDocument = mxXmlUtils.parseXml(spec);<a name="line.1019"></a>
<span class="sourceLineNo">1020</span>                org.w3c.dom.Element mxfileElement = xmlDocument.getDocumentElement(); // mxfile<a name="line.1020"></a>
<span class="sourceLineNo">1021</span>                org.w3c.dom.Element diagramElement = getChildElement(mxfileElement, "diagram");<a name="line.1021"></a>
<span class="sourceLineNo">1022</span>                org.w3c.dom.Element mxGraphModelElement = getChildElement(diagramElement, "mxGraphModel");<a name="line.1022"></a>
<span class="sourceLineNo">1023</span>                if (mxGraphModelElement == null) { // Compressed<a name="line.1023"></a>
<span class="sourceLineNo">1024</span>                        String textContent = diagramElement.getTextContent();<a name="line.1024"></a>
<span class="sourceLineNo">1025</span>                        if (!Base64.isBase64(textContent)) {<a name="line.1025"></a>
<span class="sourceLineNo">1026</span>                                throw new NasdanikaException("Compressed diagram is not Base64 encoded");<a name="line.1026"></a>
<span class="sourceLineNo">1027</span>                        }<a name="line.1027"></a>
<span class="sourceLineNo">1028</span>                    byte[] compressed = Base64.decodeBase64(textContent);<a name="line.1028"></a>
<span class="sourceLineNo">1029</span>                    byte[] decompressed = inflate(compressed);<a name="line.1029"></a>
<span class="sourceLineNo">1030</span>                    String decompressedStr = new String(decompressed, StandardCharsets.UTF_8);<a name="line.1030"></a>
<span class="sourceLineNo">1031</span>                    String decodedStr = URLDecoder.decode(decompressedStr, StandardCharsets.UTF_8.name());<a name="line.1031"></a>
<span class="sourceLineNo">1032</span>                    org.w3c.dom.Document modelDoc = mxXmlUtils.parseXml(decodedStr);<a name="line.1032"></a>
<span class="sourceLineNo">1033</span>                        mxCodec codec = new mxCodec(modelDoc);<a name="line.1033"></a>
<span class="sourceLineNo">1034</span>                        mxGraphModel graphModel = Objects.requireNonNull((mxGraphModel) codec.decode(modelDoc.getDocumentElement()), "Graph model is null for " + decodedStr);<a name="line.1034"></a>
<span class="sourceLineNo">1035</span>                        Object root = graphModel.getRoot();<a name="line.1035"></a>
<span class="sourceLineNo">1036</span>                        if (root instanceof mxICell) {<a name="line.1036"></a>
<span class="sourceLineNo">1037</span>                                visit((mxICell) root, cellVisitor);<a name="line.1037"></a>
<span class="sourceLineNo">1038</span>                        }<a name="line.1038"></a>
<span class="sourceLineNo">1039</span>                        Node encodedModel = codec.encode(graphModel);<a name="line.1039"></a>
<span class="sourceLineNo">1040</span>                        String encodedModelStr = mxXmlUtils.getXml(encodedModel);<a name="line.1040"></a>
<span class="sourceLineNo">1041</span>                    String urlEncodedStr = URLEncoder.encode(encodedModelStr, StandardCharsets.UTF_8.name()).replace("+", "%20"); // Hackish replacement of + with %20 for drawio viewer to understand.<a name="line.1041"></a>
<span class="sourceLineNo">1042</span>                    byte[] reCompressed = deflate(urlEncodedStr.getBytes(StandardCharsets.UTF_8));<a name="line.1042"></a>
<span class="sourceLineNo">1043</span>                    String reEncoded = Base64.encodeBase64String(reCompressed);<a name="line.1043"></a>
<span class="sourceLineNo">1044</span>                        diagramElement.setTextContent(reEncoded);<a name="line.1044"></a>
<span class="sourceLineNo">1045</span>                        String ret = mxXmlUtils.getXml(xmlDocument);<a name="line.1045"></a>
<span class="sourceLineNo">1046</span>                        return ret;<a name="line.1046"></a>
<span class="sourceLineNo">1047</span>                }<a name="line.1047"></a>
<span class="sourceLineNo">1048</span>                <a name="line.1048"></a>
<span class="sourceLineNo">1049</span>                mxCodec codec = new mxCodec(xmlDocument);<a name="line.1049"></a>
<span class="sourceLineNo">1050</span>                mxGraphModel graphModel = Objects.requireNonNull((mxGraphModel) codec.decode(mxGraphModelElement), "Graph model is null for " + spec);<a name="line.1050"></a>
<span class="sourceLineNo">1051</span>                Object root = graphModel.getRoot();<a name="line.1051"></a>
<span class="sourceLineNo">1052</span>                if (root instanceof mxICell) {<a name="line.1052"></a>
<span class="sourceLineNo">1053</span>                        visit((mxICell) root, cellVisitor);<a name="line.1053"></a>
<span class="sourceLineNo">1054</span>                }<a name="line.1054"></a>
<span class="sourceLineNo">1055</span>                Node encodedModel = codec.encode(graphModel);<a name="line.1055"></a>
<span class="sourceLineNo">1056</span>                diagramElement.replaceChild(encodedModel, mxGraphModelElement);<a name="line.1056"></a>
<span class="sourceLineNo">1057</span>                return mxXmlUtils.getXml(xmlDocument);                  <a name="line.1057"></a>
<span class="sourceLineNo">1058</span>        }<a name="line.1058"></a>
<span class="sourceLineNo">1059</span>        <a name="line.1059"></a>
<span class="sourceLineNo">1060</span>        /**<a name="line.1060"></a>
<span class="sourceLineNo">1061</span>         * Creates an inspector consumer which finds and reports broken links, missing images and elements with nsd-error class.<a name="line.1061"></a>
<span class="sourceLineNo">1062</span>         * @param file<a name="line.1062"></a>
<span class="sourceLineNo">1063</span>         * @param path<a name="line.1063"></a>
<span class="sourceLineNo">1064</span>         * @param siteDir<a name="line.1064"></a>
<span class="sourceLineNo">1065</span>         * @param errorConsumer<a name="line.1065"></a>
<span class="sourceLineNo">1066</span>         * @return<a name="line.1066"></a>
<span class="sourceLineNo">1067</span>         */<a name="line.1067"></a>
<span class="sourceLineNo">1068</span>        public static Consumer&lt;? super Element&gt; createInspector(Predicate&lt;String&gt; linkPredicate, Consumer&lt;String&gt; errorConsumer) {              <a name="line.1068"></a>
<span class="sourceLineNo">1069</span>                return element -&gt; {<a name="line.1069"></a>
<span class="sourceLineNo">1070</span>                        Elements anchors = element.getElementsByTag("a");<a name="line.1070"></a>
<span class="sourceLineNo">1071</span>                        for (Element anchor: anchors) {<a name="line.1071"></a>
<span class="sourceLineNo">1072</span>                                String target = anchor.attr("href");<a name="line.1072"></a>
<span class="sourceLineNo">1073</span>                                if (target != null) {<a name="line.1073"></a>
<span class="sourceLineNo">1074</span>                                        String id = anchor.attr("id");<a name="line.1074"></a>
<span class="sourceLineNo">1075</span>                                        boolean selfReferencing = id != null &amp;&amp; target.equals("#" + id); // Ignoring header tags generated by markdown.<a name="line.1075"></a>
<span class="sourceLineNo">1076</span>                                        if (!selfReferencing &amp;&amp; !linkPredicate.test(target)) {<a name="line.1076"></a>
<span class="sourceLineNo">1077</span>                                                errorConsumer.accept("Broken link: " + anchor);<a name="line.1077"></a>
<span class="sourceLineNo">1078</span>                                        }<a name="line.1078"></a>
<span class="sourceLineNo">1079</span>                                }<a name="line.1079"></a>
<span class="sourceLineNo">1080</span>                        }<a name="line.1080"></a>
<span class="sourceLineNo">1081</span>                        <a name="line.1081"></a>
<span class="sourceLineNo">1082</span>                        // Images<a name="line.1082"></a>
<span class="sourceLineNo">1083</span>                        Elements images = element.getElementsByTag("img");<a name="line.1083"></a>
<span class="sourceLineNo">1084</span>                        for (Element img: images) {<a name="line.1084"></a>
<span class="sourceLineNo">1085</span>                                String src = img.attr("src");<a name="line.1085"></a>
<span class="sourceLineNo">1086</span>                                if (src != null &amp;&amp; !linkPredicate.test(src)) {<a name="line.1086"></a>
<span class="sourceLineNo">1087</span>                                        errorConsumer.accept("Missing image: " + img);<a name="line.1087"></a>
<span class="sourceLineNo">1088</span>                                }<a name="line.1088"></a>
<span class="sourceLineNo">1089</span>                        }<a name="line.1089"></a>
<span class="sourceLineNo">1090</span>                        <a name="line.1090"></a>
<span class="sourceLineNo">1091</span>                        // NSD errors<a name="line.1091"></a>
<span class="sourceLineNo">1092</span>                        Elements errors = element.select("div.nsd-error");<a name="line.1092"></a>
<span class="sourceLineNo">1093</span>                        for (Element error: errors) {<a name="line.1093"></a>
<span class="sourceLineNo">1094</span>                                errorConsumer.accept("Error: " + error.text());<a name="line.1094"></a>
<span class="sourceLineNo">1095</span>                        }<a name="line.1095"></a>
<span class="sourceLineNo">1096</span>                        <a name="line.1096"></a>
<span class="sourceLineNo">1097</span>                        // Image maps<a name="line.1097"></a>
<span class="sourceLineNo">1098</span>                        for (Element area: element.select("area")) {<a name="line.1098"></a>
<span class="sourceLineNo">1099</span>                                String target = area.attr("href");<a name="line.1099"></a>
<span class="sourceLineNo">1100</span>                                if (target != null &amp;&amp; !linkPredicate.test(target)) {<a name="line.1100"></a>
<span class="sourceLineNo">1101</span>                                        errorConsumer.accept("Broken link: " + area);                                   <a name="line.1101"></a>
<span class="sourceLineNo">1102</span>                                }<a name="line.1102"></a>
<span class="sourceLineNo">1103</span>                        }<a name="line.1103"></a>
<span class="sourceLineNo">1104</span>                        <a name="line.1104"></a>
<span class="sourceLineNo">1105</span>                        // Drawio diagrams<a name="line.1105"></a>
<span class="sourceLineNo">1106</span>                        for (Element diagramDiv: element.select("div.mxgraph")) {<a name="line.1106"></a>
<span class="sourceLineNo">1107</span>                                traverseMxGraphModel(diagramDiv, cell -&gt; {<a name="line.1107"></a>
<span class="sourceLineNo">1108</span>                                        Object cellValue = cell.getValue();<a name="line.1108"></a>
<span class="sourceLineNo">1109</span>                                        if (cellValue instanceof org.w3c.dom.Element) {<a name="line.1109"></a>
<span class="sourceLineNo">1110</span>                                                String link = ((org.w3c.dom.Element) cellValue).getAttribute("link");<a name="line.1110"></a>
<span class="sourceLineNo">1111</span>                                                if (!org.nasdanika.common.Util.isBlank(link) &amp;&amp; !linkPredicate.test(link)) {<a name="line.1111"></a>
<span class="sourceLineNo">1112</span>                                                        String label = ((org.w3c.dom.Element) cellValue).getAttribute("label");<a name="line.1112"></a>
<span class="sourceLineNo">1113</span>                                                        if (org.nasdanika.common.Util.isBlank(label)) {<a name="line.1113"></a>
<span class="sourceLineNo">1114</span>                                                                errorConsumer.accept("Broken diagram link: " + link);<a name="line.1114"></a>
<span class="sourceLineNo">1115</span>                                                        } else {<a name="line.1115"></a>
<span class="sourceLineNo">1116</span>                                                                errorConsumer.accept("Broken diagram link on " + label + ": " + link);                                                                                  <a name="line.1116"></a>
<span class="sourceLineNo">1117</span>                                                        }<a name="line.1117"></a>
<span class="sourceLineNo">1118</span>                                                }<a name="line.1118"></a>
<span class="sourceLineNo">1119</span>                                        }<a name="line.1119"></a>
<span class="sourceLineNo">1120</span>                                });<a name="line.1120"></a>
<span class="sourceLineNo">1121</span>                        }                       <a name="line.1121"></a>
<span class="sourceLineNo">1122</span>                };<a name="line.1122"></a>
<span class="sourceLineNo">1123</span>        }<a name="line.1123"></a>
<span class="sourceLineNo">1124</span>        <a name="line.1124"></a>
<span class="sourceLineNo">1125</span>        private static void visit(mxICell cell, Consumer&lt;mxICell&gt; visitor) {<a name="line.1125"></a>
<span class="sourceLineNo">1126</span>                visitor.accept(cell);<a name="line.1126"></a>
<span class="sourceLineNo">1127</span>                for (int i = 0; i &lt; cell.getChildCount(); ++i) {<a name="line.1127"></a>
<span class="sourceLineNo">1128</span>                visit(cell.getChildAt(i), visitor);<a name="line.1128"></a>
<span class="sourceLineNo">1129</span>        }<a name="line.1129"></a>
<span class="sourceLineNo">1130</span>        }                       <a name="line.1130"></a>
<span class="sourceLineNo">1131</span><a name="line.1131"></a>
<span class="sourceLineNo">1132</span>        /**<a name="line.1132"></a>
<span class="sourceLineNo">1133</span>         * Creates a predicate checking for links relative to the argument file in the argument directory. <a name="line.1133"></a>
<span class="sourceLineNo">1134</span>         * @param file Base file<a name="line.1134"></a>
<span class="sourceLineNo">1135</span>         * @param dir Directory within which check for relative links<a name="line.1135"></a>
<span class="sourceLineNo">1136</span>         * @return<a name="line.1136"></a>
<span class="sourceLineNo">1137</span>         */<a name="line.1137"></a>
<span class="sourceLineNo">1138</span>        public static Predicate&lt;String&gt; createRelativeLinkPredicate(File file, File dir) {<a name="line.1138"></a>
<span class="sourceLineNo">1139</span>                return target -&gt; {<a name="line.1139"></a>
<span class="sourceLineNo">1140</span>                        File targetFile;<a name="line.1140"></a>
<span class="sourceLineNo">1141</span>                        String fragment;<a name="line.1141"></a>
<span class="sourceLineNo">1142</span>                        if (target.startsWith("#")) {<a name="line.1142"></a>
<span class="sourceLineNo">1143</span>                                targetFile = file;<a name="line.1143"></a>
<span class="sourceLineNo">1144</span>                                fragment = target;<a name="line.1144"></a>
<span class="sourceLineNo">1145</span>                        } else {<a name="line.1145"></a>
<span class="sourceLineNo">1146</span>                                int hashIdx = target.indexOf("#");<a name="line.1146"></a>
<span class="sourceLineNo">1147</span>                                if (hashIdx == -1) {<a name="line.1147"></a>
<span class="sourceLineNo">1148</span>                                        fragment = null;<a name="line.1148"></a>
<span class="sourceLineNo">1149</span>                                } else {<a name="line.1149"></a>
<span class="sourceLineNo">1150</span>                                        fragment = target.substring(hashIdx);<a name="line.1150"></a>
<span class="sourceLineNo">1151</span>                                        target = target.substring(0, hashIdx);<a name="line.1151"></a>
<span class="sourceLineNo">1152</span>                                }<a name="line.1152"></a>
<span class="sourceLineNo">1153</span>                                if (target.contains(":") || target.contains("?")) { // Absolute or with a query string, not checking<a name="line.1153"></a>
<span class="sourceLineNo">1154</span>                                        return true;<a name="line.1154"></a>
<span class="sourceLineNo">1155</span>                                }<a name="line.1155"></a>
<span class="sourceLineNo">1156</span>                                targetFile = new File(file.getParentFile(), target);<a name="line.1156"></a>
<span class="sourceLineNo">1157</span>                                for (File parent = targetFile.getParentFile(); parent != null; parent = parent.getParentFile()) {<a name="line.1157"></a>
<span class="sourceLineNo">1158</span>                                        if (parent.equals(dir)) {<a name="line.1158"></a>
<span class="sourceLineNo">1159</span>                                                if (!targetFile.exists()) {<a name="line.1159"></a>
<span class="sourceLineNo">1160</span>                                                        return false;<a name="line.1160"></a>
<span class="sourceLineNo">1161</span>                                                }<a name="line.1161"></a>
<span class="sourceLineNo">1162</span>                                        }<a name="line.1162"></a>
<span class="sourceLineNo">1163</span>                                }<a name="line.1163"></a>
<span class="sourceLineNo">1164</span>                        }<a name="line.1164"></a>
<span class="sourceLineNo">1165</span>                        if (fragment == null || fragment.trim().length() == 0) {<a name="line.1165"></a>
<span class="sourceLineNo">1166</span>                                return true;<a name="line.1166"></a>
<span class="sourceLineNo">1167</span>                        }<a name="line.1167"></a>
<span class="sourceLineNo">1168</span>                        <a name="line.1168"></a>
<span class="sourceLineNo">1169</span>                        try {<a name="line.1169"></a>
<span class="sourceLineNo">1170</span>                                Document document = Jsoup.parse(targetFile, StandardCharsets.UTF_8.name());<a name="line.1170"></a>
<span class="sourceLineNo">1171</span>                                Elements namedAnchors = document.select("[name='" + fragment.substring(1) + "']");<a name="line.1171"></a>
<span class="sourceLineNo">1172</span>                                Elements idAnchors = document.select("[id='" + fragment.substring(1) + "']");<a name="line.1172"></a>
<span class="sourceLineNo">1173</span>                                return namedAnchors.size() + idAnchors.size() == 1;<a name="line.1173"></a>
<span class="sourceLineNo">1174</span>                        } catch (IOException e) {<a name="line.1174"></a>
<span class="sourceLineNo">1175</span>                                throw new NasdanikaException("Error parsing " + targetFile.getAbsolutePath(), e);<a name="line.1175"></a>
<span class="sourceLineNo">1176</span>                        }<a name="line.1176"></a>
<span class="sourceLineNo">1177</span>                        <a name="line.1177"></a>
<span class="sourceLineNo">1178</span>                };<a name="line.1178"></a>
<span class="sourceLineNo">1179</span>                <a name="line.1179"></a>
<span class="sourceLineNo">1180</span>        }<a name="line.1180"></a>
<span class="sourceLineNo">1181</span><a name="line.1181"></a>
<span class="sourceLineNo">1182</span>                        <a name="line.1182"></a>
<span class="sourceLineNo">1183</span>}<a name="line.1183"></a>




























































</pre> 
  </div>  
 </body>
</html>