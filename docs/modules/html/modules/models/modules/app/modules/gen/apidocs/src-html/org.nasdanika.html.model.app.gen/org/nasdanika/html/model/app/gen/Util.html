<!doctype html>
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../../../stylesheet.css" title="Style">

<script src="../../../../../../../../../../../../../../../../../search-documents.js"></script>

<script src="https://unpkg.com/lunr/lunr.js"></script>

<script>
// Script for full-text search of JsTree

window.nsdJsTreeSearchCallback = function(str, node) { 
    var sf = new $.vakata.search(str, true, { caseSensitive : false, fuzzy : false }); 
    if (sf.search(node.text).isMatch) {
		return true;
	} 
    let searchResult = this.search(str); 
    for (const sr in searchResult) {
        if (searchResult[sr].ref === node.original['data-nsd-action-uuid']) {
            return true;
        } 
    } 
    return false; 
}.bind(lunr(function () {
			  this.ref('id');
			  this.field('title');
			  this.field('content');

			  for (const key in searchDocuments) {
				  let doc = searchDocuments[key];
				this.add({
					id: doc['action-uuid'],
					title: doc.title,
					path: doc.path,
					content: doc.content
				});  
			  }
			}));
</script>
</head>
<body>
<main role="main">
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a id="line.1">package org.nasdanika.html.model.app.gen;</a>
<span class="sourceLineNo">002</span><a id="line.2"></a>
<span class="sourceLineNo">003</span><a id="line.3">import static org.nasdanika.common.Util.isBlank;</a>
<span class="sourceLineNo">004</span><a id="line.4"></a>
<span class="sourceLineNo">005</span><a id="line.5">import java.io.File;</a>
<span class="sourceLineNo">006</span><a id="line.6">import java.io.FileOutputStream;</a>
<span class="sourceLineNo">007</span><a id="line.7">import java.io.IOException;</a>
<span class="sourceLineNo">008</span><a id="line.8">import java.io.OutputStreamWriter;</a>
<span class="sourceLineNo">009</span><a id="line.9">import java.io.Writer;</a>
<span class="sourceLineNo">010</span><a id="line.10">import java.nio.charset.StandardCharsets;</a>
<span class="sourceLineNo">011</span><a id="line.11">import java.util.ArrayList;</a>
<span class="sourceLineNo">012</span><a id="line.12">import java.util.Collections;</a>
<span class="sourceLineNo">013</span><a id="line.13">import java.util.List;</a>
<span class="sourceLineNo">014</span><a id="line.14">import java.util.ListIterator;</a>
<span class="sourceLineNo">015</span><a id="line.15">import java.util.Map.Entry;</a>
<span class="sourceLineNo">016</span><a id="line.16">import java.util.UUID;</a>
<span class="sourceLineNo">017</span><a id="line.17">import java.util.function.BiFunction;</a>
<span class="sourceLineNo">018</span><a id="line.18">import java.util.function.Consumer;</a>
<span class="sourceLineNo">019</span><a id="line.19">import java.util.function.Function;</a>
<span class="sourceLineNo">020</span><a id="line.20">import java.util.function.Predicate;</a>
<span class="sourceLineNo">021</span><a id="line.21">import java.util.stream.Collectors;</a>
<span class="sourceLineNo">022</span><a id="line.22"></a>
<span class="sourceLineNo">023</span><a id="line.23">import javax.xml.parsers.ParserConfigurationException;</a>
<span class="sourceLineNo">024</span><a id="line.24"></a>
<span class="sourceLineNo">025</span><a id="line.25">import org.apache.commons.text.StringEscapeUtils;</a>
<span class="sourceLineNo">026</span><a id="line.26">import org.eclipse.emf.common.util.EList;</a>
<span class="sourceLineNo">027</span><a id="line.27">import org.eclipse.emf.common.util.URI;</a>
<span class="sourceLineNo">028</span><a id="line.28">import org.eclipse.emf.ecore.EObject;</a>
<span class="sourceLineNo">029</span><a id="line.29">import org.eclipse.emf.ecore.util.EcoreUtil;</a>
<span class="sourceLineNo">030</span><a id="line.30">import org.json.JSONObject;</a>
<span class="sourceLineNo">031</span><a id="line.31">import org.jsoup.Jsoup;</a>
<span class="sourceLineNo">032</span><a id="line.32">import org.jsoup.nodes.Document;</a>
<span class="sourceLineNo">033</span><a id="line.33">import org.jsoup.nodes.Element;</a>
<span class="sourceLineNo">034</span><a id="line.34">import org.jsoup.select.Elements;</a>
<span class="sourceLineNo">035</span><a id="line.35">import org.nasdanika.common.Context;</a>
<span class="sourceLineNo">036</span><a id="line.36">import org.nasdanika.common.MutableContext;</a>
<span class="sourceLineNo">037</span><a id="line.37">import org.nasdanika.common.NasdanikaException;</a>
<span class="sourceLineNo">038</span><a id="line.38">import org.nasdanika.common.ProgressMonitor;</a>
<span class="sourceLineNo">039</span><a id="line.39">import org.nasdanika.drawio.ConnectionBase;</a>
<span class="sourceLineNo">040</span><a id="line.40">import org.nasdanika.drawio.ModelElement;</a>
<span class="sourceLineNo">041</span><a id="line.41">import org.nasdanika.exec.content.ContentFactory;</a>
<span class="sourceLineNo">042</span><a id="line.42">import org.nasdanika.exec.content.Text;</a>
<span class="sourceLineNo">043</span><a id="line.43">import org.nasdanika.exec.resources.Container;</a>
<span class="sourceLineNo">044</span><a id="line.44">import org.nasdanika.html.Button;</a>
<span class="sourceLineNo">045</span><a id="line.45">import org.nasdanika.html.HTMLFactory;</a>
<span class="sourceLineNo">046</span><a id="line.46">import org.nasdanika.html.Tag;</a>
<span class="sourceLineNo">047</span><a id="line.47">import org.nasdanika.html.TagName;</a>
<span class="sourceLineNo">048</span><a id="line.48">import org.nasdanika.html.bootstrap.BootstrapFactory;</a>
<span class="sourceLineNo">049</span><a id="line.49">import org.nasdanika.html.bootstrap.Breakpoint;</a>
<span class="sourceLineNo">050</span><a id="line.50">import org.nasdanika.html.bootstrap.Color;</a>
<span class="sourceLineNo">051</span><a id="line.51">import org.nasdanika.html.model.app.Action;</a>
<span class="sourceLineNo">052</span><a id="line.52">import org.nasdanika.html.model.app.ActionReference;</a>
<span class="sourceLineNo">053</span><a id="line.53">import org.nasdanika.html.model.app.AppFactory;</a>
<span class="sourceLineNo">054</span><a id="line.54">import org.nasdanika.html.model.app.AppPackage;</a>
<span class="sourceLineNo">055</span><a id="line.55">import org.nasdanika.html.model.app.ContentPanel;</a>
<span class="sourceLineNo">056</span><a id="line.56">import org.nasdanika.html.model.app.Footer;</a>
<span class="sourceLineNo">057</span><a id="line.57">import org.nasdanika.html.model.app.Header;</a>
<span class="sourceLineNo">058</span><a id="line.58">import org.nasdanika.html.model.app.Label;</a>
<span class="sourceLineNo">059</span><a id="line.59">import org.nasdanika.html.model.app.Link;</a>
<span class="sourceLineNo">060</span><a id="line.60">import org.nasdanika.html.model.app.NavigationBar;</a>
<span class="sourceLineNo">061</span><a id="line.61">import org.nasdanika.html.model.app.NavigationPanel;</a>
<span class="sourceLineNo">062</span><a id="line.62">import org.nasdanika.html.model.app.SectionStyle;</a>
<span class="sourceLineNo">063</span><a id="line.63">import org.nasdanika.html.model.bootstrap.Appearance;</a>
<span class="sourceLineNo">064</span><a id="line.64">import org.nasdanika.html.model.bootstrap.Item;</a>
<span class="sourceLineNo">065</span><a id="line.65">import org.nasdanika.html.model.bootstrap.Modal;</a>
<span class="sourceLineNo">066</span><a id="line.66">import org.xml.sax.SAXException;</a>
<span class="sourceLineNo">067</span><a id="line.67"></a>
<span class="sourceLineNo">068</span><a id="line.68">public final class Util {</a>
<span class="sourceLineNo">069</span><a id="line.69">        </a>
<span class="sourceLineNo">070</span><a id="line.70">        public static final String DATA_NSD_ACTION_UUID_ATTRIBUTE = "data-nsd-action-uuid";</a>
<span class="sourceLineNo">071</span><a id="line.71"></a>
<span class="sourceLineNo">072</span><a id="line.72">        // Util</a>
<span class="sourceLineNo">073</span><a id="line.73">        private Util() {</a>
<span class="sourceLineNo">074</span><a id="line.74">                throw new UnsupportedOperationException("Utility class, not to be instantiated");</a>
<span class="sourceLineNo">075</span><a id="line.75">        }</a>
<span class="sourceLineNo">076</span><a id="line.76"></a>
<span class="sourceLineNo">077</span><a id="line.77">        /**</a>
<span class="sourceLineNo">078</span><a id="line.78">         * Creates Bootstrap Navs from a list of items.</a>
<span class="sourceLineNo">079</span><a id="line.79">         * @param items</a>
<span class="sourceLineNo">080</span><a id="line.80">         * @param bootstrapFactory</a>
<span class="sourceLineNo">081</span><a id="line.81">         * @return</a>
<span class="sourceLineNo">082</span><a id="line.82">         */</a>
<span class="sourceLineNo">083</span><a id="line.83">        public static Tag navs(List&lt;Object&gt; items, BootstrapFactory bootstrapFactory) {</a>
<span class="sourceLineNo">084</span><a id="line.84">                HTMLFactory htmlFactory = bootstrapFactory.getHTMLFactory();</a>
<span class="sourceLineNo">085</span><a id="line.85">                Tag navs = htmlFactory.tag(TagName.ul).addClass("nav");</a>
<span class="sourceLineNo">086</span><a id="line.86">                for (Object item: items) {</a>
<span class="sourceLineNo">087</span><a id="line.87">                        Tag li = htmlFactory.tag(TagName.li, item).addClass("nav-item");</a>
<span class="sourceLineNo">088</span><a id="line.88">                        navs.accept(li);</a>
<span class="sourceLineNo">089</span><a id="line.89">                        if (item instanceof Tag) {</a>
<span class="sourceLineNo">090</span><a id="line.90">                                Tag itemTag = (Tag) item;</a>
<span class="sourceLineNo">091</span><a id="line.91">                                if (TagName.a.name().equalsIgnoreCase(itemTag.getTagName())) {</a>
<span class="sourceLineNo">092</span><a id="line.92">                                        itemTag.addClass("nav-link");</a>
<span class="sourceLineNo">093</span><a id="line.93">                                        Object data = itemTag.getData();</a>
<span class="sourceLineNo">094</span><a id="line.94">                                        if (data instanceof Item) {</a>
<span class="sourceLineNo">095</span><a id="line.95">                                                Item itemData = (Item) data;</a>
<span class="sourceLineNo">096</span><a id="line.96">                                                if (itemData.isActive()) {</a>
<span class="sourceLineNo">097</span><a id="line.97">                                                        itemTag.addClass("active");</a>
<span class="sourceLineNo">098</span><a id="line.98">                                                } else if (itemData.isDisabled()) {</a>
<span class="sourceLineNo">099</span><a id="line.99">                                                        itemTag.addClass("disabled");</a>
<span class="sourceLineNo">100</span><a id="line.100">                                                }</a>
<span class="sourceLineNo">101</span><a id="line.101">                                        }</a>
<span class="sourceLineNo">102</span><a id="line.102">                                } else if (TagName.span.name().equalsIgnoreCase(itemTag.getTagName())) {</a>
<span class="sourceLineNo">103</span><a id="line.103">                                        itemTag.addClass("navbar-text");</a>
<span class="sourceLineNo">104</span><a id="line.104">                                }</a>
<span class="sourceLineNo">105</span><a id="line.105">                        }</a>
<span class="sourceLineNo">106</span><a id="line.106">                }</a>
<span class="sourceLineNo">107</span><a id="line.107">                return navs;</a>
<span class="sourceLineNo">108</span><a id="line.108">        }</a>
<span class="sourceLineNo">109</span><a id="line.109">        </a>
<span class="sourceLineNo">110</span><a id="line.110">        /**</a>
<span class="sourceLineNo">111</span><a id="line.111">         * Creates Bootstrap Navs from a list of items.</a>
<span class="sourceLineNo">112</span><a id="line.112">         * @param items</a>
<span class="sourceLineNo">113</span><a id="line.113">         * @param bootstrapFactory</a>
<span class="sourceLineNo">114</span><a id="line.114">         * @return</a>
<span class="sourceLineNo">115</span><a id="line.115">         */</a>
<span class="sourceLineNo">116</span><a id="line.116">        public static Tag navbar(</a>
<span class="sourceLineNo">117</span><a id="line.117">                        Tag brand, </a>
<span class="sourceLineNo">118</span><a id="line.118">                        List&lt;Object&gt; items,</a>
<span class="sourceLineNo">119</span><a id="line.119">                        Breakpoint expand, </a>
<span class="sourceLineNo">120</span><a id="line.120">                        boolean dark,</a>
<span class="sourceLineNo">121</span><a id="line.121">                        Color background,</a>
<span class="sourceLineNo">122</span><a id="line.122">                        BootstrapFactory bootstrapFactory) {</a>
<span class="sourceLineNo">123</span><a id="line.123">                HTMLFactory htmlFactory = bootstrapFactory.getHTMLFactory();</a>
<span class="sourceLineNo">124</span><a id="line.124">                Tag navbar = htmlFactory.tag(TagName.ul).addClass("navbar", dark ? "navbar-dark" : "navbar-light");</a>
<span class="sourceLineNo">125</span><a id="line.125">                if (expand != null) {</a>
<span class="sourceLineNo">126</span><a id="line.126">                        navbar.addClass("navbar-expand-" + expand.code);</a>
<span class="sourceLineNo">127</span><a id="line.127">                }</a>
<span class="sourceLineNo">128</span><a id="line.128">                if (background != null) {</a>
<span class="sourceLineNo">129</span><a id="line.129">                        navbar.addClass("bg-" + background.code);</a>
<span class="sourceLineNo">130</span><a id="line.130">                }</a>
<span class="sourceLineNo">131</span><a id="line.131">                if (brand != null) {</a>
<span class="sourceLineNo">132</span><a id="line.132">                        brand.addClass("navbar-brand");</a>
<span class="sourceLineNo">133</span><a id="line.133">                        navbar.accept(brand);</a>
<span class="sourceLineNo">134</span><a id="line.134">                }</a>
<span class="sourceLineNo">135</span><a id="line.135">                String navbarContentId = htmlFactory.nextId();</a>
<span class="sourceLineNo">136</span><a id="line.136">                Button toggler = htmlFactory.button(htmlFactory.span().addClass("navbar-toggler-icon"));</a>
<span class="sourceLineNo">137</span><a id="line.137">                toggler</a>
<span class="sourceLineNo">138</span><a id="line.138">                        .addClass("navbar-toggler")</a>
<span class="sourceLineNo">139</span><a id="line.139">                        .attribute("type", "button")</a>
<span class="sourceLineNo">140</span><a id="line.140">                        .attribute("data-toggle", "collapse")</a>
<span class="sourceLineNo">141</span><a id="line.141">                        .attribute("data-target", "#" + navbarContentId)</a>
<span class="sourceLineNo">142</span><a id="line.142">                        .attribute("aria-expanded", "false")</a>
<span class="sourceLineNo">143</span><a id="line.143">                        .attribute("aria-label", "Toggle navigation");</a>
<span class="sourceLineNo">144</span><a id="line.144">                navbar.accept(toggler);</a>
<span class="sourceLineNo">145</span><a id="line.145">                </a>
<span class="sourceLineNo">146</span><a id="line.146">                Tag content = htmlFactory.div().addClass("collapse", "navbar-collapse").id(navbarContentId);</a>
<span class="sourceLineNo">147</span><a id="line.147">                navbar.accept(content);</a>
<span class="sourceLineNo">148</span><a id="line.148">                if (items != null &amp;&amp; !items.isEmpty()) {</a>
<span class="sourceLineNo">149</span><a id="line.149">                        Tag navs = navs(items, bootstrapFactory);</a>
<span class="sourceLineNo">150</span><a id="line.150">                        navs.removeClass("nav").addClass("navbar-nav", "mr-auto");</a>
<span class="sourceLineNo">151</span><a id="line.151">                        content.accept(navs);</a>
<span class="sourceLineNo">152</span><a id="line.152">                }</a>
<span class="sourceLineNo">153</span><a id="line.153">                return navbar;</a>
<span class="sourceLineNo">154</span><a id="line.154">        }</a>
<span class="sourceLineNo">155</span><a id="line.155">        </a>
<span class="sourceLineNo">156</span><a id="line.156">        /**</a>
<span class="sourceLineNo">157</span><a id="line.157">         * Generates application site from an {@link Action} model root. </a>
<span class="sourceLineNo">158</span><a id="line.158">         * @param root Root action to generate header and footer. Can be null.</a>
<span class="sourceLineNo">159</span><a id="line.159">         * @param pageTemplate Page template.</a>
<span class="sourceLineNo">160</span><a id="line.160">         * @param context Context used for uri resolution - interpolation of action locations and names. can be null.</a>
<span class="sourceLineNo">161</span><a id="line.161">         * @param container Receiver of generated resources.</a>
<span class="sourceLineNo">162</span><a id="line.162">         * @param progressMonitor Progress monitor.</a>
<span class="sourceLineNo">163</span><a id="line.163">         * @throws Exception </a>
<span class="sourceLineNo">164</span><a id="line.164">         */</a>
<span class="sourceLineNo">165</span><a id="line.165">        public static void generateSite(</a>
<span class="sourceLineNo">166</span><a id="line.166">                        Label root, </a>
<span class="sourceLineNo">167</span><a id="line.167">                        org.nasdanika.html.model.bootstrap.Page pageTemplate,</a>
<span class="sourceLineNo">168</span><a id="line.168">                        Container container,</a>
<span class="sourceLineNo">169</span><a id="line.169">                        ActionContentProvider.Factory actionContentProviderFactory,</a>
<span class="sourceLineNo">170</span><a id="line.170">                        PageContentProvider.Factory pageContentProviderFactory,</a>
<span class="sourceLineNo">171</span><a id="line.171">                        Context context,</a>
<span class="sourceLineNo">172</span><a id="line.172">                        ProgressMonitor progressMonitor) throws Exception {</a>
<span class="sourceLineNo">173</span><a id="line.173">        </a>
<span class="sourceLineNo">174</span><a id="line.174">                Label principal = null;</a>
<span class="sourceLineNo">175</span><a id="line.175">                EList&lt;EObject&gt; rootChildren = root.getChildren();</a>
<span class="sourceLineNo">176</span><a id="line.176">                if (rootChildren.size() &gt; 0) {</a>
<span class="sourceLineNo">177</span><a id="line.177">                        EObject firstChild = root.getChildren().get(0);</a>
<span class="sourceLineNo">178</span><a id="line.178">                        if (firstChild instanceof Action) {</a>
<span class="sourceLineNo">179</span><a id="line.179">                                principal = (Action) firstChild;</a>
<span class="sourceLineNo">180</span><a id="line.180">                        } else if (firstChild instanceof ActionReference) {</a>
<span class="sourceLineNo">181</span><a id="line.181">                                principal = ((ActionReference) firstChild).getTarget();</a>
<span class="sourceLineNo">182</span><a id="line.182">                        }</a>
<span class="sourceLineNo">183</span><a id="line.183">                }</a>
<span class="sourceLineNo">184</span><a id="line.184">                </a>
<span class="sourceLineNo">185</span><a id="line.185">                generateSite(root, principal, root, Collections.emptyList(), pageTemplate, container, actionContentProviderFactory, pageContentProviderFactory, context, progressMonitor);</a>
<span class="sourceLineNo">186</span><a id="line.186">        }</a>
<span class="sourceLineNo">187</span><a id="line.187">        </a>
<span class="sourceLineNo">188</span><a id="line.188">        /**</a>
<span class="sourceLineNo">189</span><a id="line.189">         * Generates application site from an {@link Action} model using a random base URI and a caching URI resolver created from the argument context with base-uri injected.</a>
<span class="sourceLineNo">190</span><a id="line.190">         * @param root Root action to generate header and footer. Can be null.</a>
<span class="sourceLineNo">191</span><a id="line.191">         * @param principal Principal action to generate navigation bar and navigation panel. Can be null.</a>
<span class="sourceLineNo">192</span><a id="line.192">         * @param activeAction Active action to generate the content panel if instance of action.</a>
<span class="sourceLineNo">193</span><a id="line.193">         * @param actionPath Action path to show in breadcrumbs.</a>
<span class="sourceLineNo">194</span><a id="line.194">         * @param pageTemplate Page template.</a>
<span class="sourceLineNo">195</span><a id="line.195">         * @param context Context used for uri resolution - interpolation of action locations and names. can be null.</a>
<span class="sourceLineNo">196</span><a id="line.196">         * @param container Receiver of generated resources.</a>
<span class="sourceLineNo">197</span><a id="line.197">         * @param progressMonitor Progress monitor.</a>
<span class="sourceLineNo">198</span><a id="line.198">         * @throws Exception </a>
<span class="sourceLineNo">199</span><a id="line.199">         */</a>
<span class="sourceLineNo">200</span><a id="line.200">        public static void generateSite(</a>
<span class="sourceLineNo">201</span><a id="line.201">                        Label root, </a>
<span class="sourceLineNo">202</span><a id="line.202">                        Label principal, </a>
<span class="sourceLineNo">203</span><a id="line.203">                        Label activeAction, </a>
<span class="sourceLineNo">204</span><a id="line.204">                        List&lt;Label&gt; actionPath,</a>
<span class="sourceLineNo">205</span><a id="line.205">                        org.nasdanika.html.model.bootstrap.Page pageTemplate,</a>
<span class="sourceLineNo">206</span><a id="line.206">                        Container container,</a>
<span class="sourceLineNo">207</span><a id="line.207">                        ActionContentProvider.Factory contentProviderFactory,</a>
<span class="sourceLineNo">208</span><a id="line.208">                        PageContentProvider.Factory pageProviderFactory,</a>
<span class="sourceLineNo">209</span><a id="line.209">                        Context context,</a>
<span class="sourceLineNo">210</span><a id="line.210">                        ProgressMonitor progressMonitor) throws Exception {</a>
<span class="sourceLineNo">211</span><a id="line.211">        </a>
<span class="sourceLineNo">212</span><a id="line.212">                if (context == null) {</a>
<span class="sourceLineNo">213</span><a id="line.213">                        context = Context.EMPTY_CONTEXT;</a>
<span class="sourceLineNo">214</span><a id="line.214">                }</a>
<span class="sourceLineNo">215</span><a id="line.215">                if (context.get(Context.BASE_URI_PROPERTY) == null) {</a>
<span class="sourceLineNo">216</span><a id="line.216">                        context = context.fork();</a>
<span class="sourceLineNo">217</span><a id="line.217">                        ((MutableContext) context).put(Context.BASE_URI_PROPERTY, URI.createURI("temp://" + UUID.randomUUID() + "/" + UUID.randomUUID() + "/"));</a>
<span class="sourceLineNo">218</span><a id="line.218">                }</a>
<span class="sourceLineNo">219</span><a id="line.219">                BiFunction&lt;Label, URI, URI&gt; uriResolver = org.nasdanika.html.model.app.util.Util.uriResolver(root, context);            </a>
<span class="sourceLineNo">220</span><a id="line.220">                generateSite(</a>
<span class="sourceLineNo">221</span><a id="line.221">                                root, </a>
<span class="sourceLineNo">222</span><a id="line.222">                                principal, </a>
<span class="sourceLineNo">223</span><a id="line.223">                                activeAction,</a>
<span class="sourceLineNo">224</span><a id="line.224">                                actionPath,</a>
<span class="sourceLineNo">225</span><a id="line.225">                                pageTemplate,</a>
<span class="sourceLineNo">226</span><a id="line.226">                                uriResolver, </a>
<span class="sourceLineNo">227</span><a id="line.227">                                (URI) context.get(Context.BASE_URI_PROPERTY), </a>
<span class="sourceLineNo">228</span><a id="line.228">                                container, </a>
<span class="sourceLineNo">229</span><a id="line.229">                                contentProviderFactory == null ? null : contentProviderFactory.create(context),</a>
<span class="sourceLineNo">230</span><a id="line.230">                                pageProviderFactory == null ? null : pageProviderFactory.create(context),                                               </a>
<span class="sourceLineNo">231</span><a id="line.231">                                progressMonitor);</a>
<span class="sourceLineNo">232</span><a id="line.232">        }</a>
<span class="sourceLineNo">233</span><a id="line.233">        </a>
<span class="sourceLineNo">234</span><a id="line.234">        /**</a>
<span class="sourceLineNo">235</span><a id="line.235">         * Generates application site from an {@link Action} model</a>
<span class="sourceLineNo">236</span><a id="line.236">         * @param root Root action to generate header and footer. Can be null.</a>
<span class="sourceLineNo">237</span><a id="line.237">         * @param principal Principal action to generate navigation bar and navigation panel. Can be null.</a>
<span class="sourceLineNo">238</span><a id="line.238">         * @param activeAction Active action to generate the content panel.</a>
<span class="sourceLineNo">239</span><a id="line.239">         * @param pageTemplate Page template.</a>
<span class="sourceLineNo">240</span><a id="line.240">         * @param uriResolver Resolves {@link Action} to {@link URI}.</a>
<span class="sourceLineNo">241</span><a id="line.241">         * @param baseURI Base URI for resolution, specifically to create relative URI's.</a>
<span class="sourceLineNo">242</span><a id="line.242">         * @param container Receiver of generated resources.</a>
<span class="sourceLineNo">243</span><a id="line.243">         * @param progressMonitor Progress monitor.</a>
<span class="sourceLineNo">244</span><a id="line.244">         * @throws Exception </a>
<span class="sourceLineNo">245</span><a id="line.245">         */</a>
<span class="sourceLineNo">246</span><a id="line.246">        public static void generateSite(</a>
<span class="sourceLineNo">247</span><a id="line.247">                        Label root, </a>
<span class="sourceLineNo">248</span><a id="line.248">                        Label principal, </a>
<span class="sourceLineNo">249</span><a id="line.249">                        Label activeAction, </a>
<span class="sourceLineNo">250</span><a id="line.250">                        List&lt;Label&gt; actionPath,</a>
<span class="sourceLineNo">251</span><a id="line.251">                        org.nasdanika.html.model.bootstrap.Page pageTemplate,</a>
<span class="sourceLineNo">252</span><a id="line.252">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">253</span><a id="line.253">                        URI baseURI,</a>
<span class="sourceLineNo">254</span><a id="line.254">                        Container container,</a>
<span class="sourceLineNo">255</span><a id="line.255">                        ActionContentProvider actionContentProvider,    </a>
<span class="sourceLineNo">256</span><a id="line.256">                        PageContentProvider pageContentProvider,</a>
<span class="sourceLineNo">257</span><a id="line.257">                        ProgressMonitor progressMonitor) throws Exception {</a>
<span class="sourceLineNo">258</span><a id="line.258">                </a>
<span class="sourceLineNo">259</span><a id="line.259">                if (activeAction instanceof Action &amp;&amp; activeAction.eContainmentFeature() != AppPackage.Literals.ACTION__SECTIONS) {</a>
<span class="sourceLineNo">260</span><a id="line.260">                        URI uri = uriResolver.apply(activeAction, baseURI);                             </a>
<span class="sourceLineNo">261</span><a id="line.261">                        if (uri != null &amp;&amp; uri.isRelative()) {</a>
<span class="sourceLineNo">262</span><a id="line.262">                                org.nasdanika.exec.resources.File file = container.getFile(uri.toString());</a>
<span class="sourceLineNo">263</span><a id="line.263">                                if (file != null) {</a>
<span class="sourceLineNo">264</span><a id="line.264">                                        org.nasdanika.html.model.bootstrap.Page bootstrapPage = EcoreUtil.copy(pageTemplate);</a>
<span class="sourceLineNo">265</span><a id="line.265">                                        bootstrapPage.setName(activeAction.getText());</a>
<span class="sourceLineNo">266</span><a id="line.266">                                        if (bootstrapPage.getBody().isEmpty()) {</a>
<span class="sourceLineNo">267</span><a id="line.267">                                                bootstrapPage.getBody().add(AppFactory.eINSTANCE.createPage());</a>
<span class="sourceLineNo">268</span><a id="line.268">                                        }</a>
<span class="sourceLineNo">269</span><a id="line.269">                                        for (EObject be: bootstrapPage.getBody()) {</a>
<span class="sourceLineNo">270</span><a id="line.270">                                                if (be instanceof org.nasdanika.html.model.app.Page) {</a>
<span class="sourceLineNo">271</span><a id="line.271">                                                        buildAppPage(root, principal, (Action) activeAction, actionPath, (org.nasdanika.html.model.app.Page) be, uriResolver, actionContentProvider, progressMonitor);                                          </a>
<span class="sourceLineNo">272</span><a id="line.272">                                                }</a>
<span class="sourceLineNo">273</span><a id="line.273">                                        }</a>
<span class="sourceLineNo">274</span><a id="line.274">                                        file.getContents().add(pageContentProvider == null ? bootstrapPage : pageContentProvider.getPageContent(bootstrapPage, baseURI, uriResolver, progressMonitor));</a>
<span class="sourceLineNo">275</span><a id="line.275">                                        </a>
<span class="sourceLineNo">276</span><a id="line.276">                                        if (activeAction instanceof Action) {</a>
<span class="sourceLineNo">277</span><a id="line.277">                                                for (org.nasdanika.exec.resources.Resource res: ((Action) activeAction).getResources()) {</a>
<span class="sourceLineNo">278</span><a id="line.278">                                                        ((Container) file.eContainer()).getContents().add(EcoreUtil.copy(res));                                 </a>
<span class="sourceLineNo">279</span><a id="line.279">                                                }</a>
<span class="sourceLineNo">280</span><a id="line.280">                                        }</a>
<span class="sourceLineNo">281</span><a id="line.281">                                }</a>
<span class="sourceLineNo">282</span><a id="line.282">                        }</a>
<span class="sourceLineNo">283</span><a id="line.283">                }</a>
<span class="sourceLineNo">284</span><a id="line.284">                </a>
<span class="sourceLineNo">285</span><a id="line.285">                List&lt;Label&gt; subActionPath = new ArrayList&lt;&gt;(actionPath);</a>
<span class="sourceLineNo">286</span><a id="line.286">                if (activeAction != root &amp;&amp; activeAction != principal) {</a>
<span class="sourceLineNo">287</span><a id="line.287">                        subActionPath.add(activeAction);</a>
<span class="sourceLineNo">288</span><a id="line.288">                }</a>
<span class="sourceLineNo">289</span><a id="line.289">                </a>
<span class="sourceLineNo">290</span><a id="line.290">                for (EObject child: org.nasdanika.html.model.app.util.Util.resolveActionReferences(activeAction.getChildren())) {</a>
<span class="sourceLineNo">291</span><a id="line.291">                        if (child instanceof Action) {</a>
<span class="sourceLineNo">292</span><a id="line.292">                                generateSite(root, principal, (Action) child, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</a>
<span class="sourceLineNo">293</span><a id="line.293">                        }</a>
<span class="sourceLineNo">294</span><a id="line.294">                }</a>
<span class="sourceLineNo">295</span><a id="line.295">                                </a>
<span class="sourceLineNo">296</span><a id="line.296">                if (activeAction instanceof Action) {</a>
<span class="sourceLineNo">297</span><a id="line.297">                        Action theActiveAction = (Action) activeAction;</a>
<span class="sourceLineNo">298</span><a id="line.298">                        for (Action section: theActiveAction.getSections()) {</a>
<span class="sourceLineNo">299</span><a id="line.299">                                generateSite(root, principal, (Action) section, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</a>
<span class="sourceLineNo">300</span><a id="line.300">                        }</a>
<span class="sourceLineNo">301</span><a id="line.301">                        </a>
<span class="sourceLineNo">302</span><a id="line.302">                        for (EObject navigation: org.nasdanika.html.model.app.util.Util.resolveActionReferences(theActiveAction.getNavigation())) {</a>
<span class="sourceLineNo">303</span><a id="line.303">                                if (navigation instanceof Action) {</a>
<span class="sourceLineNo">304</span><a id="line.304">                                        generateSite(root, principal, (Action) navigation, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</a>
<span class="sourceLineNo">305</span><a id="line.305">                                }</a>
<span class="sourceLineNo">306</span><a id="line.306">                        }</a>
<span class="sourceLineNo">307</span><a id="line.307">                        </a>
<span class="sourceLineNo">308</span><a id="line.308">                        for (Action anonymous: theActiveAction.getAnonymous()) {</a>
<span class="sourceLineNo">309</span><a id="line.309">                                generateSite(root, principal, anonymous, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</a>
<span class="sourceLineNo">310</span><a id="line.310">                        }</a>
<span class="sourceLineNo">311</span><a id="line.311">                        </a>
<span class="sourceLineNo">312</span><a id="line.312">                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getFloatLeftNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</a>
<span class="sourceLineNo">313</span><a id="line.313">                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getFloatRightNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</a>
<span class="sourceLineNo">314</span><a id="line.314">                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getLeftNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</a>
<span class="sourceLineNo">315</span><a id="line.315">                        generateNavigationPanel(root, principal, actionPath, theActiveAction.getRightNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</a>
<span class="sourceLineNo">316</span><a id="line.316">                }</a>
<span class="sourceLineNo">317</span><a id="line.317">        }</a>
<span class="sourceLineNo">318</span><a id="line.318">        </a>
<span class="sourceLineNo">319</span><a id="line.319">        private static void buildAppPage(</a>
<span class="sourceLineNo">320</span><a id="line.320">                        Label root, </a>
<span class="sourceLineNo">321</span><a id="line.321">                        Label principal, </a>
<span class="sourceLineNo">322</span><a id="line.322">                        Action activeAction, </a>
<span class="sourceLineNo">323</span><a id="line.323">                        List&lt;Label&gt; actionPath,</a>
<span class="sourceLineNo">324</span><a id="line.324">                        org.nasdanika.html.model.app.Page appPage,</a>
<span class="sourceLineNo">325</span><a id="line.325">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">326</span><a id="line.326">                        ActionContentProvider contentProvider,                  </a>
<span class="sourceLineNo">327</span><a id="line.327">                        ProgressMonitor progressMonitor) throws Exception {</a>
<span class="sourceLineNo">328</span><a id="line.328">                </a>
<span class="sourceLineNo">329</span><a id="line.329">                if (root != null) {</a>
<span class="sourceLineNo">330</span><a id="line.330">                        Label title = createLabel(root, activeAction, uriResolver, null, "header/title", false, false);</a>
<span class="sourceLineNo">331</span><a id="line.331">                        EList&lt;EObject&gt; rootChildren = root.getChildren();</a>
<span class="sourceLineNo">332</span><a id="line.332">                        if (title != null || rootChildren.size() &gt; 1) {</a>
<span class="sourceLineNo">333</span><a id="line.333">                                // Header</a>
<span class="sourceLineNo">334</span><a id="line.334">                                Header header = appPage.getHeader();</a>
<span class="sourceLineNo">335</span><a id="line.335">                                if (header == null) {</a>
<span class="sourceLineNo">336</span><a id="line.336">                                        header = AppFactory.eINSTANCE.createHeader();</a>
<span class="sourceLineNo">337</span><a id="line.337">                                        appPage.setHeader(header);</a>
<span class="sourceLineNo">338</span><a id="line.338">                                }</a>
<span class="sourceLineNo">339</span><a id="line.339">                                if (title != null) {</a>
<span class="sourceLineNo">340</span><a id="line.340">                                        header.setTitle(title);</a>
<span class="sourceLineNo">341</span><a id="line.341">                                }</a>
<span class="sourceLineNo">342</span><a id="line.342">                                List&lt;EObject&gt; headerItems = header.getItems();</a>
<span class="sourceLineNo">343</span><a id="line.343">                                rootChildren.listIterator(1).forEachRemaining(rac -&gt; {</a>
<span class="sourceLineNo">344</span><a id="line.344">                                        if (rac instanceof Action) {</a>
<span class="sourceLineNo">345</span><a id="line.345">                                                headerItems.add(createLabel((Action) rac, activeAction, uriResolver, null, "header/navigation", true, false));</a>
<span class="sourceLineNo">346</span><a id="line.346">                                        } else {</a>
<span class="sourceLineNo">347</span><a id="line.347">                                                headerItems.add(EcoreUtil.copy(rac));</a>
<span class="sourceLineNo">348</span><a id="line.348">                                        }</a>
<span class="sourceLineNo">349</span><a id="line.349">                                });</a>
<span class="sourceLineNo">350</span><a id="line.350">                        }</a>
<span class="sourceLineNo">351</span><a id="line.351">                        </a>
<span class="sourceLineNo">352</span><a id="line.352">                        if (root instanceof Action) {</a>
<span class="sourceLineNo">353</span><a id="line.353">                                List&lt;EObject&gt; rootNavigation = org.nasdanika.html.model.app.util.Util.resolveActionReferences(((Action) root).getNavigation());</a>
<span class="sourceLineNo">354</span><a id="line.354">                                if (!rootNavigation.isEmpty()) {</a>
<span class="sourceLineNo">355</span><a id="line.355">                                        Footer footer = appPage.getFooter();</a>
<span class="sourceLineNo">356</span><a id="line.356">                                        if (footer == null) {</a>
<span class="sourceLineNo">357</span><a id="line.357">                                                footer = AppFactory.eINSTANCE.createFooter();</a>
<span class="sourceLineNo">358</span><a id="line.358">                                                appPage.setFooter(footer);</a>
<span class="sourceLineNo">359</span><a id="line.359">                                        }</a>
<span class="sourceLineNo">360</span><a id="line.360">                                        EList&lt;EObject&gt; footerItems = footer.getItems();</a>
<span class="sourceLineNo">361</span><a id="line.361">                                        rootNavigation.forEach(ran -&gt; {</a>
<span class="sourceLineNo">362</span><a id="line.362">                                                if (ran instanceof Action) {</a>
<span class="sourceLineNo">363</span><a id="line.363">                                                        footerItems.add(createLabel((Action) ran, activeAction, uriResolver, null, "footer/navigation", true, false));</a>
<span class="sourceLineNo">364</span><a id="line.364">                                                } else {</a>
<span class="sourceLineNo">365</span><a id="line.365">                                                        footerItems.add(EcoreUtil.copy(ran));</a>
<span class="sourceLineNo">366</span><a id="line.366">                                                }</a>
<span class="sourceLineNo">367</span><a id="line.367">                                        });</a>
<span class="sourceLineNo">368</span><a id="line.368">                                        </a>
<span class="sourceLineNo">369</span><a id="line.369">                                }</a>
<span class="sourceLineNo">370</span><a id="line.370">                        }</a>
<span class="sourceLineNo">371</span><a id="line.371">                }</a>
<span class="sourceLineNo">372</span><a id="line.372">                </a>
<span class="sourceLineNo">373</span><a id="line.373">                if (principal != null) {</a>
<span class="sourceLineNo">374</span><a id="line.374">                        // Navbar </a>
<span class="sourceLineNo">375</span><a id="line.375">                        Label brand = createLabel(principal, activeAction, uriResolver, null, "navbar/brand", false, false);</a>
<span class="sourceLineNo">376</span><a id="line.376">                        if (principal instanceof Action) {</a>
<span class="sourceLineNo">377</span><a id="line.377">                                List&lt;EObject&gt; principalNavigation = org.nasdanika.html.model.app.util.Util.resolveActionReferences(((Action) principal).getNavigation());</a>
<span class="sourceLineNo">378</span><a id="line.378">                                if (brand != null || !principalNavigation.isEmpty()) {</a>
<span class="sourceLineNo">379</span><a id="line.379">                                        NavigationBar navBar = appPage.getNavigationBar();</a>
<span class="sourceLineNo">380</span><a id="line.380">                                        if (navBar == null) {</a>
<span class="sourceLineNo">381</span><a id="line.381">                                                navBar = AppFactory.eINSTANCE.createNavigationBar();</a>
<span class="sourceLineNo">382</span><a id="line.382">                                                appPage.setNavigationBar(navBar);</a>
<span class="sourceLineNo">383</span><a id="line.383">                                        }</a>
<span class="sourceLineNo">384</span><a id="line.384">                                        if (brand != null) {</a>
<span class="sourceLineNo">385</span><a id="line.385">                                                navBar.setBrand(brand);</a>
<span class="sourceLineNo">386</span><a id="line.386">                                        }</a>
<span class="sourceLineNo">387</span><a id="line.387">                                        EList&lt;EObject&gt; navBarItems = navBar.getItems();</a>
<span class="sourceLineNo">388</span><a id="line.388">                                        principalNavigation.forEach(principalNavigationElement -&gt; {</a>
<span class="sourceLineNo">389</span><a id="line.389">                                                if (principalNavigationElement instanceof Action) {</a>
<span class="sourceLineNo">390</span><a id="line.390">                                                        navBarItems.add(createLabel((Action) principalNavigationElement, activeAction, uriResolver, null, "navbar/item", true, false));</a>
<span class="sourceLineNo">391</span><a id="line.391">                                                } else {</a>
<span class="sourceLineNo">392</span><a id="line.392">                                                        navBarItems.add(EcoreUtil.copy(principalNavigationElement));</a>
<span class="sourceLineNo">393</span><a id="line.393">                                                }</a>
<span class="sourceLineNo">394</span><a id="line.394">                                        });</a>
<span class="sourceLineNo">395</span><a id="line.395">                                }</a>
<span class="sourceLineNo">396</span><a id="line.396">                        }</a>
<span class="sourceLineNo">397</span><a id="line.397">                        </a>
<span class="sourceLineNo">398</span><a id="line.398">                        // Navigation panel</a>
<span class="sourceLineNo">399</span><a id="line.399">                        List&lt;EObject&gt; principalChildren = org.nasdanika.html.model.app.util.Util.resolveActionReferences(principal.getChildren());</a>
<span class="sourceLineNo">400</span><a id="line.400">                        if (!principalChildren.isEmpty()) {</a>
<span class="sourceLineNo">401</span><a id="line.401">                                NavigationPanel navPanel = appPage.getNavigationPanel();</a>
<span class="sourceLineNo">402</span><a id="line.402">                                if (navPanel == null) {</a>
<span class="sourceLineNo">403</span><a id="line.403">                                        navPanel = AppFactory.eINSTANCE.createNavigationPanel();</a>
<span class="sourceLineNo">404</span><a id="line.404">                                        appPage.setNavigationPanel(navPanel);</a>
<span class="sourceLineNo">405</span><a id="line.405">                                }</a>
<span class="sourceLineNo">406</span><a id="line.406">                                if (isBlank(navPanel.getId())) {</a>
<span class="sourceLineNo">407</span><a id="line.407">                                        navPanel.setId(principal.getId() + "-navigation-panel");</a>
<span class="sourceLineNo">408</span><a id="line.408">                                }</a>
<span class="sourceLineNo">409</span><a id="line.409">                                Function&lt;Label, String&gt; navItemIdProvider = na -&gt; isBlank(na.getId()) ? null : "nsd-app-nav-item-" + na.getId();</a>
<span class="sourceLineNo">410</span><a id="line.410">                                List&lt;EObject&gt; navPanelItems = navPanel.getItems();</a>
<span class="sourceLineNo">411</span><a id="line.411">                                principalChildren.forEach(principalChild -&gt; {</a>
<span class="sourceLineNo">412</span><a id="line.412">                                        if (principalChild instanceof Label) {</a>
<span class="sourceLineNo">413</span><a id="line.413">                                                navPanelItems.add(createLabel((Label) principalChild, activeAction, uriResolver, navItemIdProvider, "nav-panel", true, true));</a>
<span class="sourceLineNo">414</span><a id="line.414">                                        } else {</a>
<span class="sourceLineNo">415</span><a id="line.415">                                                navPanelItems.add(EcoreUtil.copy(principalChild));</a>
<span class="sourceLineNo">416</span><a id="line.416">                                        }</a>
<span class="sourceLineNo">417</span><a id="line.417">                                });</a>
<span class="sourceLineNo">418</span><a id="line.418">                                </a>
<span class="sourceLineNo">419</span><a id="line.419">                        }</a>
<span class="sourceLineNo">420</span><a id="line.420">                }</a>
<span class="sourceLineNo">421</span><a id="line.421">                </a>
<span class="sourceLineNo">422</span><a id="line.422">                // Content panel</a>
<span class="sourceLineNo">423</span><a id="line.423">                ContentPanel contentPanel = appPage.getContentPanel();</a>
<span class="sourceLineNo">424</span><a id="line.424">                if (contentPanel == null) {</a>
<span class="sourceLineNo">425</span><a id="line.425">                        contentPanel = AppFactory.eINSTANCE.createContentPanel();</a>
<span class="sourceLineNo">426</span><a id="line.426">                        appPage.setContentPanel(contentPanel);</a>
<span class="sourceLineNo">427</span><a id="line.427">                }</a>
<span class="sourceLineNo">428</span><a id="line.428">                if  (activeAction != null) {</a>
<span class="sourceLineNo">429</span><a id="line.429">                        String activeActionUUID = activeAction.getUuid();</a>
<span class="sourceLineNo">430</span><a id="line.430">                        if (!org.nasdanika.common.Util.isBlank(activeActionUUID)) {</a>
<span class="sourceLineNo">431</span><a id="line.431">                                Text text = ContentFactory.eINSTANCE.createText();</a>
<span class="sourceLineNo">432</span><a id="line.432">                                text.setContent(activeActionUUID);</a>
<span class="sourceLineNo">433</span><a id="line.433">                                contentPanel.getAttributes().put(DATA_NSD_ACTION_UUID_ATTRIBUTE, text);</a>
<span class="sourceLineNo">434</span><a id="line.434">                        }</a>
<span class="sourceLineNo">435</span><a id="line.435">                }</a>
<span class="sourceLineNo">436</span><a id="line.436">                </a>
<span class="sourceLineNo">437</span><a id="line.437">                buildContentPanel(activeAction, actionPath, activeAction == root || activeAction == principal, contentPanel, uriResolver, contentProvider, progressMonitor);    </a>
<span class="sourceLineNo">438</span><a id="line.438">        }</a>
<span class="sourceLineNo">439</span><a id="line.439">        </a>
<span class="sourceLineNo">440</span><a id="line.440">        private static void buildContentPanel(</a>
<span class="sourceLineNo">441</span><a id="line.441">                        Action action, </a>
<span class="sourceLineNo">442</span><a id="line.442">                        List&lt;Label&gt; path,</a>
<span class="sourceLineNo">443</span><a id="line.443">                        boolean rootOrPrincipal,</a>
<span class="sourceLineNo">444</span><a id="line.444">                        ContentPanel contentPanel,</a>
<span class="sourceLineNo">445</span><a id="line.445">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">446</span><a id="line.446">                        ActionContentProvider contentProvider,</a>
<span class="sourceLineNo">447</span><a id="line.447">                        ProgressMonitor progressMonitor) throws Exception {</a>
<span class="sourceLineNo">448</span><a id="line.448">                </a>
<span class="sourceLineNo">449</span><a id="line.449">                if (!rootOrPrincipal) {</a>
<span class="sourceLineNo">450</span><a id="line.450">                        if (path != null &amp;&amp; !path.isEmpty()) {</a>
<span class="sourceLineNo">451</span><a id="line.451">                                EList&lt;Label&gt; breadcrumb = contentPanel.getBreadcrumb();</a>
<span class="sourceLineNo">452</span><a id="line.452">                                path.forEach(pathElement -&gt; {</a>
<span class="sourceLineNo">453</span><a id="line.453">                                        Label element = createLabel(pathElement, action, uriResolver, null, "content-panel/breadcrumb", false, false);</a>
<span class="sourceLineNo">454</span><a id="line.454">                                        if (element != null) {</a>
<span class="sourceLineNo">455</span><a id="line.455">                                                breadcrumb.add(element);</a>
<span class="sourceLineNo">456</span><a id="line.456">                                        }</a>
<span class="sourceLineNo">457</span><a id="line.457">                                });</a>
<span class="sourceLineNo">458</span><a id="line.458">                                Label tail = createLabel(action, action, uriResolver, null, "content-panel/breadcrumb", false, false);          </a>
<span class="sourceLineNo">459</span><a id="line.459">                                tail.setActive(true);</a>
<span class="sourceLineNo">460</span><a id="line.460">                                breadcrumb.add(tail);</a>
<span class="sourceLineNo">461</span><a id="line.461">                        }</a>
<span class="sourceLineNo">462</span><a id="line.462">        </a>
<span class="sourceLineNo">463</span><a id="line.463">                        if (!isBlank(action.getText()) || !isBlank(action.getIcon())) {</a>
<span class="sourceLineNo">464</span><a id="line.464">                                Label title = org.nasdanika.common.Util.isBlank(action.getName()) ? AppFactory.eINSTANCE.createLabel() : AppFactory.eINSTANCE.createLink(); </a>
<span class="sourceLineNo">465</span><a id="line.465">                                configureLabel(action, action, uriResolver, null, "content-panel/title", title, false, false);</a>
<span class="sourceLineNo">466</span><a id="line.466">                                contentPanel.setTitle(title);</a>
<span class="sourceLineNo">467</span><a id="line.467">                        }</a>
<span class="sourceLineNo">468</span><a id="line.468">                                        </a>
<span class="sourceLineNo">469</span><a id="line.469">                        List&lt;EObject&gt; navigation = org.nasdanika.html.model.app.util.Util.resolveActionReferences(action.getNavigation());</a>
<span class="sourceLineNo">470</span><a id="line.470">                        EList&lt;EObject&gt; navigationItems = contentPanel.getItems();</a>
<span class="sourceLineNo">471</span><a id="line.471">                        navigation.forEach(navigationElement -&gt; {</a>
<span class="sourceLineNo">472</span><a id="line.472">                                if (navigationElement instanceof Label) {</a>
<span class="sourceLineNo">473</span><a id="line.473">                                        navigationItems.add(createLabel((Label) navigationElement, action, uriResolver, null, "content-panel/navigation-item", true, false));</a>
<span class="sourceLineNo">474</span><a id="line.474">                                } else {</a>
<span class="sourceLineNo">475</span><a id="line.475">                                        navigationItems.add(EcoreUtil.copy(navigationElement));</a>
<span class="sourceLineNo">476</span><a id="line.476">                                }</a>
<span class="sourceLineNo">477</span><a id="line.477">                        });</a>
<span class="sourceLineNo">478</span><a id="line.478">                }</a>
<span class="sourceLineNo">479</span><a id="line.479">                </a>
<span class="sourceLineNo">480</span><a id="line.480">                int sectionColumns = action.getSectionColumns();</a>
<span class="sourceLineNo">481</span><a id="line.481">                if (sectionColumns &gt; 0) {</a>
<span class="sourceLineNo">482</span><a id="line.482">                        contentPanel.setSectionColumns(sectionColumns);</a>
<span class="sourceLineNo">483</span><a id="line.483">                }</a>
<span class="sourceLineNo">484</span><a id="line.484">                SectionStyle sectionStyle = action.getSectionStyle();</a>
<span class="sourceLineNo">485</span><a id="line.485">                if (sectionStyle != null) {</a>
<span class="sourceLineNo">486</span><a id="line.486">                        contentPanel.setSectionStyle(sectionStyle);</a>
<span class="sourceLineNo">487</span><a id="line.487">                }</a>
<span class="sourceLineNo">488</span><a id="line.488">                </a>
<span class="sourceLineNo">489</span><a id="line.489">                EList&lt;ContentPanel&gt; cpSections = contentPanel.getSections();</a>
<span class="sourceLineNo">490</span><a id="line.490">                for (Action section: action.getSections()) {</a>
<span class="sourceLineNo">491</span><a id="line.491">                        ContentPanel sectionPanel = AppFactory.eINSTANCE.createContentPanel();</a>
<span class="sourceLineNo">492</span><a id="line.492">                        cpSections.add(sectionPanel);</a>
<span class="sourceLineNo">493</span><a id="line.493">                        buildContentPanel(section, null, false, sectionPanel, uriResolver, contentProvider, progressMonitor);</a>
<span class="sourceLineNo">494</span><a id="line.494">                }</a>
<span class="sourceLineNo">495</span><a id="line.495"></a>
<span class="sourceLineNo">496</span><a id="line.496">                contentPanel.setFloatLeftNavigation(createNavigationPanel(action.getFloatLeftNavigation()));</a>
<span class="sourceLineNo">497</span><a id="line.497">                contentPanel.setFloatRightNavigation(createNavigationPanel(action.getFloatRightNavigation()));</a>
<span class="sourceLineNo">498</span><a id="line.498">                contentPanel.setLeftNavigation(createNavigationPanel(action.getLeftNavigation()));              </a>
<span class="sourceLineNo">499</span><a id="line.499">                contentPanel.setRightNavigation(createNavigationPanel(action.getRightNavigation()));</a>
<span class="sourceLineNo">500</span><a id="line.500">                </a>
<span class="sourceLineNo">501</span><a id="line.501">                contentPanel.getContent().addAll(contentProvider == null ? EcoreUtil.copyAll(action.getContent()) : contentProvider.getActionContent(action, uriResolver, progressMonitor));</a>
<span class="sourceLineNo">502</span><a id="line.502">        }</a>
<span class="sourceLineNo">503</span><a id="line.503">        </a>
<span class="sourceLineNo">504</span><a id="line.504">        /**</a>
<span class="sourceLineNo">505</span><a id="line.505">         * Creates a copy of a panel if not null and replaces action references with links.</a>
<span class="sourceLineNo">506</span><a id="line.506">         * @param panel</a>
<span class="sourceLineNo">507</span><a id="line.507">         * @return</a>
<span class="sourceLineNo">508</span><a id="line.508">         */</a>
<span class="sourceLineNo">509</span><a id="line.509">        private static NavigationPanel createNavigationPanel(NavigationPanel panel) {</a>
<span class="sourceLineNo">510</span><a id="line.510">                if (panel == null) {</a>
<span class="sourceLineNo">511</span><a id="line.511">                        return null;</a>
<span class="sourceLineNo">512</span><a id="line.512">                }</a>
<span class="sourceLineNo">513</span><a id="line.513">                NavigationPanel ret = EcoreUtil.copy(panel);</a>
<span class="sourceLineNo">514</span><a id="line.514">                ListIterator&lt;EObject&gt; iit = ret.getItems().listIterator();</a>
<span class="sourceLineNo">515</span><a id="line.515">                while (iit.hasNext()) {</a>
<span class="sourceLineNo">516</span><a id="line.516">                        EObject next = iit.next();</a>
<span class="sourceLineNo">517</span><a id="line.517">                        if (next instanceof ActionReference) {</a>
<span class="sourceLineNo">518</span><a id="line.518">                                iit.set(EcoreUtil.copy(((ActionReference) next).getTarget()));</a>
<span class="sourceLineNo">519</span><a id="line.519">                        }</a>
<span class="sourceLineNo">520</span><a id="line.520">                }</a>
<span class="sourceLineNo">521</span><a id="line.521">                return ret;</a>
<span class="sourceLineNo">522</span><a id="line.522">        }</a>
<span class="sourceLineNo">523</span><a id="line.523"></a>
<span class="sourceLineNo">524</span><a id="line.524">        private static boolean isLink(Label label, URI uri) {</a>
<span class="sourceLineNo">525</span><a id="line.525">                if (uri != null) {</a>
<span class="sourceLineNo">526</span><a id="line.526">                        return true;</a>
<span class="sourceLineNo">527</span><a id="line.527">                }</a>
<span class="sourceLineNo">528</span><a id="line.528">                </a>
<span class="sourceLineNo">529</span><a id="line.529">                if (label instanceof Link) {</a>
<span class="sourceLineNo">530</span><a id="line.530">                        Link link = (Link) label;</a>
<span class="sourceLineNo">531</span><a id="line.531">                        return !isBlank(link.getScript()) || link.getModal() != null || !isBlank(link.getName());</a>
<span class="sourceLineNo">532</span><a id="line.532">                }</a>
<span class="sourceLineNo">533</span><a id="line.533">                </a>
<span class="sourceLineNo">534</span><a id="line.534">                return false;</a>
<span class="sourceLineNo">535</span><a id="line.535">        }</a>
<span class="sourceLineNo">536</span><a id="line.536">        </a>
<span class="sourceLineNo">537</span><a id="line.537">        /**</a>
<span class="sourceLineNo">538</span><a id="line.538">         * @param action</a>
<span class="sourceLineNo">539</span><a id="line.539">         * @param activeAction</a>
<span class="sourceLineNo">540</span><a id="line.540">         * @return true if this action is active or one of its anonymous or navigation descendants is active.</a>
<span class="sourceLineNo">541</span><a id="line.541">         */</a>
<span class="sourceLineNo">542</span><a id="line.542">        private static boolean isActiveAction(Action action, Label activeAction, boolean inspectChildren) {</a>
<span class="sourceLineNo">543</span><a id="line.543">                if (action == activeAction) {</a>
<span class="sourceLineNo">544</span><a id="line.544">                        return true;</a>
<span class="sourceLineNo">545</span><a id="line.545">                }</a>
<span class="sourceLineNo">546</span><a id="line.546">                </a>
<span class="sourceLineNo">547</span><a id="line.547">                for (Action ac: action.getAnonymous()) {</a>
<span class="sourceLineNo">548</span><a id="line.548">                        if (isActiveAction(ac, activeAction, inspectChildren)) {</a>
<span class="sourceLineNo">549</span><a id="line.549">                                return true;</a>
<span class="sourceLineNo">550</span><a id="line.550">                        }</a>
<span class="sourceLineNo">551</span><a id="line.551">                }</a>
<span class="sourceLineNo">552</span><a id="line.552">                </a>
<span class="sourceLineNo">553</span><a id="line.553">                for (Action ac: action.getSections()) {</a>
<span class="sourceLineNo">554</span><a id="line.554">                        if (isActiveAction(ac, activeAction, inspectChildren)) {</a>
<span class="sourceLineNo">555</span><a id="line.555">                                return true;</a>
<span class="sourceLineNo">556</span><a id="line.556">                        }</a>
<span class="sourceLineNo">557</span><a id="line.557">                }               </a>
<span class="sourceLineNo">558</span><a id="line.558">                </a>
<span class="sourceLineNo">559</span><a id="line.559">                for (EObject nc: action.getNavigation()) {</a>
<span class="sourceLineNo">560</span><a id="line.560">                        if (nc instanceof Action &amp;&amp; isActiveAction((Action) nc, activeAction, inspectChildren)) {</a>
<span class="sourceLineNo">561</span><a id="line.561">                                return true;</a>
<span class="sourceLineNo">562</span><a id="line.562">                        }</a>
<span class="sourceLineNo">563</span><a id="line.563">                }</a>
<span class="sourceLineNo">564</span><a id="line.564">                </a>
<span class="sourceLineNo">565</span><a id="line.565">                if (inspectChildren) {</a>
<span class="sourceLineNo">566</span><a id="line.566">                        for (EObject child: action.getChildren()) {</a>
<span class="sourceLineNo">567</span><a id="line.567">                                if (child instanceof Action &amp;&amp; isActiveAction((Action) child, activeAction, inspectChildren)) {</a>
<span class="sourceLineNo">568</span><a id="line.568">                                        return true;</a>
<span class="sourceLineNo">569</span><a id="line.569">                                }</a>
<span class="sourceLineNo">570</span><a id="line.570">                        }</a>
<span class="sourceLineNo">571</span><a id="line.571">                }</a>
<span class="sourceLineNo">572</span><a id="line.572">                </a>
<span class="sourceLineNo">573</span><a id="line.573">                return false;</a>
<span class="sourceLineNo">574</span><a id="line.574">        }</a>
<span class="sourceLineNo">575</span><a id="line.575">        </a>
<span class="sourceLineNo">576</span><a id="line.576">        private static void configureLabel(</a>
<span class="sourceLineNo">577</span><a id="line.577">                        Label source, </a>
<span class="sourceLineNo">578</span><a id="line.578">                        Label activeAction, </a>
<span class="sourceLineNo">579</span><a id="line.579">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">580</span><a id="line.580">                        Function&lt;Label, String&gt; idProvider, </a>
<span class="sourceLineNo">581</span><a id="line.581">                        String appearancePath, </a>
<span class="sourceLineNo">582</span><a id="line.582">                        Label label, </a>
<span class="sourceLineNo">583</span><a id="line.583">                        boolean recursive,</a>
<span class="sourceLineNo">584</span><a id="line.584">                        boolean inNavPanel) {</a>
<span class="sourceLineNo">585</span><a id="line.585">                Appearance aa = source.getAppearance();</a>
<span class="sourceLineNo">586</span><a id="line.586">                if (aa != null) {</a>
<span class="sourceLineNo">587</span><a id="line.587">                        label.setAppearance(aa.effectiveAppearance(appearancePath));</a>
<span class="sourceLineNo">588</span><a id="line.588">                }</a>
<span class="sourceLineNo">589</span><a id="line.589"></a>
<span class="sourceLineNo">590</span><a id="line.590">                label.setColor(source.getColor());</a>
<span class="sourceLineNo">591</span><a id="line.591">                label.setDescription(source.getDescription());</a>
<span class="sourceLineNo">592</span><a id="line.592">                label.setDisabled(source.isDisabled());</a>
<span class="sourceLineNo">593</span><a id="line.593">                Modal help = source.getHelp();</a>
<span class="sourceLineNo">594</span><a id="line.594">                if (help != null) {</a>
<span class="sourceLineNo">595</span><a id="line.595">//              label.setHelp(value); TODO - make links in help relative.</a>
<span class="sourceLineNo">596</span><a id="line.596">                        throw new UnsupportedOperationException("Help modals not supported yet");</a>
<span class="sourceLineNo">597</span><a id="line.597">                }</a>
<span class="sourceLineNo">598</span><a id="line.598">                label.setIcon(source.getIcon());</a>
<span class="sourceLineNo">599</span><a id="line.599">                if (idProvider != null) {</a>
<span class="sourceLineNo">600</span><a id="line.600">                        label.setId(idProvider.apply(source));</a>
<span class="sourceLineNo">601</span><a id="line.601">                }</a>
<span class="sourceLineNo">602</span><a id="line.602">//              label.setId(action.getId());            </a>
<span class="sourceLineNo">603</span><a id="line.603">                label.setNotification(source.getNotification());</a>
<span class="sourceLineNo">604</span><a id="line.604">                label.setOutline(source.isOutline());</a>
<span class="sourceLineNo">605</span><a id="line.605">                label.setText(source.getText());</a>
<span class="sourceLineNo">606</span><a id="line.606">                label.setTooltip(source.getTooltip());</a>
<span class="sourceLineNo">607</span><a id="line.607"></a>
<span class="sourceLineNo">608</span><a id="line.608">                if (source instanceof Action) {</a>
<span class="sourceLineNo">609</span><a id="line.609">                        String sourceUUID = source.getUuid();</a>
<span class="sourceLineNo">610</span><a id="line.610">                        if (!org.nasdanika.common.Util.isBlank(sourceUUID)) {</a>
<span class="sourceLineNo">611</span><a id="line.611">                                Text text = ContentFactory.eINSTANCE.createText();</a>
<span class="sourceLineNo">612</span><a id="line.612">                                text.setContent(sourceUUID);                    </a>
<span class="sourceLineNo">613</span><a id="line.613">                                label.getAttributes().put(DATA_NSD_ACTION_UUID_ATTRIBUTE, text);</a>
<span class="sourceLineNo">614</span><a id="line.614">                        }</a>
<span class="sourceLineNo">615</span><a id="line.615">                }</a>
<span class="sourceLineNo">616</span><a id="line.616">                </a>
<span class="sourceLineNo">617</span><a id="line.617">                for (Entry&lt;String, EObject&gt; ae: source.getAttributes().entrySet()) {            </a>
<span class="sourceLineNo">618</span><a id="line.618">                        label.getAttributes().put(ae.getKey(), EcoreUtil.copy(ae.getValue()));</a>
<span class="sourceLineNo">619</span><a id="line.619">                }</a>
<span class="sourceLineNo">620</span><a id="line.620">                </a>
<span class="sourceLineNo">621</span><a id="line.621">                if (label instanceof Link) {</a>
<span class="sourceLineNo">622</span><a id="line.622">                        configureLink(source, activeAction, uriResolver, (Link) label);</a>
<span class="sourceLineNo">623</span><a id="line.623">                }</a>
<span class="sourceLineNo">624</span><a id="line.624">                </a>
<span class="sourceLineNo">625</span><a id="line.625">                if (recursive) {</a>
<span class="sourceLineNo">626</span><a id="line.626">                        EList&lt;EObject&gt; labelChildren = label.getChildren();</a>
<span class="sourceLineNo">627</span><a id="line.627">                        for (EObject actionChild: source.getChildren()) {</a>
<span class="sourceLineNo">628</span><a id="line.628">                                if (actionChild instanceof ActionReference) {</a>
<span class="sourceLineNo">629</span><a id="line.629">                                        actionChild = ((ActionReference) actionChild).getTarget();</a>
<span class="sourceLineNo">630</span><a id="line.630">                                }</a>
<span class="sourceLineNo">631</span><a id="line.631">                                if (actionChild instanceof Action) {</a>
<span class="sourceLineNo">632</span><a id="line.632">                                        Action childAction = (Action) actionChild;</a>
<span class="sourceLineNo">633</span><a id="line.633">                                        labelChildren.add(createLabel(childAction, activeAction, uriResolver, idProvider, "header/navigation", recursive, inNavPanel));</a>
<span class="sourceLineNo">634</span><a id="line.634">                                        </a>
<span class="sourceLineNo">635</span><a id="line.635">                                        // Second level - headers, separators.</a>
<span class="sourceLineNo">636</span><a id="line.636">                                } else {</a>
<span class="sourceLineNo">637</span><a id="line.637">                                        labelChildren.add(EcoreUtil.copy(actionChild));</a>
<span class="sourceLineNo">638</span><a id="line.638">                                }                                                       </a>
<span class="sourceLineNo">639</span><a id="line.639">                        }                       </a>
<span class="sourceLineNo">640</span><a id="line.640">                }</a>
<span class="sourceLineNo">641</span><a id="line.641">                </a>
<span class="sourceLineNo">642</span><a id="line.642">                label.setActive(source instanceof Action &amp;&amp; inNavPanel ? isActiveAction((Action) source, activeAction, !hasActiveChildren(label)) : source.isActive());         </a>
<span class="sourceLineNo">643</span><a id="line.643">        }</a>
<span class="sourceLineNo">644</span><a id="line.644">        </a>
<span class="sourceLineNo">645</span><a id="line.645">        private static boolean hasActiveChildren(Label label) {</a>
<span class="sourceLineNo">646</span><a id="line.646">                for (EObject child: label.getChildren()) {</a>
<span class="sourceLineNo">647</span><a id="line.647">                        if (child instanceof Label) {</a>
<span class="sourceLineNo">648</span><a id="line.648">                                Label cl = (Label) child;</a>
<span class="sourceLineNo">649</span><a id="line.649">                                if (cl.isActive() || hasActiveChildren(cl)) {</a>
<span class="sourceLineNo">650</span><a id="line.650">                                        return true;</a>
<span class="sourceLineNo">651</span><a id="line.651">                                }</a>
<span class="sourceLineNo">652</span><a id="line.652">                        }</a>
<span class="sourceLineNo">653</span><a id="line.653">                }</a>
<span class="sourceLineNo">654</span><a id="line.654">                return false;</a>
<span class="sourceLineNo">655</span><a id="line.655">        }</a>
<span class="sourceLineNo">656</span><a id="line.656">        </a>
<span class="sourceLineNo">657</span><a id="line.657">        private static void configureLink(</a>
<span class="sourceLineNo">658</span><a id="line.658">                        Label source, </a>
<span class="sourceLineNo">659</span><a id="line.659">                        Label activeAction, </a>
<span class="sourceLineNo">660</span><a id="line.660">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">661</span><a id="line.661">                        Link target) {</a>
<span class="sourceLineNo">662</span><a id="line.662">                </a>
<span class="sourceLineNo">663</span><a id="line.663">                URI activeActionURI = uriResolver.apply(activeAction, null);</a>
<span class="sourceLineNo">664</span><a id="line.664">                URI uri = uriResolver.apply(source, activeActionURI);</a>
<span class="sourceLineNo">665</span><a id="line.665">                </a>
<span class="sourceLineNo">666</span><a id="line.666">                if (uri != null) {</a>
<span class="sourceLineNo">667</span><a id="line.667">                        target.setLocation(uri.toString());</a>
<span class="sourceLineNo">668</span><a id="line.668">                }</a>
<span class="sourceLineNo">669</span><a id="line.669">                if (source instanceof Link) {</a>
<span class="sourceLineNo">670</span><a id="line.670">                        Link sourceLink = (Link) source;</a>
<span class="sourceLineNo">671</span><a id="line.671">                        target.setConfirmation(sourceLink.getConfirmation());</a>
<span class="sourceLineNo">672</span><a id="line.672">                        if (sourceLink.getModal() != null) {</a>
<span class="sourceLineNo">673</span><a id="line.673">        //              link.setModal(value); TODO - contextualization of links - relativization of URI's. Token expansion with a property computer? something like ${relative-uri/&lt;uri here&gt;}? </a>
<span class="sourceLineNo">674</span><a id="line.674">        //              Support of sub-tokens e.g. ${{relative-uri/${token}}} recognizes ${token} as a sub-token to be expanded to result in ${relative-uri/&lt;token value&gt;}.</a>
<span class="sourceLineNo">675</span><a id="line.675">                                throw new UnsupportedOperationException("Modals are not supported yet");</a>
<span class="sourceLineNo">676</span><a id="line.676">                        }</a>
<span class="sourceLineNo">677</span><a id="line.677">                        target.setName(sourceLink.getName());</a>
<span class="sourceLineNo">678</span><a id="line.678">                        target.setScript(sourceLink.getScript());</a>
<span class="sourceLineNo">679</span><a id="line.679">                        target.setTarget(sourceLink.getTarget());               </a>
<span class="sourceLineNo">680</span><a id="line.680">                }</a>
<span class="sourceLineNo">681</span><a id="line.681">                if (source instanceof Action) {</a>
<span class="sourceLineNo">682</span><a id="line.682">                        Action action = (Action) source;</a>
<span class="sourceLineNo">683</span><a id="line.683">                        if (action.isModalActivator()) {</a>
<span class="sourceLineNo">684</span><a id="line.684">                                throw new UnsupportedOperationException("Modals are not supported yet");</a>
<span class="sourceLineNo">685</span><a id="line.685">                        }</a>
<span class="sourceLineNo">686</span><a id="line.686">                        if (action.isInline()) {</a>
<span class="sourceLineNo">687</span><a id="line.687">                                throw new UnsupportedOperationException("Inline actions are not supported yet");                        </a>
<span class="sourceLineNo">688</span><a id="line.688">                        }</a>
<span class="sourceLineNo">689</span><a id="line.689">                }</a>
<span class="sourceLineNo">690</span><a id="line.690">        }</a>
<span class="sourceLineNo">691</span><a id="line.691">        </a>
<span class="sourceLineNo">692</span><a id="line.692">        /**</a>
<span class="sourceLineNo">693</span><a id="line.693">         * Creates a {@link Link} from {@link Action} with a relative location for locations.</a>
<span class="sourceLineNo">694</span><a id="line.694">         * @param source</a>
<span class="sourceLineNo">695</span><a id="line.695">         * @param uri</a>
<span class="sourceLineNo">696</span><a id="line.696">         * @param active </a>
<span class="sourceLineNo">697</span><a id="line.697">         * @param appearancePath </a>
<span class="sourceLineNo">698</span><a id="line.698">         * @return</a>
<span class="sourceLineNo">699</span><a id="line.699">         */</a>
<span class="sourceLineNo">700</span><a id="line.700">        private static Label createLabel(</a>
<span class="sourceLineNo">701</span><a id="line.701">                        Label source, </a>
<span class="sourceLineNo">702</span><a id="line.702">                        Label activeAction, </a>
<span class="sourceLineNo">703</span><a id="line.703">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">704</span><a id="line.704">                        Function&lt;Label, String&gt; idProvider, </a>
<span class="sourceLineNo">705</span><a id="line.705">                        String appearancePath,</a>
<span class="sourceLineNo">706</span><a id="line.706">                        boolean recursive,</a>
<span class="sourceLineNo">707</span><a id="line.707">                        boolean inNavPanel) {</a>
<span class="sourceLineNo">708</span><a id="line.708">                </a>
<span class="sourceLineNo">709</span><a id="line.709">                URI activeActionURI = uriResolver.apply(activeAction, null);</a>
<span class="sourceLineNo">710</span><a id="line.710">                URI uri = uriResolver.apply(source, activeActionURI);</a>
<span class="sourceLineNo">711</span><a id="line.711">                </a>
<span class="sourceLineNo">712</span><a id="line.712">                if (isBlank(source.getText()) &amp;&amp; isBlank(source.getIcon()) &amp;&amp; !recursive) {</a>
<span class="sourceLineNo">713</span><a id="line.713">                        return null;</a>
<span class="sourceLineNo">714</span><a id="line.714">                }</a>
<span class="sourceLineNo">715</span><a id="line.715">                Label label = isLink(source, uri) ? AppFactory.eINSTANCE.createLink() : AppFactory.eINSTANCE.createLabel();</a>
<span class="sourceLineNo">716</span><a id="line.716">                configureLabel(source, activeAction, uriResolver, idProvider, appearancePath, label, recursive, inNavPanel);</a>
<span class="sourceLineNo">717</span><a id="line.717">                                </a>
<span class="sourceLineNo">718</span><a id="line.718">                return label;</a>
<span class="sourceLineNo">719</span><a id="line.719">        }</a>
<span class="sourceLineNo">720</span><a id="line.720">        </a>
<span class="sourceLineNo">721</span><a id="line.721">        private static void generateNavigationPanel(</a>
<span class="sourceLineNo">722</span><a id="line.722">                        Label root, </a>
<span class="sourceLineNo">723</span><a id="line.723">                        Label principal, </a>
<span class="sourceLineNo">724</span><a id="line.724">                        List&lt;Label&gt; actionPath,</a>
<span class="sourceLineNo">725</span><a id="line.725">                        NavigationPanel navigationPanel,</a>
<span class="sourceLineNo">726</span><a id="line.726">                        org.nasdanika.html.model.bootstrap.Page pageTemplate,</a>
<span class="sourceLineNo">727</span><a id="line.727">                        BiFunction&lt;Label, URI, URI&gt; uriResolver, </a>
<span class="sourceLineNo">728</span><a id="line.728">                        URI baseURI, </a>
<span class="sourceLineNo">729</span><a id="line.729">                        Container container,</a>
<span class="sourceLineNo">730</span><a id="line.730">                        ActionContentProvider actionContentProvider,</a>
<span class="sourceLineNo">731</span><a id="line.731">                        PageContentProvider pageContentProvider,</a>
<span class="sourceLineNo">732</span><a id="line.732">                        ProgressMonitor progressMonitor) throws Exception {</a>
<span class="sourceLineNo">733</span><a id="line.733">                </a>
<span class="sourceLineNo">734</span><a id="line.734">                if (navigationPanel != null) {</a>
<span class="sourceLineNo">735</span><a id="line.735">                        for (EObject item: org.nasdanika.html.model.app.util.Util.resolveActionReferences(navigationPanel.getItems())) {</a>
<span class="sourceLineNo">736</span><a id="line.736">                                if (item instanceof Label) {</a>
<span class="sourceLineNo">737</span><a id="line.737">                                        generateSite(root, principal, (Label) item, actionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</a>
<span class="sourceLineNo">738</span><a id="line.738">                                }</a>
<span class="sourceLineNo">739</span><a id="line.739">                        }                       </a>
<span class="sourceLineNo">740</span><a id="line.740">                }</a>
<span class="sourceLineNo">741</span><a id="line.741">        }</a>
<span class="sourceLineNo">742</span><a id="line.742">        </a>
<span class="sourceLineNo">743</span><a id="line.743">        public static JSONObject createSearchDocument(String path, File file) throws IOException {</a>
<span class="sourceLineNo">744</span><a id="line.744">                return createSearchDocument(path, file, null, null);</a>
<span class="sourceLineNo">745</span><a id="line.745">        }</a>
<span class="sourceLineNo">746</span><a id="line.746">        </a>
<span class="sourceLineNo">747</span><a id="line.747">        /**</a>
<span class="sourceLineNo">748</span><a id="line.748">         * For Nasdanika App pages extracts page title, breadcrumbs and content text into a JSONObject to add to a collector and then</a>
<span class="sourceLineNo">749</span><a id="line.749">         * to use for constructing search indices. </a>
<span class="sourceLineNo">750</span><a id="line.750">         * @param path</a>
<span class="sourceLineNo">751</span><a id="line.751">         * @param file</a>
<span class="sourceLineNo">752</span><a id="line.752">         * @param contentConsumer Consumer of content elements which can be used to analyze page contents, e.g. find dead links. Can be null.  </a>
<span class="sourceLineNo">753</span><a id="line.753">         * @param processor If not null the document is passed to the processor. If the processor returns true that means that the document was manipulated by the processor and shall be saved to the source file.</a>
<span class="sourceLineNo">754</span><a id="line.754">         * @return Search document object for non-empty Nasdanika App pages, null otherwise.</a>
<span class="sourceLineNo">755</span><a id="line.755">         * @throws IOException</a>
<span class="sourceLineNo">756</span><a id="line.756">         */</a>
<span class="sourceLineNo">757</span><a id="line.757">        public static JSONObject createSearchDocument(</a>
<span class="sourceLineNo">758</span><a id="line.758">                        String path, </a>
<span class="sourceLineNo">759</span><a id="line.759">                        File file, </a>
<span class="sourceLineNo">760</span><a id="line.760">                        Consumer&lt;? super Element&gt; contentConsumer, </a>
<span class="sourceLineNo">761</span><a id="line.761">                        BiFunction&lt;String, Document, Boolean&gt; processor) throws IOException {</a>
<span class="sourceLineNo">762</span><a id="line.762">                </a>
<span class="sourceLineNo">763</span><a id="line.763">                Document document = Jsoup.parse(file, "UTF-8");</a>
<span class="sourceLineNo">764</span><a id="line.764">                if (processor != null &amp;&amp; processor.apply(path, document)) {</a>
<span class="sourceLineNo">765</span><a id="line.765">                        Document.OutputSettings outputSettings = new Document.OutputSettings();</a>
<span class="sourceLineNo">766</span><a id="line.766">                        outputSettings.prettyPrint(false);</a>
<span class="sourceLineNo">767</span><a id="line.767">                        document.outputSettings(outputSettings);</a>
<span class="sourceLineNo">768</span><a id="line.768">                        try (Writer writer = new OutputStreamWriter(new FileOutputStream(file), "UTF-8")) {</a>
<span class="sourceLineNo">769</span><a id="line.769">                                writer.write(document.html());</a>
<span class="sourceLineNo">770</span><a id="line.770">                        }</a>
<span class="sourceLineNo">771</span><a id="line.771">                }</a>
<span class="sourceLineNo">772</span><a id="line.772">                Elements contentPanelQuery = document.select("body &gt; div &gt; div.row.nsd-app-content-row &gt; div.col.nsd-app-content-panel");                                                                                                     </a>
<span class="sourceLineNo">773</span><a id="line.773">                if (contentPanelQuery.isEmpty()) {</a>
<span class="sourceLineNo">774</span><a id="line.774">                        return null;</a>
<span class="sourceLineNo">775</span><a id="line.775">                }</a>
<span class="sourceLineNo">776</span><a id="line.776">                Elements contentQuery = contentPanelQuery.select("div &gt; div.row.nsd-app-content-panel-content-row");</a>
<span class="sourceLineNo">777</span><a id="line.777">                if (contentQuery.isEmpty()) {</a>
<span class="sourceLineNo">778</span><a id="line.778">                        return null;</a>
<span class="sourceLineNo">779</span><a id="line.779">                }</a>
<span class="sourceLineNo">780</span><a id="line.780">                if (contentConsumer != null) {</a>
<span class="sourceLineNo">781</span><a id="line.781">                        contentQuery.forEach(contentConsumer);</a>
<span class="sourceLineNo">782</span><a id="line.782">                }</a>
<span class="sourceLineNo">783</span><a id="line.783">                </a>
<span class="sourceLineNo">784</span><a id="line.784">                StringBuilder contentText = new StringBuilder(contentQuery.text());</a>
<span class="sourceLineNo">785</span><a id="line.785">                </a>
<span class="sourceLineNo">786</span><a id="line.786">                // Drawio diagrams labels</a>
<span class="sourceLineNo">787</span><a id="line.787">                for (Element diagramDiv: contentQuery.select("div.mxgraph")) {</a>
<span class="sourceLineNo">788</span><a id="line.788">                        try {</a>
<span class="sourceLineNo">789</span><a id="line.789">                                traverseDrawio(diagramDiv, element -&gt; {</a>
<span class="sourceLineNo">790</span><a id="line.790">                                        if (element instanceof ModelElement) {</a>
<span class="sourceLineNo">791</span><a id="line.791">                                                ModelElement me = (ModelElement) element;</a>
<span class="sourceLineNo">792</span><a id="line.792">                                                String meLabel = me.getLabel();</a>
<span class="sourceLineNo">793</span><a id="line.793">                                                if (!org.nasdanika.common.Util.isBlank(meLabel)) {</a>
<span class="sourceLineNo">794</span><a id="line.794">                                                        String labelText = Jsoup.parse(meLabel).text();</a>
<span class="sourceLineNo">795</span><a id="line.795">                                                        contentText.append(" ").append(labelText);                                                                                      </a>
<span class="sourceLineNo">796</span><a id="line.796">                                                }</a>
<span class="sourceLineNo">797</span><a id="line.797">                                                String meTooltip = me.getTooltip();</a>
<span class="sourceLineNo">798</span><a id="line.798">                                                if (!org.nasdanika.common.Util.isBlank(meTooltip)) {</a>
<span class="sourceLineNo">799</span><a id="line.799">                                                        String tooltipText = Jsoup.parse(meTooltip).text();</a>
<span class="sourceLineNo">800</span><a id="line.800">                                                        contentText.append(" ").append(tooltipText);                                                                                    </a>
<span class="sourceLineNo">801</span><a id="line.801">                                                }</a>
<span class="sourceLineNo">802</span><a id="line.802">                                        }</a>
<span class="sourceLineNo">803</span><a id="line.803">                                }, null);</a>
<span class="sourceLineNo">804</span><a id="line.804">                        } catch (Exception e) {</a>
<span class="sourceLineNo">805</span><a id="line.805">                                throw new NasdanikaException(e);</a>
<span class="sourceLineNo">806</span><a id="line.806">                        }</a>
<span class="sourceLineNo">807</span><a id="line.807">                }</a>
<span class="sourceLineNo">808</span><a id="line.808">                </a>
<span class="sourceLineNo">809</span><a id="line.809">                if (org.nasdanika.common.Util.isBlank(contentText.toString())) {</a>
<span class="sourceLineNo">810</span><a id="line.810">                        return null;</a>
<span class="sourceLineNo">811</span><a id="line.811">                }</a>
<span class="sourceLineNo">812</span><a id="line.812">                </a>
<span class="sourceLineNo">813</span><a id="line.813">                JSONObject searchDocument = new JSONObject();</a>
<span class="sourceLineNo">814</span><a id="line.814">                searchDocument.put("content", StringEscapeUtils.escapeHtml4(contentText.toString()));</a>
<span class="sourceLineNo">815</span><a id="line.815">                Elements titleQuery = contentPanelQuery.select("div &gt; div.row.nsd-app-content-panel-title-and-items-row &gt; div.col-auto &gt; h1");</a>
<span class="sourceLineNo">816</span><a id="line.816">                if (titleQuery.size() == 1) {</a>
<span class="sourceLineNo">817</span><a id="line.817">                        searchDocument.put("title", StringEscapeUtils.escapeHtml4(titleQuery.get(0).text()));</a>
<span class="sourceLineNo">818</span><a id="line.818">                } else {</a>
<span class="sourceLineNo">819</span><a id="line.819">                        searchDocument.put("title", document.title());</a>
<span class="sourceLineNo">820</span><a id="line.820">                }</a>
<span class="sourceLineNo">821</span><a id="line.821">                Elements breadcrumbQuery = contentPanelQuery.select("div &gt; div.row.nsd-app-content-panel-breadcrumb-row &gt; div &gt; nav &gt; ol &gt; li");</a>
<span class="sourceLineNo">822</span><a id="line.822">                if (breadcrumbQuery.size() &gt; 0) {</a>
<span class="sourceLineNo">823</span><a id="line.823">                        searchDocument.put("path", String.join("/", breadcrumbQuery.stream().map(e -&gt; StringEscapeUtils.escapeHtml4(e.text())).collect(Collectors.toList())));</a>
<span class="sourceLineNo">824</span><a id="line.824">                }</a>
<span class="sourceLineNo">825</span><a id="line.825">                for (Element element: contentPanelQuery) {</a>
<span class="sourceLineNo">826</span><a id="line.826">                        String actionUUID = element.attr(DATA_NSD_ACTION_UUID_ATTRIBUTE);</a>
<span class="sourceLineNo">827</span><a id="line.827">                        if (!org.nasdanika.common.Util.isBlank(actionUUID)) {</a>
<span class="sourceLineNo">828</span><a id="line.828">                                searchDocument.put("action-uuid", actionUUID);</a>
<span class="sourceLineNo">829</span><a id="line.829">                                break;</a>
<span class="sourceLineNo">830</span><a id="line.830">                        }</a>
<span class="sourceLineNo">831</span><a id="line.831">                }</a>
<span class="sourceLineNo">832</span><a id="line.832">                </a>
<span class="sourceLineNo">833</span><a id="line.833">                return searchDocument;</a>
<span class="sourceLineNo">834</span><a id="line.834">        }</a>
<span class="sourceLineNo">835</span><a id="line.835">        </a>
<span class="sourceLineNo">836</span><a id="line.836">        /**</a>
<span class="sourceLineNo">837</span><a id="line.837">         * Loads {@link mxGraphModel} from mxgraph div.</a>
<span class="sourceLineNo">838</span><a id="line.838">         * @param mxGraphDiv</a>
<span class="sourceLineNo">839</span><a id="line.839">         * @return</a>
<span class="sourceLineNo">840</span><a id="line.840">         * @throws IOException </a>
<span class="sourceLineNo">841</span><a id="line.841">         * @throws SAXException </a>
<span class="sourceLineNo">842</span><a id="line.842">         * @throws ParserConfigurationException </a>
<span class="sourceLineNo">843</span><a id="line.843">         */</a>
<span class="sourceLineNo">844</span><a id="line.844">        public static org.nasdanika.drawio.Document loadDrawioDocument(Element mxGraphDiv) throws Exception {</a>
<span class="sourceLineNo">845</span><a id="line.845">                String data = mxGraphDiv.attr("data-mxgraph");</a>
<span class="sourceLineNo">846</span><a id="line.846">                if (data != null) {</a>
<span class="sourceLineNo">847</span><a id="line.847">                        JSONObject jsonData = new JSONObject(data);</a>
<span class="sourceLineNo">848</span><a id="line.848">                        Object xml = jsonData.get("xml");</a>
<span class="sourceLineNo">849</span><a id="line.849">                        if (xml instanceof String) {</a>
<span class="sourceLineNo">850</span><a id="line.850">                                return org.nasdanika.drawio.Document.load((String) xml, null);</a>
<span class="sourceLineNo">851</span><a id="line.851">                        }</a>
<span class="sourceLineNo">852</span><a id="line.852">                }</a>
<span class="sourceLineNo">853</span><a id="line.853">                return null;</a>
<span class="sourceLineNo">854</span><a id="line.854">        }</a>
<span class="sourceLineNo">855</span><a id="line.855"></a>
<span class="sourceLineNo">856</span><a id="line.856">        public static void traverseDrawio(Element mxGraphDiv, Consumer&lt;org.nasdanika.drawio.Element&gt; visitor, ConnectionBase connectionBase) throws Exception {</a>
<span class="sourceLineNo">857</span><a id="line.857">                org.nasdanika.drawio.Document document = loadDrawioDocument(mxGraphDiv);</a>
<span class="sourceLineNo">858</span><a id="line.858">                if (document != null) {</a>
<span class="sourceLineNo">859</span><a id="line.859">                        document.accept(visitor, connectionBase);</a>
<span class="sourceLineNo">860</span><a id="line.860">                }               </a>
<span class="sourceLineNo">861</span><a id="line.861">        }</a>
<span class="sourceLineNo">862</span><a id="line.862">                </a>
<span class="sourceLineNo">863</span><a id="line.863">        /**</a>
<span class="sourceLineNo">864</span><a id="line.864">         * Loads document, traverses all elements and then saves and returns the document.</a>
<span class="sourceLineNo">865</span><a id="line.865">         * @param spec</a>
<span class="sourceLineNo">866</span><a id="line.866">         * @param visitor</a>
<span class="sourceLineNo">867</span><a id="line.867">         * @param connectionBase</a>
<span class="sourceLineNo">868</span><a id="line.868">         * @param compress</a>
<span class="sourceLineNo">869</span><a id="line.869">         * @return</a>
<span class="sourceLineNo">870</span><a id="line.870">         */</a>
<span class="sourceLineNo">871</span><a id="line.871">        public static String filterDrawio(</a>
<span class="sourceLineNo">872</span><a id="line.872">                        String spec, </a>
<span class="sourceLineNo">873</span><a id="line.873">                        Consumer&lt;org.nasdanika.drawio.Element&gt; visitor, </a>
<span class="sourceLineNo">874</span><a id="line.874">                        ConnectionBase connectionBase, </a>
<span class="sourceLineNo">875</span><a id="line.875">                        Boolean compress) throws Exception {</a>
<span class="sourceLineNo">876</span><a id="line.876">                </a>
<span class="sourceLineNo">877</span><a id="line.877">                org.nasdanika.drawio.Document document = org.nasdanika.drawio.Document.load(spec, null);</a>
<span class="sourceLineNo">878</span><a id="line.878">                if (document != null) {</a>
<span class="sourceLineNo">879</span><a id="line.879">                        document.accept(visitor, connectionBase);</a>
<span class="sourceLineNo">880</span><a id="line.880">                }       </a>
<span class="sourceLineNo">881</span><a id="line.881">                return document.save(compress);</a>
<span class="sourceLineNo">882</span><a id="line.882">        }</a>
<span class="sourceLineNo">883</span><a id="line.883">        </a>
<span class="sourceLineNo">884</span><a id="line.884">        /**</a>
<span class="sourceLineNo">885</span><a id="line.885">         * Creates an inspector consumer which finds and reports broken links, missing images and elements with nsd-error class.</a>
<span class="sourceLineNo">886</span><a id="line.886">         * @param file</a>
<span class="sourceLineNo">887</span><a id="line.887">         * @param path</a>
<span class="sourceLineNo">888</span><a id="line.888">         * @param siteDir</a>
<span class="sourceLineNo">889</span><a id="line.889">         * @param errorConsumer</a>
<span class="sourceLineNo">890</span><a id="line.890">         * @return</a>
<span class="sourceLineNo">891</span><a id="line.891">         */</a>
<span class="sourceLineNo">892</span><a id="line.892">        public static Consumer&lt;? super Element&gt; createInspector(Predicate&lt;String&gt; linkPredicate, Consumer&lt;String&gt; errorConsumer) {              </a>
<span class="sourceLineNo">893</span><a id="line.893">                return element -&gt; {</a>
<span class="sourceLineNo">894</span><a id="line.894">                        Elements anchors = element.getElementsByTag("a");</a>
<span class="sourceLineNo">895</span><a id="line.895">                        for (Element anchor: anchors) {</a>
<span class="sourceLineNo">896</span><a id="line.896">                                String target = anchor.attr("href");</a>
<span class="sourceLineNo">897</span><a id="line.897">                                if (target != null) {</a>
<span class="sourceLineNo">898</span><a id="line.898">                                        String id = anchor.attr("id");</a>
<span class="sourceLineNo">899</span><a id="line.899">                                        boolean selfReferencing = id != null &amp;&amp; target.equals("#" + id); // Ignoring header tags generated by markdown.</a>
<span class="sourceLineNo">900</span><a id="line.900">                                        if (!selfReferencing &amp;&amp; !linkPredicate.test(target)) {</a>
<span class="sourceLineNo">901</span><a id="line.901">                                                errorConsumer.accept("Broken link: " + anchor);</a>
<span class="sourceLineNo">902</span><a id="line.902">                                        }</a>
<span class="sourceLineNo">903</span><a id="line.903">                                }</a>
<span class="sourceLineNo">904</span><a id="line.904">                        }</a>
<span class="sourceLineNo">905</span><a id="line.905">                        </a>
<span class="sourceLineNo">906</span><a id="line.906">                        // Images</a>
<span class="sourceLineNo">907</span><a id="line.907">                        Elements images = element.getElementsByTag("img");</a>
<span class="sourceLineNo">908</span><a id="line.908">                        for (Element img: images) {</a>
<span class="sourceLineNo">909</span><a id="line.909">                                String src = img.attr("src");</a>
<span class="sourceLineNo">910</span><a id="line.910">                                if (src != null &amp;&amp; !linkPredicate.test(src)) {</a>
<span class="sourceLineNo">911</span><a id="line.911">                                        errorConsumer.accept("Missing image: " + img);</a>
<span class="sourceLineNo">912</span><a id="line.912">                                }</a>
<span class="sourceLineNo">913</span><a id="line.913">                        }</a>
<span class="sourceLineNo">914</span><a id="line.914">                        </a>
<span class="sourceLineNo">915</span><a id="line.915">                        // NSD errors</a>
<span class="sourceLineNo">916</span><a id="line.916">                        Elements errors = element.select("div.nsd-error");</a>
<span class="sourceLineNo">917</span><a id="line.917">                        for (Element error: errors) {</a>
<span class="sourceLineNo">918</span><a id="line.918">                                errorConsumer.accept("Error: " + error.text());</a>
<span class="sourceLineNo">919</span><a id="line.919">                        }</a>
<span class="sourceLineNo">920</span><a id="line.920">                        </a>
<span class="sourceLineNo">921</span><a id="line.921">                        // Image maps</a>
<span class="sourceLineNo">922</span><a id="line.922">                        for (Element area: element.select("area")) {</a>
<span class="sourceLineNo">923</span><a id="line.923">                                String target = area.attr("href");</a>
<span class="sourceLineNo">924</span><a id="line.924">                                if (target != null &amp;&amp; !linkPredicate.test(target)) {</a>
<span class="sourceLineNo">925</span><a id="line.925">                                        errorConsumer.accept("Broken link: " + area);                                   </a>
<span class="sourceLineNo">926</span><a id="line.926">                                }</a>
<span class="sourceLineNo">927</span><a id="line.927">                        }</a>
<span class="sourceLineNo">928</span><a id="line.928">                        </a>
<span class="sourceLineNo">929</span><a id="line.929">                        // Drawio diagrams</a>
<span class="sourceLineNo">930</span><a id="line.930">                        for (Element diagramDiv: element.select("div.mxgraph")) {</a>
<span class="sourceLineNo">931</span><a id="line.931">                                try {</a>
<span class="sourceLineNo">932</span><a id="line.932">                                        traverseDrawio(diagramDiv, docElement -&gt; {</a>
<span class="sourceLineNo">933</span><a id="line.933">                                                if (docElement instanceof org.nasdanika.drawio.ModelElement) {</a>
<span class="sourceLineNo">934</span><a id="line.934">                                                        org.nasdanika.drawio.ModelElement modelElement = (org.nasdanika.drawio.ModelElement) docElement;</a>
<span class="sourceLineNo">935</span><a id="line.935">                                                        String link = modelElement.getLink();</a>
<span class="sourceLineNo">936</span><a id="line.936">                                                        if (!org.nasdanika.common.Util.isBlank(link) &amp;&amp; !linkPredicate.test(link)) {</a>
<span class="sourceLineNo">937</span><a id="line.937">                                                                String label = modelElement.getLabel();</a>
<span class="sourceLineNo">938</span><a id="line.938">                                                                if (org.nasdanika.common.Util.isBlank(label)) {</a>
<span class="sourceLineNo">939</span><a id="line.939">                                                                        errorConsumer.accept("Broken diagram link: " + link);</a>
<span class="sourceLineNo">940</span><a id="line.940">                                                                } else {</a>
<span class="sourceLineNo">941</span><a id="line.941">                                                                        errorConsumer.accept("Broken diagram link on " + label + ": " + link);                                                                                  </a>
<span class="sourceLineNo">942</span><a id="line.942">                                                                }</a>
<span class="sourceLineNo">943</span><a id="line.943">                                                        }</a>
<span class="sourceLineNo">944</span><a id="line.944">                                                }</a>
<span class="sourceLineNo">945</span><a id="line.945">                                        }, null);</a>
<span class="sourceLineNo">946</span><a id="line.946">                                } catch (Exception e) {</a>
<span class="sourceLineNo">947</span><a id="line.947">                                        throw new NasdanikaException(e);</a>
<span class="sourceLineNo">948</span><a id="line.948">                                }</a>
<span class="sourceLineNo">949</span><a id="line.949">                        }                       </a>
<span class="sourceLineNo">950</span><a id="line.950">                };</a>
<span class="sourceLineNo">951</span><a id="line.951">        }</a>
<span class="sourceLineNo">952</span><a id="line.952"></a>
<span class="sourceLineNo">953</span><a id="line.953">        /**</a>
<span class="sourceLineNo">954</span><a id="line.954">         * Creates a predicate checking for links relative to the argument file in the argument directory. </a>
<span class="sourceLineNo">955</span><a id="line.955">         * @param file Base file</a>
<span class="sourceLineNo">956</span><a id="line.956">         * @param dir Directory within which check for relative links</a>
<span class="sourceLineNo">957</span><a id="line.957">         * @return</a>
<span class="sourceLineNo">958</span><a id="line.958">         */</a>
<span class="sourceLineNo">959</span><a id="line.959">        public static Predicate&lt;String&gt; createRelativeLinkPredicate(File file, File dir) {</a>
<span class="sourceLineNo">960</span><a id="line.960">                return target -&gt; {</a>
<span class="sourceLineNo">961</span><a id="line.961">                        File targetFile;</a>
<span class="sourceLineNo">962</span><a id="line.962">                        String fragment;</a>
<span class="sourceLineNo">963</span><a id="line.963">                        if (target.startsWith("#")) {</a>
<span class="sourceLineNo">964</span><a id="line.964">                                targetFile = file;</a>
<span class="sourceLineNo">965</span><a id="line.965">                                fragment = target;</a>
<span class="sourceLineNo">966</span><a id="line.966">                        } else {</a>
<span class="sourceLineNo">967</span><a id="line.967">                                int hashIdx = target.indexOf("#");</a>
<span class="sourceLineNo">968</span><a id="line.968">                                if (hashIdx == -1) {</a>
<span class="sourceLineNo">969</span><a id="line.969">                                        fragment = null;</a>
<span class="sourceLineNo">970</span><a id="line.970">                                } else {</a>
<span class="sourceLineNo">971</span><a id="line.971">                                        fragment = target.substring(hashIdx);</a>
<span class="sourceLineNo">972</span><a id="line.972">                                        target = target.substring(0, hashIdx);</a>
<span class="sourceLineNo">973</span><a id="line.973">                                }</a>
<span class="sourceLineNo">974</span><a id="line.974">                                if (target.contains(":") || target.contains("?")) { // Absolute or with a query string, not checking</a>
<span class="sourceLineNo">975</span><a id="line.975">                                        return true;</a>
<span class="sourceLineNo">976</span><a id="line.976">                                }</a>
<span class="sourceLineNo">977</span><a id="line.977">                                targetFile = new File(file.getParentFile(), target);</a>
<span class="sourceLineNo">978</span><a id="line.978">                                for (File parent = targetFile.getParentFile(); parent != null; parent = parent.getParentFile()) {</a>
<span class="sourceLineNo">979</span><a id="line.979">                                        if (parent.equals(dir)) {</a>
<span class="sourceLineNo">980</span><a id="line.980">                                                if (!targetFile.exists()) {</a>
<span class="sourceLineNo">981</span><a id="line.981">                                                        return false;</a>
<span class="sourceLineNo">982</span><a id="line.982">                                                }</a>
<span class="sourceLineNo">983</span><a id="line.983">                                        }</a>
<span class="sourceLineNo">984</span><a id="line.984">                                }</a>
<span class="sourceLineNo">985</span><a id="line.985">                        }</a>
<span class="sourceLineNo">986</span><a id="line.986">                        if (fragment == null || fragment.trim().length() == 0) {</a>
<span class="sourceLineNo">987</span><a id="line.987">                                return true;</a>
<span class="sourceLineNo">988</span><a id="line.988">                        }</a>
<span class="sourceLineNo">989</span><a id="line.989">                        </a>
<span class="sourceLineNo">990</span><a id="line.990">                        try {</a>
<span class="sourceLineNo">991</span><a id="line.991">                                Document document = Jsoup.parse(targetFile, StandardCharsets.UTF_8.name());</a>
<span class="sourceLineNo">992</span><a id="line.992">                                Elements namedAnchors = document.select("[name='" + fragment.substring(1) + "']");</a>
<span class="sourceLineNo">993</span><a id="line.993">                                Elements idAnchors = document.select("[id='" + fragment.substring(1) + "']");</a>
<span class="sourceLineNo">994</span><a id="line.994">                                return namedAnchors.size() + idAnchors.size() == 1;</a>
<span class="sourceLineNo">995</span><a id="line.995">                        } catch (IOException e) {</a>
<span class="sourceLineNo">996</span><a id="line.996">                                throw new NasdanikaException("Error parsing " + targetFile.getAbsolutePath(), e);</a>
<span class="sourceLineNo">997</span><a id="line.997">                        }</a>
<span class="sourceLineNo">998</span><a id="line.998">                        </a>
<span class="sourceLineNo">999</span><a id="line.999">                };</a>
<span class="sourceLineNo">1000</span><a id="line.1000">                </a>
<span class="sourceLineNo">1001</span><a id="line.1001">        }</a>
<span class="sourceLineNo">1002</span><a id="line.1002">                        </a>
<span class="sourceLineNo">1003</span><a id="line.1003">}</a>




























































</pre>
</div>
</main>

</body></html>
