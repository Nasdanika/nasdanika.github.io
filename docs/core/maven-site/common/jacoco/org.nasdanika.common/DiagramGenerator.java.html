<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiagramGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika Common</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.common</a> &gt; <span class="el_source">DiagramGenerator.java</span></div><h1>DiagramGenerator.java</h1><pre class="source lang-java linenums">package org.nasdanika.common;

import java.io.IOException;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLConnection;
import java.nio.charset.StandardCharsets;

/**
 * Generates PlantUML diagrams.
 * @author Pavel
 *
 */
public interface DiagramGenerator extends Composeable&lt;DiagramGenerator&gt; {
	
	public static String UML_DIALECT = &quot;uml&quot;;
	public static String SALT_DIALECT = &quot;salt&quot;;
	public static String GANTT_DIALECT = &quot;gantt&quot;;
	public static String MINDMAP_DIALECT = &quot;mindmap&quot;;
	public static String WBS_DIALECT = &quot;wbs&quot;;
	public static String DRAWIO_DIALECT = &quot;drawio&quot;;
	public static String MERMAID_DIALECT = &quot;mermaid&quot;;
	
	/**
	 * @param dialect
	 * @return true if given dialect is supported by this generator
	 */
	boolean isSupported(String dialect);
	
	/**
	 * Uses local PlantUML.
	 */
<span class="nc" id="L34">	DiagramGenerator INSTANCE = new DiagramGeneratorImpl();</span>
	
	/**
	 * Creates an instance of {@link DiagramGenerator} which does a POST to the service URL postfixed with /&amp;lt;dialect name&amp;gt; with diagram text spec as payload
	 * and returns the payload as String. UTF-8 is used for character encoding. 
	 * The service shall call the INSTANCE's &lt;code&gt;generateDiagram()&lt;/code&gt;. It can also perform caching of generated images. Return code 200 is treated as success. 
	 * Any other response code is treated as an error.
	 * Remoting can be used in situations where GrapViz (https://graphviz.org/) is not available on diagram generating machines or to improve performance via caching.
	 * 
	 * An example of server implementation with SpringBoot can be found here - https://github.com/Nasdanika/spring-exec/blob/main/src/main/java/org/nasdanika/spring/exec/controllers/ExecController.java#L344
	 * @param service Service URL with a trailing slash /. Must be an HTTP(s) URL.
	 * @return Diagram image and image map.
	 */
	static DiagramGenerator createClient(URL service) {
		
<span class="nc" id="L49">		return new DiagramGenerator() {</span>

			@Override
			public String generateDiagram(String spec, String dialect) {
				try {
<span class="nc" id="L54">					URL dialectURL = new URL(service, dialect);</span>
<span class="nc" id="L55">					URLConnection connection = dialectURL.openConnection();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">					if (!(connection instanceof HttpURLConnection)) {</span>
<span class="nc" id="L57">						throw new IllegalArgumentException(&quot;Not an HTTP(s) url: &quot;+dialectURL);</span>
					}
					
<span class="nc" id="L60">					HttpURLConnection httpConnection = (HttpURLConnection) connection;</span>
<span class="nc" id="L61">					httpConnection.setRequestMethod(&quot;POST&quot;);</span>
<span class="nc" id="L62">					httpConnection.setDoOutput(true);</span>
<span class="nc" id="L63">					try (OutputStream out = connection.getOutputStream()) {</span>
<span class="nc" id="L64">						out.write(spec.getBytes(StandardCharsets.UTF_8));</span>
					}
					
<span class="nc" id="L67">					int responseCode = httpConnection.getResponseCode();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">					if (responseCode == 200) {</span>
<span class="nc" id="L69">						return DefaultConverter.INSTANCE.toString(httpConnection.getInputStream());</span>
					}
					
<span class="nc" id="L72">					throw new IOException(&quot;HTTP Call to &quot;+dialectURL+&quot; has failed with response: &quot;+responseCode+&quot; &quot;+httpConnection.getResponseMessage());</span>
<span class="nc" id="L73">				} catch (IOException e) {</span>
<span class="nc" id="L74">					throw new NasdanikaException(e);</span>
				}
			}

			@Override
			public boolean isSupported(String dialect) {
				try {
<span class="nc" id="L81">					URL dialectURL = new URL(service, dialect);</span>
<span class="nc" id="L82">					URLConnection connection = dialectURL.openConnection();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">					if (!(connection instanceof HttpURLConnection)) {</span>
<span class="nc" id="L84">						throw new IllegalArgumentException(&quot;Not an HTTP(s) url: &quot;+dialectURL);</span>
					}				
<span class="nc" id="L86">					HttpURLConnection httpConnection = (HttpURLConnection) connection;				</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">					return httpConnection.getResponseCode() == 200; // GET OK indicates that dialect is supported. </span>
<span class="nc" id="L88">				} catch (Exception e) {</span>
<span class="nc" id="L89">					throw new NasdanikaException(e);</span>
				}
			}
			
		};
		
	}
	
	/**
	 * Generates a PlantUML diagram with an image map from text definition. The definition shall not contain start and end tags.
	 * @return
	 * @throws IOException 
	 */
	String generateDiagram(String spec, String dialect);
			
	default String generateUmlDiagram(String spec) {
<span class="nc" id="L105">		return generateDiagram(spec, UML_DIALECT);</span>
	}
		
	default String generateWireframeDiagram(String spec) {
<span class="nc" id="L109">		return generateDiagram(spec, SALT_DIALECT);</span>
	}
	
	default String generateGanttDiagram(String spec) {
<span class="nc" id="L113">		return generateDiagram(spec, GANTT_DIALECT);</span>
	}
	
	default String generateMindmapDiagram(String spec) {
<span class="nc" id="L117">		return generateDiagram(spec, MINDMAP_DIALECT);</span>
	}
	
	default String generateWbsDiagram(String spec) {
<span class="nc" id="L121">		return generateDiagram(spec, WBS_DIALECT);</span>
	}
	
	default String generateDrawioDiagram(String spec) {
<span class="nc" id="L125">		return generateDiagram(spec, DRAWIO_DIALECT);</span>
	}
	
	default String generateMermaidDiagram(String spec) {
<span class="nc" id="L129">		return generateDiagram(spec, MERMAID_DIALECT);</span>
	}
	
//	/**
//	 * Creates a diagram generator facading this one and cacheing generated diagrams by dialect and diagram text SHA-256 digest.
//	 * @param container
//	 * @param progressMonitor
//	 * @return
//	 */
//	default DiagramGenerator cachingDiagramGenerator(Container&lt;String&gt; container, ProgressMonitor progressMonitor) {
//		
//		return new DiagramGenerator() {
//			
//			private int hits;
//			private int misses;
//
//			@Override
//			public String generateDiagram(String spec, String dialect) {
//				try {
//					String cachePath = dialect + &quot;/&quot; + Hex.encodeHexString(MessageDigest.getInstance(&quot;SHA-256&quot;).digest(spec.getBytes(StandardCharsets.UTF_8))) + &quot;.html&quot;;
//					Object ret = container.find(cachePath, progressMonitor);
//					if (ret instanceof String) {
//						++hits;
//						return (String) ret;
//					}
//					String diagram = DiagramGenerator.this.generateDiagram(spec, dialect);
//					container.put(cachePath, diagram, progressMonitor);
//					++misses;
//					return diagram;
//				} catch (NoSuchAlgorithmException e) {
//					throw new NasdanikaException(e);
//				}
//			}
//			
//			@Override
//			public String toString() {
//				return super.toString() + &quot; hits: &quot; + hits + &quot;, misses: &quot; + misses;
//			}
//
//			@Override
//			public boolean isSupported(String dialect) {
//				return DiagramGenerator.this.isSupported(dialect);
//			}
//			
//		};
//	}
	
	@Override
	default DiagramGenerator compose(DiagramGenerator other) {
<span class="nc" id="L178">		return new DiagramGenerator() {</span>

			@Override
			public boolean isSupported(String dialect) {
<span class="nc bnc" id="L182" title="All 4 branches missed.">				return DiagramGenerator.this.isSupported(dialect) || other.isSupported(dialect);</span>
			}

			@Override
			public String generateDiagram(String spec, String dialect) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">				return (DiagramGenerator.this.isSupported(dialect) ? DiagramGenerator.this : other).generateDiagram(spec, dialect);</span>
			}
			
		};
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>