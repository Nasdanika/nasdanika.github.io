<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika Common</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.common</a> &gt; <span class="el_source">DefaultConverter.java</span></div><h1>DefaultConverter.java</h1><pre class="source lang-java linenums">package org.nasdanika.common;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.Reader;
import java.io.StringReader;
import java.io.StringWriter;
import java.io.Writer;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.time.Duration;
import java.time.Instant;
import java.time.Period;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Objects;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.EStructuralFeature;
import org.json.JSONArray;
import org.json.JSONObject;
import org.json.JSONTokener;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.yaml.snakeyaml.Yaml;

/**
 * Reflective converter providing some common conversions, some of them chained
 * @author Pavel
 *
 */
<span class="fc" id="L56">public class DefaultConverter extends ReflectiveConverter {</span>
	
<span class="fc" id="L58">	public static DefaultConverter INSTANCE = new DefaultConverter();</span>
	
	// String to JSONObject and JSONArray
	
	@ConverterMethod
	public JSONArray toJSONArray(String str) {
<span class="nc" id="L64">		return new JSONArray(new JSONTokener(str));</span>
	}
	
	@ConverterMethod
	public JSONObject toJSONObject(String str) {
<span class="fc" id="L69">		return new JSONObject(new JSONTokener(str));</span>
	}
	
	/**
	 * Constructor conversion is not working well, using just type and toString value.
	 * @param obj
	 * @return
	 */
	@ConverterMethod
	public JSONObject toJSONObject(Object obj) {
<span class="nc" id="L79">		JSONObject ret = new JSONObject();</span>
<span class="nc" id="L80">		ret.put(&quot;type&quot;, obj.getClass().getName());</span>
<span class="nc" id="L81">		ret.put(&quot;value&quot;, obj.toString());</span>
<span class="nc" id="L82">		return ret;</span>
	}
	
	// Reader to String, and JSONObject and JSONArray.
	
	@ConverterMethod
	public String toString(Reader reader) throws IOException {
<span class="fc" id="L89">		StringWriter sw = new StringWriter();</span>
<span class="fc" id="L90">		try (BufferedReader br = new BufferedReader(reader)) {</span>
			int ch;
<span class="fc bfc" id="L92" title="All 2 branches covered.">			while ((ch = br.read()) != -1) {</span>
<span class="fc" id="L93">				sw.write(ch);</span>
			}
		}
<span class="fc" id="L96">		sw.close();</span>
<span class="fc" id="L97">		return sw.toString();</span>
	}
	
	@ConverterMethod
	public JSONArray toJSONArray(Reader reader) {
<span class="nc" id="L102">		return new JSONArray(new JSONTokener(reader));</span>
	}
	
	@ConverterMethod
	public JSONObject toJSONObject(Reader reader) {
<span class="nc" id="L107">		return new JSONObject(new JSONTokener(reader));</span>
	}

	// InputStream to Reader, String, and JSONObject and JSONArray.
	
	/**
	 * Reads input stream into a byte array. 
	 * @param in
	 * @return
	 * @throws IOException 
	 */
	@ConverterMethod
	public byte[] toByteArray(InputStream in) throws IOException {
<span class="nc" id="L120">		ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L121">		try (InputStream bin = new BufferedInputStream(in)) {</span>
			int b;
<span class="nc bnc" id="L123" title="All 2 branches missed.">			while ((b = bin.read()) != -1) {</span>
<span class="nc" id="L124">				baos.write(b);</span>
			}
		}
<span class="nc" id="L127">		baos.close();</span>
<span class="nc" id="L128">		return baos.toByteArray();				</span>
	}
	
	/**
	 * Always UTF-8.
	 * @param in
	 * @return
	 */
	@ConverterMethod
	public Reader toReader(InputStream in) {
<span class="fc" id="L138">		return new InputStreamReader(in, StandardCharsets.UTF_8);</span>
	}
			
	@ConverterMethod
	public String toString(byte[] bytes) throws IOException {
<span class="nc" id="L143">		return new String(bytes, StandardCharsets.UTF_8);</span>
	}
	
	@ConverterMethod
	public String toString(InputStream in) throws IOException {
<span class="nc" id="L148">		return toString(toReader(in));</span>
	}
	
	@ConverterMethod
	public JSONArray toJSONArray(InputStream in) {
<span class="nc" id="L153">		return toJSONArray(toReader(in));</span>
	}
	
	@ConverterMethod
	public JSONObject toJSONObject(InputStream in) {
<span class="nc" id="L158">		return toJSONObject(toReader(in));</span>
	}
	
	// URL to InputStream, Reader, String, and JSONObject and JSONArray.
	
	@ConverterMethod
	public InputStream toInputStream(URL url) throws IOException {
<span class="fc" id="L165">		return url.openStream();</span>
	}
	
	/**
	 * Reads input stream into a byte array. 
	 * @param in
	 * @return
	 * @throws IOException 
	 */
	@ConverterMethod
	public byte[] toByteArray(URL url) throws IOException {
<span class="nc" id="L176">		return toByteArray(toInputStream(url));</span>
	}
	
	/**
	 * Always UTF-8.
	 * @param in
	 * @return
	 * @throws IOException 
	 */
	@ConverterMethod
	public Reader toReader(URL url) throws IOException {
<span class="fc" id="L187">		return toReader(toInputStream(url));</span>
	}
	
	/**
	 * Reads URL to String
	 * @param url
	 * @return
	 * @throws IOException
	 */
	@ConverterMethod
	public String stringContent(URL url) throws IOException {
<span class="fc" id="L198">		return toString(toReader(url));</span>
	}
	
	@ConverterMethod
	public JSONArray toJSONArray(URL url) throws IOException {
<span class="nc" id="L203">		return toJSONArray(toReader(url));</span>
	}
	
	@ConverterMethod
	public JSONObject toJSONObject(URL url) throws IOException {
<span class="nc" id="L208">		return new JSONObject(toReader(url));</span>
	}
		
	@ConverterMethod
	public InputStream toInputStream(byte[] bytes) throws IOException {
<span class="nc" id="L213">		return new ByteArrayInputStream(bytes);</span>
	}
	
	@ConverterMethod
	public InputStream toInputStream(CharSequence charSequence) throws IOException {
<span class="nc" id="L218">		return toInputStream(toByteArray(charSequence));</span>
	}
	
	/**
	 * Converts character sequence to byte array with UTF_8 encoding.
	 * @param charSequence
	 * @return
	 * @throws IOException
	 */
	@ConverterMethod
	public byte[] toByteArray(CharSequence charSequence) throws IOException {
<span class="nc" id="L229">		ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L230">		try (Writer writer = new OutputStreamWriter(baos, StandardCharsets.UTF_8)) {</span>
<span class="nc" id="L231">			writer.write(charSequence.toString());</span>
		}
<span class="nc" id="L233">		baos.close();</span>
<span class="nc" id="L234">		return baos.toByteArray();				</span>
	}
	
	/**
	 * @param text
	 * @return parsed duration.
	 */
	@ConverterMethod
	public Duration toDuration(CharSequence text) {
<span class="nc" id="L243">		return Duration.parse(text);</span>
	}

	/**
	 * @param text
	 * @return parsed period.
	 */
	@ConverterMethod
	public Period toPeriod(CharSequence text) {
<span class="nc" id="L252">		return Period.parse(text);</span>
	}

	/**
	 * @param text
	 * @return parsed duration.
	 */
	@ConverterMethod
	public Instant toInstant(String text) {
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if (text == null) {</span>
<span class="nc" id="L262">			return null;</span>
		}
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (text.contains(&quot;Z&quot;)) {</span>
<span class="nc" id="L265">			return Instant.parse(text);</span>
		}
		// Parsing via Date for convenience
<span class="nc" id="L268">		Date date = convert(text, Date.class);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">		return date == null ? null : date.toInstant();</span>
	}

	/**
	 * @param text
	 * @return parsed duration.
	 */
	@ConverterMethod
	public Instant toInstant(Date date) {
<span class="nc" id="L278">		return Instant.ofEpochMilli(date.getTime());</span>
	}
	
	@ConverterMethod
	public URI toURI(String str) {
<span class="nc" id="L283">		return URI.createURI(str);</span>
	}
	
	
	// URI
	
	@ConverterMethod
	public InputStream toInputStream(URI uri) throws IOException {
<span class="nc bnc" id="L291" title="All 2 branches missed.">		if (Util.CLASSPATH_SCHEME.equals(uri.scheme())) {</span>
<span class="nc" id="L292">			String resource = uri.toString().substring(Util.CLASSPATH_URL_PREFIX.length());</span>
<span class="nc" id="L293">			return Objects.requireNonNull(getClass().getClassLoader().getResourceAsStream(resource), &quot;ClassLoader resource not found: &quot; + resource);</span>
		}
<span class="nc" id="L295">		return toInputStream(new URL(uri.toString()));</span>
	}
	
	/**
	 * Reads input stream into a byte array. 
	 * @param in
	 * @return
	 * @throws IOException 
	 */
	@ConverterMethod
	public byte[] toByteArray(URI uri) throws IOException {
<span class="nc" id="L306">		return toByteArray(toInputStream(uri));</span>
	}
	
	/**
	 * Always UTF-8.
	 * @param in
	 * @return
	 * @throws IOException 
	 */
	@ConverterMethod
	public Reader toReader(URI uri) throws IOException {
<span class="nc" id="L317">		return toReader(toInputStream(uri));</span>
	}
	
	/**
	 * Reads URL to String
	 * @param url
	 * @return
	 * @throws IOException
	 */
//	@ConverterMethod - Not a converter method because conversion breaks getting base URI property.
	public String stringContent(URI uri) throws IOException {
<span class="nc" id="L328">		return toString(toReader(uri));</span>
	}
	
	@ConverterMethod
	public JSONArray toJSONArray(URI uri) throws IOException {
<span class="nc" id="L333">		return toJSONArray(toReader(uri));</span>
	}
	
	@ConverterMethod
	public JSONObject toJSONObject(URI uri) throws IOException {
<span class="nc" id="L338">		return new JSONObject(toReader(uri));</span>
	}
	
	@ConverterMethod
	public String toString(Node node) throws TransformerException, IOException {
<span class="nc" id="L343">	    DOMSource source = new DOMSource(node);</span>
<span class="nc" id="L344">	    StringWriter out = new StringWriter();</span>
<span class="nc" id="L345">		TransformerFactory tFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L346">	    Transformer transformer = tFactory.newTransformer();</span>
<span class="nc" id="L347">	    transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, &quot;yes&quot;);</span>
<span class="nc" id="L348">    	transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L349">		transformer.setOutputProperty(OutputKeys.ENCODING, &quot;UTF-8&quot;);</span>
	    
<span class="nc" id="L351">	    try (out) {</span>
<span class="nc" id="L352">	    	transformer.transform(source, new StreamResult(out));</span>
	    }
<span class="nc" id="L354">		return out.toString();</span>
	}
	
	// XML
	
	@ConverterMethod
	public Document parseXML(URI uri) throws ParserConfigurationException, SAXException, IOException {
<span class="nc" id="L361">		return parseXML(toInputStream(uri));</span>
	}	
	
	@ConverterMethod
	public Document parseXML(InputStream inputStream) throws ParserConfigurationException, SAXException, IOException {
<span class="nc" id="L366">		return parseXML(toReader(inputStream));</span>
	}	
	
	@ConverterMethod
	public Document parseXML(Reader reader) throws ParserConfigurationException, SAXException, IOException {
<span class="nc" id="L371">		DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L372">		DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();</span>
<span class="nc" id="L373">		return dBuilder.parse(new InputSource(reader));</span>
	}
	
	@ConverterMethod
	public Document parseXML(String xmlStr) throws ParserConfigurationException, SAXException, IOException {
<span class="nc" id="L378">		return parseXML(new StringReader(xmlStr));</span>
	}

	// YAML

	public Object loadYAML(URI uri) throws IOException {
<span class="nc" id="L384">		return loadYAML(toInputStream(uri));</span>
	}	
	
	public Object loadYAML(InputStream inputStream) throws IOException  {
<span class="nc" id="L388">		return loadYAML(toReader(inputStream));</span>
	}	
	
	public Object loadYAML(Reader reader) throws IOException {
<span class="nc" id="L392">		return loadYAML(toString(reader));</span>
	}
	
	public Object loadYAML(String yamlStr) {
<span class="nc" id="L396">		Yaml yaml = new Yaml();</span>
<span class="nc" id="L397">		return yaml.load(yamlStr);</span>
	}
	
	// JSON
	
	@ConverterMethod
	public JSONObject loadJSONObject(URI uri) throws IOException {
<span class="nc" id="L404">		return loadJSONObject(toInputStream(uri));</span>
	}	
	
	@ConverterMethod
	public JSONObject loadJSONObject(InputStream inputStream) throws IOException {
<span class="nc" id="L409">		return loadJSONObject(toReader(inputStream));</span>
	}	
	
	@ConverterMethod
	public JSONObject loadJSONObject(Reader reader) throws IOException {
<span class="nc" id="L414">		return loadJSONObject(toString(reader));</span>
	}
	
	@ConverterMethod
	public JSONObject loadJSONObject(String jsonStr) {
<span class="nc" id="L419">		return new JSONObject(new JSONTokener(jsonStr));</span>
	}
	
	
	@ConverterMethod
	public JSONArray loadJSONArray(URI uri) throws IOException {
<span class="nc" id="L425">		return loadJSONArray(toInputStream(uri));</span>
	}	
	
	@ConverterMethod
	public JSONArray loadJSONArray(InputStream inputStream) throws IOException {
<span class="nc" id="L430">		return loadJSONArray(toReader(inputStream));</span>
	}	
	
	@ConverterMethod
	public JSONArray loadJSONArray(Reader reader) throws IOException {
<span class="nc" id="L435">		return loadJSONArray(toString(reader));</span>
	}
	
	@ConverterMethod
	public JSONArray loadJSONArray(String jsonStr) {
<span class="nc" id="L440">		return new JSONArray(new JSONTokener(jsonStr));</span>
	}
	
	/**
	 * Outputs EObject as a Map of {@link EStructuralFeature}s names to their values. Such a map can then be used to output to YAML or JSON.
	 * @param eObj EObject
	 * @param referenceProvider Providers or values for non-containment references. If null such references are not output to the map.
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Map&lt;String, Object&gt; toMap(EObject eObj, java.util.function.Function&lt;EObject, Object&gt; referenceProvider) {
<span class="nc bnc" id="L451" title="All 2 branches missed.">		if (eObj == null) {</span>
<span class="nc" id="L452">			return null;</span>
		}
<span class="nc" id="L454">		Map&lt;String, Object&gt; ret = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">		for (EStructuralFeature sf: eObj.eClass().getEAllStructuralFeatures()) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">			if (eObj.eIsSet(sf)) {</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">				if (sf instanceof EAttribute) {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">					if (sf.isMany()) {</span>
<span class="nc" id="L459">						Collection&lt;Object&gt; vList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">						for (Object av: (Collection&lt;Object&gt;) eObj.eGet(sf)) {</span>
<span class="nc" id="L461">							vList.add(av);</span>
<span class="nc" id="L462">						}</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">						if (!vList.isEmpty()) {</span>
<span class="nc" id="L464">							ret.put(sf.getName(), vList);</span>
						}
<span class="nc" id="L466">					} else {</span>
<span class="nc" id="L467">						ret.put(sf.getName(), eObj.eGet(sf));</span>
					}
				} else {
<span class="nc" id="L470">					EReference eRef = (EReference) sf;</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">					if (eRef.isContainment()) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">						if (eRef.isMany()) {</span>
<span class="nc" id="L473">							Collection&lt;Map&lt;String, Object&gt;&gt; vList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">							for (EObject rv: (Collection&lt;EObject&gt;) eObj.eGet(sf)) {</span>
<span class="nc" id="L475">								vList.add(toMap(rv, referenceProvider));</span>
<span class="nc" id="L476">							}</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">							if (!vList.isEmpty()) {</span>
<span class="nc" id="L478">								ret.put(sf.getName(), vList);</span>
							}
<span class="nc" id="L480">						} else {</span>
<span class="nc" id="L481">							ret.put(sf.getName(), toMap((EObject) eObj.eGet(sf), referenceProvider));</span>
						}
<span class="nc bnc" id="L483" title="All 2 branches missed.">					} else if (referenceProvider != null) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">						if (eRef.isMany()) {</span>
<span class="nc" id="L485">							Collection&lt;Object&gt; vList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">							for (EObject rv: (Collection&lt;EObject&gt;) eObj.eGet(sf)) {</span>
<span class="nc" id="L487">								vList.add(referenceProvider.apply(rv));</span>
<span class="nc" id="L488">							}</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">							if (!vList.isEmpty()) {</span>
<span class="nc" id="L490">								ret.put(sf.getName(), vList);</span>
							}
<span class="nc" id="L492">						} else {</span>
<span class="nc" id="L493">							ret.put(sf.getName(), referenceProvider.apply((EObject) eObj.eGet(sf)));</span>
						}						
					}
				}
			}			
<span class="nc" id="L498">		}</span>
<span class="nc" id="L499">		return ret;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>