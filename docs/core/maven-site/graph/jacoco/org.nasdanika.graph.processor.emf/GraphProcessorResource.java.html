<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GraphProcessorResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika Graph</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.graph.processor.emf</a> &gt; <span class="el_source">GraphProcessorResource.java</span></div><h1>GraphProcessorResource.java</h1><pre class="source lang-java linenums">package org.nasdanika.graph.processor.emf;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.function.Supplier;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.impl.ResourceImpl;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.graph.Element;
import org.nasdanika.graph.processor.ConnectionProcessorConfig;
import org.nasdanika.graph.processor.NodeProcessorConfig;
import org.nasdanika.graph.processor.ProcessorConfig;
import org.nasdanika.graph.processor.ProcessorFactory;
import org.nasdanika.graph.processor.ProcessorInfo;


/**
 * Base class for resource which load their contents by creating a {@link Stream} of {@link Element}'s from a resource {@link URI} and then uses {@link ProcessorFactory} to create {@link Supplier}'s of {@link EObject} with {@link ProcessorFactory}. 
 * @author Pavel
 *
 */
public abstract class GraphProcessorResource&lt;P, T extends EObject&gt; extends ResourceImpl {
	
	protected abstract ProcessorFactory&lt;P, ?, ?&gt; getProcessorFactory();
	
	protected GraphProcessorResource(URI uri) {
<span class="nc" id="L34">		super(uri);</span>
<span class="nc" id="L35">	}</span>

	/**
	 * Loads {@link Element}s from the input stream to pass to 
	 * @param inputStream
	 * @param options
	 * @return
	 * @throws IOException
	 */
	protected abstract Stream&lt;? extends Element&gt; loadElements(InputStream inputStream, Map&lt;?, ?&gt; options) throws IOException;
	
	@Override
	protected void doLoad(InputStream inputStream, Map&lt;?, ?&gt; options) throws IOException {
<span class="nc" id="L48">		List&lt;? extends Element&gt; elements = loadElements(inputStream, options).collect(Collectors.toList());</span>
<span class="nc" id="L49">		Map&lt;Element, ProcessorInfo&lt;P&gt;&gt; registry = getProcessorFactory().createProcessors(elements.stream(), getProgressMonitor());</span>
<span class="nc" id="L50">		List&lt;T&gt; roots = getSemanticElements(registry).filter(this::isRoot).collect(Collectors.toList()); // TODO .forEach(getContents()::add) - fails with concurrent modification exception</span>
<span class="nc" id="L51">		getContents().addAll(roots);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">		for (Element element: elements) {</span>
<span class="nc" id="L53">			ProcessorInfo&lt;P&gt; info = registry.get(element);</span>
<span class="nc" id="L54">			ProcessorConfig&lt;P&gt; config = info.getConfig();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">			if (config instanceof NodeProcessorConfig) {</span>
<span class="nc" id="L56">				eAdapters().add(new NodeProcessorConfigAdapter&lt;&gt;((NodeProcessorConfig&lt;P, ?, ?&gt;) config));</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">			} else if (config instanceof ConnectionProcessorConfig) {</span>
<span class="nc" id="L58">				eAdapters().add(new ConnectionProcessorConfigAdapter&lt;&gt;((ConnectionProcessorConfig&lt;P, ?, ?&gt;) config));				</span>
			} else {
<span class="nc" id="L60">				eAdapters().add(new ProcessorConfigAdapter&lt;&gt;(config));				</span>
			}
<span class="nc" id="L62">		}</span>
<span class="nc" id="L63">	}</span>

	protected abstract ProgressMonitor getProgressMonitor();
	
	@SuppressWarnings(&quot;unchecked&quot;)
	protected Stream&lt;T&gt; getSemanticElements(P processor) {
<span class="nc bnc" id="L69" title="All 2 branches missed.">		if (processor instanceof SemanticProcessor) {</span>
<span class="nc" id="L70">			return ((SemanticProcessor&lt;T&gt;) processor).getSemanticElements().stream();</span>
		}
<span class="nc" id="L72">		return Stream.empty();</span>
	};

	/**
	 * Retrieves semantic elements {@link EObject}s from the registry.
	 * @param registry
	 * @return
	 */
	protected Stream&lt;T&gt; getSemanticElements(Map&lt;Element, ProcessorInfo&lt;P&gt;&gt; registry) {
<span class="nc" id="L81">		return registry.values().stream().map(pi -&gt; pi.getProcessor()).filter(Objects::nonNull).flatMap(this::getSemanticElements);</span>
	}
	
	/**
	 * @param semanticElement 
	 * @return true if the argument semantic element shall be added to the resource contents.
	 * This implementation returns true if the semantic element is not null and is not contained by another semantic element, i.e. its eContainer() returns null.
	 */
	protected boolean isRoot(EObject semanticElement) {
<span class="nc bnc" id="L90" title="All 4 branches missed.">		return semanticElement != null &amp;&amp; semanticElement.eContainer() == null;</span>
	}
			
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>