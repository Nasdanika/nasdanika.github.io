<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModelElementImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Java API for working with Drawio diagrams</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.drawio.impl</a> &gt; <span class="el_source">ModelElementImpl.java</span></div><h1>ModelElementImpl.java</h1><pre class="source lang-java linenums">package org.nasdanika.drawio.impl;

import java.io.IOException;
import java.net.URL;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.BiFunction;
import java.util.stream.Collectors;

import javax.xml.parsers.ParserConfigurationException;

import org.eclipse.emf.common.util.URI;
import org.nasdanika.common.AbstractSplitJoinSet;
import org.nasdanika.common.DelimitedStringMap;
import org.nasdanika.common.NasdanikaException;
import org.nasdanika.common.Util;
import org.nasdanika.drawio.ConnectionBase;
import org.nasdanika.drawio.Document;
import org.nasdanika.drawio.Element;
import org.nasdanika.drawio.Model;
import org.nasdanika.drawio.ModelElement;
import org.nasdanika.drawio.Page;
import org.xml.sax.SAXException;

class ModelElementImpl extends ElementImpl implements ModelElement {
	
	private static final String PAGE_LINK_PREFIX = &quot;data:page&quot;;
	private static final String ID_DATA_PAGE_PREFIX = PAGE_LINK_PREFIX + &quot;/id,&quot;; // Page identified by id - internal references
	private static final String NAME_DATA_PAGE_PREFIX = PAGE_LINK_PREFIX + &quot;/name,&quot;; // Page identified by name - external references
	private static final String FIRST_DATA_PAGE_PREFIX = PAGE_LINK_PREFIX + &quot;,&quot;; // First document page
	private static final String ATTRIBUTE_TAGS = &quot;tags&quot;;
	static final String ATTRIBUTE_VALUE = &quot;value&quot;;
	static final String ATTRIBUTE_PARENT = &quot;parent&quot;;
	static final String ATTRIBUTE_LABEL = &quot;label&quot;;
	static final String ATTRIBUTE_LINK = &quot;link&quot;;
	static final String ATTRIBUTE_TOOLTIP = &quot;tooltip&quot;;
	static final String ATTRIBUTE_TARGET = &quot;target&quot;;
	static final String ATTRIBUTE_SOURCE = &quot;source&quot;;
	static final String ATTRIBUTE_STYLE = &quot;style&quot;;
	static final String ATTRIBUTE_VISIBLE = &quot;visible&quot;;	
	
	/**
	 * For element resolution.
	 */
	protected ModelImpl model;

	/**
	 * @param element XML element for this page element
	 * @param rootElement root element containing all model elements to use for lookup of parent and children.
	 */
<span class="fc" id="L58">	ModelElementImpl(org.w3c.dom.Element element, ModelImpl model) {</span>
<span class="fc" id="L59">		this.element = element;</span>
<span class="fc" id="L60">		this.model = model;</span>
<span class="fc" id="L61">	}</span>

	@Override
	public ModelElement getParent() {
<span class="fc bfc" id="L65" title="All 2 branches covered.">		if (getCellElement().hasAttribute(ATTRIBUTE_PARENT)) {	</span>
<span class="fc" id="L66">			return model.find(getCellElement().getAttribute(ATTRIBUTE_PARENT));</span>
		}
<span class="fc" id="L68">		return null;</span>
	}
	
	@Override
	protected List&lt;? extends Element&gt; getChildren() {
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">		if (element.hasAttribute(ATTRIBUTE_ID)) {</span>
<span class="fc bfc" id="L74" title="All 4 branches covered.">			return model.collect(e -&gt; ModelElementImpl.getCellElement(e).hasAttribute(ATTRIBUTE_PARENT) &amp;&amp; ModelElementImpl.getCellElement(e).getAttribute(ATTRIBUTE_PARENT).equals(element.getAttribute(ATTRIBUTE_ID)));</span>
		}
<span class="nc" id="L76">		return Collections.emptyList();</span>
	}
	
	protected org.w3c.dom.Element getCellElement() {
<span class="fc" id="L80">		return getCellElement(element);</span>
	}	
	
	@Override
	public String getId() {
<span class="nc bnc" id="L85" title="All 2 branches missed.">		return getElement().hasAttribute(ATTRIBUTE_ID) ? getElement().getAttribute(ATTRIBUTE_ID) : null;</span>
	}
	
	static org.w3c.dom.Element getCellElement(org.w3c.dom.Element element) {
<span class="fc bfc" id="L89" title="All 2 branches covered.">		return &quot;mxCell&quot;.equals(element.getTagName()) ? element : DocumentImpl.getChildrenElements(element, &quot;mxCell&quot;).get(0);</span>
	}
	
	/**
	 * Wraps mxCell into object element if not already
	 * @return
	 */
	protected org.w3c.dom.Element asObjectElement() {
<span class="fc bfc" id="L97" title="All 2 branches covered.">		if (&quot;mxCell&quot;.equals(element.getTagName())) {</span>
<span class="fc" id="L98">			org.w3c.dom.Element objectElement = element.getOwnerDocument().createElement(&quot;object&quot;);</span>
<span class="fc" id="L99">			element.getParentNode().replaceChild(objectElement, element);</span>
<span class="fc" id="L100">			org.w3c.dom.Element cellElement = element;</span>
<span class="fc" id="L101">			element = objectElement;</span>
<span class="fc" id="L102">			objectElement.appendChild(cellElement);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">			if (cellElement.hasAttribute(ATTRIBUTE_VALUE)) {</span>
<span class="fc" id="L104">				element.setAttribute(ATTRIBUTE_LABEL, cellElement.getAttribute(ATTRIBUTE_VALUE));</span>
<span class="fc" id="L105">				cellElement.removeAttribute(ATTRIBUTE_VALUE);</span>
			}
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">			if (cellElement.hasAttribute(ATTRIBUTE_ID)) {</span>
<span class="fc" id="L108">				element.setAttribute(ATTRIBUTE_ID, cellElement.getAttribute(ATTRIBUTE_ID));</span>
<span class="fc" id="L109">				cellElement.removeAttribute(ATTRIBUTE_ID);</span>
			}
		}
<span class="fc" id="L112">		return element;</span>
	}

	@Override
	public void setLabel(String label) {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">		element.setAttribute(&quot;mxCell&quot;.equals(element.getTagName()) ? ATTRIBUTE_VALUE : ATTRIBUTE_LABEL, label);</span>
<span class="fc" id="L118">	}</span>

	@Override
	public String getLink() {
<span class="fc" id="L122">		return getProperty(ATTRIBUTE_LINK);</span>
	}

	@Override
	public void setLink(String link) {
<span class="fc" id="L127">		setProperty(ATTRIBUTE_LINK, link);</span>
<span class="fc" id="L128">	}</span>

	@Override
	public String getTooltip() {
<span class="nc" id="L132">		return getProperty(ATTRIBUTE_TOOLTIP);</span>
	}

	@Override
	public void setTooltip(String tooltip) {
<span class="fc" id="L137">		setProperty(ATTRIBUTE_TOOLTIP, tooltip);</span>
<span class="fc" id="L138">	}</span>

	@Override
	public Map&lt;String, String&gt; getStyle() {
<span class="fc" id="L142">		return new DelimitedStringMap(&quot;;&quot;, &quot;=&quot;) {</span>

			@Override
			protected String getState() {
<span class="fc" id="L146">				return getCellElement().getAttribute(ATTRIBUTE_STYLE);</span>
			}

			@Override
			protected void setState(String state) {
<span class="fc" id="L151">				getCellElement().setAttribute(ATTRIBUTE_STYLE, state);</span>
<span class="fc" id="L152">			}</span>
			
		};
	}
	
	@Override
	public String getLabel() {
<span class="fc bfc" id="L159" title="All 2 branches covered.">		return interpolate(&quot;mxCell&quot;.equals(element.getTagName()) ? element.getAttribute(ATTRIBUTE_VALUE) : element.getAttribute(ATTRIBUTE_LABEL), new HashSet&lt;&gt;());</span>
	}

	/**
	 * Unexpanded property.
	 * @param name
	 * @return
	 */
	private String getRawProperty(String name) {
<span class="fc bfc" id="L168" title="All 2 branches covered.">		return &quot;mxCell&quot;.equals(element.getTagName()) ? null : element.getAttribute(name);</span>
	}
	
	private String interpolate(String str, Set&lt;String&gt; expanded) {		
<span class="pc bpc" id="L172" title="1 of 4 branches missed.">		if (!Util.isBlank(str) &amp;&amp; &quot;1&quot;.equals(getRawProperty(&quot;placeholders&quot;))) {</span>
<span class="nc" id="L173">			StringBuilder retBuilder = new StringBuilder();</span>
<span class="nc" id="L174">			int i = 0;</span>
			int start;
<span class="nc bnc" id="L176" title="All 4 branches missed.">			while (i &lt; str.length() &amp;&amp;  (start = str.indexOf(&quot;%&quot;, i)) != -1) {</span>
<span class="nc" id="L177">				int end = str.indexOf(&quot;%&quot;, start + 1);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">				if (end == -1) {</span>
<span class="nc" id="L179">					break; </span>
				}

<span class="nc" id="L182">				String pName = str.substring(start + 1, end);</span>
<span class="nc" id="L183">				String pValue = getRawProperty(pName);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">				if (expanded.add(pName)) {</span>
<span class="nc" id="L185">					pValue = interpolate(pValue, expanded);</span>
				}
<span class="nc bnc" id="L187" title="All 2 branches missed.">				if (Util.isBlank(pValue)) {</span>
<span class="nc" id="L188">					pValue = getInheritedProperty(getParent(), pName);</span>
				}
				
<span class="nc bnc" id="L191" title="All 2 branches missed.">				if (Util.isBlank(pValue)) {</span>
<span class="nc" id="L192">					retBuilder.append(str.substring(i, end));</span>
<span class="nc" id="L193">					i = end;</span>
				} else {
<span class="nc" id="L195">					retBuilder.append(str.substring(i, start)).append(pValue);</span>
<span class="nc" id="L196">					i = end + 1;</span>
				}
<span class="nc" id="L198">			}</span>
<span class="nc" id="L199">			retBuilder.append(str.substring(i));</span>
<span class="nc" id="L200">			return retBuilder.toString();</span>
		}

<span class="fc" id="L203">		return str;</span>
	}
	
	private static String getInheritedProperty(ModelElement modelElement, String name) {
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (modelElement == null) {</span>
<span class="nc" id="L208">			return null;</span>
		}
<span class="nc" id="L210">		String val = modelElement.getProperty(name);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">		if (!Util.isBlank(val)) {</span>
<span class="nc" id="L212">			return val;</span>
		}
<span class="nc" id="L214">		return getInheritedProperty(modelElement.getParent(), name);</span>
	}

	@Override
	public String getProperty(String name) {
<span class="fc" id="L219">		return interpolate(getRawProperty(name), new HashSet&lt;&gt;());</span>
	}

	@Override
	public void setProperty(String name, String value) {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">		if (Util.isBlank(value)) {</span>
<span class="nc" id="L225">			asObjectElement().removeAttribute(name);			</span>
		} else {
<span class="fc" id="L227">			asObjectElement().setAttribute(name, value);</span>
		}
<span class="fc" id="L229">	}</span>

	@Override
	public Set&lt;String&gt; getTags() {
<span class="fc" id="L233">		return new AbstractSplitJoinSet&lt;String,String,String&gt;() {</span>

			@Override
			protected String getState() {
<span class="fc" id="L237">				return getProperty(ATTRIBUTE_TAGS);</span>
			}

			@Override
			protected void setState(String state) {
<span class="fc" id="L242">				setProperty(ATTRIBUTE_TAGS, state);</span>
<span class="fc" id="L243">			}</span>

			@Override
			protected List&lt;String&gt; split(String state) {
<span class="fc bfc" id="L247" title="All 2 branches covered.">				if (Util.isBlank(state)) {</span>
<span class="fc" id="L248">					return Collections.emptyList();</span>
				}
<span class="fc" id="L250">				return Arrays.asList(state.split(&quot; &quot;));</span>
			}

			@Override			
			protected String join(List&lt;String&gt; chunks) {
<span class="pc bpc" id="L255" title="2 of 4 branches missed.">				if (chunks == null || chunks.isEmpty()) {</span>
<span class="nc" id="L256">					return null;</span>
				}
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">				return chunks.stream().filter(e -&gt; !Util.isBlank(e)).collect(Collectors.joining(&quot; &quot;));</span>
			}

			@Override
			protected String load(String chunk) {
<span class="fc" id="L263">				return chunk;</span>
			}

			@Override
			protected String store(String element) {
<span class="fc" id="L268">				return element;</span>
			}
			
		};
	}

	@Override
	public boolean isVisible() {
<span class="nc" id="L276">		org.w3c.dom.Element cellElement = getCellElement(getElement());</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">		return !cellElement.hasAttribute(ATTRIBUTE_VISIBLE) || &quot;1&quot;.equals(cellElement.getAttribute(ATTRIBUTE_VISIBLE));</span>
	}

	@Override
	public void setVisible(boolean visible) {
<span class="nc" id="L282">		org.w3c.dom.Element cellElement = getCellElement(getElement());</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (visible) {</span>
<span class="nc" id="L284">			cellElement.removeAttribute(ATTRIBUTE_VISIBLE);</span>
		} else {
<span class="nc" id="L286">			cellElement.setAttribute(ATTRIBUTE_VISIBLE, &quot;0&quot;);</span>
		}		
<span class="nc" id="L288">	}</span>
	
	public &lt;T&gt; T resolve(T base, BiFunction&lt;? super ModelElement,T,T&gt; resolver, ConnectionBase connectionBase) {
<span class="fc" id="L291">		ModelElement logicalParent = getLogicalParent(connectionBase);</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">		return resolver.apply(this, logicalParent == null ? base : logicalParent.resolve(base, resolver, connectionBase)); </span>
	}
	
	protected ModelElement getLogicalParent(ConnectionBase connectionBase) {
<span class="fc" id="L296">		return getParent();</span>
	}

	@Override
	public Model getModel() {
<span class="fc" id="L301">		return model;</span>
	}
	
	@Override
	public boolean isPageLink() {
<span class="nc" id="L306">		String link = getLink();</span>
<span class="nc bnc" id="L307" title="All 4 branches missed.">		return !Util.isBlank(link) &amp;&amp; link.startsWith(PAGE_LINK_PREFIX);</span>
	}

	@Override
	public Page getLinkedPage() {
<span class="fc" id="L312">		String link = getLink();</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">		if (Util.isBlank(link)) {</span>
<span class="fc" id="L314">			return null;</span>
		}
		
<span class="fc" id="L317">		Document document = getModel().getPage().getDocument();</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">		if (link.startsWith(FIRST_DATA_PAGE_PREFIX)) {</span>
<span class="fc" id="L319">			URI targetURI = URI.createURI(link.substring(FIRST_DATA_PAGE_PREFIX.length()));</span>
<span class="fc" id="L320">			URI docURI = document.getURI();</span>
<span class="pc bpc" id="L321" title="4 of 8 branches missed.">			if (targetURI.isRelative() &amp;&amp; docURI != null &amp;&amp; !docURI.isRelative() &amp;&amp; docURI.isHierarchical()) {</span>
<span class="fc" id="L322">				targetURI = targetURI.resolve(docURI);</span>
			}
			
			try {
<span class="fc" id="L326">				Document targetDocument = Document.load(targetURI);</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">				for (Page page: targetDocument.getPages()) {</span>
<span class="fc" id="L328">					return page;</span>
				}
<span class="nc" id="L330">			} catch (IOException | ParserConfigurationException | SAXException e) {</span>
<span class="nc" id="L331">				throw new NasdanikaException(&quot;Failed to load document from &quot; + targetURI, e);</span>
<span class="nc" id="L332">			}</span>
<span class="nc" id="L333">			throw new IllegalArgumentException(&quot;No pages in &quot; + targetURI);</span>
		}

<span class="fc bfc" id="L336" title="All 2 branches covered.">		if (link.startsWith(ID_DATA_PAGE_PREFIX)) {</span>
<span class="fc" id="L337">			String targetId = link.substring(ID_DATA_PAGE_PREFIX.length());</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">			for (Page page: document.getPages()) {</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">				if (targetId.equals(page.getId())) {</span>
<span class="fc" id="L340">					return page;</span>
				}
<span class="fc" id="L342">			}</span>
<span class="nc" id="L343">			throw new IllegalArgumentException(&quot;Linked page not found: &quot; + targetId);</span>
		}

<span class="pc bpc" id="L346" title="1 of 2 branches missed.">		if (link.startsWith(NAME_DATA_PAGE_PREFIX)) {</span>
<span class="fc" id="L347">			String targetUriStr = link.substring(NAME_DATA_PAGE_PREFIX.length());</span>
<span class="fc" id="L348">			URI targetURI = URI.createURI(targetUriStr);</span>
<span class="fc" id="L349">			URI docURI = document.getURI();</span>
<span class="pc bpc" id="L350" title="4 of 8 branches missed.">			if (targetURI.isRelative() &amp;&amp; docURI != null &amp;&amp; !docURI.isRelative() &amp;&amp; docURI.isHierarchical()) {</span>
<span class="fc" id="L351">				targetURI = targetURI.resolve(docURI);</span>
			}
				
			try {
<span class="fc" id="L355">				Document targetDocument = Document.load(new URL(targetURI.toString()));</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">				for (Page page: targetDocument.getPages()) {</span>
<span class="pc bpc" id="L357" title="1 of 4 branches missed.">					if (Util.isBlank(targetURI.fragment()) || URLDecoder.decode(targetURI.fragment(), StandardCharsets.UTF_8).equals(page.getName())) {</span>
<span class="fc" id="L358">						return page;</span>
					}
<span class="fc" id="L360">				}</span>
<span class="nc" id="L361">			} catch (IOException | ParserConfigurationException | SAXException e) {</span>
<span class="nc" id="L362">				throw new NasdanikaException(&quot;Failed to load document from &quot; + targetURI, e);</span>
<span class="nc" id="L363">			}</span>
<span class="nc" id="L364">			throw new IllegalArgumentException(&quot;Linked page not found: &quot; + targetURI);</span>
		}

<span class="nc" id="L367">		return null;</span>
	}

	@Override
	public URI getURI() {
<span class="nc" id="L372">		URI parentURI = getParent().getURI();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">		return parentURI == null ? URI.createURI(URLEncoder.encode(getId(), StandardCharsets.UTF_8)) : parentURI.appendSegment(URLEncoder.encode(getId(), StandardCharsets.UTF_8));</span>
	}
	
	@Override
	public String toString() {
<span class="fc" id="L378">		return super.toString() + &quot; &quot; + getLabel();</span>
	}
	
	@Override
	public boolean equals(Object obj) {
<span class="pc bpc" id="L383" title="2 of 6 branches missed.">		return super.equals(obj) &amp;&amp; obj instanceof ModelElement &amp;&amp; getModel().equals(((ModelElement) obj).getModel());</span>
	}

	@Override
	protected String getMarkerPosition() {
<span class="nc" id="L388">		StringBuilder positionBuilder = new StringBuilder();</span>
<span class="nc" id="L389">		Page page = getModel().getPage();</span>
<span class="nc" id="L390">		positionBuilder.append(&quot;page-name: &quot; + page.getName() + &quot;, page-id: &quot; + page.getId());</span>
<span class="nc" id="L391">		String label = getLabel();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">		if (!Util.isBlank(label)) {</span>
<span class="nc" id="L393">			positionBuilder.append(&quot;, label: &quot;+ label);</span>
		}
<span class="nc" id="L395">		String id = getId();</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">		if (!Util.isBlank(id)) {</span>
<span class="nc" id="L397">			positionBuilder.append(&quot;, id:&quot; + id);</span>
		}
<span class="nc" id="L399">		return positionBuilder.toString();</span>
	}
	
	@Override	
	protected String getMarkerLocation() {
<span class="nc" id="L404">		return ((ElementImpl) getModel().getPage()).getMarkerLocation();</span>
	}
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>