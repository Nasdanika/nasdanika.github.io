<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DrawioEObjectFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Java API for working with Drawio diagrams</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.drawio.emf</a> &gt; <span class="el_source">DrawioEObjectFactory.java</span></div><h1>DrawioEObjectFactory.java</h1><pre class="source lang-java linenums">package org.nasdanika.drawio.emf;

import java.util.LinkedHashMap;
import java.util.Map;

import org.eclipse.emf.ecore.EObject;
import org.jsoup.Jsoup;
import org.nasdanika.common.Context;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.common.Util;
import org.nasdanika.drawio.ModelElement;
import org.nasdanika.drawio.Page;
import org.nasdanika.graph.Element;
import org.nasdanika.graph.processor.ProcessorConfig;
import org.nasdanika.graph.processor.ProcessorInfo;
import org.nasdanika.graph.processor.emf.ResourceSetPropertySourceEObjectFactory;
import org.nasdanika.graph.processor.emf.SemanticProcessor;

/**
 * @author Pavel
 *
 */
<span class="nc" id="L23">public abstract class DrawioEObjectFactory&lt;T extends EObject, P extends SemanticProcessor&lt;T&gt;&gt; extends ResourceSetPropertySourceEObjectFactory&lt;T,P&gt; {</span>
	
	@Override
	protected void setRegistry(ProcessorConfig&lt;P&gt; config, P processor, Map&lt;Element, ProcessorInfo&lt;P&gt;&gt; registry, ProgressMonitor progressMonitor) {
<span class="nc" id="L27">		super.setRegistry(config, processor, registry, progressMonitor);</span>
<span class="nc" id="L28">		Element element = config.getElement();</span>
<span class="nc bnc" id="L29" title="All 2 branches missed.">		if (element instanceof ModelElement) {</span>
<span class="nc" id="L30">			Page linkedPage = ((ModelElement) element).getLinkedPage();</span>
<span class="nc bnc" id="L31" title="All 4 branches missed.">			if (linkedPage != null &amp;&amp; !&quot;false&quot;.equals(getPropertyValue(config.getElement(), getLinkPagePropertyName()))) {</span>
<span class="nc" id="L32">				linkPage(config, processor, registry, registry.get(linkedPage), progressMonitor);</span>
			}
		}				
<span class="nc" id="L35">	}</span>

	protected String getLinkPagePropertyName() {
<span class="nc" id="L38">		return &quot;link-page&quot;;</span>
	}	
	
	/**
	 * Processes elements from the linked page. This implementation collects all page semantic elements without container and processes then as children of this element.
	 * @param config
	 * @param semanticElement
	 * @param registry
	 * @param likedPageInfo
	 */
	protected void linkPage(ProcessorConfig&lt;P&gt; config, P processor, Map&lt;Element, ProcessorInfo&lt;P&gt;&gt; registry, ProcessorInfo&lt;P&gt; linkedPageInfo, ProgressMonitor progressMonitor) {
<span class="nc" id="L49">		ProcessorInfo&lt;P&gt; thisInfo = ProcessorInfo.of(config, processor, null);</span>
<span class="nc" id="L50">		linkedPageInfo.getConfig().getElement().accept(pe -&gt; {</span>
<span class="nc" id="L51">			ProcessorInfo&lt;P&gt; re = registry.get(pe);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">			if (re.getProcessor() != null) {</span>
<span class="nc" id="L53">				setParent(re.getConfig(), re.getProcessor(), thisInfo, progressMonitor, f -&gt; {</span>
<span class="nc" id="L54">					f.printStackTrace(); // Should never happen</span>
<span class="nc" id="L55">				});</span>
			}
<span class="nc" id="L57">		});		</span>
<span class="nc" id="L58">	}</span>
	
	@Override
	protected Context createElementContext(ProcessorConfig&lt;P&gt; config) {
<span class="nc" id="L62">		Context superContext = super.createElementContext(config);</span>
		
<span class="nc" id="L64">		Context context = new Context() {</span>

			@Override
			public Object get(String key) {
<span class="nc bnc" id="L68" title="All 2 branches missed.">				if (Util.isBlank(key)) {</span>
<span class="nc" id="L69">					return null;</span>
				}
				
				// page name
<span class="nc bnc" id="L73" title="All 2 branches missed.">				if (config.getElement() instanceof Page) {</span>
<span class="nc" id="L74">					Page page = (Page) config.getElement();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">					if (&quot;name&quot;.equals(key)) {</span>
<span class="nc" id="L76">						return page.getName();</span>
					}
<span class="nc bnc" id="L78" title="All 2 branches missed.">					if (&quot;id&quot;.equals(key)) {</span>
<span class="nc" id="L79">						return page.getId();</span>
					}
<span class="nc bnc" id="L81" title="All 2 branches missed.">				} else if (config.getElement() instanceof ModelElement) {</span>
<span class="nc" id="L82">					ModelElement modelElement = (ModelElement) config.getElement();</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">					if (&quot;id&quot;.equals(key)) {</span>
<span class="nc" id="L85">						return modelElement.getId();</span>
					}

<span class="nc" id="L88">					String label = modelElement.getLabel();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">					if (&quot;label&quot;.equals(key)) {</span>
<span class="nc" id="L90">						return label;</span>
					}

<span class="nc bnc" id="L93" title="All 2 branches missed.">					if (&quot;label-text&quot;.equals(key)) { // Plain text label							</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">						return (Util.isBlank(label) ? label : Jsoup.parse(label).text());</span>
					}

<span class="nc bnc" id="L97" title="All 2 branches missed.">					if (&quot;link&quot;.equals(key)) {</span>
<span class="nc" id="L98">						return modelElement.getLink();</span>
					}

<span class="nc bnc" id="L101" title="All 2 branches missed.">					if (&quot;tooltip&quot;.equals(key)) {</span>
<span class="nc" id="L102">						return modelElement.getTooltip();</span>
					}
				}
				
<span class="nc" id="L106">				return null;</span>
			}

			@Override
			public &lt;ST&gt; ST get(Class&lt;ST&gt; type) {
<span class="nc" id="L111">				return null;</span>
			}
			
		};
<span class="nc" id="L115">		return context.compose(superContext);</span>
	}
	
	@Override
	protected Object getElementQualifier(ProcessorConfig&lt;P&gt; config) {
<span class="nc" id="L120">		Map&lt;String,Object&gt; qualifier = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L121">		Element element = config.getElement();</span>
<span class="nc" id="L122">		qualifier.put(&quot;type&quot;, element.getClass().getCanonicalName());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (element instanceof Page) {</span>
<span class="nc" id="L124">			qualifier.put(&quot;id&quot;, ((Page) element).getId());</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">		} else if (element instanceof ModelElement) {</span>
<span class="nc" id="L126">			qualifier.put(&quot;id&quot;, ((ModelElement) element).getId());			</span>
		} else {
<span class="nc" id="L128">			qualifier.put(&quot;hash&quot;, element.hashCode());</span>
		}
<span class="nc" id="L130">		return qualifier;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>