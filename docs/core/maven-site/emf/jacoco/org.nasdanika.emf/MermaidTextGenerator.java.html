<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MermaidTextGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika EMF</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.emf</a> &gt; <span class="el_source">MermaidTextGenerator.java</span></div><h1>MermaidTextGenerator.java</h1><pre class="source lang-java linenums">package org.nasdanika.emf;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.stream.Collectors;

import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.common.util.TreeIterator;
import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EClassifier;
import org.eclipse.emf.ecore.EDataType;
import org.eclipse.emf.ecore.EEnum;
import org.eclipse.emf.ecore.EEnumLiteral;
import org.eclipse.emf.ecore.EGenericType;
import org.eclipse.emf.ecore.EModelElement;
import org.eclipse.emf.ecore.ENamedElement;
import org.eclipse.emf.ecore.EOperation;
import org.eclipse.emf.ecore.EPackage;
import org.eclipse.emf.ecore.EParameter;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.EStructuralFeature;
import org.eclipse.emf.ecore.ETypeParameter;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.nasdanika.common.Context;
import org.nasdanika.common.DependencyTracer;
import org.nasdanika.common.NasdanikaException;
import org.nasdanika.common.Util;
import org.nasdanika.ncore.util.NcoreUtil;

/**
 * Generates Mermaid.js class diagram (https://mermaid-js.github.io/mermaid/#/classDiagram) text from Ecore models.
 * 
 * @author Pavel Vlasov
 *
 */
public class MermaidTextGenerator implements DiagramTextGenerator {
	
	private static final String DIAGRAM_STYLE_KEY = &quot;diagram-style&quot;;
	private static final String RELATED_BACKGROUND = &quot;#DDDDDD&quot;;
	
	// Default background: #FEFECE

	// TODO - support of packages and fully qualified names -&gt; get rid of Logical name?
	
	private Appendable collector;
	private Function&lt;EClassifier, String&gt; eClassifierLinkResolver;
	private Function&lt;EModelElement, String&gt; eModelElementFirstDocSentenceProvider;
	private Predicate&lt;EModelElement&gt; elementPredicate;

	public MermaidTextGenerator(
			Appendable collector, 
			Predicate&lt;EModelElement&gt; elementPredicate,			
			Function&lt;EClassifier, String&gt; eClassifierLinkResolver, 
<span class="nc" id="L63">			Function&lt;EModelElement, String&gt; eModelElementFirstDocSentenceProvider) {</span>
<span class="nc" id="L64">		this.collector = collector;</span>
<span class="nc" id="L65">		this.elementPredicate = elementPredicate;</span>
<span class="nc" id="L66">		this.eClassifierLinkResolver = eClassifierLinkResolver;</span>
<span class="nc" id="L67">		this.eModelElementFirstDocSentenceProvider = eModelElementFirstDocSentenceProvider;</span>
<span class="nc" id="L68">	}</span>
	
	private static final String EXTENDS_RELATION = &quot;&lt;|--&quot;; 
	private static final String IMPLEMENTS_RELATION = &quot;&lt;|..&quot;;
	private static final String DEPENDENCY_RELATION = &quot;..&gt;&quot;;	
	private static final String CLASS_COMPARTMENT_SEPARATOR_LINE = &quot;\t__\n&quot;;

	protected void appendClassStart(String modifiers, String classType, String name, String link, String style) throws IOException {
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (modifiers != null) {</span>
<span class="nc" id="L77">			collector.append(modifiers);</span>
<span class="nc" id="L78">			collector.append(&quot; &quot;);</span>
		}
		
<span class="nc" id="L81">		collector</span>
<span class="nc" id="L82">			.append(classType)</span>
<span class="nc" id="L83">			.append(&quot; &quot;)</span>
<span class="nc" id="L84">			.append(name)</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">			.append(Util.isBlank(link) ? &quot;&quot; : &quot; [[&quot; + link + &quot;]]&quot;)</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">			.append(Util.isBlank(style) ? &quot;&quot; : &quot; &quot; + style)</span>
<span class="nc" id="L87">			.append(&quot; {\n&quot;);</span>
<span class="nc" id="L88">	}</span>
	
	protected String getLocalizedName(ENamedElement namedElement) {
<span class="nc" id="L91">		return EObjectAdaptable.getResourceContext(namedElement).getString(&quot;label&quot;, namedElement.getName());</span>
	}
	
	protected void appendClassEnd() throws IOException {
<span class="nc" id="L95">		collector.append(&quot;}\n&quot;);</span>
<span class="nc" id="L96">	}</span>

	private static String getSimpleName(String name) {
<span class="nc bnc" id="L99" title="All 2 branches missed.">		return name==null ? null : name.substring(name.lastIndexOf('.') + 1);</span>
	}

	protected void appendMember(String modifiers, String visibility, String type, String name, Iterable&lt;String&gt; parameters) throws IOException {
<span class="nc" id="L103">		collector.append(&quot;\t&quot;);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (visibility != null) {</span>
<span class="nc" id="L105">			collector.append(visibility);</span>
		}
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (modifiers != null) {</span>
<span class="nc" id="L108">			collector.append(modifiers);</span>
<span class="nc" id="L109">			collector.append(&quot; &quot;);</span>
		}
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (type != null) {</span>
<span class="nc" id="L112">			collector.append(type);</span>
<span class="nc" id="L113">			collector.append(&quot; &quot;);</span>
		}
<span class="nc bnc" id="L115" title="All 2 branches missed.">		if (name != null) {</span>
<span class="nc" id="L116">			collector.append(name);</span>
		}
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (parameters != null) {</span>
<span class="nc" id="L119">			collector.append(&quot;(&quot;);</span>
<span class="nc" id="L120">			Iterator&lt;String&gt; it = parameters.iterator();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L122">				collector.append(it.next());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">				if (it.hasNext()) {</span>
<span class="nc" id="L124">					collector.append(&quot;, &quot;);</span>
				}
			}
<span class="nc" id="L127">			collector.append(&quot;)&quot;);</span>
		}
<span class="nc" id="L129">		collector.append(&quot;\n&quot;);</span>
<span class="nc" id="L130">	}</span>
	
	protected void appendAttribute(String modifiers, String visibility, String type, String name) throws IOException {
<span class="nc" id="L133">		appendMember(modifiers, visibility, type, name, null);</span>
<span class="nc" id="L134">	}</span>

	protected void appendOperation(String modifiers, String visibility, String type, String name, Iterable&lt;String&gt; parameters) throws IOException {
<span class="nc" id="L137">		appendMember(modifiers, visibility, type, name, parameters);</span>
<span class="nc" id="L138">	}</span>
		
	public void appendGeneralization(EClass subClass, EGenericType superType) throws IOException {
<span class="nc" id="L141">		EClass superClass = (EClass) superType.getEClassifier();</span>
<span class="nc" id="L142">		collector</span>
<span class="nc" id="L143">			.append(qualifiedName(superClass))</span>
<span class="nc" id="L144">			.append(&quot; &quot;)</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">			.append(superClass.isInterface() &amp;&amp; !subClass.isInterface() ? IMPLEMENTS_RELATION : EXTENDS_RELATION)</span>
<span class="nc" id="L146">			.append(&quot; &quot;)</span>
<span class="nc" id="L147">			.append(qualifiedName(subClass));</span>
		
<span class="nc bnc" id="L149" title="All 2 branches missed.">		if (!superType.getETypeArguments().isEmpty()) {</span>
<span class="nc" id="L150">			collector.append(&quot; : &lt;&quot;);</span>
<span class="nc" id="L151">			Iterator&lt;EGenericType&gt; it = superType.getETypeArguments().iterator();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L153">				collector.append(genericName(it.next()));</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">				if (it.hasNext()) {</span>
<span class="nc" id="L155">					collector.append(&quot;,&quot;);</span>
				}
			}
<span class="nc" id="L158">			collector.append(&quot;&gt;&quot;);</span>
		}		
		
<span class="nc" id="L161">		collector.append(&quot;\n&quot;);</span>
<span class="nc" id="L162">	}</span>
		
	// --- ECore ---
	
<span class="nc" id="L166">	private DependencyTracer&lt;EClassifier&gt; OUT_DEPENDENCY_TRACER = new DependencyTracer&lt;EClassifier&gt;() {</span>

		@Override
		protected Iterable&lt;EClassifier&gt; getDependencies(EClassifier obj) {
<span class="nc" id="L170">			Collection&lt;EClassifier&gt; ret = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if (obj instanceof EClass) {</span>
<span class="nc" id="L172">				EClass eClass = (EClass) obj;</span>
<span class="nc" id="L173">				ret.addAll(eClass.getESuperTypes());</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">				for (EReference ref: eClass.getEReferences()) {</span>
<span class="nc" id="L175">					ret.add(ref.getEReferenceType());</span>
<span class="nc" id="L176">				}</span>
				
<span class="nc" id="L178">				ret.addAll(EmfUtil.collectTypeDependencies(eClass));				</span>
			}
<span class="nc" id="L180">			return ret;</span>
		}
		
	};
		
<span class="nc" id="L185">	private DependencyTracer&lt;EClassifier&gt; inDependencyTracer = new DependencyTracer&lt;EClassifier&gt;() {</span>

		@Override
		protected Iterable&lt;EClassifier&gt; getDependencies(EClassifier obj) {
<span class="nc" id="L189">			Collection&lt;EClassifier&gt; ret = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if (obj instanceof EClass) {</span>
<span class="nc" id="L191">				ret.addAll(getSubTypes((EClass) obj));</span>
<span class="nc" id="L192">				ret.addAll(getReferrers((EClass) obj));</span>
			}
<span class="nc" id="L194">			ret.addAll(getUses(obj));</span>
<span class="nc" id="L195">			return ret;</span>
		}
		
	};
		
<span class="nc" id="L200">	private DependencyTracer&lt;EClassifier&gt; bothDependencyTracer = new DependencyTracer&lt;EClassifier&gt;() {</span>
	
		@Override
		protected Iterable&lt;EClassifier&gt; getDependencies(EClassifier obj) {
<span class="nc" id="L204">			Collection&lt;EClassifier&gt; ret = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">			if (obj instanceof EClass) {</span>
				// In
<span class="nc" id="L207">				EClass eClass = (EClass) obj;</span>
<span class="nc" id="L208">				ret.addAll(getSubTypes(eClass));</span>
<span class="nc" id="L209">				ret.addAll(getReferrers(eClass));</span>
				
				// Out
<span class="nc" id="L212">				ret.addAll(eClass.getESuperTypes());</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">				for (EReference ref: eClass.getEReferences()) {</span>
<span class="nc" id="L214">					ret.add(ref.getEReferenceType());</span>
<span class="nc" id="L215">				}</span>
				
<span class="nc" id="L217">				ret.addAll(EmfUtil.collectTypeDependencies(eClass));				</span>
			}

			// In
<span class="nc" id="L221">			ret.addAll(getUses(obj));</span>
			
<span class="nc" id="L223">			return ret;</span>
		}
		
	};
	
	
	/**
	 * Appends core classifiers, their related classifiers, and relationships
	 * @param coreClassifiers
	 * @throws IOException 
	 */
	@Override
	public void appendWithRelationships(
			Collection&lt;? extends EClassifier&gt; coreClassifiers,
			RelationshipDirection direction,
			int depth) {
		
		try {
<span class="nc" id="L241">			Set&lt;EClassifier&gt; coreSet = new HashSet&lt;&gt;(coreClassifiers);				</span>
<span class="nc" id="L242">			Set&lt;EClassifier&gt; relatedSet = new HashSet&lt;&gt;();</span>
			
<span class="nc bnc" id="L244" title="All 4 branches missed.">			switch (direction) {</span>
			case both:
<span class="nc" id="L246">				relatedSet = bothDependencyTracer.trace(coreSet, depth);</span>
<span class="nc" id="L247">				break;</span>
			case in:
<span class="nc" id="L249">				relatedSet = inDependencyTracer.trace(coreSet, depth);</span>
<span class="nc" id="L250">				break;</span>
			case out:
<span class="nc" id="L252">				relatedSet = OUT_DEPENDENCY_TRACER.trace(coreSet, depth);</span>
<span class="nc" id="L253">				break;</span>
			default:
				break;		
			}
			
<span class="nc" id="L258">			Set&lt;EClassifier&gt; allClassifiers = new HashSet&lt;&gt;(coreSet);</span>
			
<span class="nc bnc" id="L260" title="All 2 branches missed.">			for (EClassifier rc: relatedSet) {</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">				if (!coreSet.contains(rc) &amp;&amp; getEClassifierLink(rc) != null) {</span>
<span class="nc" id="L262">					allClassifiers.add(rc);				</span>
				}
<span class="nc" id="L264">			}</span>
			
<span class="nc bnc" id="L266" title="All 2 branches missed.">			for (EClassifier cc: coreSet) {</span>
<span class="nc" id="L267">				appendEClassifier(cc, allClassifiers);</span>
<span class="nc" id="L268">			}</span>
			
<span class="nc bnc" id="L270" title="All 2 branches missed.">			for (EClassifier rc: relatedSet) {</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">				if (!coreSet.contains(rc) &amp;&amp; getEClassifierLink(rc) != null) {</span>
<span class="nc" id="L272">					String style = NcoreUtil.getNasdanikaAnnotationDetail(rc, DIAGRAM_STYLE_KEY);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">					if (style == null) {</span>
<span class="nc" id="L274">						style = RELATED_BACKGROUND;</span>
					} else {
<span class="nc" id="L276">						style = Context.singleton(&quot;background&quot;, RELATED_BACKGROUND).interpolateToString(style);</span>
					}
					
<span class="nc" id="L279">					appendEClassifier(rc, style, allClassifiers);</span>
				}
<span class="nc" id="L281">			}		</span>
			
<span class="nc bnc" id="L283" title="All 2 branches missed.">			for (EClassifier c: allClassifiers) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">				if (c instanceof EClass) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">					for (EGenericType gsc: ((EClass) c).getEGenericSuperTypes()) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">						if (allClassifiers.contains(gsc.getEClassifier())) {</span>
<span class="nc" id="L287">							appendGeneralization((EClass) c, gsc);</span>
						}
<span class="nc" id="L289">					}</span>
				}
<span class="nc" id="L291">			}</span>
			
<span class="nc" id="L293">			Set&lt;EReference&gt; processedOpposites = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">			for (EClassifier c: allClassifiers) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">				if (c instanceof EClass) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">					for (EReference ref: ((EClass) c).getEReferences()) {</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">						if (!processedOpposites.contains(ref) &amp;&amp; allClassifiers.contains(ref.getEReferenceType())) {</span>
<span class="nc" id="L298">							appendEReference(ref);</span>
<span class="nc" id="L299">							EReference opposite = NcoreUtil.getOpposite(ref);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">							if (opposite!=null) {</span>
<span class="nc" id="L301">								processedOpposites.add(opposite);</span>
							}
						} 
<span class="nc" id="L304">					}</span>
				}
<span class="nc" id="L306">			}	</span>
			
			// Type dependencies
<span class="nc bnc" id="L309" title="All 2 branches missed.">			for (EClassifier c: allClassifiers) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">				for (EClass src: getUses(c)) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">					if (allClassifiers.contains(src)) {</span>
<span class="nc" id="L312">						appendTypeDependency(src, c);</span>
					}				
<span class="nc" id="L314">				}</span>
<span class="nc" id="L315">			}</span>
<span class="nc" id="L316">		} catch (IOException e) {</span>
<span class="nc" id="L317">			throw new NasdanikaException(e);</span>
<span class="nc" id="L318">		}</span>
<span class="nc" id="L319">	}</span>
	
	protected static String getMultiplicity(EStructuralFeature feature) {
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (feature.isMany()) {</span>
<span class="nc" id="L323">			int lowerBound = feature.getLowerBound();</span>
<span class="nc" id="L324">			int upperBound = feature.getUpperBound();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">			if (lowerBound == upperBound) {</span>
<span class="nc" id="L326">				return String.valueOf(lowerBound);</span>
			}
<span class="nc bnc" id="L328" title="All 4 branches missed.">			if (lowerBound==0 &amp;&amp; upperBound==-1) {</span>
<span class="nc" id="L329">				return &quot;*&quot;;</span>
			}
<span class="nc bnc" id="L331" title="All 2 branches missed.">			return String.valueOf(lowerBound)+&quot;..&quot;+(upperBound == -1 ? &quot;*&quot; : upperBound);</span>
		}
		
<span class="nc" id="L334">		return &quot;&quot;;</span>
	}	
	
	/**
	 * @param ref
	 * @return Empty string if there are no EKeys, a comma separated list of EKeys in parenthesis otherwise.
	 */
	protected String eKeys(EReference ref) {
<span class="nc" id="L342">		StringBuilder ret = new StringBuilder();</span>
<span class="nc" id="L343">		EList&lt;EAttribute&gt; eKeys = ref.getEKeys();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">		if (!eKeys.isEmpty()) {</span>
<span class="nc" id="L345">			ret.append(&quot;(&quot;);		</span>
<span class="nc" id="L346">			ret.append(String.join(&quot;,&quot;, eKeys.stream().map(this::getLocalizedName).collect(Collectors.toList())));</span>
<span class="nc" id="L347">			ret.append(&quot;)&quot;);</span>
		}
		
<span class="nc" id="L350">		return ret.toString();</span>
	}
	
	protected void appendEReference(EReference ref) throws IOException {
<span class="nc" id="L354">		collector.append(qualifiedName(ref.getEContainingClass()));</span>
<span class="nc" id="L355">		collector.append(&quot; &quot;);</span>
<span class="nc" id="L356">		EReference opposite = NcoreUtil.getOpposite(ref);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if (ref.isContainment()) {</span>
<span class="nc" id="L358">			collector.append(&quot;*&quot;);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">		} else if (opposite!=null) {</span>
<span class="nc" id="L360">			collector.append(&quot;\&quot;&quot;);</span>
<span class="nc" id="L361">			collector.append(getLocalizedName(opposite));</span>
<span class="nc" id="L362">			collector.append(eKeys(opposite));</span>
<span class="nc" id="L363">			String multiplicity = getMultiplicity(opposite);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">			if (!multiplicity.isEmpty()) {</span>
<span class="nc" id="L365">				collector.append(&quot;[&quot;+multiplicity+&quot;]&quot;);</span>
			}
<span class="nc" id="L367">			collector.append(&quot;\&quot; &quot;);</span>
		}
		
<span class="nc" id="L370">		String diagramStyle = NcoreUtil.getNasdanikaAnnotationDetail(ref, DIAGRAM_STYLE_KEY);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">		String relationLine = Util.isBlank(diagramStyle) ? &quot;--&quot; : &quot;-[&quot; + diagramStyle + &quot;]-&quot;;</span>
<span class="nc" id="L372">		String associationRelation = relationLine + &quot;&gt;&quot;;</span>
		
<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (opposite == null) {</span>
<span class="nc" id="L375">			collector.append(associationRelation);</span>
		} else {
<span class="nc" id="L377">			collector.append(relationLine);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">			if (opposite.isContainment()) {</span>
<span class="nc" id="L379">				collector.append(&quot;*&quot;);</span>
			}
		}		
<span class="nc" id="L382">		collector.append(&quot; &quot;);</span>
		
<span class="nc" id="L384">		String multiplicity = getMultiplicity(ref);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">		if (opposite == null) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">			if (!multiplicity.isEmpty()) {</span>
<span class="nc" id="L387">				collector</span>
<span class="nc" id="L388">					.append(&quot;\&quot;&quot;)</span>
<span class="nc" id="L389">					.append(multiplicity)</span>
<span class="nc" id="L390">					.append(&quot;\&quot; &quot;);						</span>
			}
		} else {
<span class="nc" id="L393">			collector.append(&quot;\&quot;&quot;);</span>
<span class="nc" id="L394">			collector.append(getLocalizedName(ref));			</span>
<span class="nc" id="L395">			collector.append(eKeys(ref));</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">			if (!multiplicity.isEmpty()) {</span>
<span class="nc" id="L397">				collector.append(&quot;[&quot;+multiplicity+&quot;]&quot;);</span>
			}
<span class="nc" id="L399">			collector.append(&quot;\&quot; &quot;);			</span>
		}		
		
<span class="nc" id="L402">		collector.append(qualifiedName(ref.getEReferenceType()));		</span>
		
<span class="nc bnc" id="L404" title="All 2 branches missed.">		if (opposite == null) {</span>
<span class="nc" id="L405">			collector</span>
<span class="nc" id="L406">				.append(&quot; : &quot;)</span>
<span class="nc" id="L407">				.append(getLocalizedName(ref));</span>

<span class="nc" id="L409">			collector.append(eKeys(ref));			</span>
<span class="nc" id="L410">			collector.append(genericTypeArguments(ref.getEGenericType()));</span>
		}
		
<span class="nc" id="L413">		collector.append(System.lineSeparator());</span>
<span class="nc" id="L414">	}</span>
	
	protected void appendTypeDependency(EClass source, EClassifier target) throws IOException {
<span class="nc" id="L417">		collector.append(qualifiedName(source));</span>
<span class="nc" id="L418">		collector.append(&quot; &quot;);</span>
<span class="nc" id="L419">		collector.append(DEPENDENCY_RELATION);</span>
<span class="nc" id="L420">		collector.append(&quot; &quot;);</span>
<span class="nc" id="L421">		collector.append(qualifiedName(target));		</span>
<span class="nc" id="L422">		collector.append(System.lineSeparator());</span>
<span class="nc" id="L423">	}</span>
	
	/**
	 * Finds all subtypes in the resourceset. 
	 * @return
	 */
	protected Collection&lt;EClass&gt; getSubTypes(EClass eClass) {
		TreeIterator&lt;?&gt; acit;
<span class="nc" id="L431">		Resource eResource = eClass.eResource();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">		if (eResource == null) {</span>
<span class="nc" id="L433">			EPackage ePackage = eClass.getEPackage();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">			if (ePackage == null) {</span>
<span class="nc" id="L435">				return Collections.emptySet();</span>
			}
<span class="nc" id="L437">			acit = ePackage.eAllContents();</span>
<span class="nc" id="L438">		} else {</span>
<span class="nc" id="L439">			ResourceSet resourceSet = eResource.getResourceSet();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">			acit = resourceSet == null ? eResource.getAllContents() : resourceSet.getAllContents();</span>
		}
<span class="nc" id="L442">		Set&lt;EClass&gt; ret = new HashSet&lt;&gt;();</span>
<span class="nc" id="L443">		acit.forEachRemaining(obj -&gt; {</span>
<span class="nc bnc" id="L444" title="All 4 branches missed.">			if (obj instanceof EClass &amp;&amp; ((EClass) obj).getESuperTypes().contains(eClass)) {</span>
<span class="nc" id="L445">				ret.add((EClass) obj);</span>
			}
<span class="nc" id="L447">		});</span>
<span class="nc" id="L448">		return ret;</span>
	}
	
	/**
	 * Finds all referrers in the resourceset. 
	 * @return
	 */
	protected Collection&lt;EClass&gt; getReferrers(EClass eClass) {
		TreeIterator&lt;?&gt; acit;
<span class="nc" id="L457">		Resource eResource = eClass.eResource();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">		if (eResource == null) {</span>
<span class="nc" id="L459">			EPackage ePackage = eClass.getEPackage();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">			if (ePackage == null) {</span>
<span class="nc" id="L461">				return Collections.emptySet();</span>
			}
<span class="nc" id="L463">			acit = ePackage.eAllContents();</span>
<span class="nc" id="L464">		} else {</span>
<span class="nc" id="L465">			ResourceSet resourceSet = eResource.getResourceSet();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			acit = resourceSet == null ? eResource.getAllContents() : resourceSet.getAllContents();</span>
		}
<span class="nc" id="L468">		Set&lt;EClass&gt; ret = new HashSet&lt;&gt;();</span>
<span class="nc" id="L469">		acit.forEachRemaining(obj -&gt; {</span>
<span class="nc bnc" id="L470" title="All 4 branches missed.">			if (obj instanceof EReference &amp;&amp; ((EReference) obj).getEReferenceType() == eClass) {</span>
<span class="nc" id="L471">				ret.add(((EReference) obj).getEContainingClass());</span>
			}
<span class="nc" id="L473">		});</span>
<span class="nc" id="L474">		return ret;</span>
	}
	
	/**
	 * Finds all type uses in the resourceset. 
	 * @return
	 */
	protected Collection&lt;EClass&gt; getUses(EClassifier eClassifier) {
		TreeIterator&lt;?&gt; acit;
<span class="nc" id="L483">		Resource eResource = eClassifier.eResource();</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">		if (eResource == null) {</span>
<span class="nc" id="L485">			EPackage ePackage = eClassifier.getEPackage();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">			if (ePackage == null) {</span>
<span class="nc" id="L487">				return Collections.emptySet();</span>
			}
<span class="nc" id="L489">			acit = ePackage.eAllContents();</span>
<span class="nc" id="L490">		} else {</span>
<span class="nc" id="L491">			ResourceSet resourceSet = eResource.getResourceSet();</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">			acit = resourceSet == null ? eResource.getAllContents() : resourceSet.getAllContents();</span>
		}
<span class="nc" id="L494">		Set&lt;EClass&gt; ret = new HashSet&lt;&gt;();</span>
<span class="nc" id="L495">		acit.forEachRemaining(obj -&gt; {</span>
<span class="nc bnc" id="L496" title="All 4 branches missed.">			if (obj instanceof EClass &amp;&amp; EmfUtil.collectTypeDependencies((EClass) obj).contains(eClassifier)) {</span>
<span class="nc" id="L497">				ret.add((EClass) obj);</span>
			}
<span class="nc" id="L499">		});</span>
<span class="nc" id="L500">		return ret;</span>
	}
		
	public void appendEClassifier(EClassifier eClassifier, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc" id="L504">		String style = Context.EMPTY_CONTEXT.interpolateToString(NcoreUtil.getNasdanikaAnnotationDetail(eClassifier, DIAGRAM_STYLE_KEY));</span>
<span class="nc" id="L505">		appendEClassifier(eClassifier, style, allClassifiers);</span>
<span class="nc" id="L506">	}</span>
	
	public void appendEClassifier(EClassifier eClassifier, String style, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc bnc" id="L509" title="All 2 branches missed.">		if (eClassifier instanceof EClass) {</span>
<span class="nc" id="L510">			appendEClass((EClass) eClassifier, style, allClassifiers);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">		} else if (eClassifier instanceof EEnum) {</span>
<span class="nc" id="L512">			appendEEnum((EEnum) eClassifier, style, allClassifiers);			</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">		} else if (eClassifier instanceof EDataType) {</span>
<span class="nc" id="L514">			appendEDataType((EDataType) eClassifier, style, allClassifiers);</span>
		}
<span class="nc" id="L516">	}</span>
	
	protected String qualifiedName(EClassifier eClassifier) {
<span class="nc" id="L519">		EPackage ePackage = eClassifier.getEPackage();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">		if (ePackage == null) {</span>
<span class="nc" id="L521">			return getLocalizedName(eClassifier);				</span>
		}
<span class="nc" id="L523">		return &quot;\&quot;&quot;+getLocalizedName(ePackage)+&quot; (&quot;+ePackage.getNsURI()+&quot;).&quot;+getLocalizedName(eClassifier)+&quot;\&quot;&quot;;</span>
	}	
	
	protected String typeParameters(EClassifier eClassifier) {
<span class="nc bnc" id="L527" title="All 2 branches missed.">		if (eClassifier.getETypeParameters().isEmpty()) {</span>
<span class="nc" id="L528">			return &quot;&quot;;</span>
		}
<span class="nc" id="L530">		StringBuilder typeParameters = new StringBuilder();</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">		for (ETypeParameter typeParameter: eClassifier.getETypeParameters()) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">			if (typeParameters.length() &gt; 0) {</span>
<span class="nc" id="L533">				typeParameters.append(&quot;,&quot;);</span>
			}
<span class="nc" id="L535">			typeParameters.append(genericName(typeParameter));</span>
<span class="nc" id="L536">		}		</span>
		
<span class="nc" id="L538">		return &quot;&lt;&quot; + typeParameters +&quot;&gt;&quot;;</span>
	}	
	
	protected String genericName(ETypeParameter typeParameter) {
<span class="nc" id="L542">		StringBuilder ret = new StringBuilder(typeParameter.getName());</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">		for (EGenericType bound : typeParameter.getEBounds()) {</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">			if (bound.getEUpperBound() != null) {</span>
<span class="nc" id="L545">				ret.append(&quot; extends &quot;).append(genericName(bound.getEUpperBound()));</span>
			}
<span class="nc bnc" id="L547" title="All 2 branches missed.">			if (bound.getELowerBound() != null) {</span>
<span class="nc" id="L548">				ret.append(&quot; super &quot;).append(genericName(bound.getELowerBound()));</span>
			}
<span class="nc" id="L550">		}</span>
		
<span class="nc" id="L552">		return ret.toString();</span>
	}
	
	protected String genericName(EGenericType eGenericType) {
<span class="nc bnc" id="L556" title="All 2 branches missed.">		if (eGenericType == null) {</span>
<span class="nc" id="L557">			return &quot;void&quot;;</span>
		}
<span class="nc" id="L559">		StringBuilder ret = new StringBuilder();		</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">		if (eGenericType.getETypeParameter() != null) {</span>
<span class="nc" id="L561">			ret.append(eGenericType.getETypeParameter().getName());</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">		} else if (eGenericType.getEClassifier() != null) {</span>
<span class="nc" id="L563">			ret.append(eGenericType.getEClassifier().getName());			</span>
		}
<span class="nc" id="L565">		ret.append(genericTypeArguments(eGenericType));</span>
<span class="nc" id="L566">		return ret.toString();</span>
	}

	protected String genericTypeArguments(EGenericType eGenericType) {
<span class="nc" id="L570">		StringBuilder ret = new StringBuilder();</span>
<span class="nc" id="L571">		Iterator&lt;EGenericType&gt; it = eGenericType.getETypeArguments().iterator();</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">		if (it.hasNext()) {</span>
<span class="nc" id="L573">			ret.append(&quot;&lt;&quot;);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L575">				ret.append(genericName(it.next()));</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">				if (it.hasNext()) {</span>
<span class="nc" id="L577">					ret.append(&quot;,&quot;);</span>
				}
			}
<span class="nc" id="L580">			ret.append(&quot;&gt;&quot;);</span>
		}
<span class="nc" id="L582">		return ret.toString();</span>
	}

	public void appendEClass(EClass eClass, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc" id="L586">		appendEClass(eClass, null, allClassifiers);</span>
<span class="nc" id="L587">	}</span>
	
	public void appendEClass(EClass eClass, String style, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc bnc" id="L590" title="All 4 branches missed.">		String modifiers = eClass.isAbstract() &amp;&amp; !eClass.isInterface() ? &quot;abstract&quot; : null;</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">		appendClassStart(modifiers, eClass.isInterface() ? &quot;interface&quot; : &quot;class&quot;, qualifiedName(eClass) + typeParameters(eClass), getEClassifierLink(eClass), style);</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">		if (isAppendAttributes(eClass)) {</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">			for (EAttribute attribute: eClass.getEAttributes().stream().sorted((a,b) -&gt; a.getName().compareTo(b.getName())).collect(Collectors.toList())) {			</span>
<span class="nc" id="L594">				EGenericType eGenericType = attribute.getEGenericType();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">				if (eGenericType != null) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">					appendAttribute(null, null, genericName(eGenericType) + (attribute.isMany() ? &quot;[]&quot; : &quot;&quot;), getLocalizedName(attribute));</span>
				}						
<span class="nc" id="L598">			}</span>
		}
<span class="nc" id="L600">		collector.append(CLASS_COMPARTMENT_SEPARATOR_LINE);</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">		for (EReference reference: eClass.getEReferences().stream().sorted((a,b) -&gt; a.getName().compareTo(b.getName())).collect(Collectors.toList())) {</span>
<span class="nc" id="L602">			EGenericType eGenericType = reference.getEGenericType();			</span>
<span class="nc bnc" id="L603" title="All 4 branches missed.">			if (eGenericType == null || !allClassifiers.contains(reference.getEReferenceType())) {</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">				appendAttribute(null, null, genericName(eGenericType) + (reference.isMany() ? &quot;[]&quot; : &quot;&quot;), getLocalizedName(reference));</span>
			}						
<span class="nc" id="L606">		}</span>
		
<span class="nc" id="L608">		collector.append(CLASS_COMPARTMENT_SEPARATOR_LINE);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">		if (isAppendOperations(eClass)) {</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">			for (EOperation op : eClass.getEOperations().stream().sorted((a,b) -&gt; a.getName().compareTo(b.getName())).collect(Collectors.toList())) {</span>
<span class="nc" id="L611">				Collection&lt;String&gt; parameters = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">				for (EParameter parameter : op.getEParameters()) {</span>
<span class="nc" id="L613">					String paramString = getLocalizedName(parameter);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">					if (parameter.getEGenericType() != null) {</span>
<span class="nc" id="L615">						paramString = genericName(parameter.getEGenericType()) + &quot; &quot; + paramString;</span>
					}
<span class="nc" id="L617">					parameters.add(paramString);</span>
<span class="nc" id="L618">				}</span>
<span class="nc" id="L619">				appendOperation(null, null, genericName(op.getEGenericType()), getLocalizedName(op), parameters);</span>
<span class="nc" id="L620">			}</span>
		}
<span class="nc" id="L622">		appendClassEnd();</span>
<span class="nc" id="L623">	}</span>

	/**
	 * Constructs {@link EClassifier} with the first documentation sentence as a tooltip. 
	 * @param eClassifier
	 * @return
	 */
	protected String getEClassifierLink(EClassifier eClassifier) {
<span class="nc" id="L631">		String link = null;</span>
<span class="nc bnc" id="L632" title="All 4 branches missed.">		if (eClassifier != null &amp;&amp; eClassifierLinkResolver != null) {</span>
<span class="nc" id="L633">			link = eClassifierLinkResolver.apply(eClassifier);</span>
<span class="nc bnc" id="L634" title="All 4 branches missed.">			if (link != null &amp;&amp; eModelElementFirstDocSentenceProvider != null) {</span>
<span class="nc" id="L635">				String firstDocSentence = eModelElementFirstDocSentenceProvider.apply(eClassifier);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">				if (!org.nasdanika.common.Util.isBlank(firstDocSentence)) {</span>
<span class="nc" id="L637">					link += &quot;{&quot; + firstDocSentence + &quot;}&quot;;</span>
				}
			}
		}
<span class="nc" id="L641">		return link;</span>
	}
	
	protected boolean isAppendAttributes(EClass eClass) {
<span class="nc" id="L645">		return true;</span>
	}
	
	protected boolean isAppendOperations(EClass eClass) {
<span class="nc" id="L649">		return true;</span>
	}

	public void appendEDataType(EDataType dataType, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc" id="L653">		appendEDataType(dataType, null, allClassifiers);</span>
<span class="nc" id="L654">	}	</span>
	
	public void appendEDataType(EDataType dataType, String background, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc" id="L657">		appendClassStart(null, &quot;class&quot;, qualifiedName(dataType)+&quot; &lt;&lt; (D,orchid) &gt;&gt;&quot;, getEClassifierLink(dataType), background);</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		if (dataType.getInstanceClassName() != null) {</span>
<span class="nc" id="L659">			appendAttribute(null, null, null, dataType.getInstanceClassName());</span>
		}
<span class="nc" id="L661">		appendClassEnd();</span>
<span class="nc" id="L662">	}</span>

	public void appendEEnum(EEnum eEnum, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc" id="L665">		appendEEnum(eEnum, null, allClassifiers);</span>
<span class="nc" id="L666">	}</span>
	
	public void appendEEnum(EEnum eEnum, String background, Set&lt;EClassifier&gt; allClassifiers) throws IOException {
<span class="nc" id="L669">		appendClassStart(null, &quot;enum&quot;, qualifiedName(eEnum), getEClassifierLink(eEnum), background);</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">		for (EEnumLiteral literal : eEnum.getELiterals()) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">			appendAttribute(String.valueOf(literal.getValue()), null, getLocalizedName(literal), literal.getName().equals(literal.getLiteral()) ? &quot;&quot; : literal.getLiteral());</span>
<span class="nc" id="L672">		}</span>
<span class="nc" id="L673">		appendClassEnd();</span>
<span class="nc" id="L674">	}</span>

	protected String getTypeName(EClassifier type) {
<span class="nc" id="L677">		String typeName = null;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">		if (type != null) {</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">			if (type instanceof EDataType) {</span>
<span class="nc" id="L680">				typeName = type.getInstanceClassName();</span>
			}
<span class="nc bnc" id="L682" title="All 2 branches missed.">			if (typeName == null) {</span>
<span class="nc" id="L683">				typeName = getLocalizedName(type);</span>
			}
		}
<span class="nc" id="L686">		return getSimpleName(typeName);</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>