<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EObjectAdaptable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika EMF</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.emf</a> &gt; <span class="el_source">EObjectAdaptable.java</span></div><h1>EObjectAdaptable.java</h1><pre class="source lang-java linenums">package org.nasdanika.emf;

import java.util.Collection;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

import org.eclipse.emf.common.notify.Adapter;
import org.eclipse.emf.common.notify.AdapterFactory;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.util.EcoreUtil;
import org.nasdanika.common.AccessController;
import org.nasdanika.common.Adaptable;
import org.nasdanika.common.ConsumerFactory;
import org.nasdanika.common.Context;
import org.nasdanika.common.Converter;
import org.nasdanika.common.DefaultConverter;
import org.nasdanika.common.Function;
import org.nasdanika.common.FunctionFactory;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.common.ResourceLocator;
import org.nasdanika.common.SupplierFactory;

/**
 * Bridges {@link Adaptable} and EObject adaptation framework - {@link Adapter}.
 * This class also adapts to {@link AccessController} by delegating to the container and adding containment feature to the 
 * qualifier. E.g. if an object Account is contained by Customer under accounts reference and Account is not adaptable to AccessController
 * then this adaptable would adapt Customer to AccessController and if successful will append 'accounts' suffix to the qualifier. 
 * This behavior allows to bubble-up permissions checks. 
 * @author Pavel
 *
 * @param &lt;T&gt;
 */
public class EObjectAdaptable&lt;T extends EObject&gt; implements Adaptable {
	
	protected T target;

<span class="nc" id="L39">	public EObjectAdaptable(T target) {</span>
<span class="nc" id="L40">		this.target = target;</span>
<span class="nc" id="L41">	}</span>
	
	@Override
	public &lt;A&gt; A adaptTo(Class&lt;A&gt; type) {
<span class="nc" id="L45">		return adaptTo(target, type);</span>
	}		

	/**
	 * Adapts target to ResourceLocator and returns context or empty context if there is no context, i.e. the context is never null.
	 * @param target
	 * @return
	 */
	public static Context getResourceContext(EObject target) {
<span class="nc" id="L54">		return Context.EMPTY_CONTEXT.compose(EObjectAdaptable.adaptTo(target, ResourceLocator.class));</span>
	}
	
	/**
	 * Adapts target to ResourceLocator and returns context or empty context if there is no context, i.e. the context is never null.
	 * @param target
	 * @return
	 */
	protected Context getResourceContext() {
<span class="nc" id="L63">		return getResourceContext(target);</span>
	}
	
	public static &lt;A&gt; A adaptTo(EObject target, Class&lt;A&gt; type) {
<span class="nc" id="L67">		return adaptTo(target, type, null);</span>
	}
			
	@SuppressWarnings(&quot;unchecked&quot;)
	public static &lt;A&gt; A adaptTo(EObject target, Class&lt;A&gt; type, AdapterFactory adapterFactory) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (target == null) {</span>
<span class="nc" id="L73">			return null;</span>
		}
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (type.isInstance(target)) {</span>
<span class="nc" id="L76">			return (A) target;</span>
		}
<span class="nc" id="L78">		A adapter = (A) EcoreUtil.getRegisteredAdapter(target, type);</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">		if (adapter == null &amp;&amp; adapterFactory != null) {</span>
<span class="nc" id="L80">			adapter = (A) adapterFactory.adaptNew(target, type);</span>
		}
		
<span class="nc bnc" id="L83" title="All 4 branches missed.">		if (adapter == null &amp;&amp; AccessController.class == type) {</span>
			// Delegating to the container with containment reference qualifier
<span class="nc" id="L85">			EObject container = target.eContainer();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">			if (container != null) {</span>
<span class="nc" id="L87">				EReference containmentReference = target.eContainmentFeature();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">				if (containmentReference != null) {</span>
<span class="nc" id="L89">					AccessController cap = adaptTo(container, AccessController.class);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">					if (cap != null) {</span>
<span class="nc" id="L91">						return (A) new AccessController() {</span>
							
							@Override
							public boolean hasPermission(String action, String qualifier, Context context) {
								String cQualifier;
<span class="nc bnc" id="L96" title="All 2 branches missed.">								if (qualifier == null) {</span>
<span class="nc" id="L97">									cQualifier = qualifier;</span>
								} else {
<span class="nc" id="L99">									String suffix = containmentReference.getName();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">									if (containmentReference.isMany()) {</span>
<span class="nc" id="L101">										int pos = ((List&lt;?&gt;) container.eGet(containmentReference)).indexOf(target);</span>
<span class="nc" id="L102">										suffix += &quot;[&quot; + pos + &quot;]&quot;;</span>
									}
<span class="nc bnc" id="L104" title="All 2 branches missed.">									if (qualifier.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L105">										cQualifier = qualifier + suffix;</span>
									} else {
<span class="nc" id="L107">										cQualifier = qualifier + &quot;/&quot; + suffix;</span>
									}
								}
<span class="nc" id="L110">								return cap.hasPermission(action, cQualifier, context);</span>
							}
						};
					}
				}
			}
		}
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (adapter == null) {</span>
			// Last resort - iterate over all adapters for type compatibility without
			// using Adapter.isAdapterForType as it checks adapter factory for edit adapters
<span class="nc bnc" id="L120" title="All 2 branches missed.">			for (Adapter a: target.eAdapters()) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">				if (type.isInstance(a)) {</span>
<span class="nc" id="L122">					return (A) a;</span>
				}
<span class="nc" id="L124">			}			</span>
		}
<span class="nc" id="L126">		return adapter;		</span>
	}
	
	public static &lt;A&gt; A adaptToNonNull(EObject target, Class&lt;A&gt; type) {
<span class="nc" id="L130">		return Objects.requireNonNull(adaptTo(target, type), &quot;Cannot adapt &quot; + target + &quot; to &quot; + type);</span>
	}
	
	// --- Convenience methods for checking access permissions ---
	
	public static AccessController adaptToAccessController(EObject target) {
<span class="nc" id="L136">		AccessController ac = adaptTo(target, AccessController.class);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		return ac == null ? AccessController.ALLOW_ALL : ac;</span>
	}

	/**
	 * Checks for a permission to perform an action for a given qualifier.
	 * @param action
	 * @param qualifier
	 * @return
	 */
	public static boolean hasPermission(EObject obj, String action, String qualifier) {
<span class="nc" id="L147">		return adaptToAccessController(obj).hasPermission(action, qualifier);</span>
	}
	
	/**
	 * Checks &quot;read&quot; permissions
	 * @param qualifier
	 * @return
	 */
	public static boolean canRead(EObject obj, String qualifier) {
<span class="nc" id="L156">		return adaptToAccessController(obj).canRead(qualifier);</span>
	}
	
	/**
	 * Checks &quot;create&quot; permission
	 * @param qualifier
	 * @return
	 */
	public static boolean canCreate(EObject obj, String qualifier) {
<span class="nc" id="L165">		return adaptToAccessController(obj).canCreate(qualifier);</span>
	}
	
	/**
	 * Checks &quot;delete&quot; permission
	 * @param qualifier
	 * @return
	 */
	public static boolean canDelete(EObject obj, String qualifier) {
<span class="nc" id="L174">		return adaptToAccessController(obj).canDelete(qualifier);</span>
	}
	
	/**
	 * Checks &quot;update&quot; permission
	 * @param qualifier
	 * @return
	 */
	public static boolean canUpdate(EObject obj, String qualifier) {
<span class="nc" id="L183">		return adaptToAccessController(obj).canUpdate(qualifier);</span>
	}
	
	/**
	 * Checks &quot;execute&quot; permission
	 * @param qualifier
	 * @param context
	 * @return
	 */
	public static boolean canExecute(EObject obj, String qualifier) {
<span class="nc" id="L193">		return adaptToAccessController(obj).canExecute(qualifier);</span>
	}

	/**
	 * Checks for a permission to perform an action for a given qualifier.
	 * @param action
	 * @param qualifier
	 * @return
	 */
	public static boolean hasPermission(EObject obj, String action, String qualifier, Context context) {
<span class="nc" id="L203">		return adaptToAccessController(obj).hasPermission(action, qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;read&quot; permissions
	 * @param qualifier
	 * @return
	 */
	public static boolean canRead(EObject obj, String qualifier, Context context) {
<span class="nc" id="L212">		return adaptToAccessController(obj).canRead(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;create&quot; permission
	 * @param qualifier
	 * @return
	 */
	public static boolean canCreate(EObject obj, String qualifier, Context context) {
<span class="nc" id="L221">		return adaptToAccessController(obj).canCreate(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;delete&quot; permission
	 * @param qualifier
	 * @return
	 */
	public static boolean canDelete(EObject obj, String qualifier, Context context) {
<span class="nc" id="L230">		return adaptToAccessController(obj).canDelete(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;update&quot; permission
	 * @param qualifier
	 * @return
	 */
	public static boolean canUpdate(EObject obj, String qualifier, Context context) {
<span class="nc" id="L239">		return adaptToAccessController(obj).canUpdate(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;execute&quot; permission
	 * @param qualifier
	 * @param context
	 * @return
	 */
	public static boolean canExecute(EObject obj, String qualifier, Context context) {
<span class="nc" id="L249">		return adaptToAccessController(obj).canExecute(qualifier, context);</span>
	}
	
	// --- Instance methods ---
		
	protected AccessController adaptToAccessController() {
<span class="nc" id="L255">		AccessController ac = adaptToAccessController(target);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		return ac == null ? AccessController.ALLOW_ALL : ac;</span>
	}

	/**
	 * Checks for a permission to perform an action for a given qualifier.
	 * @param action
	 * @param qualifier
	 * @return
	 */
	protected boolean hasPermission(String action, String qualifier) {
<span class="nc" id="L266">		return adaptToAccessController().hasPermission(action, qualifier);</span>
	}
	
	/**
	 * Checks &quot;read&quot; permissions
	 * @param qualifier
	 * @return
	 */
	protected boolean canRead(String qualifier) {
<span class="nc" id="L275">		return adaptToAccessController().canRead(qualifier);</span>
	}
	
	/**
	 * Checks &quot;create&quot; permission
	 * @param qualifier
	 * @return
	 */
	protected boolean canCreate(String qualifier) {
<span class="nc" id="L284">		return adaptToAccessController().canCreate(qualifier);</span>
	}
	
	/**
	 * Checks &quot;delete&quot; permission
	 * @param qualifier
	 * @return
	 */
	protected boolean canDelete(String qualifier) {
<span class="nc" id="L293">		return adaptToAccessController().canDelete(qualifier);</span>
	}
	
	/**
	 * Checks &quot;update&quot; permission
	 * @param qualifier
	 * @return
	 */
	protected boolean canUpdate(String qualifier) {
<span class="nc" id="L302">		return adaptToAccessController().canUpdate(qualifier);</span>
	}
	
	/**
	 * Checks &quot;execute&quot; permission
	 * @param qualifier
	 * @param context
	 * @return
	 */
	protected boolean canExecute(String qualifier) {
<span class="nc" id="L312">		return adaptToAccessController().canExecute(qualifier);</span>
	}
	
	/**
	 * Checks for a permission to perform an action for a given qualifier.
	 * @param action
	 * @param qualifier
	 * @return
	 */
	protected boolean hasPermission(String action, String qualifier, Context context) {
<span class="nc" id="L322">		return adaptToAccessController().hasPermission(action, qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;read&quot; permissions
	 * @param qualifier
	 * @return
	 */
	protected boolean canRead(String qualifier, Context context) {
<span class="nc" id="L331">		return adaptToAccessController().canRead(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;create&quot; permission
	 * @param qualifier
	 * @return
	 */
	protected boolean canCreate(String qualifier, Context context) {
<span class="nc" id="L340">		return adaptToAccessController().canCreate(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;delete&quot; permission
	 * @param qualifier
	 * @return
	 */
	protected boolean canDelete(String qualifier, Context context) {
<span class="nc" id="L349">		return adaptToAccessController().canDelete(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;update&quot; permission
	 * @param qualifier
	 * @return
	 */
	protected boolean canUpdate(String qualifier, Context context) {
<span class="nc" id="L358">		return adaptToAccessController().canUpdate(qualifier, context);</span>
	}
	
	/**
	 * Checks &quot;execute&quot; permission
	 * @param qualifier
	 * @param context
	 * @return
	 */
	protected boolean canExecute(String qualifier, Context context) {
<span class="nc" id="L368">		return adaptToAccessController().canExecute(qualifier, context);</span>
	}
	
	// --- Adapting to execution participants factories
	
	public static &lt;T&gt; SupplierFactory&lt;T&gt; adaptToSupplierFactory(EObject target, Class&lt;T&gt; type) {
<span class="nc" id="L374">		return adaptToSupplierFactory(target, type, null);</span>
	}	
	
	/**
	 * Adapts to a {@link SupplierFactory} of specific type by adapting to {@link SupplierFactory.Provider} first and obtaining a typed factory from it.
	 * If it doesn't work then adapts to SupplierFactory and then's it with a {@link FunctionFactory} which converts the result to requested type.
	 * @param &lt;T&gt;
	 * @param type
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static &lt;T&gt; SupplierFactory&lt;T&gt; adaptToSupplierFactory(EObject target, Class&lt;T&gt; type, AdapterFactory adapterFactory) {
<span class="nc" id="L386">		SupplierFactory.Provider provider = adaptTo(target, SupplierFactory.Provider.class, adapterFactory);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">		if (provider != null) {</span>
<span class="nc" id="L388">			SupplierFactory&lt;T&gt; factory = provider.getFactory(type);</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">			if (factory != null) {</span>
<span class="nc" id="L390">				return factory;</span>
			}
		}
<span class="nc" id="L393">		SupplierFactory&lt;Object&gt; factory = adaptTo(target, SupplierFactory.class, adapterFactory);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (factory == null) { </span>
<span class="nc" id="L395">			return null;</span>
		}
<span class="nc" id="L397">		return factory.then(new FunctionFactory&lt;Object,T&gt;() {</span>

			@Override
			public Function&lt;Object, T&gt; create(Context context) {				
<span class="nc" id="L401">				return new Function&lt;Object, T&gt;() {</span>

					@Override
					public double size() {
<span class="nc" id="L405">						return 1;</span>
					}

					@Override
					public String name() {
<span class="nc" id="L410">						return &quot;Converter to &quot;+type;</span>
					}

					@Override
					public T execute(Object result, ProgressMonitor progressMonitor) {
<span class="nc bnc" id="L415" title="All 4 branches missed.">						if (result == null || type.isInstance(result)) {</span>
<span class="nc" id="L416">							return (T) result;</span>
						}
<span class="nc" id="L418">						Converter converter = context.get(Converter.class, DefaultConverter.INSTANCE);</span>
<span class="nc" id="L419">						T ret = converter.convert(result, type);</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">						if (ret == null) {</span>
<span class="nc" id="L421">							throw new IllegalArgumentException(&quot;Cannot convert &quot; + result.getClass() + &quot; &quot; + result + &quot; to &quot; + type);</span>
						}
<span class="nc" id="L423">						return ret;</span>
					}
				};
			}
			
		});		
	}
	
	/**
	 * Adapts target to {@link SupplierFactory} and throws {@link NullPointerException} if result is null.
	 * @param &lt;T&gt;
	 * @param target
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; SupplierFactory&lt;T&gt; adaptToSupplierFactoryNonNull(EObject target, Class&lt;T&gt; type, AdapterFactory adapterFactory) {
<span class="nc" id="L439">		return Objects.requireNonNull(adaptToSupplierFactory(target, type, adapterFactory), &quot;Cannot adapt &quot; + target + &quot; to SupplierFactory&lt;&quot; + type + &quot;&gt;&quot;);</span>
	}
	
	/**
	 * Adapts target to {@link SupplierFactory} and throws {@link NullPointerException} if result is null.
	 * @param &lt;T&gt;
	 * @param target
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; SupplierFactory&lt;T&gt; adaptToSupplierFactoryNonNull(EObject target, Class&lt;T&gt; type) {
<span class="nc" id="L450">		return adaptToSupplierFactoryNonNull(target, type, null);</span>
	}
		
	/**
	 * Adapts each element of the targets collection to {@link SupplierFactory} and returns as a list.
	 * @param &lt;T&gt;
	 * @param targets
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; List&lt;SupplierFactory&lt;T&gt;&gt; adaptToSupplierFactory(Collection&lt;? extends EObject&gt; targets, Class&lt;T&gt; type) {
<span class="nc" id="L461">		return targets.stream().map(e -&gt;adaptToSupplierFactory(e, type)).collect(Collectors.toList());</span>
	}
	
	/**
	 * Adapts each element of the targets collection to {@link SupplierFactory} and returns as a list.
	 * Throws {@link NullPointerException} if any of the targets cannot be adapted.
	 * @param &lt;T&gt;
	 * @param targets
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; List&lt;SupplierFactory&lt;T&gt;&gt; adaptToSupplierFactoryNonNull(Collection&lt;? extends EObject&gt; targets, Class&lt;T&gt; type) {
<span class="nc" id="L473">		return targets.stream().map(e -&gt;adaptToSupplierFactoryNonNull(e, type)).collect(Collectors.toList());</span>
	}

	/**
	 * Adapts to a {@link FunctionFactory} of specific parameter and result types by adapting to {@link FunctionFactory.Provider} first and obtaining a typed factory from it.
	 * If it doesn't work then adapts to FunctionFactory and then's it with a {@link FunctionFactory} which converts the result to requested type. The argument is not converted.
	 * @param &lt;T&gt;
	 * @param &lt;R&gt;
	 * @param parameterType
	 * @param resultType
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static &lt;T,R&gt; FunctionFactory&lt;T,R&gt; adaptToFunctionFactory(EObject target, Class&lt;T&gt; parameterType, Class&lt;R&gt; resultType) {
<span class="nc" id="L487">		FunctionFactory.Provider provider = adaptTo(target, FunctionFactory.Provider.class);</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">		if (provider != null) {</span>
<span class="nc" id="L489">			FunctionFactory&lt;T,R&gt; factory = provider.getFactory(parameterType, resultType);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">			if (factory != null) {</span>
<span class="nc" id="L491">				return factory;</span>
			}
		}
<span class="nc" id="L494">		FunctionFactory&lt;Object,Object&gt; factory = adaptTo(target, FunctionFactory.class);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">		if (factory == null) { </span>
<span class="nc" id="L496">			return null;</span>
		}
<span class="nc" id="L498">		return (FunctionFactory&lt;T,R&gt;) factory.then(new FunctionFactory&lt;Object,R&gt;() {</span>

			@Override
			public Function&lt;Object,R&gt; create(Context context) {				
<span class="nc" id="L502">				return new Function&lt;Object,R&gt;() {</span>

					@Override
					public double size() {
<span class="nc" id="L506">						return 1;</span>
					}

					@Override
					public String name() {
<span class="nc" id="L511">						return &quot;Converter to &quot;+resultType;</span>
					}

					@Override
					public R execute(Object result, ProgressMonitor progressMonitor) {
<span class="nc bnc" id="L516" title="All 4 branches missed.">						if (result == null || resultType.isInstance(result)) {</span>
<span class="nc" id="L517">							return (R) result;</span>
						}
<span class="nc" id="L519">						Converter converter = context.get(Converter.class, DefaultConverter.INSTANCE);</span>
<span class="nc" id="L520">						R ret = converter.convert(result, resultType);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">						if (ret == null) {</span>
<span class="nc" id="L522">							throw new IllegalArgumentException(&quot;Cannot convert &quot; + result.getClass() + &quot; &quot; + result + &quot; to &quot; + resultType);</span>
						}
<span class="nc" id="L524">						return ret;</span>
					}
				};
			}
			
		});		
	}
	
	/**
	 * Adapts target to FunctionFactory and throws {@link NullPointerException} if result is null.
	 * @param &lt;T&gt;
	 * @param target
	 * @param type
	 * @return
	 */
	public static &lt;T,R&gt; FunctionFactory&lt;T,R&gt; adaptToFunctionFactoryNonNull(EObject target, Class&lt;T&gt; parameterType, Class&lt;R&gt; resultType) {
<span class="nc" id="L540">		return Objects.requireNonNull(adaptToFunctionFactory(target, parameterType, resultType), &quot;Cannot adapt &quot; + target + &quot; to FunctionFactory&lt;&quot; + parameterType + &quot;, &quot; + resultType + &quot;&gt;&quot;);</span>
	}
	
	/**
	 * Adapts each element of the targets collection to {@link FunctionFactory} and returns as a list.
	 * @return
	 */
	public static &lt;T,R&gt; List&lt;FunctionFactory&lt;T,R&gt;&gt; adaptToFunctionFactory(Collection&lt;? extends EObject&gt; targets, Class&lt;T&gt; parameterType, Class&lt;R&gt; resultType) {
<span class="nc" id="L548">		return targets.stream().map(e -&gt; adaptToFunctionFactory(e, parameterType, resultType)).collect(Collectors.toList());</span>
	}
	
	/**
	 * Adapts each element of the targets collection to {@link FunctionFactory} and returns as a list.
	 * Throws {@link NullPointerException} if any of the targets cannot be adapted.
	 * @return
	 */
	public static &lt;T,R&gt; List&lt;FunctionFactory&lt;T,R&gt;&gt; adaptToFunctionFactoryNonNull(Collection&lt;? extends EObject&gt; targets, Class&lt;T&gt; parameterType, Class&lt;R&gt; resultType) {
<span class="nc" id="L557">		return targets.stream().map(e -&gt; adaptToFunctionFactoryNonNull(e, parameterType, resultType)).collect(Collectors.toList());</span>
	}
	
	/**
	 * Adapts to a {@link ConsumerFactory} of specific type by adapting to {@link ConsumerFactory.Provider} first and obtaining a typed factory from it.
	 * If it doesn't work then adapts to ConsumerFactory.
	 * @param &lt;T&gt;
	 * @param type
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static &lt;T&gt; ConsumerFactory&lt;T&gt; adaptToConsumerFactory(EObject target, Class&lt;T&gt; type) {
<span class="nc" id="L569">		ConsumerFactory.Provider provider = adaptTo(target, ConsumerFactory.Provider.class);</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">		if (provider != null) {</span>
<span class="nc" id="L571">			ConsumerFactory&lt;T&gt; factory = provider.getFactory(type);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">			if (factory != null) {</span>
<span class="nc" id="L573">				return factory;</span>
			}
		}
<span class="nc" id="L576">		return adaptTo(target, ConsumerFactory.class);</span>
	}
		
	/**
	 * Adapts target to ConsumerFactory and throws {@link NullPointerException} if result is null.
	 * @param &lt;T&gt;
	 * @param target
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; ConsumerFactory&lt;T&gt; adaptToConsumerFactoryNonNull(EObject target, Class&lt;T&gt; type) {
<span class="nc" id="L587">		return Objects.requireNonNull(adaptToConsumerFactory(target, type), &quot;Cannot adapt &quot; + target + &quot; to ConsumerFactory&lt;&quot; + type + &quot;&gt;&quot;);</span>
	}
	
	/**
	 * Adapts each element of the targets collection to {@link ConsumerFactory} and returns as a list.
	 * @param &lt;T&gt;
	 * @param targets
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; List&lt;ConsumerFactory&lt;T&gt;&gt; adaptToConsumerFactory(Collection&lt;? extends EObject&gt; targets, Class&lt;T&gt; type) {
<span class="nc" id="L598">		return targets.stream().map(e -&gt; adaptToConsumerFactory(e, type)).collect(Collectors.toList());</span>
	}
	
	/**
	 * Adapts each element of the targets collection to {@link ConsumerFactory} and returns as a list.
	 * Throws {@link NullPointerException} if any of the targets cannot be adapted.
	 * @param &lt;T&gt;
	 * @param targets
	 * @param type
	 * @return
	 */
	public static &lt;T&gt; List&lt;ConsumerFactory&lt;T&gt;&gt; adaptToConsumerFactoryNonNull(Collection&lt;? extends EObject&gt; targets, Class&lt;T&gt; type) {
<span class="nc" id="L610">		return targets.stream().map(e -&gt; adaptToConsumerFactoryNonNull(e, type)).collect(Collectors.toList());</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>