<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EObjectSupplierFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika EMF</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.emf.persistence</a> &gt; <span class="el_source">EObjectSupplierFactory.java</span></div><h1>EObjectSupplierFactory.java</h1><pre class="source lang-java linenums">package org.nasdanika.emf.persistence;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.function.BiFunction;

import org.eclipse.emf.common.util.EMap;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EClassifier;
import org.eclipse.emf.ecore.ENamedElement;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.EStructuralFeature;
import org.nasdanika.common.BiSupplier;
import org.nasdanika.common.Context;
import org.nasdanika.common.ExecutionException;
import org.nasdanika.common.Function;
import org.nasdanika.common.FunctionFactory;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.emf.EmfUtil;
import org.nasdanika.emf.EmfUtil.EModelElementDocumentation;
import org.nasdanika.ncore.util.NcoreUtil;
import org.nasdanika.persistence.ConfigurationException;
import org.nasdanika.persistence.DelegatingSupplierFactoryFeature;
import org.nasdanika.persistence.EnumSupplierFactoryAttribute;
import org.nasdanika.persistence.Feature;
import org.nasdanika.persistence.FunctionSupplierFactoryAttribute;
import org.nasdanika.persistence.ListSupplierFactoryAttribute;
import org.nasdanika.persistence.MapSupplierFactoryAttribute;
import org.nasdanika.persistence.Marker;
import org.nasdanika.persistence.ObjectLoader;
import org.nasdanika.persistence.StringSupplierFactoryAttribute;
import org.nasdanika.persistence.SupplierFactoryFeatureObject;
import org.nasdanika.persistence.TypedSupplierFactoryAttribute;

/**
 * Loads {@link EObject} {@link EStructuralFeature}s from configuration.
 * @author Pavel
 *
 */
public class EObjectSupplierFactory extends SupplierFactoryFeatureObject&lt;EObject&gt; {
	
<span class="nc" id="L49">	private Map&lt;String, EStructuralFeature&gt; featureMap = new LinkedHashMap&lt;&gt;();</span>

	private EClass eClass;
	private EObjectLoader loader;
		
<span class="nc" id="L54">	private java.util.function.Function&lt;EClass, EObject&gt; constructor = this::instantiate;</span>

	/**
	 * 
	 * @param loader
	 * @param eClass
	 * @param keyProvider
	 * @param constructor Constructs a new EObject instance for EClass. If null, EPackage factory is used to create a new object.
	 */
	public EObjectSupplierFactory(
			EObjectLoader loader, 
			EClass eClass, 
			BiFunction&lt;EClass,ENamedElement,String&gt; keyProvider,
<span class="nc" id="L67">			java.util.function.Function&lt;EClass, EObject&gt; constructor) {</span>

<span class="nc" id="L69">		this.loader = loader;</span>
<span class="nc" id="L70">		this.eClass = eClass;	// TODO - handling prototype - if there is an annotation - chain - may need to handle @ super?</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		if (keyProvider == null) {</span>
<span class="nc" id="L72">			keyProvider = EObjectLoader.LOAD_KEY_PROVIDER; </span>
		}		
<span class="nc bnc" id="L74" title="All 2 branches missed.">		for (EStructuralFeature feature: eClass.getEAllStructuralFeatures()) {</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">			if (!feature.isChangeable() &amp;&amp; !&quot;true&quot;.equals(NcoreUtil.getNasdanikaAnnotationDetail(feature, EObjectLoader.IS_COMPUTED))) {</span>
<span class="nc" id="L76">				continue;</span>
			}
<span class="nc" id="L78">			String featureKey = keyProvider.apply(eClass, feature);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">			if (featureKey == null) {</span>
<span class="nc" id="L80">				continue;</span>
			}
<span class="nc" id="L82">			featureMap.put(featureKey, feature);</span>
<span class="nc" id="L83">			addFeature(wrapFeature(featureKey, feature, loader, keyProvider));</span>
<span class="nc" id="L84">		}</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">		if (constructor != null) {</span>
<span class="nc" id="L86">			this.constructor = constructor;</span>
		}
<span class="nc" id="L88">	}</span>
	
	/**
	 * Wraps {@link EStructuralFeature} into {@link Feature}
	 * @param featureKey
	 * @param feature
	 * @return
	 */
	protected Feature&lt;?&gt; wrapFeature(
			String featureKey, 
			EStructuralFeature feature, 
			EObjectLoader loader, 
			BiFunction&lt;EClass,ENamedElement,String&gt; keyProvider) {
		
<span class="nc" id="L102">		return wrapFeature(featureKey, feature, loader, keyProvider, EObjectLoader.isDefaultFeature(eClass, feature));</span>
	}

	/**
	 * Wraps {@link EStructuralFeature} into {@link Feature}. 
	 * Static version is needed for {@link EMap} support. 
	 * @param featureKey
	 * @param feature
	 * @return
	 */
	@SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
	public Feature&lt;?&gt; wrapFeature(
			String featureKey, 
			EStructuralFeature feature, 
			EObjectLoader loader, 
			BiFunction&lt;EClass,ENamedElement,String&gt; keyProvider,
			boolean isDefault) {
		
<span class="nc" id="L120">		Object[] exclusiveWith = EObjectLoader.getExclusiveWith(eClass, feature, keyProvider);</span>
		
<span class="nc" id="L122">		EModelElementDocumentation documentation = EmfUtil.getDocumentation(feature);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (feature instanceof EAttribute) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (feature.isMany()) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">				return new ListSupplierFactoryAttribute&lt;&gt;(new org.nasdanika.persistence.ReferenceList&lt;&gt;(featureKey, isDefault, feature.isRequired(), null, documentation == null ? null : documentation.getDocumentation(), exclusiveWith), true);</span>
			}
			
<span class="nc" id="L128">			EClassifier featureType = feature.getEType();</span>
<span class="nc" id="L129">			Class&lt;?&gt; featureClass = featureType.getInstanceClass();</span>
<span class="nc" id="L130">			boolean interpolate = &quot;true&quot;.equals(NcoreUtil.getNasdanikaAnnotationDetail(feature, &quot;interpolate&quot;, &quot;true&quot;));</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">			if (String.class == featureClass) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">				org.nasdanika.persistence.Reference delegate = new org.nasdanika.persistence.Reference(featureKey, isDefault, feature.isRequired(), null, documentation == null ? null : documentation.getDocumentation(), exclusiveWith) {</span>
					
					@Override
					public Object create(ObjectLoader loader, Object config, URI base, ProgressMonitor progressMonitor,	List&lt;? extends Marker&gt; markers) {
<span class="nc" id="L136">						Object ret = super.create(loader, config, base, progressMonitor, markers);</span>
<span class="nc bnc" id="L137" title="All 10 branches missed.">						if (base != null &amp;&amp; !base.isRelative() &amp;&amp; base.isHierarchical() &amp;&amp; ret instanceof String &amp;&amp; &quot;true&quot;.equals(NcoreUtil.getNasdanikaAnnotationDetail(feature, EObjectLoader.IS_RESOLVE_URI))) {</span>
<span class="nc" id="L138">							return URI.createURI((String) ret).resolve(base).toString();</span>
						}
<span class="nc" id="L140">						return ret;</span>
					}
					
				};
<span class="nc" id="L144">				return new StringSupplierFactoryAttribute(delegate, interpolate);</span>
			}
			
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (featureClass.isEnum()) {</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">				StringSupplierFactoryAttribute stringAttribute = new StringSupplierFactoryAttribute(new org.nasdanika.persistence.Reference(featureKey, isDefault, feature.isRequired(), null, documentation == null ? null : documentation.getDocumentation(), exclusiveWith), interpolate);</span>
<span class="nc" id="L149">				return new EnumSupplierFactoryAttribute(stringAttribute, featureClass, null);</span>
			}
			
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (EClass.class == featureClass) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">				StringSupplierFactoryAttribute stringAttribute = new StringSupplierFactoryAttribute(new org.nasdanika.persistence.Reference(featureKey, isDefault, feature.isRequired(), null, documentation == null ? null : documentation.getDocumentation(), exclusiveWith), interpolate);</span>
<span class="nc" id="L154">				FunctionFactory&lt;String,EClass&gt; functionFactory = new FunctionFactory&lt;String, EClass&gt;() {</span>

					@Override
					public Function&lt;String, EClass&gt; create(Context ctx) {
<span class="nc" id="L158">						return new Function&lt;String, EClass&gt;() {</span>

							@Override
							public double size() {
<span class="nc" id="L162">								return 1;</span>
							}

							@Override
							public String name() {
<span class="nc" id="L167">								return &quot;Resolving type to EClass&quot;;</span>
							}

							@Override
							public EClass execute(String type, ProgressMonitor progressMonitor) {
<span class="nc" id="L172">								BiSupplier&lt;EClass, BiFunction&lt;EClass,ENamedElement, String&gt;&gt; result = loader.resolveEClass(type);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">								if (result == null) {</span>
<span class="nc" id="L174">									throw new ConfigurationException(&quot;Cannot resolve &quot; + type+ &quot; to EClass&quot;, EObjectSupplierFactory.this.getMarkers());</span>
								}
<span class="nc" id="L176">								return result.getFirst();</span>
							}
							
						};
					}
					
				};
<span class="nc" id="L183">				return new FunctionSupplierFactoryAttribute(stringAttribute, functionFactory);</span>
			}
			
<span class="nc" id="L186">			Function converter = null; // TODO: From annotations for, say, dates - parse pattern - SimpleDateFormat?</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			return new TypedSupplierFactoryAttribute(featureClass, new org.nasdanika.persistence.Reference(featureKey, isDefault, feature.isRequired(), null, documentation == null ? null : documentation.getDocumentation(), exclusiveWith), interpolate, converter);			</span>
		}
		
<span class="nc bnc" id="L190" title="All 2 branches missed.">		if (feature instanceof EReference) {</span>
<span class="nc" id="L191">			EReference eReference = (EReference) feature;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">			if (feature.isMany()) {</span>
				// EMap
<span class="nc bnc" id="L194" title="All 2 branches missed.">				if (feature.getEType().getInstanceClass() == Map.Entry.class) {</span>
<span class="nc" id="L195">					return new MapSupplierFactoryAttribute&lt;&gt;(new ReferenceMap&lt;&gt;(</span>
							featureKey, 
							isDefault, 
<span class="nc" id="L198">							feature.isRequired(), </span>
							null, 
<span class="nc bnc" id="L200" title="All 2 branches missed.">							documentation == null ? null : documentation.getDocumentation(),</span>
							eClass,
							eReference,
							loader,
							true,
							keyProvider,
							exclusiveWith), true);
				}
<span class="nc" id="L208">				return new ListSupplierFactoryAttribute&lt;&gt;(new ReferenceList&lt;&gt;(</span>
						featureKey, 
						isDefault, 
<span class="nc" id="L211">						feature.isRequired(), </span>
						null, 
<span class="nc bnc" id="L213" title="All 2 branches missed.">						documentation == null ? null : documentation.getDocumentation(),</span>
						eClass,
						eReference,
						loader,
						true,
						keyProvider,
						exclusiveWith), true);
			}
			
<span class="nc" id="L222">			return new DelegatingSupplierFactoryFeature&lt;&gt;(new Reference&lt;&gt;(</span>
					featureKey, 
					isDefault, 
<span class="nc" id="L225">					feature.isRequired(), </span>
					null, 
<span class="nc bnc" id="L227" title="All 2 branches missed.">					documentation == null ? null : documentation.getDocumentation(),</span>
					eClass,
					eReference,
					loader,
					true,					
					keyProvider,
					exclusiveWith));
			
		}
		
<span class="nc" id="L237">		throw new UnsupportedOperationException(&quot;Unusupported feature type: &quot; + feature);</span>
	}

	@Override
	protected Function&lt;Map&lt;Object, Object&gt;, EObject&gt; createResultFunction(Context context) {
<span class="nc" id="L242">		return new Function&lt;Map&lt;Object,Object&gt;, EObject&gt;() {</span>
			
			@Override
			public double size() {
<span class="nc" id="L246">				return 1;</span>
			}
			
			@Override
			public String name() {
<span class="nc" id="L251">				return &quot;Creating &quot; + eClass.getName();</span>
			}
			
			@SuppressWarnings(&quot;unchecked&quot;)
			@Override
			public EObject execute(Map&lt;Object, Object&gt; data, ProgressMonitor progressMonitor) {
<span class="nc" id="L257">				EObject ret = constructor.apply(eClass);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">				if (ret == null) {</span>
<span class="nc" id="L259">					ret = instantiate(eClass);</span>
				}
<span class="nc" id="L261">				List&lt;? extends Marker&gt; markers = getMarkers();</span>
<span class="nc" id="L262">				loader.mark(ret, markers, progressMonitor);</span>
<span class="nc" id="L263">				Map&lt;EStructuralFeature, Object&gt; loadedFeatures = new HashMap&lt;&gt;();</span>
<span class="nc" id="L264">				EStructuralFeature[] loadingFeature = { null };</span>
<span class="nc" id="L265">				ret.eAdapters().add(new LoadTrackerAdapter() {</span>

					@Override
					public boolean isLoaded(EStructuralFeature feature) {
<span class="nc" id="L269">						return loadedFeatures.containsKey(feature);</span>
					}

					@Override
					public boolean isLoading(EStructuralFeature feature) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">						return feature == loadingFeature[0];</span>
					}
					
					@Override
					public Object get(EStructuralFeature feature) {
<span class="nc" id="L279">						return loadedFeatures.get(feature);</span>
					}
					
				});
<span class="nc bnc" id="L283" title="All 2 branches missed.">				for (Feature&lt;?&gt; feature: features) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">					if (feature.isLoaded()) {</span>
						try {
<span class="nc" id="L286">							EStructuralFeature structuralFeature = featureMap.get(feature.getKey());</span>
<span class="nc" id="L287">							loadingFeature[0] = structuralFeature;</span>
<span class="nc" id="L288">							Object value = feature.get(data);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">							if (structuralFeature.isChangeable()) {</span>
								// Unwrapping singleton lists
<span class="nc bnc" id="L291" title="All 2 branches missed.">								if (structuralFeature instanceof EReference) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">									if (structuralFeature.isMany()) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">										if (value instanceof List) {</span>
<span class="nc" id="L294">											List&lt;Object&gt; theValue = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">											for (Object element: (List&lt;?&gt;) value) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">												if (element instanceof List) {</span>
<span class="nc" id="L297">													theValue.addAll((List&lt;Object&gt;) element);</span>
												} else {
<span class="nc" id="L299">													theValue.add(element);</span>
												}												
<span class="nc" id="L301">											}</span>
<span class="nc" id="L302">											setFeature(ret, structuralFeature, theValue);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">										} else if (value instanceof Map) {</span>
<span class="nc" id="L304">											EClass refType = ((EReference) structuralFeature).getEReferenceType();</span>
<span class="nc" id="L305">											boolean isManyValue = false;</span>
<span class="nc" id="L306">											Class&lt;?&gt; refTypeInstanceClass = refType.getInstanceClass();</span>
<span class="nc bnc" id="L307" title="All 4 branches missed.">											if (refTypeInstanceClass != null &amp;&amp; Map.Entry.class.isAssignableFrom(refTypeInstanceClass)) {</span>
<span class="nc" id="L308">												EStructuralFeature valueFeature = refType.getEStructuralFeature(&quot;value&quot;);</span>
<span class="nc bnc" id="L309" title="All 4 branches missed.">												isManyValue = valueFeature != null &amp;&amp; valueFeature.isMany();</span>
											}
<span class="nc" id="L311">											Map&lt;Object,Object&gt; theValue = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">											for (Entry&lt;Object, Object&gt; entry: ((Map&lt;Object,Object&gt;) value).entrySet()) {</span>
<span class="nc" id="L313">												Object entryValue = entry.getValue();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">												if (entryValue instanceof List) {</span>
<span class="nc" id="L315">													List&lt;?&gt; entryValueList = (List&lt;?&gt;) entryValue;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">													if (isManyValue) {</span>
<span class="nc" id="L317">														List&lt;Object&gt; theEntryValueList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">														for (Object entryValueElement: (List&lt;?&gt;) entryValueList) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">															if (entryValueElement instanceof List) {</span>
<span class="nc" id="L320">																theEntryValueList.addAll((List&lt;Object&gt;) entryValueElement);</span>
															} else {
<span class="nc" id="L322">																theEntryValueList.add(entryValueElement);</span>
															}												
<span class="nc" id="L324">														}	</span>
<span class="nc" id="L325">														theValue.put(entry.getKey(), theEntryValueList);</span>
<span class="nc" id="L326">													} else {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">														if (entryValueList.size() == 1) {</span>
<span class="nc" id="L328">															theValue.put(entry.getKey(), entryValueList.get(0));														</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">														} else if (!entryValueList.isEmpty()) {</span>
<span class="nc" id="L330">															throw new ConfigurationException(&quot;Map entry value list size is more than one: &quot;+ entryValue, markers);</span>
														}
													}
<span class="nc" id="L333">												} else {</span>
<span class="nc" id="L334">													theValue.put(entry.getKey(), entryValue);</span>
												}												
<span class="nc" id="L336">											}</span>
<span class="nc" id="L337">											setFeature(ret, structuralFeature, theValue);											</span>
<span class="nc" id="L338">										} else {</span>
<span class="nc" id="L339">											setFeature(ret, structuralFeature, value);											</span>
										}
									} else {
<span class="nc bnc" id="L342" title="All 4 branches missed.">										if (value instanceof List &amp;&amp; ((List&lt;?&gt;) value).size() == 1) {</span>
<span class="nc" id="L343">											setFeature(ret, structuralFeature, ((List&lt;?&gt;) value).get(0));</span>
										} else {
<span class="nc" id="L345">											setFeature(ret, structuralFeature, value);</span>
										}
									}
								} else {
<span class="nc" id="L349">									setFeature(ret, structuralFeature, value);</span>
								}
							}
<span class="nc" id="L352">							loadedFeatures.put(structuralFeature, value);</span>
<span class="nc" id="L353">						} catch (ConfigurationException e) {</span>
<span class="nc" id="L354">							throw e;</span>
<span class="nc" id="L355">						} catch (Exception e) {</span>
<span class="nc bnc" id="L356" title="All 4 branches missed.">							throw markers == null || markers.isEmpty() ? new ExecutionException(e) : new ConfigurationException(&quot;Error setting feature &quot; + feature.getKey() + &quot; in &quot; + ret + &quot;: &quot; + e, e, markers);</span>
						} finally {
<span class="nc" id="L358">							loadingFeature[0] = null;</span>
						}
					}
<span class="nc" id="L361">				}</span>
<span class="nc" id="L362">				return ret;</span>
			}
		};
	}
	
	protected EObject instantiate(EClass eClazz) {
<span class="nc" id="L368">		return eClazz.getEPackage().getEFactoryInstance().create(eClazz);</span>
	}	

	/**
	 * Sets structural feature. This implementation calls eObj.eSet().  
	 * @param eObj
	 * @param structuralFeature
	 * @param value
	 */
	protected void setFeature(EObject eObj, EStructuralFeature structuralFeature, Object value) {
<span class="nc" id="L378">		eObj.eSet(structuralFeature, value);</span>
<span class="nc" id="L379">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>