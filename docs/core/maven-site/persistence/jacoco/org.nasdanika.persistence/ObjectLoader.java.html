<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ObjectLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika Persistence</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.persistence</a> &gt; <span class="el_source">ObjectLoader.java</span></div><h1>ObjectLoader.java</h1><pre class="source lang-java linenums">package org.nasdanika.persistence;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.eclipse.emf.common.util.URI;
import org.json.JSONArray;
import org.json.JSONObject;
import org.json.JSONTokener;
import org.nasdanika.common.ExecutionParticipant;
import org.nasdanika.common.ProgressMonitor;
import org.yaml.snakeyaml.Yaml;
import org.yaml.snakeyaml.error.MarkedYAMLException;

/**
 * Loads objects from configuration, e.g. YAML or JSON.
 * Objects are loaded as follows: 
 * 
 * * If config value is a map with a single element, then its key is an object type to be instantiated. Type is passed to create() method and is implementation-specific. E.g. a factory may use aliases/logical names for a 
 * pre-defined set of supported objects/components.  
 * * If config value is a multi-value map, then the result would be a map with each value instantiated as explained here.
 * * If config value is a list then the result would be a list with each element instantiated as explained here.
 * * Otherwise the value is returned as-is. 
 * 
 * {@link ExecutionParticipant}'s factory loading methods cast instantiated objects to a specific execution participant type factory and wrap values. Lists, and maps are wrapped into compound execution participants of requested type.
 *   
 * @author Pavel
 *
 */
public interface ObjectLoader {
	
	/**
	 * Creates an object of requested type with a given config.
	 * @param ObjectLoader for creating object parts. This factory or parent/root loader for chained loaders.
	 * @param type
	 * @param config
	 * @param base Base URL for resolving references.
	 * @param progressMonitor 
	 * @param marker Optional source marker for troubleshooting.  
	 * @return
	 */
	Object create(ObjectLoader loader, String type, Object config, URI base, ProgressMonitor progressMonitor, List&lt;? extends Marker&gt; markers);
	
	@SuppressWarnings(&quot;unchecked&quot;)
	default Object load(Object spec, URI base, ProgressMonitor progressMonitor) {
		// map
<span class="nc bnc" id="L60" title="All 2 branches missed.">		if (spec instanceof Map) {</span>
<span class="nc" id="L61">			Map&lt;String,Object&gt; map = (Map&lt;String,Object&gt;) spec;</span>
			// single
<span class="nc bnc" id="L63" title="All 2 branches missed.">			if (map.size() == 1) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">				for (Entry&lt;String, Object&gt; e: map.entrySet()) {</span>
<span class="nc" id="L65">					return create(this, e.getKey(), e.getValue(), base, progressMonitor, Util.getMarkers(map, e.getKey()));</span>
				}
			}
			// otherwise
<span class="nc" id="L69">			Map&lt;String,Object&gt; ret = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">			for (Entry&lt;String, Object&gt; e: map.entrySet()) {</span>
<span class="nc" id="L71">				ret.put(e.getKey(), load(e.getValue(), base, progressMonitor));</span>
<span class="nc" id="L72">			}</span>
<span class="nc" id="L73">			return ret;</span>
		}
		
		// list
<span class="nc bnc" id="L77" title="All 2 branches missed.">		if (spec instanceof Collection) {</span>
<span class="nc" id="L78">			List&lt;Object&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">			for (Object e: (Collection&lt;?&gt;) spec) {</span>
<span class="nc" id="L80">				ret.add(load(e, base, progressMonitor));</span>
<span class="nc" id="L81">			}</span>
<span class="nc" id="L82">			return ret;</span>
		}
		
		// Scalar - return AS-IS
<span class="nc" id="L86">		return spec;</span>
	}
	
	default Object loadYaml(String yamlString, URI base, ProgressMonitor progressMonitor) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">		Yaml yaml = MarkingYamlConstructor.createMarkingYaml(base == null ? null : base.toString());</span>
<span class="nc" id="L91">		return load(yaml.load(yamlString), base, progressMonitor);</span>
	}
	
	default Object loadYaml(InputStream in, URI base, ProgressMonitor progressMonitor) throws IOException {
<span class="nc" id="L95">		try (Reader reader = new InputStreamReader(in, getCharset())) {</span>
<span class="nc" id="L96">			return loadYaml(reader, base, progressMonitor);</span>
		}
	}
	
	default Object loadYaml(Reader reader, URI base, ProgressMonitor progressMonitor) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">		Yaml yaml = MarkingYamlConstructor.createMarkingYaml(base == null ? null : base.toString());</span>
<span class="nc" id="L102">		return load(yaml.load(reader), base, progressMonitor);</span>
	}
	
	default Object loadYaml(URL url, ProgressMonitor progressMonitor) throws Exception {
<span class="nc" id="L106">		progressMonitor.worked(1, &quot;Loading YAML from &quot; + url);</span>
<span class="nc" id="L107">		Yaml yaml = MarkingYamlConstructor.createMarkingYaml(url.toString());</span>
<span class="nc" id="L108">		try (Reader reader = new InputStreamReader(url.openStream(), getCharset())) {</span>
<span class="nc" id="L109">			return load(yaml.load(reader), URI.createURI(url.toString()), progressMonitor);</span>
<span class="nc" id="L110">		} catch (MarkedYAMLException e) {</span>
<span class="nc" id="L111">			throw new ConfigurationException(e.getMessage(), e, new MarkerImpl(url.toString(), e.getProblemMark()));</span>
		}
	}
	
	default Object loadYaml(File file, ProgressMonitor progressMonitor) throws MalformedURLException, Exception {
<span class="nc" id="L116">		return loadYaml(file.toURI().toURL(), progressMonitor);</span>
	}
		
	default Object loadJsonObject(String str, URI base, ProgressMonitor progressMonitor) {
<span class="nc" id="L120">		JSONObject jsonObject = new JSONObject(new JSONTokener(str));</span>
<span class="nc" id="L121">		return load(jsonObject.toMap(), base, progressMonitor);</span>
	}
	
	default Object loadJsonObject(InputStream in, URI base, ProgressMonitor progressMonitor) throws IOException {
<span class="nc" id="L125">		try (Reader reader = new InputStreamReader(in, getCharset())) {	</span>
<span class="nc" id="L126">			return loadJsonObject(reader, base, progressMonitor);</span>
		}
	}
	
	default Object loadJsonObject(Reader reader, URI base, ProgressMonitor progressMonitor) {
<span class="nc" id="L131">		JSONObject jsonObject = new JSONObject(new JSONTokener(reader));</span>
<span class="nc" id="L132">		return load(jsonObject.toMap(), base, progressMonitor);</span>
	}
	
	default Object loadJsonObject(URL url, ProgressMonitor progressMonitor) throws IOException {
<span class="nc" id="L136">		progressMonitor.worked(1, &quot;Loading JSON object from &quot; + url);</span>
<span class="nc" id="L137">		return loadJsonObject(url.openStream(), URI.createURI(url.toString()), progressMonitor);</span>
	}
		
	default Object loadJsonArray(String str, URI base, ProgressMonitor progressMonitor) {
<span class="nc" id="L141">		JSONArray jsonArray = new JSONArray(new JSONTokener(str));</span>
<span class="nc" id="L142">		return load(jsonArray.toList(), base, progressMonitor);</span>
	}
	
	default Object loadJsonArray(InputStream in, URI base, ProgressMonitor progressMonitor) throws IOException {
<span class="nc" id="L146">		try (Reader reader = new InputStreamReader(in, getCharset())) {</span>
<span class="nc" id="L147">			return loadJsonArray(reader,  base, progressMonitor);</span>
		}
	}
	
	default Object loadJsonArray(Reader reader, URI base, ProgressMonitor progressMonitor) {
<span class="nc" id="L152">		JSONArray jsonArray = new JSONArray(new JSONTokener(reader));</span>
<span class="nc" id="L153">		return load(jsonArray.toList(), base, progressMonitor);</span>
	}
	
	default Object loadJsonArray(URL url, ProgressMonitor progressMonitor) throws IOException {
<span class="nc" id="L157">		progressMonitor.worked(1, &quot;Loading JSON array from &quot; + url);</span>
<span class="nc" id="L158">		return loadJsonArray(url.openStream(), URI.createURI(url.toString()), progressMonitor);</span>
	}
	
	/**
	 * Override to customize charset.
	 * @return
	 */
	default Charset getCharset() {
<span class="nc" id="L166">		return StandardCharsets.UTF_8;</span>
	}
	
	/*
	 * TODO - loading from Excel using Apache POI - https://search.maven.org/artifact/org.apache.poi/poi/5.0.0/jar
	 * Use URL fragment to address Sheets and ranges. E.g. myworkbook.xslx#Sheet1:A1:C100
	 * If no fragment - a map of sheet names to lists of maps with first row as key names and subsequent rows as data.
	 * For streams - pass sheet and range as method parameters.
	 * Figure out how to get the type, e.g. if the type is known beforehand - type provider function taking a tuple. 
	 * Maybe too complex to be handled at this level. 
	 */
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>