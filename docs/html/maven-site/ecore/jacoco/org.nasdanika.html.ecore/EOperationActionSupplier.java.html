<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EOperationActionSupplier.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika HTML Ecore documentation</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.html.ecore</a> &gt; <span class="el_source">EOperationActionSupplier.java</span></div><h1>EOperationActionSupplier.java</h1><pre class="source lang-java linenums">package org.nasdanika.html.ecore;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.function.BiFunction;
import java.util.function.Function;
import java.util.function.Predicate;

import org.apache.commons.codec.binary.Hex;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EClassifier;
import org.eclipse.emf.ecore.EGenericType;
import org.eclipse.emf.ecore.EModelElement;
import org.eclipse.emf.ecore.ENamedElement;
import org.eclipse.emf.ecore.EOperation;
import org.eclipse.emf.ecore.EPackage;
import org.eclipse.emf.ecore.EParameter;
import org.nasdanika.common.Context;
import org.nasdanika.common.NasdanikaException;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.html.Fragment;
import org.nasdanika.html.HTMLFactory;
import org.nasdanika.html.Tag;
import org.nasdanika.html.TagName;
import org.nasdanika.html.bootstrap.Table;
import org.nasdanika.html.model.app.Action;
import org.nasdanika.html.model.app.AppFactory;
import org.nasdanika.html.model.app.SectionStyle;

public class EOperationActionSupplier extends ETypedElementActionSupplier&lt;EOperation&gt; implements EcoreActionSupplier  {

	public EOperationActionSupplier(
			EOperation value, 
			Context context, 
			java.util.function.Function&lt;EPackage,String&gt; ePackagePathComputer,
			Predicate&lt;EModelElement&gt; elementPredicate,
			BiFunction&lt;ENamedElement, String, String&gt; labelProvider) {
<span class="fc" id="L40">		super(value, context, ePackagePathComputer, elementPredicate, labelProvider);</span>
<span class="fc" id="L41">	}</span>
	
	@Override
	public Action execute(EClass contextEClass, ProgressMonitor progressMonitor) {
		try {
<span class="fc" id="L46">			Action action = super.execute(contextEClass, progressMonitor);</span>
<span class="fc" id="L47">			action.setSectionStyle(SectionStyle.HEADER);</span>
			
<span class="fc" id="L49">			EClass eContainingClass = eObject.getEContainingClass();</span>
			
<span class="fc" id="L51">			EList&lt;Action&gt; sections = action.getSections();		</span>
			
<span class="fc bfc" id="L53" title="All 2 branches covered.">			if (!eObject.getEParameters().isEmpty()) {</span>
<span class="fc" id="L54">				Action parametersCategory = AppFactory.eINSTANCE.createAction();</span>
<span class="fc" id="L55">				parametersCategory.setText(&quot;Parameters&quot;);</span>
<span class="fc" id="L56">				sections.add(parametersCategory);</span>
<span class="fc" id="L57">				EList&lt;Action&gt; parameters = parametersCategory.getSections();</span>
				
				// Creating a digest of parameter types to make the id shorter.
<span class="fc" id="L60">				MessageDigest md = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
				
<span class="fc bfc" id="L62" title="All 2 branches covered.">				for (EParameter ep: eObject.getEParameters()) {</span>
<span class="fc" id="L63">					EClassifier type = ep.getEType();</span>
<span class="fc" id="L64">					String typeStr = type.eClass().getName() + &quot;-&quot; + encodeEPackage(type.getEPackage()) + &quot;-&quot; + type.getName() + &quot;,&quot;;</span>
<span class="fc" id="L65">					md.update(typeStr.getBytes(StandardCharsets.UTF_8));</span>
					
<span class="fc" id="L67">					parameters.add(adaptChild(ep).execute(contextEClass, progressMonitor));				</span>
<span class="fc" id="L68">				}</span>
			}
			
<span class="fc" id="L71">			String signature = eOperationSignature(eObject, this::encodeEPackage);</span>
			
<span class="fc" id="L73">			StringBuilder idBuilder = new StringBuilder(encodeEPackage(eContainingClass.getEPackage()))</span>
<span class="fc" id="L74">					.append(&quot;-&quot;)</span>
<span class="fc" id="L75">					.append(eContainingClass.getName())</span>
<span class="fc" id="L76">					.append(&quot;-&quot;)</span>
<span class="fc" id="L77">					.append(signature);</span>
			
<span class="fc" id="L79">			action.setId(idBuilder.toString());</span>
<span class="fc" id="L80">			action.setName(signature);</span>
			
			// Exceptions
<span class="fc" id="L83">			EList&lt;EGenericType&gt; eGenericExceptions = eObject.getEGenericExceptions();</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">			if (!eGenericExceptions.isEmpty()) {</span>
<span class="nc" id="L85">				HTMLFactory htmlFactory = context.get(HTMLFactory.class);</span>
<span class="nc" id="L86">				Fragment gstf = htmlFactory.fragment(TagName.h3.create(&quot;Exceptions&quot;));</span>
	
<span class="nc" id="L88">				Tag list = TagName.ul.create();</span>
<span class="nc" id="L89">				gstf.content(list);</span>
				
<span class="nc bnc" id="L91" title="All 2 branches missed.">				for (EGenericType genericException: eGenericExceptions) {</span>
<span class="nc" id="L92">					Tag listItem = TagName.li.create();</span>
<span class="nc" id="L93">					list.content(listItem);</span>
<span class="nc" id="L94">					genericType(genericException, contextEClass, listItem.getContent()::add, progressMonitor);</span>
<span class="nc" id="L95">				}</span>
<span class="nc" id="L96">				addContent(action, gstf.toString());</span>
			}				
			
<span class="fc" id="L99">			return action;</span>
<span class="nc" id="L100">		} catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L101">			throw new NasdanikaException(e);</span>
		}
	}
	
	public static String eOperationSignature(EOperation eOperation, Function&lt;EPackage, String&gt; ePackageEncoder) throws NoSuchAlgorithmException {		
<span class="fc" id="L106">		StringBuilder signatureBuilder = new StringBuilder(eOperation.eClass().getName())</span>
<span class="fc" id="L107">				.append(&quot;-&quot;)</span>
<span class="fc" id="L108">				.append(eOperation.getName());</span>
		
<span class="fc bfc" id="L110" title="All 2 branches covered.">		if (!eOperation.getEParameters().isEmpty()) {</span>
			// Creating a digest of parameter types to make the id shorter.
<span class="fc" id="L112">			MessageDigest md = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
			
<span class="fc bfc" id="L114" title="All 2 branches covered.">			for (EParameter ep: eOperation.getEParameters()) {</span>
<span class="fc" id="L115">				EClassifier type = ep.getEType();</span>
<span class="fc" id="L116">				String typeStr = type.eClass().getName() + &quot;-&quot; + ePackageEncoder.apply(type.getEPackage()) + &quot;-&quot; + type.getName() + &quot;,&quot;;</span>
<span class="fc" id="L117">				md.update(typeStr.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L118">			}</span>
<span class="fc" id="L119">			signatureBuilder.append(&quot;-&quot;).append(Hex.encodeHexString(md.digest()));			</span>
		}

<span class="fc" id="L122">		return signatureBuilder.toString();</span>
	}
	
	@Override
	protected Table propertiesTable(EClass contextEClass, ProgressMonitor monitor) {
<span class="fc" id="L127">		Table table = super.propertiesTable(contextEClass, monitor);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">		if (contextEClass != null) {</span>
<span class="fc" id="L129">				addRow(table, &quot;Declaring class&quot;).add(link(eObject.getEContainingClass(), contextEClass));</span>
		}
<span class="fc" id="L131">		return table;</span>
	}
		
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>