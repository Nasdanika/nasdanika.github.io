<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NavigationPanelConsumerFactoryAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika Application Model Generation Adapters</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.html.model.app.gen</a> &gt; <span class="el_source">NavigationPanelConsumerFactoryAdapter.java</span></div><h1>NavigationPanelConsumerFactoryAdapter.java</h1><pre class="source lang-java linenums">package org.nasdanika.html.model.app.gen;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Map;

import org.eclipse.emf.common.notify.AdapterFactory;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.EObject;
import org.json.JSONObject;
import org.nasdanika.common.BiSupplier;
import org.nasdanika.common.Context;
import org.nasdanika.common.Function;
import org.nasdanika.common.ListCompoundSupplierFactory;
import org.nasdanika.common.MapCompoundSupplierFactory;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.emf.EObjectAdaptable;
import org.nasdanika.html.HTMLElement;
import org.nasdanika.html.HTMLFactory;
import org.nasdanika.html.Input;
import org.nasdanika.html.InputType;
import org.nasdanika.html.Tag;
import org.nasdanika.html.TagName;
import org.nasdanika.html.bootstrap.BootstrapFactory;
import org.nasdanika.html.bootstrap.Breakpoint;
import org.nasdanika.html.bootstrap.Card;
import org.nasdanika.html.bootstrap.Color;
import org.nasdanika.html.bootstrap.Size;
import org.nasdanika.html.bootstrap.TagBootstrapElement;
import org.nasdanika.html.jstree.JsTreeFactory;
import org.nasdanika.html.jstree.JsTreeNode;
import org.nasdanika.html.model.app.AppPackage;
import org.nasdanika.html.model.app.Label;
import org.nasdanika.html.model.app.NavigationPanel;
import org.nasdanika.html.model.app.NavigationPanelStyle;

public class NavigationPanelConsumerFactoryAdapter extends PagePartConsumerFactoryAdapter&lt;NavigationPanel&gt; {

	public static final String CLEAR_STATE_FILTER = &quot;tree.state.filter = function(state) { delete state.core.selected; return state; };&quot;;
	private static final String SEARCH_FILTER = &quot; tree.search.search_callback = function(searchStr, node) { if (typeof window.nsdJsTreeSearchCallback === 'function') return window.nsdJsTreeSearchCallback(searchStr, node); var sf = new $.vakata.search(searchStr, true, { caseSensitive : false, fuzzy : false }); return sf.search(node.text).isMatch; };&quot;;
	private static final String SEARCH_INPUT_SUFFIX = &quot;_searchInput&quot;;
	private static final String SEARCH_INPUT_TOOLTIP = &quot;Full-text search. You can use wildcards, e.g. 'foo*' or 'f*o'; title or content fields, e.g. 'title:foo* bar'; boosts, e.g. 'foo^10 bar'; fuzzy matches, e.g. 'foo~1'; and term presence, e.g. '+foo bar -baz'&quot;;

	protected NavigationPanelConsumerFactoryAdapter(NavigationPanel navigationPanel, AdapterFactory adapterFactory) {
<span class="fc" id="L47">		super(navigationPanel, adapterFactory);</span>
<span class="fc" id="L48">	}</span>
	
	private Function&lt;BiSupplier&lt;HTMLElement&lt;?&gt;, List&lt;JsTreeNode&gt;&gt;, HTMLElement&lt;?&gt;&gt; createTreeFunction(NavigationPanelStyle effectiveStyle, Context context) {
<span class="fc" id="L51">		return new Function&lt;BiSupplier&lt;HTMLElement&lt;?&gt;, List&lt;JsTreeNode&gt;&gt;, HTMLElement&lt;?&gt;&gt;() {</span>
			
			@Override
			public double size() {
<span class="fc" id="L55">				return 1;</span>
			}
			
			@Override
			public String name() {
<span class="fc" id="L60">				return &quot;JsTree&quot;;</span>
			}
			
			@Override
			public HTMLElement&lt;?&gt; execute(BiSupplier&lt;HTMLElement&lt;?&gt;, List&lt;JsTreeNode&gt;&gt; input, ProgressMonitor progressMonitor) {
<span class="fc" id="L65">				Tag ret = (Tag) input.getFirst();</span>
				
				Tag panel;
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">				if (getTarget().isCollapsible()) {</span>
<span class="nc" id="L69">					Tag triggerDiv = ret.getFactory().div().addClass(&quot;nsd-collapse-panel&quot;, &quot;bg-light&quot;, &quot;text-center&quot;);</span>
<span class="nc" id="L70">					ret.content(triggerDiv);</span>
<span class="nc" id="L71">					HTMLFactory htmlFactory = ret.getFactory();</span>
<span class="nc" id="L72">					panel = htmlFactory.div();</span>
<span class="nc" id="L73">					panel.id(&quot;nsd-nav-panel-&quot; + getTarget().getUuid() + &quot;-collapsible&quot;);</span>
					
<span class="nc" id="L75">					Tag iTag = htmlFactory.tag(TagName.i).addClass(&quot;fa&quot;).attribute(&quot;aria-hidden&quot;, &quot;true&quot;);</span>

<span class="nc" id="L77">					Tag collapsibleTrigger = htmlFactory.span(iTag)</span>
<span class="nc" id="L78">							.addClass(&quot;nsd-collapsible-trigger&quot;)</span>
<span class="nc" id="L79">							.attribute(&quot;data-toggle&quot;, &quot;collapse&quot;)</span>
<span class="nc" id="L80">							.attribute(&quot;data-target&quot;, &quot;#&quot; + panel.getId())</span>
<span class="nc" id="L81">							.attribute(&quot;aria-expanded&quot;, &quot;true&quot;)</span>
<span class="nc" id="L82">							.attribute(&quot;aria-controls&quot;, panel.getId())</span>
<span class="nc" id="L83">							.attribute(&quot;title&quot;, &quot;Toggle panel&quot;)</span>
<span class="nc" id="L84">							.id(panel.getId()+&quot;-trigger&quot;);</span>
					
<span class="nc" id="L86">					triggerDiv.content(collapsibleTrigger);</span>
<span class="nc" id="L87">					panel.addClass(&quot;nsd-collapsible&quot;, &quot;collapse&quot;, &quot;show&quot;);</span>
<span class="nc" id="L88">					panel.style(&quot;clear&quot;, &quot;right&quot;);</span>

<span class="nc" id="L90">					ret.content(panel);</span>
<span class="nc" id="L91">				} else {</span>
<span class="fc" id="L92">					panel = ret;</span>
				}
				
<span class="fc" id="L95">				JsTreeFactory jsTreeFactory = context.get(JsTreeFactory.class, JsTreeFactory.INSTANCE);</span>
<span class="fc" id="L96">				HTMLFactory htmlFactory = jsTreeFactory.getHTMLFactory();</span>
<span class="fc" id="L97">				String treeId = getTarget().getId();</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">				if (org.nasdanika.common.Util.isBlank(treeId)) {</span>
<span class="fc" id="L99">					treeId = htmlFactory.nextId();</span>
				}
				
<span class="fc" id="L102">				String searchInputId = null;</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">				if (effectiveStyle == NavigationPanelStyle.SEARCHABLE_TREE) {</span>
<span class="fc" id="L104">					Input searchInput = htmlFactory.input(InputType.text);</span>
<span class="fc" id="L105">					searchInput.addClass(&quot;form-control&quot;, &quot;mt-1&quot;);</span>
<span class="fc" id="L106">					searchInputId = treeId + SEARCH_INPUT_SUFFIX;</span>
<span class="fc" id="L107">					searchInput.id(searchInputId);</span>
<span class="fc" id="L108">					searchInput.attribute(&quot;title&quot;, SEARCH_INPUT_TOOLTIP);</span>
<span class="fc" id="L109">					panel.accept(searchInput);</span>
				}
				
<span class="fc" id="L112">				Tag container = htmlFactory.div().id(treeId);</span>
<span class="fc" id="L113">				panel.accept(container);</span>
				
<span class="fc" id="L115">				JSONObject jsTree = jsTreeFactory.buildJsTree(input.getSecond());</span>

				// Configures jsTree. TODO - from the model.
<span class="fc" id="L118">				List&lt;String&gt; plugins = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L119">				plugins.add(&quot;state&quot;);</span>
<span class="fc" id="L120">				plugins.add(&quot;type&quot;);</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">				if (effectiveStyle == NavigationPanelStyle.SEARCHABLE_TREE) {</span>
<span class="fc" id="L122">					plugins.add(&quot;search&quot;);</span>
<span class="fc" id="L123">					JSONObject searchConfig = new JSONObject();</span>
<span class="fc" id="L124">					searchConfig.put(&quot;show_only_matches&quot;, true);</span>
<span class="fc" id="L125">					searchConfig.put(&quot;show_only_matches_children&quot;, true);</span>
<span class="fc" id="L126">					jsTree.put(&quot;search&quot;, searchConfig);</span>
					
					// TODO - use lunrjs search.js
				}
				
<span class="fc" id="L131">				jsTree.put(&quot;plugins&quot;, plugins); 		</span>
<span class="fc" id="L132">				jsTree.put(&quot;state&quot;, Collections.singletonMap(&quot;key&quot;, treeId));</span>
<span class="fc" id="L133">				jsTree.put(&quot;types&quot;, Collections.singletonMap(&quot;leaf&quot;, Collections.singletonMap(&quot;icon&quot;, &quot;jstree-file&quot;))); // File leaf icon.</span>
				
				// Deletes selection from state
<span class="fc" id="L136">				String filter = CLEAR_STATE_FILTER;</span>
				
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">				if (effectiveStyle == NavigationPanelStyle.SEARCHABLE_TREE) {</span>
<span class="fc" id="L139">					filter += &quot; &quot; + SEARCH_FILTER;</span>
				}
				
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">				Tag script = jsTreeFactory.bind(container, jsTree, filter, searchInputId == null ? null : &quot;#&quot; + searchInputId);</span>
<span class="fc" id="L143">				panel.accept(script);</span>
				
<span class="fc" id="L145">				return ret;</span>
			}
						
		};
	}
	
	private Function&lt;BiSupplier&lt;HTMLElement&lt;?&gt;, Map&lt;Class&lt;?&gt;, Object&gt;&gt;, HTMLElement&lt;?&gt;&gt; createCardsFunction(Context context) {
<span class="fc" id="L152">		return new Function&lt;BiSupplier&lt;HTMLElement&lt;?&gt;, Map&lt;Class&lt;?&gt;, Object&gt;&gt;, HTMLElement&lt;?&gt;&gt;() {</span>
			
			@Override
			public double size() {
<span class="fc" id="L156">				return 1;</span>
			}
			
			@Override
			public String name() {
<span class="fc" id="L161">				return &quot;Cards&quot;;</span>
			}
			
			@SuppressWarnings(&quot;unchecked&quot;)
			@Override
			public HTMLElement&lt;?&gt; execute(BiSupplier&lt;HTMLElement&lt;?&gt;, Map&lt;Class&lt;?&gt;, Object&gt;&gt; input, ProgressMonitor progressMonitor) {
<span class="fc" id="L167">				Tag ret = (Tag) input.getFirst();</span>
				Tag panel;
<span class="fc bfc" id="L169" title="All 2 branches covered.">				if (getTarget().isCollapsible()) {</span>
<span class="fc" id="L170">					HTMLFactory htmlFactory = ret.getFactory();</span>
<span class="fc" id="L171">					Tag triggerDiv = htmlFactory.div().addClass(&quot;nsd-collapse-panel&quot;, &quot;bg-light&quot;, &quot;text-center&quot;);</span>
<span class="fc" id="L172">					ret.content(triggerDiv);</span>
<span class="fc" id="L173">					panel = htmlFactory.div();</span>
<span class="fc" id="L174">					panel.id(&quot;nsd-nav-panel-&quot; + getTarget().getUuid() + &quot;-collapsible&quot;);</span>
					
<span class="fc" id="L176">					Tag iTag = htmlFactory.tag(TagName.i).addClass(&quot;fa&quot;).attribute(&quot;aria-hidden&quot;, &quot;true&quot;);</span>

<span class="fc" id="L178">					Tag collapsibleTrigger = htmlFactory.span(iTag)</span>
<span class="fc" id="L179">							.addClass(&quot;nsd-collapsible-trigger&quot;)</span>
<span class="fc" id="L180">							.attribute(&quot;data-toggle&quot;, &quot;collapse&quot;)</span>
<span class="fc" id="L181">							.attribute(&quot;data-target&quot;, &quot;#&quot; + panel.getId())</span>
<span class="fc" id="L182">							.attribute(&quot;aria-expanded&quot;, &quot;true&quot;)</span>
<span class="fc" id="L183">							.attribute(&quot;aria-controls&quot;, panel.getId())</span>
<span class="fc" id="L184">							.attribute(&quot;title&quot;, &quot;Toggle panel&quot;)							</span>
<span class="fc" id="L185">							.id(panel.getId()+&quot;-trigger&quot;);</span>
					
<span class="fc" id="L187">					triggerDiv.content(collapsibleTrigger);</span>
<span class="fc" id="L188">					panel.addClass(&quot;nsd-collapsible&quot;, &quot;collapse&quot;, &quot;show&quot;);</span>
<span class="fc" id="L189">					panel.style(&quot;clear&quot;, &quot;right&quot;);</span>

<span class="fc" id="L191">					ret.content(panel);</span>
<span class="fc" id="L192">				} else {</span>
<span class="fc" id="L193">					panel = ret;</span>
				}
				
<span class="fc" id="L196">				List&lt;Object&gt; items = (List&lt;Object&gt;) input.getSecond().get(Object.class);</span>
				
<span class="fc" id="L198">				JsTreeFactory jsTreeFactory = context.get(JsTreeFactory.class, JsTreeFactory.INSTANCE);</span>
<span class="fc" id="L199">				String treeId = getTarget().getId();</span>
<span class="fc" id="L200">				HTMLFactory htmlFactory = jsTreeFactory.getHTMLFactory();</span>
				
<span class="fc" id="L202">				Tag currentActionGroup = null; // Add items without children to an action group</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">				for (Object item: items) {</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">					if (item instanceof Tag) {</span>
<span class="fc" id="L205">						Tag itemTag = (Tag) item;</span>
<span class="fc" id="L206">						Object data = itemTag.getData();</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">						if (data instanceof Label) {</span>
<span class="fc" id="L208">							Label semanticElement = (Label) data; </span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">							if (semanticElement.getChildren().isEmpty()) {</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">								if (currentActionGroup == null) {</span>
<span class="fc" id="L211">									currentActionGroup = htmlFactory.div().addClass(&quot;list-group&quot;, &quot;list-group-flush&quot;);</span>
								}
<span class="fc" id="L213">								itemTag.addClass(&quot;list-group-item&quot;, &quot;list-group-action&quot;);</span>
<span class="fc" id="L214">								itemTag.addClassConditional(semanticElement.isActive(), &quot;active&quot;);</span>
<span class="fc" id="L215">								itemTag.addClassConditional(semanticElement.isDisabled(), &quot;disabled&quot;);</span>
<span class="fc" id="L216">								currentActionGroup.accept(itemTag);</span>
							} else {
<span class="fc bfc" id="L218" title="All 2 branches covered.">								if (currentActionGroup != null) {</span>
<span class="fc" id="L219">									panel.accept(currentActionGroup);</span>
<span class="fc" id="L220">									currentActionGroup = null;</span>
								}
								
<span class="fc" id="L223">								Card card = context.get(BootstrapFactory.class, BootstrapFactory.INSTANCE).card();</span>
<span class="fc" id="L224">								panel.accept(card);</span>
<span class="fc" id="L225">								TagBootstrapElement cardHeader = card.getHeader();</span>
<span class="fc" id="L226">								Color color = semanticElement.getColor();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">								if (color != null) {</span>
<span class="fc" id="L228">									card.border(color);</span>
<span class="fc" id="L229">									cardHeader.background(color);</span>
								}
<span class="fc" id="L231">								Tag title = (Tag) itemTag.getContent().get(0);</span>
								
								// Remove dropdown classes and attributes
<span class="fc" id="L234">								title</span>
<span class="fc" id="L235">									.removeClass(&quot;nav-link&quot;, &quot;dropdown-toggle&quot;)</span>
<span class="fc" id="L236">									.attribute(&quot;role&quot;, null)</span>
<span class="fc" id="L237">									.attribute(&quot;data-toggle&quot;, null);								</span>
								
<span class="fc bfc" id="L239" title="All 2 branches covered.">								if (color != null) {</span>
<span class="fc" id="L240">									title.removeClass(&quot;text-&quot; + color.code);</span>
								}
								
<span class="fc" id="L243">								Tag cardHeaderTag = cardHeader.toHTMLElement();</span>
								Tag collapsible;
								// Tree or items
<span class="fc" id="L246">								TagBootstrapElement cardBody = card.getBody();																</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">								if (depth(semanticElement.getChildren()) == 1) {</span>
<span class="fc" id="L248">									Tag childrenActionGroup = htmlFactory.div().addClass(&quot;list-group&quot;, &quot;list-group-flush&quot;);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">									for (Object itemChild: (List&lt;Object&gt;) itemTag.getData(AppPackage.Literals.LABEL__CHILDREN)) {</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">										if (itemChild instanceof Tag) {</span>
<span class="fc" id="L251">											Tag itemChildTag = (Tag) itemChild;</span>
<span class="fc" id="L252">											Label childSemanticElement = (Label) itemChildTag.getData();</span>
<span class="fc" id="L253">											itemChildTag.addClass(&quot;list-group-item&quot;, &quot;list-group-action&quot;).removeClass(&quot;dropdown-item&quot;);</span>
<span class="fc" id="L254">											itemChildTag.addClassConditional(childSemanticElement.isActive(), &quot;active&quot;);</span>
<span class="fc" id="L255">											itemChildTag.addClassConditional(childSemanticElement.isDisabled(), &quot;disabled&quot;);</span>
<span class="fc" id="L256">											childrenActionGroup.accept(itemChildTag);</span>
<span class="fc" id="L257">										} else {</span>
<span class="nc" id="L258">											cardBody.toHTMLElement().accept(itemChild);</span>
										}
<span class="fc" id="L260">									}</span>
<span class="fc" id="L261">									card.toHTMLElement().accept(childrenActionGroup);</span>
<span class="fc" id="L262">									collapsible = childrenActionGroup;</span>
<span class="fc" id="L263">								} else {									</span>
<span class="fc" id="L264">									cardBody.padding().all(Breakpoint.DEFAULT, Size.S1);</span>
<span class="fc" id="L265">									collapsible = cardBody.toHTMLElement();</span>
<span class="fc" id="L266">									List&lt;JsTreeNode&gt; nodes = (List&lt;JsTreeNode&gt;) input.getSecond().get(JsTreeNode.class);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">									for (JsTreeNode node: nodes) {</span>
<span class="fc bfc" id="L268" title="All 2 branches covered.">										if (node.getData() == semanticElement) {</span>
											String nodeTreeId;
<span class="fc bfc" id="L270" title="All 2 branches covered.">											if (org.nasdanika.common.Util.isBlank(treeId)) {</span>
<span class="fc" id="L271">												nodeTreeId = &quot;nsd-nav-tree-&quot; + semanticElement.getId();</span>
											} else {
<span class="fc" id="L273">												nodeTreeId = treeId + &quot;-&quot; + semanticElement.getId();</span>
											}
											
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">											boolean isSearchable = treeSize(node.children()) &gt;= getSearchThreshold();									</span>
<span class="fc" id="L277">											String searchInputId = null;</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">											if (isSearchable) {</span>
<span class="fc" id="L279">												Input searchInput = htmlFactory.input(InputType.text);</span>
<span class="fc" id="L280">												searchInput.addClass(&quot;form-control&quot;);</span>
<span class="fc" id="L281">												searchInputId = cardBody.getFactory().getHTMLFactory().nextId() + SEARCH_INPUT_SUFFIX;</span>
<span class="fc" id="L282">												searchInput.id(searchInputId);</span>
<span class="fc" id="L283">												searchInput.attribute(&quot;title&quot;, SEARCH_INPUT_TOOLTIP);												</span>
<span class="fc" id="L284">												cardBody.toHTMLElement().accept(searchInput);</span>
											}
											
<span class="fc" id="L287">											Tag container = htmlFactory.div().id(nodeTreeId);</span>
<span class="fc" id="L288">											cardBody.toHTMLElement().accept(container);</span>
											
<span class="fc" id="L290">											JSONObject jsTree = jsTreeFactory.buildJsTree(node.children());</span>
							
											// Configures jsTree. TODO - from the model.
<span class="fc" id="L293">											List&lt;String&gt; plugins = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L294">											plugins.add(&quot;state&quot;);</span>
<span class="fc" id="L295">											plugins.add(&quot;type&quot;);</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">											if (isSearchable) {</span>
<span class="fc" id="L297">												plugins.add(&quot;search&quot;);</span>
<span class="fc" id="L298">												JSONObject searchConfig = new JSONObject();</span>
<span class="fc" id="L299">												searchConfig.put(&quot;show_only_matches&quot;, true);</span>
<span class="fc" id="L300">												searchConfig.put(&quot;show_only_matches_children&quot;, true);</span>
<span class="fc" id="L301">												jsTree.put(&quot;search&quot;, searchConfig);</span>
												
												// TODO - use lunrjs search.js
											}
											
<span class="fc" id="L306">											jsTree.put(&quot;plugins&quot;, plugins); 		</span>
<span class="fc" id="L307">											jsTree.put(&quot;state&quot;, Collections.singletonMap(&quot;key&quot;, treeId));</span>
<span class="fc" id="L308">											jsTree.put(&quot;types&quot;, Collections.singletonMap(&quot;leaf&quot;, Collections.singletonMap(&quot;icon&quot;, &quot;jstree-file&quot;))); // File leaf icon.</span>
											
											// Deletes selection from state
<span class="fc" id="L311">											String filter = CLEAR_STATE_FILTER;</span>
											
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">											if (isSearchable) {</span>
<span class="fc" id="L314">												filter += &quot; &quot; + SEARCH_FILTER;</span>
											}
											
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">											Tag script = jsTreeFactory.bind(container, jsTree, filter, searchInputId == null ? null : &quot;#&quot; + searchInputId);</span>
<span class="fc" id="L318">											panel.accept(script);</span>
<span class="fc" id="L319">											break;</span>
										}
<span class="fc" id="L321">									}</span>
								}

								// Collapse button
<span class="fc bfc" id="L325" title="All 2 branches covered.">								if (getTarget().getStyle() == NavigationPanelStyle.COLLAPSIBLE_CARDS) {</span>
<span class="fc" id="L326">									Tag iTag = htmlFactory.tag(TagName.i).addClass(&quot;fa&quot;).attribute(&quot;aria-hidden&quot;, &quot;true&quot;);</span>
<span class="fc" id="L327">									collapsible.id(semanticElement.getId()+&quot;-collapsible&quot;);</span>

<span class="fc" id="L329">									Tag collapsibleTrigger = htmlFactory.span(iTag)</span>
<span class="fc" id="L330">											.addClass(&quot;nsd-collapsible-trigger&quot;)</span>
<span class="fc" id="L331">											.attribute(&quot;data-toggle&quot;, &quot;collapse&quot;)</span>
<span class="fc" id="L332">											.attribute(&quot;data-target&quot;, &quot;#&quot; + collapsible.getId())</span>
<span class="fc" id="L333">											.attribute(&quot;aria-expanded&quot;, &quot;true&quot;)</span>
<span class="fc" id="L334">											.attribute(&quot;aria-controls&quot;, collapsible.getId())</span>
<span class="fc" id="L335">											.attribute(&quot;title&quot;, &quot;Toggle card&quot;)											</span>
<span class="fc" id="L336">											.id(semanticElement.getId()+&quot;-collapsible-trigger&quot;);</span>
									
<span class="fc" id="L338">									cardHeaderTag.content(collapsibleTrigger);</span>
<span class="fc" id="L339">									collapsible.addClass(&quot;nsd-collapsible&quot;, &quot;collapse&quot;, &quot;show&quot;);</span>
								}
								
<span class="fc" id="L342">								cardHeaderTag.content(title);								</span>
							}
<span class="fc" id="L344">						} else {</span>
<span class="nc" id="L345">							panel.accept(item);</span>
						}						
<span class="fc" id="L347">					} else {</span>
<span class="nc" id="L348">						panel.accept(item);</span>
					}
<span class="fc" id="L350">				}</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">				if (currentActionGroup != null) {</span>
<span class="fc" id="L352">					panel.accept(currentActionGroup);</span>
				}
				
<span class="fc" id="L355">				return ret;</span>
			}
		};
	}
	
	protected int getSearchThreshold() {
<span class="fc" id="L361">		return getTarget().getJsTreeSearchThreshold(); </span>
	}
		
	private static int depth(Collection&lt;EObject&gt; items) {
<span class="fc" id="L365">		int ret = 0;</span>
<span class="fc bfc" id="L366" title="All 2 branches covered.">		for (EObject item: items) {</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">			if (item instanceof Label) {</span>
<span class="fc" id="L368">				ret = Math.max(ret, depth(((Label) item).getChildren()) + 1);</span>
			}
<span class="fc" id="L370">		}</span>
<span class="fc" id="L371">		return ret;</span>
	}
	
	private static int treeSize(Collection&lt;JsTreeNode&gt; nodes) {
<span class="fc" id="L375">		int ret = 0;</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">		for (JsTreeNode node: nodes) {</span>
<span class="fc" id="L377">			++ret;</span>
<span class="fc" id="L378">			ret += treeSize(node.children());</span>
<span class="fc" id="L379">		}</span>
<span class="fc" id="L380">		return ret;</span>
	}	
	
	private static int size(Collection&lt;EObject&gt; items) {
<span class="fc" id="L384">		int ret = 0;</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">		for (EObject item: items) {</span>
<span class="fc" id="L386">			++ret;</span>
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">			if (item instanceof Label) {</span>
<span class="fc" id="L388">				ret += size(((Label) item).getChildren());</span>
			}
<span class="fc" id="L390">		}</span>
<span class="fc" id="L391">		return ret;</span>
	}
	
	/**
	 * Adapts items to {@link JsTreeNode} suppliers.
	 */
	@Override
	protected Function&lt;HTMLElement&lt;?&gt;, HTMLElement&lt;?&gt;&gt; createConfigureFunction(Context context) {
<span class="fc" id="L399">		NavigationPanel semanticElement = getTarget();</span>
<span class="fc" id="L400">		NavigationPanelStyle style = semanticElement.getStyle();</span>
		
<span class="fc" id="L402">		EList&lt;EObject&gt; items = semanticElement.getItems();</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">		if (style == NavigationPanelStyle.AUTO) {</span>
<span class="pc bpc" id="L404" title="1 of 4 branches missed.">			style = depth(items) &gt; 2 ?  size(items) &gt;= getSearchThreshold() ? NavigationPanelStyle.SEARCHABLE_TREE : NavigationPanelStyle.TREE : NavigationPanelStyle.CARDS; </span>
		}
		
<span class="fc" id="L407">		ListCompoundSupplierFactory&lt;JsTreeNode&gt; nodesFactory = new ListCompoundSupplierFactory&lt;&gt;(&quot;Nodes&quot;, EObjectAdaptable.adaptToSupplierFactoryNonNull(items, JsTreeNode.class));</span>
<span class="pc bpc" id="L408" title="1 of 4 branches missed.">		if (style == NavigationPanelStyle.TREE || style == NavigationPanelStyle.SEARCHABLE_TREE) {</span>
<span class="fc" id="L409">			Function&lt;HTMLElement&lt;?&gt;, BiSupplier&lt;HTMLElement&lt;?&gt;, List&lt;JsTreeNode&gt;&gt;&gt; nodesFunction = nodesFactory.&lt;HTMLElement&lt;?&gt;&gt;asFunctionFactory().create(context);</span>
<span class="fc" id="L410">			return super.createConfigureFunction(context).then(nodesFunction).then(createTreeFunction(style, context));</span>
		}
		
<span class="fc" id="L413">		ListCompoundSupplierFactory&lt;Object&gt; tagsFactory = new ListCompoundSupplierFactory&lt;&gt;(&quot;Tags&quot;, EObjectAdaptable.adaptToSupplierFactoryNonNull(items, Object.class));</span>
		
<span class="fc" id="L415">		MapCompoundSupplierFactory&lt;Class&lt;?&gt;, Object&gt; tagsAndNodesSupplierFactory = new MapCompoundSupplierFactory&lt;&gt;(&quot;Tags and nodes&quot;);</span>
<span class="fc" id="L416">		tagsAndNodesSupplierFactory.put(JsTreeNode.class, nodesFactory);</span>
<span class="fc" id="L417">		tagsAndNodesSupplierFactory.put(Object.class, tagsFactory);</span>
<span class="fc" id="L418">		Function&lt;HTMLElement&lt;?&gt;, BiSupplier&lt;HTMLElement&lt;?&gt;, Map&lt;Class&lt;?&gt;, Object&gt;&gt;&gt; tagsAndNodesFunction = tagsAndNodesSupplierFactory.&lt;HTMLElement&lt;?&gt;&gt;asFunctionFactory().create(context);</span>
		
<span class="fc" id="L420">		return super.createConfigureFunction(context).then(tagsAndNodesFunction).then(createCardsFunction(context));</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>