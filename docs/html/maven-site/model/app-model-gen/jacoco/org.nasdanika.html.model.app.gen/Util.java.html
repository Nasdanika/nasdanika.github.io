<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Util.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nasdanika Application Model Generation Adapters</a> &gt; <a href="index.source.html" class="el_package">org.nasdanika.html.model.app.gen</a> &gt; <span class="el_source">Util.java</span></div><h1>Util.java</h1><pre class="source lang-java linenums">package org.nasdanika.html.model.app.gen;

import static org.nasdanika.common.Util.isBlank;

import java.io.File;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.net.MalformedURLException;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Objects;
import java.util.UUID;
import java.util.function.BiConsumer;
import java.util.function.BiFunction;
import java.util.function.BiPredicate;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.TransformerException;

import org.apache.commons.text.StringEscapeUtils;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EClassifier;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EPackage;
import org.eclipse.emf.ecore.EPackage.Registry;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.util.Diagnostician;
import org.eclipse.emf.ecore.util.EcoreUtil;
import org.eclipse.emf.ecore.xmi.impl.XMIResourceFactoryImpl;
import org.json.JSONObject;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.nasdanika.common.ConsumerFactory;
import org.nasdanika.common.Context;
import org.nasdanika.common.DefaultConverter;
import org.nasdanika.common.Diagnostic;
import org.nasdanika.common.DiagnosticException;
import org.nasdanika.common.NasdanikaException;
import org.nasdanika.common.ProgressMonitor;
import org.nasdanika.common.Status;
import org.nasdanika.drawio.ConnectionBase;
import org.nasdanika.drawio.ModelElement;
import org.nasdanika.emf.EObjectAdaptable;
import org.nasdanika.emf.persistence.EObjectLoader;
import org.nasdanika.emf.persistence.GitMarkerFactory;
import org.nasdanika.emf.persistence.MarkerFactory;
import org.nasdanika.emf.persistence.NcoreDrawioResourceFactory;
import org.nasdanika.emf.persistence.TextResourceFactory;
import org.nasdanika.exec.ExecPackage;
import org.nasdanika.exec.content.ContentFactory;
import org.nasdanika.exec.content.ContentPackage;
import org.nasdanika.exec.content.Text;
import org.nasdanika.exec.resources.Container;
import org.nasdanika.exec.resources.ResourcesPackage;
import org.nasdanika.graph.processor.ProcessorConfig;
import org.nasdanika.graph.processor.emf.SemanticProcessor;
import org.nasdanika.html.Button;
import org.nasdanika.html.HTMLFactory;
import org.nasdanika.html.Tag;
import org.nasdanika.html.TagName;
import org.nasdanika.html.bootstrap.BootstrapFactory;
import org.nasdanika.html.bootstrap.Breakpoint;
import org.nasdanika.html.bootstrap.Color;
import org.nasdanika.html.emf.NcoreActionBuilder;
import org.nasdanika.html.model.app.Action;
import org.nasdanika.html.model.app.ActionReference;
import org.nasdanika.html.model.app.AppFactory;
import org.nasdanika.html.model.app.AppPackage;
import org.nasdanika.html.model.app.ContentPanel;
import org.nasdanika.html.model.app.Footer;
import org.nasdanika.html.model.app.Header;
import org.nasdanika.html.model.app.Label;
import org.nasdanika.html.model.app.Link;
import org.nasdanika.html.model.app.NavigationBar;
import org.nasdanika.html.model.app.NavigationPanel;
import org.nasdanika.html.model.app.SectionStyle;
import org.nasdanika.html.model.bootstrap.Appearance;
import org.nasdanika.html.model.bootstrap.BootstrapPackage;
import org.nasdanika.html.model.bootstrap.Item;
import org.nasdanika.html.model.html.HtmlPackage;
import org.nasdanika.ncore.NcorePackage;
import org.nasdanika.ncore.util.NcoreResourceSet;
import org.nasdanika.ncore.util.NcoreUtil;
import org.nasdanika.persistence.ObjectLoaderResourceFactory;
import org.nasdanika.resources.BinaryEntityContainer;
import org.xml.sax.SAXException;

import com.redfin.sitemapgenerator.ChangeFreq;
import com.redfin.sitemapgenerator.WebSitemapGenerator;
import com.redfin.sitemapgenerator.WebSitemapUrl;

public final class Util {
	
	public static final String DATA_NSD_LABEL_UUID_ATTRIBUTE = &quot;data-nsd-label-uuid&quot;;

	// Util
<span class="nc" id="L120">	private Util() {</span>
<span class="nc" id="L121">		throw new UnsupportedOperationException(&quot;Utility class, not to be instantiated&quot;);</span>
	}

	/**
	 * Creates Bootstrap Navs from a list of items.
	 * @param items
	 * @param bootstrapFactory
	 * @return
	 */
	public static Tag navs(List&lt;Object&gt; items, BootstrapFactory bootstrapFactory) {
<span class="fc" id="L131">		HTMLFactory htmlFactory = bootstrapFactory.getHTMLFactory();</span>
<span class="fc" id="L132">		Tag navs = htmlFactory.tag(TagName.ul).addClass(&quot;nav&quot;);</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">		for (Object item: items) {</span>
<span class="fc" id="L134">			Tag li = htmlFactory.tag(TagName.li, item).addClass(&quot;nav-item&quot;);</span>
<span class="fc" id="L135">			navs.accept(li);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">			if (item instanceof Tag) {</span>
<span class="fc" id="L137">				Tag itemTag = (Tag) item;</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">				if (TagName.a.name().equalsIgnoreCase(itemTag.getTagName())) {</span>
<span class="fc" id="L139">					itemTag.addClass(&quot;nav-link&quot;);</span>
<span class="fc" id="L140">					Object data = itemTag.getData();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">					if (data instanceof Item) {</span>
<span class="fc" id="L142">						Item itemData = (Item) data;</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">						if (itemData.isActive()) {</span>
<span class="fc" id="L144">							itemTag.addClass(&quot;active&quot;);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">						} else if (itemData.isDisabled()) {</span>
<span class="fc" id="L146">							itemTag.addClass(&quot;disabled&quot;);</span>
						}
					}
<span class="fc bfc" id="L149" title="All 2 branches covered.">				} else if (TagName.span.name().equalsIgnoreCase(itemTag.getTagName())) {</span>
<span class="fc" id="L150">					itemTag.addClass(&quot;navbar-text&quot;);</span>
				}
			}
<span class="fc" id="L153">		}</span>
<span class="fc" id="L154">		return navs;</span>
	}
	
	/**
	 * Creates Bootstrap Navs from a list of items.
	 * @param items
	 * @param bootstrapFactory
	 * @return
	 */
	public static Tag navbar(
			Tag brand, 
			List&lt;Object&gt; items,
			Breakpoint expand, 
			boolean dark,
			Color background,
			BootstrapFactory bootstrapFactory) {
<span class="fc" id="L170">		HTMLFactory htmlFactory = bootstrapFactory.getHTMLFactory();</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">		Tag navbar = htmlFactory.tag(TagName.ul).addClass(&quot;navbar&quot;, dark ? &quot;navbar-dark&quot; : &quot;navbar-light&quot;);</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">		if (expand != null) {</span>
<span class="fc" id="L173">			navbar.addClass(&quot;navbar-expand-&quot; + expand.code);</span>
		}
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">		if (background != null) {</span>
<span class="nc" id="L176">			navbar.addClass(&quot;bg-&quot; + background.code);</span>
		}
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (brand != null) {</span>
<span class="fc" id="L179">			brand.addClass(&quot;navbar-brand&quot;);</span>
<span class="fc" id="L180">			navbar.accept(brand);</span>
		}
<span class="fc" id="L182">		String navbarContentId = htmlFactory.nextId();</span>
<span class="fc" id="L183">		Button toggler = htmlFactory.button(htmlFactory.span().addClass(&quot;navbar-toggler-icon&quot;));</span>
<span class="fc" id="L184">		toggler</span>
<span class="fc" id="L185">			.addClass(&quot;navbar-toggler&quot;)</span>
<span class="fc" id="L186">			.attribute(&quot;type&quot;, &quot;button&quot;)</span>
<span class="fc" id="L187">			.attribute(&quot;data-toggle&quot;, &quot;collapse&quot;)</span>
<span class="fc" id="L188">			.attribute(&quot;data-target&quot;, &quot;#&quot; + navbarContentId)</span>
<span class="fc" id="L189">			.attribute(&quot;aria-expanded&quot;, &quot;false&quot;)</span>
<span class="fc" id="L190">			.attribute(&quot;aria-label&quot;, &quot;Toggle navigation&quot;);</span>
<span class="fc" id="L191">		navbar.accept(toggler);</span>
		
<span class="fc" id="L193">		Tag content = htmlFactory.div().addClass(&quot;collapse&quot;, &quot;navbar-collapse&quot;).id(navbarContentId);</span>
<span class="fc" id="L194">		navbar.accept(content);</span>
<span class="pc bpc" id="L195" title="1 of 4 branches missed.">		if (items != null &amp;&amp; !items.isEmpty()) {</span>
<span class="fc" id="L196">			Tag navs = navs(items, bootstrapFactory);</span>
<span class="fc" id="L197">			navs.removeClass(&quot;nav&quot;).addClass(&quot;navbar-nav&quot;, &quot;mr-auto&quot;);</span>
<span class="fc" id="L198">			content.accept(navs);</span>
		}
<span class="fc" id="L200">		return navbar;</span>
	}
	
	/**
	 * Generates application site from an {@link Action} model root. 
	 * @param root Root action to generate header and footer. Can be null.
	 * @param pageTemplate Page template.
	 * @param context Context used for uri resolution - interpolation of action locations and names. can be null.
	 * @param container Receiver of generated resources.
	 * @param progressMonitor Progress monitor.
	 */
	public static void generateSite(
			Label root, 
			org.nasdanika.html.model.bootstrap.Page pageTemplate,
			Container container,
			ActionContentProvider.Factory actionContentProviderFactory,
			PageContentProvider.Factory pageContentProviderFactory,
			Context context,
			ProgressMonitor progressMonitor) {
	
<span class="fc" id="L220">		Label principal = null;</span>
<span class="fc" id="L221">		EList&lt;EObject&gt; rootChildren = root.getChildren();</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">		if (rootChildren.size() &gt; 0) {</span>
<span class="fc" id="L223">			EObject firstChild = root.getChildren().get(0);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">			if (firstChild instanceof Action) {</span>
<span class="fc" id="L225">				principal = (Action) firstChild;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">			} else if (firstChild instanceof ActionReference) {</span>
<span class="nc" id="L227">				principal = ((ActionReference) firstChild).getTarget();</span>
			}
		}
		
<span class="fc" id="L231">		generateSite(root, principal, root, Collections.emptyList(), pageTemplate, container, actionContentProviderFactory, pageContentProviderFactory, context, progressMonitor);</span>
<span class="fc" id="L232">	}</span>
	
	/**
	 * Generates application site from an {@link Action} model using a random base URI and a caching URI resolver created from the argument context with base-uri injected.
	 * @param root Root action to generate header and footer. Can be null.
	 * @param principal Principal action to generate navigation bar and navigation panel. Can be null.
	 * @param activeAction Active action to generate the content panel if instance of action.
	 * @param actionPath Action path to show in breadcrumbs.
	 * @param pageTemplate Page template.
	 * @param context Context used for uri resolution - interpolation of action locations and names. can be null.
	 * @param container Receiver of generated resources.
	 * @param progressMonitor Progress monitor.
	 */
	public static void generateSite(
			Label root, 
			Label principal, 
			Label activeAction, 
			List&lt;Label&gt; actionPath,
			org.nasdanika.html.model.bootstrap.Page pageTemplate,
			Container container,
			ActionContentProvider.Factory contentProviderFactory,
			PageContentProvider.Factory pageProviderFactory,
			Context context,
			ProgressMonitor progressMonitor) {
	
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">		if (context == null) {</span>
<span class="nc" id="L258">			context = Context.EMPTY_CONTEXT;</span>
		}
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">		if (activeAction instanceof Action) {</span>
<span class="fc" id="L261">			context = Context.singleton(Action.class, (Action) activeAction).compose(context);</span>
		}
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">		if (context.get(Context.BASE_URI_PROPERTY) == null) {</span>
<span class="fc" id="L264">        	context = Context.singleton(Context.BASE_URI_PROPERTY, URI.createURI(&quot;temp://&quot; + UUID.randomUUID() + &quot;/&quot; + UUID.randomUUID() + &quot;/&quot;)).compose(context);</span>
		}
<span class="fc" id="L266">		BiFunction&lt;Label, URI, URI&gt; uriResolver = org.nasdanika.html.model.app.util.Util.uriResolver(root, context);		</span>
<span class="fc" id="L267">		generateSite(</span>
				root, 
				principal, 
				activeAction,
				actionPath,
				pageTemplate,
				uriResolver, 
<span class="fc" id="L274">				(URI) context.get(Context.BASE_URI_PROPERTY), </span>
				container, 
<span class="fc bfc" id="L276" title="All 2 branches covered.">				contentProviderFactory == null ? null : contentProviderFactory.create(context),</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">				pageProviderFactory == null ? null : pageProviderFactory.create(context),						</span>
				progressMonitor);
<span class="fc" id="L279">	}</span>
	
	/**
	 * Generates application site from an {@link Action} model
	 * @param root Root action to generate header and footer. Can be null.
	 * @param principal Principal action to generate navigation bar and navigation panel. Can be null.
	 * @param activeAction Active action to generate the content panel.
	 * @param pageTemplate Page template.
	 * @param uriResolver Resolves {@link Action} to {@link URI}.
	 * @param baseURI Base URI for resolution, specifically to create relative URI's.
	 * @param container Receiver of generated resources.
	 * @param progressMonitor Progress monitor.
	 */
	public static void generateSite(
			Label root, 
			Label principal, 
			Label activeAction, 
			List&lt;Label&gt; actionPath,
			org.nasdanika.html.model.bootstrap.Page pageTemplate,
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			URI baseURI,
			Container container,
			ActionContentProvider actionContentProvider,	
			PageContentProvider pageContentProvider,
			ProgressMonitor progressMonitor) {
		
<span class="fc bfc" id="L305" title="All 4 branches covered.">		if (activeAction instanceof Action &amp;&amp; activeAction.eContainmentFeature() != AppPackage.Literals.ACTION__SECTIONS) {</span>
<span class="fc" id="L306">			URI uri = uriResolver.apply(activeAction, baseURI);				</span>
<span class="pc bpc" id="L307" title="1 of 4 branches missed.">			if (uri != null &amp;&amp; uri.isRelative()) {</span>
<span class="fc" id="L308">				org.nasdanika.exec.resources.File file = container.getFile(uri.toString());</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">				if (file != null) {</span>
<span class="fc" id="L310">					org.nasdanika.html.model.bootstrap.Page bootstrapPage = EcoreUtil.copy(pageTemplate);</span>
<span class="fc" id="L311">					bootstrapPage.setName(activeAction.getText());</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">					if (bootstrapPage.getBody().isEmpty()) {</span>
<span class="nc" id="L313">						bootstrapPage.getBody().add(AppFactory.eINSTANCE.createPage());</span>
					}
<span class="fc bfc" id="L315" title="All 2 branches covered.">					for (EObject be: bootstrapPage.getBody()) {</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">						if (be instanceof org.nasdanika.html.model.app.Page) {</span>
<span class="fc" id="L317">							buildAppPage(root, principal, (Action) activeAction, actionPath, (org.nasdanika.html.model.app.Page) be, uriResolver, actionContentProvider, progressMonitor);						</span>
						}
<span class="fc" id="L319">					}</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">					if (pageContentProvider == null) {</span>
<span class="fc" id="L321">						file.getContents().add(bootstrapPage);</span>
					} else {
<span class="fc" id="L323">						file.getContents().addAll(pageContentProvider.getPageContent(bootstrapPage, baseURI, uriResolver, progressMonitor));						</span>
					}
					
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">					if (activeAction instanceof Action) {</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">						for (org.nasdanika.exec.resources.Resource res: ((Action) activeAction).getResources()) {</span>
<span class="nc" id="L328">							((Container) file.eContainer()).getContents().add(EcoreUtil.copy(res));					</span>
<span class="nc" id="L329">						}</span>
					}
				}
			}
		}
		
<span class="fc" id="L335">		List&lt;Label&gt; subActionPath = new ArrayList&lt;&gt;(actionPath);</span>
<span class="fc bfc" id="L336" title="All 4 branches covered.">		if (activeAction != root &amp;&amp; activeAction != principal) {</span>
<span class="fc" id="L337">			subActionPath.add(activeAction);</span>
		}
		
<span class="fc bfc" id="L340" title="All 2 branches covered.">		for (EObject child: org.nasdanika.html.model.app.util.Util.resolveActionReferences(activeAction.getChildren())) {</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">			if (child instanceof Label) {</span>
<span class="fc" id="L342">				generateSite(root, principal, (Label) child, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</span>
			}
<span class="fc" id="L344">		}</span>
				
<span class="fc bfc" id="L346" title="All 2 branches covered.">		if (activeAction instanceof Action) {</span>
<span class="fc" id="L347">			Action theActiveAction = (Action) activeAction;</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">			for (Action section: theActiveAction.getSections()) {</span>
<span class="fc" id="L349">				generateSite(root, principal, (Action) section, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</span>
<span class="fc" id="L350">			}</span>
			
<span class="fc bfc" id="L352" title="All 2 branches covered.">			for (EObject navigation: org.nasdanika.html.model.app.util.Util.resolveActionReferences(theActiveAction.getNavigation())) {</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">				if (navigation instanceof Label) {</span>
<span class="fc" id="L354">					generateSite(root, principal, (Label) navigation, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</span>
				}
<span class="fc" id="L356">			}</span>
			
<span class="fc bfc" id="L358" title="All 2 branches covered.">			for (Action anonymous: theActiveAction.getAnonymous()) {</span>
<span class="fc" id="L359">				generateSite(root, principal, anonymous, subActionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</span>
<span class="fc" id="L360">			}</span>
			
<span class="fc" id="L362">			generateNavigationPanel(root, principal, actionPath, theActiveAction.getFloatLeftNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</span>
<span class="fc" id="L363">			generateNavigationPanel(root, principal, actionPath, theActiveAction.getFloatRightNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</span>
<span class="fc" id="L364">			generateNavigationPanel(root, principal, actionPath, theActiveAction.getLeftNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</span>
<span class="fc" id="L365">			generateNavigationPanel(root, principal, actionPath, theActiveAction.getRightNavigation(), pageTemplate, uriResolver, baseURI, container, actionContentProvider,  pageContentProvider,progressMonitor);</span>
		}
<span class="fc" id="L367">	}</span>
	
	private static void buildAppPage(
			Label root, 
			Label principal, 
			Action activeAction, 
			List&lt;Label&gt; actionPath,
			org.nasdanika.html.model.app.Page appPage,
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			ActionContentProvider contentProvider,			
			ProgressMonitor progressMonitor) {
		
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">		if (root != null) {</span>
<span class="fc" id="L380">			Label title = createLabel(root, activeAction, uriResolver, null, &quot;header/title&quot;, false, false, false);</span>
<span class="fc" id="L381">			EList&lt;EObject&gt; rootChildren = root.getChildren();</span>
<span class="pc bpc" id="L382" title="3 of 4 branches missed.">			if (title != null || rootChildren.size() &gt; 1) {</span>
				// Header
<span class="fc" id="L384">				Header header = appPage.getHeader();</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">				if (header == null) {</span>
<span class="fc" id="L386">					header = AppFactory.eINSTANCE.createHeader();</span>
<span class="fc" id="L387">					appPage.setHeader(header);</span>
				}
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">				if (title != null) {</span>
<span class="fc" id="L390">					header.setTitle(title);</span>
				}
<span class="fc" id="L392">				List&lt;EObject&gt; headerItems = header.getItems();</span>
<span class="fc" id="L393">				rootChildren.listIterator(1).forEachRemaining(rac -&gt; {</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">					if (rac instanceof Label) {</span>
<span class="fc" id="L395">						headerItems.add(createLabel((Label) rac, activeAction, uriResolver, null, &quot;header/navigation&quot;, true, false, false));</span>
					} else {
<span class="nc" id="L397">						headerItems.add(EcoreUtil.copy(rac));</span>
					}
<span class="fc" id="L399">				});</span>
			}
			
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">			if (root instanceof Action) {</span>
<span class="fc" id="L403">				List&lt;EObject&gt; rootNavigation = org.nasdanika.html.model.app.util.Util.resolveActionReferences(((Action) root).getNavigation());</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">				if (!rootNavigation.isEmpty()) {</span>
<span class="fc" id="L405">					Footer footer = appPage.getFooter();</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">					if (footer == null) {</span>
<span class="fc" id="L407">						footer = AppFactory.eINSTANCE.createFooter();</span>
<span class="fc" id="L408">						appPage.setFooter(footer);</span>
					}
<span class="fc" id="L410">					EList&lt;EObject&gt; footerItems = footer.getItems();</span>
<span class="fc" id="L411">					rootNavigation.forEach(ran -&gt; {</span>
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">						if (ran instanceof Label) {</span>
<span class="fc" id="L413">							footerItems.add(createLabel((Label) ran, activeAction, uriResolver, null, &quot;footer/navigation&quot;, true, false, false));</span>
						} else {
<span class="nc" id="L415">							footerItems.add(EcoreUtil.copy(ran));</span>
						}
<span class="fc" id="L417">					});</span>
					
				}
			}
		}
		
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">		if (principal != null) {</span>
			// Navbar 
<span class="fc" id="L425">			Label brand = createLabel(principal, activeAction, uriResolver, null, &quot;navbar/brand&quot;, false, false, false);</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">			if (principal instanceof Action) {</span>
<span class="fc" id="L427">				List&lt;EObject&gt; principalNavigation = org.nasdanika.html.model.app.util.Util.resolveActionReferences(((Action) principal).getNavigation());</span>
<span class="pc bpc" id="L428" title="3 of 4 branches missed.">				if (brand != null || !principalNavigation.isEmpty()) {</span>
<span class="fc" id="L429">					NavigationBar navBar = appPage.getNavigationBar();</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">					if (navBar == null) {</span>
<span class="fc" id="L431">						navBar = AppFactory.eINSTANCE.createNavigationBar();</span>
<span class="fc" id="L432">						appPage.setNavigationBar(navBar);</span>
					}
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">					if (brand != null) {</span>
<span class="fc" id="L435">						navBar.setBrand(brand);</span>
					}
<span class="fc" id="L437">					EList&lt;EObject&gt; navBarItems = navBar.getItems();</span>
<span class="fc" id="L438">					principalNavigation.forEach(principalNavigationElement -&gt; {</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">						if (principalNavigationElement instanceof Label) {</span>
<span class="fc" id="L440">							navBarItems.add(createLabel((Label) principalNavigationElement, activeAction, uriResolver, null, &quot;navbar/item&quot;, true, false, false));</span>
						} else {
<span class="nc" id="L442">							navBarItems.add(EcoreUtil.copy(principalNavigationElement));</span>
						}
<span class="fc" id="L444">					});</span>
				}
			}
			
			// Navigation panel
<span class="fc" id="L449">			List&lt;EObject&gt; principalChildren = org.nasdanika.html.model.app.util.Util.resolveActionReferences(principal.getChildren());</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">			if (!principalChildren.isEmpty()) {</span>
<span class="fc" id="L451">				NavigationPanel navPanel = appPage.getNavigationPanel();</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">				if (navPanel == null) {</span>
<span class="nc" id="L453">					navPanel = AppFactory.eINSTANCE.createNavigationPanel();</span>
<span class="nc" id="L454">					appPage.setNavigationPanel(navPanel);</span>
				}
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">				if (isBlank(navPanel.getId())) {</span>
<span class="fc" id="L457">					navPanel.setId(principal.getId() + &quot;-navigation-panel&quot;);</span>
				}
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">				Function&lt;Label, String&gt; navItemIdProvider = na -&gt; isBlank(na.getId()) ? null : &quot;nsd-app-nav-item-&quot; + na.getId();</span>
<span class="fc" id="L460">				List&lt;EObject&gt; navPanelItems = navPanel.getItems();</span>
<span class="fc" id="L461">				principalChildren.forEach(principalChild -&gt; {</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">					if (principalChild instanceof Label) {</span>
<span class="fc" id="L463">						navPanelItems.add(createLabel((Label) principalChild, activeAction, uriResolver, navItemIdProvider, &quot;nav-panel&quot;, true, true, false));</span>
					} else {
<span class="nc" id="L465">						navPanelItems.add(EcoreUtil.copy(principalChild));</span>
					}
<span class="fc" id="L467">				});</span>
				
			}
		}
		
		// Content panel
<span class="fc" id="L473">		ContentPanel contentPanel = appPage.getContentPanel();</span>
<span class="pc bpc" id="L474" title="1 of 2 branches missed.">		if (contentPanel == null) {</span>
<span class="fc" id="L475">			contentPanel = AppFactory.eINSTANCE.createContentPanel();</span>
<span class="fc" id="L476">			appPage.setContentPanel(contentPanel);</span>
		}
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">		if  (activeAction != null) {</span>
<span class="fc" id="L479">			String activeActionUUID = activeAction.getUuid();</span>
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">			if (!org.nasdanika.common.Util.isBlank(activeActionUUID)) {</span>
<span class="fc" id="L481">				Text text = ContentFactory.eINSTANCE.createText();</span>
<span class="fc" id="L482">				text.setContent(activeActionUUID);</span>
<span class="fc" id="L483">				contentPanel.getAttributes().put(DATA_NSD_LABEL_UUID_ATTRIBUTE, text);</span>
			}
		}
		
<span class="pc bpc" id="L487" title="1 of 4 branches missed.">		buildContentPanel(activeAction, actionPath, activeAction == root || activeAction == principal, contentPanel, uriResolver, contentProvider, progressMonitor);	</span>
<span class="fc" id="L488">	}</span>
	
	private static void buildContentPanel(
			Action action, 
			List&lt;Label&gt; path,
			boolean rootOrPrincipal,
			ContentPanel contentPanel,
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			ActionContentProvider contentProvider,
			ProgressMonitor progressMonitor) {
		
<span class="fc bfc" id="L499" title="All 2 branches covered.">		if (!rootOrPrincipal) {</span>
<span class="fc bfc" id="L500" title="All 4 branches covered.">			if (path != null &amp;&amp; !path.isEmpty()) {</span>
<span class="fc" id="L501">				EList&lt;Label&gt; breadcrumb = contentPanel.getBreadcrumb();</span>
<span class="fc" id="L502">				path.forEach(pathElement -&gt; {</span>
<span class="fc" id="L503">					Label element = createLabel(pathElement, action, uriResolver, null, &quot;content-panel/breadcrumb&quot;, false, false, false);</span>
<span class="fc bfc" id="L504" title="All 2 branches covered.">					if (element != null) {</span>
<span class="fc" id="L505">						breadcrumb.add(element);</span>
					}
<span class="fc" id="L507">				});</span>
<span class="fc" id="L508">				Label tail = createLabel(action, action, uriResolver, null, &quot;content-panel/breadcrumb&quot;, false, false, false);		</span>
<span class="fc" id="L509">				tail.setActive(true);</span>
<span class="fc" id="L510">				breadcrumb.add(tail);</span>
			}
	
<span class="pc bpc" id="L513" title="3 of 4 branches missed.">			if (!isBlank(action.getText()) || !isBlank(action.getIcon())) {</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">				Label title = org.nasdanika.common.Util.isBlank(action.getName()) ? AppFactory.eINSTANCE.createLabel() : AppFactory.eINSTANCE.createLink(); </span>
<span class="fc" id="L515">				configureLabel(action, action, uriResolver, null, &quot;content-panel/title&quot;, title, false, false, true);</span>
<span class="fc" id="L516">				contentPanel.setTitle(title);</span>
			}
					
<span class="fc" id="L519">			List&lt;EObject&gt; navigation = org.nasdanika.html.model.app.util.Util.resolveActionReferences(action.getNavigation());</span>
<span class="fc" id="L520">			EList&lt;EObject&gt; navigationItems = contentPanel.getItems();</span>
<span class="fc" id="L521">			navigation.forEach(navigationElement -&gt; {</span>
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">				if (navigationElement instanceof Label) {</span>
<span class="fc" id="L523">					navigationItems.add(createLabel((Label) navigationElement, action, uriResolver, null, &quot;content-panel/navigation-item&quot;, true, false, false));</span>
				} else {
<span class="nc" id="L525">					navigationItems.add(EcoreUtil.copy(navigationElement));</span>
				}
<span class="fc" id="L527">			});</span>
		}
		
<span class="fc" id="L530">		int sectionColumns = action.getSectionColumns();</span>
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">		if (sectionColumns &gt; 0) {</span>
<span class="fc" id="L532">			contentPanel.setSectionColumns(sectionColumns);</span>
		}
<span class="fc" id="L534">		SectionStyle sectionStyle = action.getSectionStyle();</span>
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">		if (sectionStyle != null) {</span>
<span class="fc" id="L536">			contentPanel.setSectionStyle(sectionStyle);</span>
		}
		
<span class="fc" id="L539">		EList&lt;ContentPanel&gt; cpSections = contentPanel.getSections();</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">		for (Action section: action.getSections()) {</span>
<span class="fc" id="L541">			ContentPanel sectionPanel = AppFactory.eINSTANCE.createContentPanel();</span>
<span class="fc" id="L542">			cpSections.add(sectionPanel);</span>
<span class="fc" id="L543">			buildContentPanel(section, null, false, sectionPanel, uriResolver, contentProvider, progressMonitor);</span>
<span class="fc" id="L544">		}</span>

<span class="fc" id="L546">		contentPanel.setFloatLeftNavigation(createNavigationPanel(action.getFloatLeftNavigation()));</span>
<span class="fc" id="L547">		contentPanel.setFloatRightNavigation(createNavigationPanel(action.getFloatRightNavigation()));</span>
<span class="fc" id="L548">		contentPanel.setLeftNavigation(createNavigationPanel(action.getLeftNavigation()));		</span>
<span class="fc" id="L549">		contentPanel.setRightNavigation(createNavigationPanel(action.getRightNavigation()));</span>
		
<span class="fc bfc" id="L551" title="All 2 branches covered.">		contentPanel.getContent().addAll(contentProvider == null ? EcoreUtil.copyAll(action.getContent()) : contentProvider.getActionContent(action, uriResolver, progressMonitor));</span>
		
<span class="fc" id="L553">		List&lt;URI&gt; actionURIs = NcoreUtil.getIdentifiers(action);</span>
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">		if (!actionURIs.isEmpty()) {</span>
<span class="fc" id="L555">			String urisStr = String.join(&quot; &quot;, actionURIs.stream().map(Object::toString).collect(Collectors.toList()));</span>
<span class="fc" id="L556">			contentPanel.getAttributes().put(&quot;data-nsd-action-uris&quot;, NcoreUtil.wrapString(urisStr));</span>
		}
<span class="fc" id="L558">	}</span>
	
	/**
	 * Creates a copy of a panel if not null and replaces action references with links.
	 * @param panel
	 * @return
	 */
	private static NavigationPanel createNavigationPanel(NavigationPanel panel) {
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">		if (panel == null) {</span>
<span class="fc" id="L567">			return null;</span>
		}
<span class="nc" id="L569">		NavigationPanel ret = EcoreUtil.copy(panel);</span>
<span class="nc" id="L570">		ListIterator&lt;EObject&gt; iit = ret.getItems().listIterator();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">		while (iit.hasNext()) {</span>
<span class="nc" id="L572">			EObject next = iit.next();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">			if (next instanceof ActionReference) {</span>
<span class="nc" id="L574">				iit.set(EcoreUtil.copy(((ActionReference) next).getTarget()));</span>
			}
<span class="nc" id="L576">		}</span>
<span class="nc" id="L577">		return ret;</span>
	}

	private static boolean isLink(Label label, URI uri) {
<span class="fc bfc" id="L581" title="All 2 branches covered.">		if (uri != null) {</span>
<span class="fc" id="L582">			return true;</span>
		}
		
<span class="fc bfc" id="L585" title="All 2 branches covered.">		if (label instanceof Link) {</span>
<span class="fc" id="L586">			Link link = (Link) label;</span>
<span class="pc bpc" id="L587" title="4 of 8 branches missed.">			return !isBlank(link.getLocation()) || !isBlank(link.getScript()) || link.getModal() != null || !isBlank(link.getName());</span>
		}
		
<span class="fc" id="L590">		return false;</span>
	}
	
	/**
	 * @param action
	 * @param activeAction
	 * @return true if this action is active or one of its anonymous or navigation descendants is active.
	 */
	private static boolean isActiveAction(Action action, Label activeAction, boolean inspectChildren) {
<span class="fc bfc" id="L599" title="All 2 branches covered.">		if (action == activeAction) {</span>
<span class="fc" id="L600">			return true;</span>
		}
		
<span class="fc bfc" id="L603" title="All 2 branches covered.">		for (Action ac: action.getAnonymous()) {</span>
<span class="fc bfc" id="L604" title="All 2 branches covered.">			if (isActiveAction(ac, activeAction, inspectChildren)) {</span>
<span class="fc" id="L605">				return true;</span>
			}
<span class="fc" id="L607">		}</span>
		
<span class="fc bfc" id="L609" title="All 2 branches covered.">		for (Action ac: action.getSections()) {</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">			if (isActiveAction(ac, activeAction, inspectChildren)) {</span>
<span class="nc" id="L611">				return true;</span>
			}
<span class="fc" id="L613">		}		</span>
		
<span class="fc bfc" id="L615" title="All 2 branches covered.">		for (EObject nc: action.getNavigation()) {</span>
<span class="pc bpc" id="L616" title="1 of 4 branches missed.">			if (nc instanceof Action &amp;&amp; isActiveAction((Action) nc, activeAction, inspectChildren)) {</span>
<span class="fc" id="L617">				return true;</span>
			}
<span class="fc" id="L619">		}</span>
		
<span class="fc bfc" id="L621" title="All 2 branches covered.">		if (inspectChildren) {</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">			for (EObject child: action.getChildren()) {</span>
<span class="pc bpc" id="L623" title="2 of 4 branches missed.">				if (child instanceof Action &amp;&amp; isActiveAction((Action) child, activeAction, inspectChildren)) {</span>
<span class="nc" id="L624">					return true;</span>
				}
<span class="fc" id="L626">			}</span>
		}
		
<span class="fc" id="L629">		return false;</span>
	}
	
	private static void configureLabel(
			Label source, 
			Label activeAction, 
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			Function&lt;Label, String&gt; idProvider, 
			String appearancePath, 
			Label label, 
			boolean recursive,
			boolean inNavPanel,
			boolean decorate) {
<span class="fc" id="L642">		Appearance aa = source.getAppearance();</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">		if (aa != null) {</span>
<span class="nc" id="L644">			label.setAppearance(aa.effectiveAppearance(appearancePath));</span>
		}

<span class="fc" id="L647">		label.setColor(source.getColor());</span>
<span class="fc" id="L648">		label.setDescription(source.getDescription());</span>
<span class="fc" id="L649">		label.setDisabled(source.isDisabled());</span>
<span class="fc" id="L650">		Label decorator = source.getDecorator();</span>
<span class="fc bfc" id="L651" title="All 4 branches covered.">		if (decorator != null &amp;&amp; decorate) {</span>
<span class="fc" id="L652">			label.setDecorator(EcoreUtil.copy(decorator));</span>
		}
<span class="fc" id="L654">		label.setIcon(source.getIcon());</span>
<span class="fc bfc" id="L655" title="All 2 branches covered.">		if (idProvider != null) {</span>
<span class="fc" id="L656">			label.setId(idProvider.apply(source));</span>
		}
//		label.setId(action.getId());		
<span class="fc" id="L659">		label.setNotification(source.getNotification());</span>
<span class="fc" id="L660">		label.setOutline(source.isOutline());</span>
<span class="fc" id="L661">		label.setText(source.getText());</span>
<span class="fc" id="L662">		label.setTooltip(source.getTooltip());</span>

<span class="fc" id="L664">		Action effectiveSourceAction = null;</span>
<span class="fc bfc" id="L665" title="All 2 branches covered.">		if (source instanceof Action) {</span>
<span class="fc" id="L666">			effectiveSourceAction = (Action) source;</span>
<span class="fc bfc" id="L667" title="All 2 branches covered.">		} else if (source instanceof Link) {</span>
<span class="fc" id="L668">			effectiveSourceAction = ((Link) source).getAction();</span>
		}				
				
<span class="fc bfc" id="L671" title="All 2 branches covered.">		if (effectiveSourceAction != null) {</span>
<span class="fc" id="L672">			String sourceUUID = effectiveSourceAction.getUuid();</span>
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">			if (!org.nasdanika.common.Util.isBlank(sourceUUID)) {</span>
<span class="fc" id="L674">				Text text = ContentFactory.eINSTANCE.createText();</span>
<span class="fc" id="L675">				text.setContent(sourceUUID);			</span>
<span class="fc" id="L676">				label.getAttributes().put(DATA_NSD_LABEL_UUID_ATTRIBUTE, text);</span>
			}
		}
		
<span class="fc bfc" id="L680" title="All 2 branches covered.">		for (Entry&lt;String, EObject&gt; ae: source.getAttributes().entrySet()) {		</span>
<span class="fc" id="L681">			label.getAttributes().put(ae.getKey(), EcoreUtil.copy(ae.getValue()));</span>
<span class="fc" id="L682">		}</span>
		
<span class="fc bfc" id="L684" title="All 2 branches covered.">		if (label instanceof Link) {</span>
<span class="fc" id="L685">			configureLink(source, activeAction, uriResolver, (Link) label);</span>
		}
		
<span class="fc bfc" id="L688" title="All 2 branches covered.">		if (recursive) {</span>
<span class="fc" id="L689">			EList&lt;EObject&gt; labelChildren = label.getChildren();</span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">			for (EObject sourceChild: source.getChildren()) {</span>
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">				if (sourceChild instanceof ActionReference) {</span>
<span class="nc" id="L692">					sourceChild = ((ActionReference) sourceChild).getTarget();</span>
				}
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">				if (sourceChild instanceof Label) {</span>
<span class="fc" id="L695">					Label childLabel = (Label) sourceChild;</span>
<span class="fc" id="L696">					labelChildren.add(createLabel(childLabel, activeAction, uriResolver, idProvider, &quot;header/navigation&quot;, recursive, inNavPanel, false));</span>
					
					// Second level - headers, separators.
<span class="fc" id="L699">				} else {</span>
<span class="nc" id="L700">					labelChildren.add(EcoreUtil.copy(sourceChild));</span>
				}							
<span class="fc" id="L702">			}			</span>
		}
		
<span class="pc bpc" id="L705" title="1 of 10 branches missed.">		label.setActive(effectiveSourceAction != null &amp;&amp; inNavPanel ? isActiveAction(effectiveSourceAction, activeAction, !hasActiveChildren(label)) &amp;&amp; !hasActiveChildren(source, activeAction) : source.isActive());		</span>
<span class="fc" id="L706">	}</span>
	
	private static boolean hasActiveChildren(Label label, Label activeAction) {
<span class="fc bfc" id="L709" title="All 2 branches covered.">		for (EObject child: label.getChildren()) { </span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">			if (child instanceof Label) { </span>
<span class="fc" id="L711">				Label cl = (Label) child; </span>
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">				if (cl instanceof Link) {</span>
<span class="fc" id="L713">					Action linkAction = ((Link) cl).getAction();</span>
<span class="pc bpc" id="L714" title="3 of 4 branches missed.">					if (linkAction != null &amp;&amp; isActiveAction(linkAction, activeAction, true)) {</span>
<span class="nc" id="L715">						return true;</span>
					}
<span class="pc bpc" id="L717" title="1 of 2 branches missed.">					if (hasActiveChildren(cl, activeAction)) {</span>
<span class="nc" id="L718">						return true;</span>
					}
				}
			}
<span class="fc" id="L722">		}</span>
<span class="fc" id="L723">		return false;</span>
	}	
	
	private static boolean hasActiveChildren(Label label) {
<span class="fc bfc" id="L727" title="All 2 branches covered.">		for (EObject child: label.getChildren()) {</span>
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">			if (child instanceof Label) {</span>
<span class="fc" id="L729">				Label cl = (Label) child;</span>
<span class="fc bfc" id="L730" title="All 4 branches covered.">				if (cl.isActive() || hasActiveChildren(cl)) {</span>
<span class="fc" id="L731">					return true;</span>
				}
			}
<span class="fc" id="L734">		}</span>
<span class="fc" id="L735">		return false;</span>
	}
	
	private static void configureLink(
			Label source, 
			Label activeAction, 
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			Link target) {
		
<span class="fc" id="L744">		URI activeActionURI = uriResolver.apply(activeAction, null);</span>
<span class="fc" id="L745">		Label uriSource = source;</span>
<span class="pc bpc" id="L746" title="1 of 2 branches missed.">		if (uriSource instanceof Link) {</span>
<span class="fc" id="L747">			Action linkAction = ((Link) uriSource).getAction();</span>
<span class="pc bpc" id="L748" title="1 of 2 branches missed.">			if (linkAction != null) {</span>
<span class="nc" id="L749">				uriSource = linkAction;</span>
			}
		}
<span class="fc" id="L752">		URI uri = uriResolver.apply(uriSource, activeActionURI);		</span>
		
<span class="fc bfc" id="L754" title="All 2 branches covered.">		if (uri != null) {</span>
<span class="fc" id="L755">			target.setLocation(uri.toString());</span>
		}
<span class="pc bpc" id="L757" title="1 of 2 branches missed.">		if (source instanceof Link) {</span>
<span class="fc" id="L758">			Link sourceLink = (Link) source;</span>
<span class="fc" id="L759">			target.setConfirmation(sourceLink.getConfirmation());</span>
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">			if (sourceLink.getModal() != null) {</span>
	//		link.setModal(value); TODO - contextualization of links - relativization of URI's. Token expansion with a property computer? something like ${relative-uri/&lt;uri here&gt;}? 
	//		Support of sub-tokens e.g. ${{relative-uri/${token}}} recognizes ${token} as a sub-token to be expanded to result in ${relative-uri/&lt;token value&gt;}.
<span class="nc" id="L763">				throw new UnsupportedOperationException(&quot;Modals are not supported yet&quot;);</span>
			}
<span class="fc" id="L765">			target.setName(sourceLink.getName());</span>
<span class="fc" id="L766">			target.setScript(sourceLink.getScript());</span>
<span class="fc" id="L767">			target.setTarget(sourceLink.getTarget());	</span>
<span class="fc bfc" id="L768" title="All 2 branches covered.">			if (org.nasdanika.common.Util.isBlank(target.getLocation())) {</span>
<span class="fc" id="L769">				target.setLocation(sourceLink.getLocation());</span>
			}
		}
<span class="fc bfc" id="L772" title="All 2 branches covered.">		if (source instanceof Action) {</span>
<span class="fc" id="L773">			Action action = (Action) source;</span>
<span class="pc bpc" id="L774" title="1 of 2 branches missed.">			if (action.isModalActivator()) {</span>
<span class="nc" id="L775">				throw new UnsupportedOperationException(&quot;Modals are not supported yet&quot;);</span>
			}
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">			if (action.isInline()) {</span>
<span class="nc" id="L778">				throw new UnsupportedOperationException(&quot;Inline actions are not supported yet&quot;);			</span>
			}
		}
<span class="fc" id="L781">	}</span>
	
	/**
	 * Creates a {@link Link} from {@link Action} with a relative location for locations.
	 * @param source
	 * @param uri
	 * @param active 
	 * @param appearancePath 
	 * @return
	 */
	public static Label createLabel(
			Label source, 
			Label activeAction, 
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			Function&lt;Label, String&gt; idProvider, 
			String appearancePath,
			boolean recursive,
			boolean inNavPanel,
			boolean decorate) {
		
<span class="fc" id="L801">		URI activeActionURI = uriResolver.apply(activeAction, null);</span>
		
<span class="fc" id="L803">		Label uriSource = source;</span>
<span class="fc bfc" id="L804" title="All 2 branches covered.">		if (uriSource instanceof Link) {</span>
<span class="fc" id="L805">			Action linkAction = ((Link) uriSource).getAction();</span>
<span class="pc bpc" id="L806" title="1 of 2 branches missed.">			if (linkAction != null) {</span>
<span class="nc" id="L807">				uriSource = linkAction;</span>
			}
		}
<span class="fc" id="L810">		URI uri = uriResolver.apply(uriSource, activeActionURI);		</span>
		
<span class="pc bpc" id="L812" title="1 of 6 branches missed.">		if (isBlank(source.getText()) &amp;&amp; isBlank(source.getIcon()) &amp;&amp; !recursive) {</span>
<span class="fc" id="L813">			return null;</span>
		}
<span class="fc bfc" id="L815" title="All 4 branches covered.">		Label label = source != activeAction &amp;&amp; isLink(source, uri) ? AppFactory.eINSTANCE.createLink() : AppFactory.eINSTANCE.createLabel();</span>
<span class="fc" id="L816">		configureLabel(source, activeAction, uriResolver, idProvider, appearancePath, label, recursive, inNavPanel, decorate);</span>
				
<span class="fc" id="L818">		return label;</span>
	}
	
	private static void generateNavigationPanel(
			Label root, 
			Label principal, 
			List&lt;Label&gt; actionPath,
			NavigationPanel navigationPanel,
			org.nasdanika.html.model.bootstrap.Page pageTemplate,
			BiFunction&lt;Label, URI, URI&gt; uriResolver, 
			URI baseURI, 
			Container container,
			ActionContentProvider actionContentProvider,
			PageContentProvider pageContentProvider,
			ProgressMonitor progressMonitor) {
		
<span class="pc bpc" id="L834" title="1 of 2 branches missed.">		if (navigationPanel != null) {</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">			for (EObject item: org.nasdanika.html.model.app.util.Util.resolveActionReferences(navigationPanel.getItems())) {</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">				if (item instanceof Label) {</span>
<span class="nc" id="L837">					generateSite(root, principal, (Label) item, actionPath, pageTemplate, uriResolver, baseURI, container, actionContentProvider, pageContentProvider, progressMonitor);</span>
				}
<span class="nc" id="L839">			}			</span>
		}
<span class="fc" id="L841">	}</span>
	
	public static JSONObject createSearchDocument(String path, File file, Consumer&lt;Exception&gt; errorConsumer) throws IOException {
<span class="nc" id="L844">		return createSearchDocument(path, file, null, null, errorConsumer);</span>
	}
	
	/**
	 * For Nasdanika App pages extracts page title, breadcrumbs and content text into a JSONObject to add to a collector and then
	 * to use for constructing search indices. 
	 * @param path
	 * @param file
	 * @param contentConsumer Consumer of content elements which can be used to analyze page contents, e.g. find dead links. Can be null.  
	 * @param processor If not null the document is passed to the processor. If the processor returns true that means that the document was manipulated by the processor and shall be saved to the source file.
	 * @return Search document object for non-empty Nasdanika App pages, null otherwise.
	 * @throws IOException
	 */
	public static JSONObject createSearchDocument(
			String path, 
			File file, 
			Consumer&lt;? super Element&gt; contentConsumer, 
			BiFunction&lt;String, Document, Boolean&gt; processor,
			Consumer&lt;Exception&gt; errorConsumer) throws IOException {
		
<span class="fc" id="L864">		Document document = Jsoup.parse(file, &quot;UTF-8&quot;);</span>
<span class="pc bpc" id="L865" title="1 of 4 branches missed.">		if (processor != null &amp;&amp; processor.apply(path, document)) {</span>
<span class="fc" id="L866">			Document.OutputSettings outputSettings = new Document.OutputSettings();</span>
<span class="fc" id="L867">			outputSettings.prettyPrint(false);</span>
<span class="fc" id="L868">			document.outputSettings(outputSettings);</span>
<span class="fc" id="L869">			try (Writer writer = new OutputStreamWriter(new FileOutputStream(file), &quot;UTF-8&quot;)) {</span>
<span class="fc" id="L870">				writer.write(document.html());</span>
			}
		}
<span class="fc" id="L873">		Elements contentPanelQuery = document.select(&quot;body &gt; div &gt; div.row.nsd-app-content-row &gt; div.col.nsd-app-content-panel&quot;);							                                              </span>
<span class="pc bpc" id="L874" title="1 of 2 branches missed.">		if (contentPanelQuery.isEmpty()) {</span>
<span class="nc" id="L875">			return null;</span>
		}
<span class="fc" id="L877">		Elements contentQuery = contentPanelQuery.select(&quot;div &gt; div.row.nsd-app-content-panel-content-row&quot;);</span>
<span class="pc bpc" id="L878" title="1 of 2 branches missed.">		if (contentQuery.isEmpty()) {</span>
<span class="nc" id="L879">			return null;</span>
		}
<span class="pc bpc" id="L881" title="1 of 2 branches missed.">		if (contentConsumer != null) {</span>
<span class="fc" id="L882">			contentQuery.forEach(contentConsumer);</span>
		}
		
<span class="fc" id="L885">		StringBuilder contentText = new StringBuilder(contentQuery.text());</span>
		
		// Drawio diagrams labels
<span class="fc bfc" id="L888" title="All 2 branches covered.">		for (Element diagramDiv: contentQuery.select(&quot;div.mxgraph&quot;)) {</span>
			try {
<span class="fc" id="L890">				traverseDrawio(diagramDiv, element -&gt; {</span>
<span class="fc bfc" id="L891" title="All 2 branches covered.">					if (element instanceof ModelElement) {</span>
<span class="fc" id="L892">						ModelElement me = (ModelElement) element;</span>
<span class="fc" id="L893">						String meLabel = me.getLabel();</span>
<span class="fc bfc" id="L894" title="All 2 branches covered.">						if (!org.nasdanika.common.Util.isBlank(meLabel)) {</span>
<span class="fc" id="L895">							String labelText = Jsoup.parse(meLabel).text();</span>
<span class="fc" id="L896">							contentText.append(&quot; &quot;).append(labelText);											</span>
						}
<span class="fc" id="L898">						String meTooltip = me.getTooltip();</span>
<span class="fc bfc" id="L899" title="All 2 branches covered.">						if (!org.nasdanika.common.Util.isBlank(meTooltip)) {</span>
<span class="fc" id="L900">							String tooltipText = Jsoup.parse(meTooltip).text();</span>
<span class="fc" id="L901">							contentText.append(&quot; &quot;).append(tooltipText);											</span>
						}
					}
<span class="fc" id="L904">				}, null);</span>
<span class="nc" id="L905">			} catch (Exception e) {</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">				if (errorConsumer == null) {</span>
<span class="nc" id="L907">					e.printStackTrace();</span>
				} else {
<span class="nc" id="L909">					errorConsumer.accept(e);</span>
				}
<span class="fc" id="L911">			}</span>
<span class="fc" id="L912">		}</span>
		
<span class="fc bfc" id="L914" title="All 2 branches covered.">		if (org.nasdanika.common.Util.isBlank(contentText.toString())) {</span>
<span class="fc" id="L915">			return null;</span>
		}
		
<span class="fc" id="L918">		JSONObject searchDocument = new JSONObject();</span>
<span class="fc" id="L919">		searchDocument.put(&quot;content&quot;, StringEscapeUtils.escapeHtml4(contentText.toString()));</span>
<span class="fc" id="L920">		Elements titleQuery = contentPanelQuery.select(&quot;div &gt; div.row.nsd-app-content-panel-title-and-items-row &gt; div.col-auto &gt; h1&quot;);</span>
<span class="fc bfc" id="L921" title="All 2 branches covered.">		if (titleQuery.size() == 1) {</span>
<span class="fc" id="L922">			searchDocument.put(&quot;title&quot;, StringEscapeUtils.escapeHtml4(titleQuery.get(0).text()));</span>
		} else {
<span class="fc" id="L924">			searchDocument.put(&quot;title&quot;, document.title());</span>
		}
<span class="fc" id="L926">		Elements breadcrumbQuery = contentPanelQuery.select(&quot;div &gt; div.row.nsd-app-content-panel-breadcrumb-row &gt; div &gt; nav &gt; ol &gt; li&quot;);</span>
<span class="fc bfc" id="L927" title="All 2 branches covered.">		if (breadcrumbQuery.size() &gt; 0) {</span>
<span class="fc" id="L928">			searchDocument.put(&quot;path&quot;, String.join(&quot;/&quot;, breadcrumbQuery.stream().map(e -&gt; StringEscapeUtils.escapeHtml4(e.text())).collect(Collectors.toList())));</span>
		}
<span class="pc bpc" id="L930" title="1 of 2 branches missed.">		for (Element element: contentPanelQuery) {</span>
<span class="fc" id="L931">			String actionUUID = element.attr(DATA_NSD_LABEL_UUID_ATTRIBUTE);</span>
<span class="pc bpc" id="L932" title="1 of 2 branches missed.">			if (!org.nasdanika.common.Util.isBlank(actionUUID)) {</span>
<span class="fc" id="L933">				searchDocument.put(NcoreActionBuilder.ACTION_UUID_KEY, actionUUID);</span>
<span class="fc" id="L934">				break;</span>
			}
<span class="nc" id="L936">		}</span>
		
<span class="fc" id="L938">		return searchDocument;</span>
	}
	
	/**
	 * Loads {@link mxGraphModel} from mxgraph div.
	 * @param mxGraphDiv
	 * @return
	 * @throws IOException 
	 * @throws SAXException 
	 * @throws ParserConfigurationException 
	 */
	public static org.nasdanika.drawio.Document loadDrawioDocument(Element mxGraphDiv) throws ParserConfigurationException, SAXException, IOException {
<span class="fc" id="L950">		String data = mxGraphDiv.attr(&quot;data-mxgraph&quot;);</span>
<span class="pc bpc" id="L951" title="1 of 2 branches missed.">		if (data != null) {</span>
<span class="fc" id="L952">			JSONObject jsonData = new JSONObject(data);</span>
<span class="fc" id="L953">			Object xml = jsonData.get(&quot;xml&quot;);</span>
<span class="pc bpc" id="L954" title="1 of 2 branches missed.">			if (xml instanceof String) {</span>
<span class="fc" id="L955">				return org.nasdanika.drawio.Document.load((String) xml, null);</span>
			}
		}
<span class="nc" id="L958">		return null;</span>
	}

	public static void traverseDrawio(Element mxGraphDiv, Consumer&lt;org.nasdanika.drawio.Element&gt; visitor, ConnectionBase connectionBase) throws ParserConfigurationException, SAXException, IOException {
<span class="fc" id="L962">		org.nasdanika.drawio.Document document = loadDrawioDocument(mxGraphDiv);</span>
<span class="pc bpc" id="L963" title="1 of 2 branches missed.">		if (document != null) {</span>
<span class="fc" id="L964">			document.accept(visitor, connectionBase);</span>
		}		
<span class="fc" id="L966">	}</span>
		
	/**
	 * Loads document, traverses all elements and then saves and returns the document.
	 * @param spec
	 * @param visitor
	 * @param connectionBase
	 * @param compress
	 * @return
	 * @throws IOException 
	 * @throws SAXException 
	 * @throws ParserConfigurationException 
	 * @throws TransformerException 
	 */
	public static String filterDrawio(
			String spec, 
			Consumer&lt;org.nasdanika.drawio.Element&gt; visitor, 
			ConnectionBase connectionBase, 
			Boolean compress) throws ParserConfigurationException, SAXException, IOException, TransformerException {
		
<span class="nc" id="L986">		org.nasdanika.drawio.Document document = org.nasdanika.drawio.Document.load(spec, null);</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">		if (document != null) {</span>
<span class="nc" id="L988">			document.accept(visitor, connectionBase);</span>
		}	
<span class="nc" id="L990">		return document.save(compress);</span>
	}
	
	/**
	 * Creates an inspector consumer which finds and reports broken links, missing images and elements with nsd-error class.
	 * @param file
	 * @param path
	 * @param siteDir
	 * @param errorConsumer
	 * @return
	 */
	public static Consumer&lt;? super Element&gt; createInspector(Predicate&lt;String&gt; linkPredicate, Consumer&lt;String&gt; errorConsumer) {		
<span class="fc" id="L1002">		return element -&gt; {</span>
<span class="fc" id="L1003">			Elements anchors = element.getElementsByTag(&quot;a&quot;);</span>
<span class="fc bfc" id="L1004" title="All 2 branches covered.">			for (Element anchor: anchors) {</span>
<span class="fc" id="L1005">				String target = anchor.attr(&quot;href&quot;);</span>
<span class="pc bpc" id="L1006" title="1 of 2 branches missed.">				if (target != null) {</span>
<span class="fc" id="L1007">					String id = anchor.attr(&quot;id&quot;);</span>
<span class="pc bpc" id="L1008" title="1 of 4 branches missed.">					boolean selfReferencing = id != null &amp;&amp; target.equals(&quot;#&quot; + id); // Ignoring header tags generated by markdown.</span>
<span class="pc bpc" id="L1009" title="1 of 4 branches missed.">					if (!selfReferencing &amp;&amp; !linkPredicate.test(target)) {</span>
<span class="nc" id="L1010">						errorConsumer.accept(&quot;Broken link: &quot; + anchor);</span>
					}
				}
<span class="fc" id="L1013">			}</span>
			
			// Images
<span class="fc" id="L1016">			Elements images = element.getElementsByTag(&quot;img&quot;);</span>
<span class="pc bpc" id="L1017" title="1 of 2 branches missed.">			for (Element img: images) {</span>
<span class="nc" id="L1018">				String src = img.attr(&quot;src&quot;);</span>
<span class="nc bnc" id="L1019" title="All 4 branches missed.">				if (src != null &amp;&amp; !linkPredicate.test(src)) {</span>
<span class="nc" id="L1020">					errorConsumer.accept(&quot;Missing image: &quot; + img);</span>
				}
<span class="nc" id="L1022">			}</span>
			
			// NSD errors
<span class="fc" id="L1025">			Elements errors = element.select(&quot;div.nsd-error&quot;);</span>
<span class="pc bpc" id="L1026" title="1 of 2 branches missed.">			for (Element error: errors) {</span>
<span class="nc" id="L1027">				errorConsumer.accept(&quot;Error: &quot; + error.text());</span>
<span class="nc" id="L1028">			}</span>
			
			// Image maps
<span class="pc bpc" id="L1031" title="1 of 2 branches missed.">			for (Element area: element.select(&quot;area&quot;)) {</span>
<span class="nc" id="L1032">				String target = area.attr(&quot;href&quot;);</span>
<span class="nc bnc" id="L1033" title="All 4 branches missed.">				if (target != null &amp;&amp; !linkPredicate.test(target)) {</span>
<span class="nc" id="L1034">					errorConsumer.accept(&quot;Broken link: &quot; + area);					</span>
				}
<span class="nc" id="L1036">			}</span>
			
			// Drawio diagrams
<span class="fc bfc" id="L1039" title="All 2 branches covered.">			for (Element diagramDiv: element.select(&quot;div.mxgraph&quot;)) {</span>
				try {
<span class="fc" id="L1041">					traverseDrawio(diagramDiv, docElement -&gt; {</span>
<span class="fc bfc" id="L1042" title="All 2 branches covered.">						if (docElement instanceof org.nasdanika.drawio.ModelElement) {</span>
<span class="fc" id="L1043">							org.nasdanika.drawio.ModelElement modelElement = (org.nasdanika.drawio.ModelElement) docElement;</span>
<span class="fc" id="L1044">							String link = modelElement.getLink();</span>
<span class="fc bfc" id="L1045" title="All 4 branches covered.">							if (!org.nasdanika.common.Util.isBlank(link) &amp;&amp; !linkPredicate.test(link)) {</span>
<span class="fc" id="L1046">								String label = modelElement.getLabel();</span>
<span class="fc bfc" id="L1047" title="All 2 branches covered.">								if (org.nasdanika.common.Util.isBlank(label)) {</span>
<span class="fc" id="L1048">									errorConsumer.accept(&quot;Broken diagram link: &quot; + link);</span>
								} else {
<span class="fc" id="L1050">									errorConsumer.accept(&quot;Broken diagram link on &quot; + label + &quot;: &quot; + link);											</span>
								}
							}
						}
<span class="fc" id="L1054">					}, null);</span>
<span class="nc" id="L1055">				} catch (Exception e) {</span>
<span class="nc" id="L1056">					errorConsumer.accept(&quot;Error traversing drawio &quot; + diagramDiv + &quot;: &quot; + e);</span>
<span class="fc" id="L1057">				}</span>
<span class="fc" id="L1058">			}			</span>
<span class="fc" id="L1059">		};</span>
	}

	/**
	 * Creates a predicate checking for links relative to the argument file in the argument directory. 
	 * @param file Base file
	 * @param dir Directory within which check for relative links
	 * @return
	 */
	public static Predicate&lt;String&gt; createRelativeLinkPredicate(File file, File dir) {
<span class="fc" id="L1069">		return target -&gt; {</span>
			File targetFile;
			String fragment;
<span class="pc bpc" id="L1072" title="1 of 2 branches missed.">			if (target.startsWith(&quot;#&quot;)) {</span>
<span class="nc" id="L1073">				targetFile = file;</span>
<span class="nc" id="L1074">				fragment = target;</span>
			} else {
<span class="fc" id="L1076">				int hashIdx = target.indexOf(&quot;#&quot;);</span>
<span class="fc bfc" id="L1077" title="All 2 branches covered.">				if (hashIdx == -1) {</span>
<span class="fc" id="L1078">					fragment = null;</span>
				} else {
<span class="fc" id="L1080">					fragment = target.substring(hashIdx);</span>
<span class="fc" id="L1081">					target = target.substring(0, hashIdx);</span>
				}
<span class="pc bpc" id="L1083" title="1 of 4 branches missed.">				if (target.contains(&quot;:&quot;) || target.contains(&quot;?&quot;)) { // Absolute or with a query string, not checking</span>
<span class="fc" id="L1084">					return true;</span>
				}
<span class="fc" id="L1086">				targetFile = new File(file.getParentFile(), target);</span>
<span class="fc bfc" id="L1087" title="All 2 branches covered.">				for (File parent = targetFile.getParentFile(); parent != null; parent = parent.getParentFile()) {</span>
<span class="fc bfc" id="L1088" title="All 2 branches covered.">					if (parent.equals(dir)) {</span>
<span class="fc bfc" id="L1089" title="All 2 branches covered.">						if (!targetFile.exists()) {</span>
<span class="fc" id="L1090">							return false;</span>
						}
					}
				}
			}
<span class="pc bpc" id="L1095" title="1 of 4 branches missed.">			if (fragment == null || fragment.trim().length() == 0) {</span>
<span class="fc" id="L1096">				return true;</span>
			}
			
			try {
<span class="fc" id="L1100">				Document document = Jsoup.parse(targetFile, StandardCharsets.UTF_8.name());</span>
<span class="fc" id="L1101">				Elements namedAnchors = document.select(&quot;[name='&quot; + fragment.substring(1) + &quot;']&quot;);</span>
<span class="fc" id="L1102">				Elements idAnchors = document.select(&quot;[id='&quot; + fragment.substring(1) + &quot;']&quot;);</span>
<span class="pc bpc" id="L1103" title="1 of 2 branches missed.">				return namedAnchors.size() + idAnchors.size() &gt; 0; // Ignoring duplicate fragment anchors</span>
<span class="nc" id="L1104">			} catch (IOException e) {</span>
<span class="nc" id="L1105">				throw new NasdanikaException(&quot;Error parsing &quot; + targetFile.getAbsolutePath(), e);</span>
			}
			
		};
		
	}

	/**
	 * Inserts search json and search script tags into the document.
	 * @param path
	 * @param doc
	 * @return
	 */
	public static boolean configureSearch(
			String path, 
			Document doc,
			String searchDocumentsPath,
			Supplier&lt;InputStream&gt; searchScriptSupplier) {
<span class="fc" id="L1123">		Element head = doc.head();</span>
<span class="fc" id="L1124">		URI base = URI.createURI(&quot;temp://&quot; + UUID.randomUUID() + &quot;/&quot;);</span>
<span class="fc" id="L1125">		URI searchScriptURI = URI.createURI(searchDocumentsPath).resolve(base);</span>
<span class="fc" id="L1126">		URI thisURI = URI.createURI(path).resolve(base);</span>
<span class="fc" id="L1127">		URI relativeSearchScriptURI = searchScriptURI.deresolve(thisURI, true, true, true);</span>
<span class="fc" id="L1128">		head.append(System.lineSeparator() + &quot;&lt;script src=\&quot;&quot; + relativeSearchScriptURI + &quot;\&quot;&gt;&lt;/script&gt;&quot; + System.lineSeparator());</span>
<span class="fc" id="L1129">		head.append(System.lineSeparator() + &quot;&lt;script src=\&quot;https://unpkg.com/lunr/lunr.js\&quot;&gt;&lt;/script&gt;&quot; + System.lineSeparator());</span>
				
<span class="fc" id="L1131">		try (InputStream in = searchScriptSupplier.get()) {</span>
<span class="fc" id="L1132">			head.append(System.lineSeparator() + &quot;&lt;script&gt;&quot; + System.lineSeparator() + DefaultConverter.INSTANCE.toString(in) + System.lineSeparator() + &quot;&lt;/script&gt;&quot; + System.lineSeparator());</span>
<span class="nc" id="L1133">		} catch (Exception e) {</span>
<span class="nc" id="L1134">			e.printStackTrace();</span>
<span class="fc" id="L1135">		}</span>
		
<span class="fc" id="L1137">		return true;</span>
	}
	
	/**
	 * Inserts search json and search script tags into the document. Uses search.js resource for the search script.
	 * @param path
	 * @param doc
	 * @return
	 */
	public static boolean configureSearch(
			String path, 
			Document doc,
			String searchDocumentsPath) {
<span class="fc" id="L1150">		return configureSearch(</span>
				path, 
				doc, 
				searchDocumentsPath, 
<span class="fc" id="L1154">				() -&gt; Util.class.getResourceAsStream(&quot;search.js&quot;));</span>
	}
	
	/**
	 * Generates sitemap and search index for lunrjs by scanning files in a directory.
	 * @param dir Directory to scan
	 * @param base URI prefix for file paths with or without dangling /  
	 * @throws IOException
	 */
	public static JSONObject generateSitemapAndSearch(
			File dir,
			String domain,
			BiPredicate&lt;File, String&gt; siteMapPredicate,
			ChangeFreq changeFrequency,
			BiPredicate&lt;File, String&gt; searchPredicate,
			BiConsumer&lt;String,String&gt; errorConsumer,
			BiFunction&lt;String, Document, Boolean&gt; searchConfigurator) throws IOException {
		
		// Site map and search index
<span class="fc" id="L1173">		JSONObject searchDocuments = new JSONObject();</span>
		
<span class="pc bpc" id="L1175" title="1 of 2 branches missed.">		WebSitemapGenerator wsg = org.nasdanika.common.Util.isBlank(domain) ? null : new WebSitemapGenerator(domain, dir);</span>
<span class="fc" id="L1176">		boolean[] isSiteMapEmpty = { true };</span>
<span class="fc" id="L1177">		BiConsumer&lt;File, String&gt; listener = new BiConsumer&lt;File, String&gt;() {</span>
			
			@Override
			public void accept(File file, String path) {
<span class="pc bpc" id="L1181" title="2 of 6 branches missed.">				if (wsg != null &amp;&amp; (siteMapPredicate == null || siteMapPredicate.test(file, path))) {</span>
					try {
<span class="fc" id="L1183">						WebSitemapUrl url = new WebSitemapUrl.Options(domain + &quot;/&quot; + path).lastMod(new Date(file.lastModified())).changeFreq(changeFrequency).build();</span>
<span class="fc" id="L1184">						wsg.addUrl(url); </span>
<span class="fc" id="L1185">						isSiteMapEmpty[0] = false;</span>
<span class="nc" id="L1186">					} catch (MalformedURLException e) {</span>
<span class="nc" id="L1187">						throw new NasdanikaException(e);</span>
<span class="fc" id="L1188">					}</span>
				}
				
<span class="fc bfc" id="L1191" title="All 2 branches covered.">				if (searchPredicate.test(file, path)) {</span>
					try {
<span class="fc" id="L1193">						Predicate&lt;String&gt; predicate = createRelativeLinkPredicate(file, dir);						</span>
<span class="fc" id="L1194">						Consumer&lt;? super Element&gt; inspector = createInspector(predicate, error -&gt; errorConsumer.accept(path, error));</span>
						
<span class="fc" id="L1196">						JSONObject searchDocument = createSearchDocument(</span>
								path, 
								file, 
								inspector, 
								searchConfigurator, 
<span class="nc" id="L1201">								e -&gt; errorConsumer.accept(path, &quot;Error creating search document: &quot; + e));</span>
<span class="fc bfc" id="L1202" title="All 2 branches covered.">						if (searchDocument == null) {</span>
<span class="fc" id="L1203">							errorConsumer.accept(path, &quot;Blank page&quot;);</span>
						} else {
<span class="fc" id="L1205">							searchDocuments.put(path, searchDocument);</span>
						}
<span class="nc" id="L1207">					} catch (IOException e) {</span>
<span class="nc" id="L1208">						throw new NasdanikaException(e);</span>
<span class="fc" id="L1209">					}</span>
				}
<span class="fc" id="L1211">			}</span>
		};
<span class="fc" id="L1213">		org.nasdanika.common.Util.walk(null, listener, dir.listFiles());</span>
<span class="pc bpc" id="L1214" title="1 of 2 branches missed.">		if (!isSiteMapEmpty[0]) {</span>
<span class="fc" id="L1215">			wsg.write();</span>
		}
<span class="fc" id="L1217">		return searchDocuments;</span>
	}
	
	public static JSONObject generateSitemapAndSearch(
			File dir,
			String domain,
			BiPredicate&lt;File, String&gt; siteMapPredicate,
			ChangeFreq changeFrequency,
			BiPredicate&lt;File, String&gt; searchPredicate,
			BiConsumer&lt;String,String&gt; errorConsumer,
			String searchDocumentsPath,
			Supplier&lt;InputStream&gt; searchScriptSupplier) throws IOException {
		
<span class="nc" id="L1230">		return generateSitemapAndSearch(</span>
				dir, 
				domain, 
				siteMapPredicate, 
				changeFrequency, 
				searchPredicate, 
				errorConsumer, 
<span class="nc" id="L1237">				(path, doc) -&gt; configureSearch(path, doc, searchDocumentsPath, searchScriptSupplier));</span>
	}
		
	/**
	 * Generates sitemap and search using search.js resource.
	 * @param dir
	 * @param domain
	 * @param siteMapPredicate
	 * @param changeFrequency
	 * @param searchPredicate
	 * @param errorConsumer
	 * @param searchDocumentsPath
	 * @throws IOException
	 */
	public static JSONObject generateSitemapAndSearch(
			File dir,
			String domain,
			BiPredicate&lt;File, String&gt; siteMapPredicate,
			ChangeFreq changeFrequency,
			BiPredicate&lt;File, String&gt; searchPredicate,
			BiConsumer&lt;String,String&gt; errorConsumer,
			String searchDocumentsPath) throws IOException {
		
<span class="fc" id="L1260">		return generateSitemapAndSearch(</span>
				dir, 
				domain, 
				siteMapPredicate, 
				changeFrequency, 
				searchPredicate, 
				errorConsumer, 
<span class="fc" id="L1267">				(path, doc) -&gt; configureSearch(path, doc, searchDocumentsPath));</span>
	}
	
	public static void generateSitemapAndSearch(
			File dir,
			String domain,
			BiPredicate&lt;File, String&gt; siteMapPredicate,
			ChangeFreq changeFrequency,
			BiPredicate&lt;File, String&gt; searchPredicate,
			BiConsumer&lt;String,String&gt; errorConsumer) throws IOException {				

<span class="fc" id="L1278">		String searchDocumentsPath = &quot;search-documents.js&quot;;</span>
<span class="fc" id="L1279">		JSONObject searchDocuments = generateSitemapAndSearch(dir, domain, siteMapPredicate, changeFrequency, searchPredicate, errorConsumer, searchDocumentsPath);		</span>
<span class="fc" id="L1280">		try (FileWriter writer = new FileWriter(new File(dir, searchDocumentsPath))) {</span>
<span class="fc" id="L1281">			writer.write(&quot;var searchDocuments = &quot; + searchDocuments);</span>
		}
<span class="fc" id="L1283">	}</span>
	
	public interface SemanticElementFactory {

		Collection&lt;EObject&gt; createSemanticElements(
				ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt; config,
				ProgressMonitor progressMonitor,
				BiFunction&lt;ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt;, ProgressMonitor, Collection&lt;EObject&gt;&gt; defaultFactory);
	}
	
	/**
	 * Can be passed to createResourceSet to customize drawio semantic elements.
	 * @author Pavel
	 *
	 */
	public interface SemanticElementConfigurator {
		
		Collection&lt;EObject&gt; configureSemanticElements(
				URI uri,
				ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt; config, 
				Collection&lt;EObject&gt; semanticElements, 
				ProgressMonitor progressMonitor);
		
	}
	
	/**
	 * If semantic element is an {@link Action} and there are C4 properties, configured the action with those properties. 
	 * @param uri
	 * @param config
	 * @param semanticElements
	 * @param progressMonitor
	 * @return
	 */
	public static Collection&lt;EObject&gt; configureC4Actions(
			URI uri,
			ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt; config, 
			Collection&lt;EObject&gt; semanticElements, 
			ProgressMonitor progressMonitor) {
	
<span class="pc bpc" id="L1322" title="1 of 2 branches missed.">		if (semanticElements == null) {</span>
<span class="nc" id="L1323">			return semanticElements;</span>
		}
		
<span class="pc bpc" id="L1326" title="1 of 2 branches missed.">		for (EObject semanticElement: semanticElements) {</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">			if (semanticElement instanceof Label) {</span>
<span class="nc" id="L1328">				Label label = (Label) semanticElement;</span>
<span class="nc" id="L1329">				org.nasdanika.graph.Element element = config.getElement();</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">				if (element instanceof ModelElement) {</span>
<span class="nc" id="L1331">					ModelElement modelElement = (ModelElement) element;</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed.">					if (org.nasdanika.common.Util.isBlank(label.getText())) {</span>
<span class="nc" id="L1333">						label.setText(modelElement.getProperty(&quot;c4Name&quot;));</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">						if (org.nasdanika.common.Util.isBlank(label.getText())) {</span>
<span class="nc" id="L1335">							label.setText(modelElement.getProperty(&quot;c4Type&quot;));</span>
						}
					}
<span class="nc bnc" id="L1338" title="All 2 branches missed.">					if (org.nasdanika.common.Util.isBlank(label.getTooltip())) {</span>
<span class="nc" id="L1339">						label.setTooltip(modelElement.getProperty(&quot;c4Description&quot;));						</span>
					}
<span class="nc bnc" id="L1341" title="All 2 branches missed.">					if (org.nasdanika.common.Util.isBlank(label.getIcon())) {</span>
<span class="nc" id="L1342">						String c4Type = modelElement.getProperty(&quot;c4Type&quot;);</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">						if (c4Type != null) {</span>
<span class="nc bnc" id="L1344" title="All 3 branches missed.">							switch (c4Type) {</span>
							case &quot;Database&quot;:
<span class="nc" id="L1346">								label.setIcon(&quot;fas fa-database&quot;);</span>
<span class="nc" id="L1347">								break;</span>
							case &quot;Person&quot;:
<span class="nc" id="L1349">								label.setIcon(&quot;fas fa-user&quot;);</span>
							}
						}
					}
				}
			}
<span class="nc" id="L1355">		}</span>
		
<span class="fc" id="L1357">		return semanticElements;</span>
	} 

	/**
	 * Creates {@link NcoreResourceSet} with {@link XMIResourceFactoryImpl}, {@link ObjectLoaderResourceFactory} handling yml, json extensions and data scheme.
	 * {@link NcoreDrawioResourceFactory} for drawio extension. Uses {@link GitMarkerFactory} for {@link EObjectLoader}.
	 * Registers {@link AppAdapterFactory}.
	 * Registers Ncore, Exec, and HTML packages.
	 * @param progressMonitor
	 * @return
	 */	
	public static ResourceSet createResourceSet(Context context, ProgressMonitor progressMonitor) {
<span class="fc" id="L1369">		return createResourceSet(context, progressMonitor, null, Util::configureC4Actions);</span>
	}
	
	public static ResourceSet createResourceSet(
			Context context, 
			ProgressMonitor progressMonitor, 
			SemanticElementFactory semanticElementFactory,
			SemanticElementConfigurator semanticElementConfigurator) {
		
<span class="fc" id="L1378">		ResourceSet resourceSet = new NcoreResourceSet();</span>
		
<span class="fc" id="L1380">		EObjectLoader eObjectLoader = new EObjectLoader(null, null, resourceSet);</span>
<span class="fc" id="L1381">		GitMarkerFactory markerFactory = new GitMarkerFactory();</span>
<span class="fc" id="L1382">		eObjectLoader.setMarkerFactory(markerFactory);</span>
<span class="fc" id="L1383">		Resource.Factory objectLoaderResourceFactory = new ObjectLoaderResourceFactory() { </span>
			
			@Override
			protected org.nasdanika.persistence.ObjectLoader getObjectLoader(Resource resource) {
<span class="fc" id="L1387">				return eObjectLoader;</span>
			}
			
			@Override
			protected Context getContext(Resource resource) {
<span class="pc bpc" id="L1392" title="1 of 2 branches missed.">				return context == null ? Context.EMPTY_CONTEXT : context;</span>
			}
			
		};
<span class="fc" id="L1396">		Map&lt;String, Object&gt; extensionToFactoryMap = resourceSet.getResourceFactoryRegistry().getExtensionToFactoryMap();</span>
<span class="fc" id="L1397">		extensionToFactoryMap.put(&quot;yml&quot;, objectLoaderResourceFactory);</span>
<span class="fc" id="L1398">		extensionToFactoryMap.put(&quot;json&quot;, objectLoaderResourceFactory);</span>
<span class="fc" id="L1399">		resourceSet.getResourceFactoryRegistry().getProtocolToFactoryMap().put(&quot;data&quot;, objectLoaderResourceFactory);</span>
		
<span class="fc" id="L1401">		NcoreDrawioResourceFactory&lt;EObject&gt; ncoreDrawioResourceFactory = new NcoreDrawioResourceFactory&lt;EObject&gt;() {</span>
			
			@Override
			protected ResourceSet getResourceSet() {
<span class="nc" id="L1405">				return resourceSet;</span>
			}
			
			@Override
			protected ProgressMonitor getProgressMonitor(URI uri) {
<span class="fc" id="L1410">				return progressMonitor;</span>
			}
			
			@Override
			protected MarkerFactory getMarkerFactory() {
<span class="nc" id="L1415">				return markerFactory;</span>
			}
			
			@Override
			protected Collection&lt;EObject&gt; createSemanticElements(
					ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt; config,
					ProgressMonitor progressMonitor,
					BiFunction&lt;ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt;, ProgressMonitor, Collection&lt;EObject&gt;&gt; defaultFactory) {
				
<span class="pc bpc" id="L1424" title="1 of 2 branches missed.">				return semanticElementFactory == null ? super.createSemanticElements(config, progressMonitor, defaultFactory) : semanticElementFactory.createSemanticElements(config, progressMonitor, defaultFactory);</span>
			}
			
			@Override
			protected Collection&lt;EObject&gt; configureSemanticElements(
					URI uri,
					ProcessorConfig&lt;SemanticProcessor&lt;EObject&gt;&gt; config, Collection&lt;EObject&gt; semanticElements,
					ProgressMonitor progressMonitor) {
<span class="fc" id="L1432">				Collection&lt;EObject&gt; configuredSemanticElements = super.configureSemanticElements(uri, config, semanticElements, progressMonitor);				</span>
<span class="pc bpc" id="L1433" title="1 of 2 branches missed.">				return semanticElementConfigurator == null ? configuredSemanticElements : semanticElementConfigurator.configureSemanticElements(uri, config, configuredSemanticElements, progressMonitor);</span>
			}
			
		};
		
<span class="fc" id="L1438">		extensionToFactoryMap.put(&quot;drawio&quot;, ncoreDrawioResourceFactory);		</span>

		// For handling textual representations
<span class="fc" id="L1441">		TextResourceFactory textResourceFactory = new TextResourceFactory();</span>
<span class="fc" id="L1442">		extensionToFactoryMap.put(&quot;txt&quot;, textResourceFactory);		</span>
<span class="fc" id="L1443">		extensionToFactoryMap.put(&quot;puml&quot;, textResourceFactory);								</span>
<span class="fc" id="L1444">		extensionToFactoryMap.put(&quot;mermaid&quot;, textResourceFactory);		</span>
		
<span class="fc" id="L1446">		extensionToFactoryMap.put(org.eclipse.emf.ecore.resource.Resource.Factory.Registry.DEFAULT_EXTENSION, new XMIResourceFactoryImpl());</span>
		
<span class="fc" id="L1448">		resourceSet.getPackageRegistry().put(NcorePackage.eNS_URI, NcorePackage.eINSTANCE);</span>
<span class="fc" id="L1449">		resourceSet.getPackageRegistry().put(ExecPackage.eNS_URI, ExecPackage.eINSTANCE);</span>
<span class="fc" id="L1450">		resourceSet.getPackageRegistry().put(ContentPackage.eNS_URI, ContentPackage.eINSTANCE);</span>
<span class="fc" id="L1451">		resourceSet.getPackageRegistry().put(ResourcesPackage.eNS_URI, ResourcesPackage.eINSTANCE);</span>
<span class="fc" id="L1452">		resourceSet.getPackageRegistry().put(HtmlPackage.eNS_URI, HtmlPackage.eINSTANCE);</span>
<span class="fc" id="L1453">		resourceSet.getPackageRegistry().put(BootstrapPackage.eNS_URI, BootstrapPackage.eINSTANCE);</span>
<span class="fc" id="L1454">		resourceSet.getPackageRegistry().put(AppPackage.eNS_URI, AppPackage.eINSTANCE);</span>
		 
<span class="fc" id="L1456">		resourceSet.getAdapterFactories().add(new AppAdapterFactory());</span>
		
<span class="fc" id="L1458">		return resourceSet;</span>
	}
	
	/**
	 * Generates files (binary entities) from a resource model .
	 * @throws org.eclipse.emf.common.util.DiagnosticException 
	 * @throws Exception
	 */
	public static void generateContainer(
			URI resourceModelURI, 
			BinaryEntityContainer container, 
			Context context, 
			ProgressMonitor progressMonitor) throws org.eclipse.emf.common.util.DiagnosticException {
		
<span class="nc" id="L1472">		ResourceSet resourceSet = createResourceSet(context, progressMonitor);		</span>
<span class="nc" id="L1473">		resourceSet.getAdapterFactories().add(new AppAdapterFactory());				</span>
<span class="nc" id="L1474">		Resource containerResource = resourceSet.getResource(resourceModelURI, true);</span>
<span class="nc" id="L1475">		generateContainer(containerResource, container, context, progressMonitor);</span>
<span class="nc" id="L1476">	}</span>
		
	/**
	 * Generates files (binary entities) from a resource model .
	 * @throws org.eclipse.emf.common.util.DiagnosticException 
	 * @throws Exception
	 */
	public static void generateContainer(
			Resource containerResource, 
			BinaryEntityContainer container, 
			Context context, 
			ProgressMonitor progressMonitor) throws org.eclipse.emf.common.util.DiagnosticException {
		
<span class="fc bfc" id="L1489" title="All 2 branches covered.">		for (EObject eObject : containerResource.getContents()) {</span>
<span class="fc" id="L1490">			generateContainer(eObject, container, context, progressMonitor);</span>
<span class="fc" id="L1491">		}</span>
<span class="fc" id="L1492">	}		</span>
		
	/**
	 * Generates files (binary entities) from a resource model .
	 * @throws org.eclipse.emf.common.util.DiagnosticException 
	 * @throws Exception
	 */
	public static void generateContainer(
			EObject eObj, 
			BinaryEntityContainer container, 
			Context context, 
			ProgressMonitor progressMonitor) throws org.eclipse.emf.common.util.DiagnosticException {
		
<span class="fc" id="L1505">		Diagnostician diagnostician = new Diagnostician();</span>
<span class="fc" id="L1506">		org.eclipse.emf.common.util.Diagnostic diagnostic = diagnostician.validate(eObj);</span>
<span class="pc bpc" id="L1507" title="1 of 2 branches missed.">		if (diagnostic.getSeverity() == org.eclipse.emf.common.util.Diagnostic.ERROR) {</span>
<span class="nc" id="L1508">			throw new org.eclipse.emf.common.util.DiagnosticException(diagnostic);</span>
		};
		// Diagnosing loaded resources. 
		try {
<span class="fc" id="L1512">			ConsumerFactory&lt;BinaryEntityContainer&gt; consumerFactory = Objects.requireNonNull(EObjectAdaptable.adaptToConsumerFactory(eObj, BinaryEntityContainer.class), &quot;Cannot adapt to ConsumerFactory&quot;);</span>
<span class="fc" id="L1513">			Diagnostic callDiagnostic = org.nasdanika.common.Util.call(consumerFactory.create(context), container, progressMonitor);</span>
<span class="pc bpc" id="L1514" title="2 of 4 branches missed.">			if (callDiagnostic.getStatus() == Status.FAIL || callDiagnostic.getStatus() == Status.ERROR) {</span>
<span class="nc" id="L1515">				System.err.println(&quot;***********************&quot;);</span>
<span class="nc" id="L1516">				System.err.println(&quot;*      Diagnostic     *&quot;);</span>
<span class="nc" id="L1517">				System.err.println(&quot;***********************&quot;);</span>
<span class="nc" id="L1518">				callDiagnostic.dump(System.err, 4, Status.FAIL, Status.ERROR);</span>
			}
<span class="pc bpc" id="L1520" title="1 of 2 branches missed.">			if (callDiagnostic.getStatus() != Status.SUCCESS) {</span>
<span class="nc" id="L1521">				throw new DiagnosticException(callDiagnostic);</span>
			};
<span class="nc" id="L1523">		} catch (DiagnosticException e) {</span>
<span class="nc" id="L1524">			System.err.println(&quot;******************************&quot;);</span>
<span class="nc" id="L1525">			System.err.println(&quot;*      Diagnostic failed     *&quot;);</span>
<span class="nc" id="L1526">			System.err.println(&quot;******************************&quot;);</span>
<span class="nc" id="L1527">			e.getDiagnostic().dump(System.err, 4, Status.FAIL);</span>
<span class="nc" id="L1528">			throw e;</span>
<span class="fc" id="L1529">		}</span>
<span class="fc" id="L1530">	}</span>
	
	/**
	 * Loads a semantic map (EObject -&gt; Label) from JSON or YAML resource. The resource is considered to by YAML if its URI ends with .yml or .yaml case insensitive. 
	 * @param uri Semantic map URI. Link locations in the map are resolved relative to this URI.
	 * @param factory Factory for creating key {@link EObject}s if map entries have &lt;code&gt;type&lt;/code&gt; key. Keys must implement {@link org.nasdanika.ncore.ModelElement} so URI's can be injected into them.
	 * @return
	 * @throws IOException 
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static Map&lt;org.nasdanika.ncore.ModelElement, Label&gt; loadSemanticMap(URI uri, BiFunction&lt;String,String,org.nasdanika.ncore.ModelElement&gt; factory) throws IOException {
<span class="nc" id="L1541">		String lastSegment = uri.lastSegment().toLowerCase();</span>
		Map&lt;String, Object&gt; semanticMap;
<span class="nc bnc" id="L1543" title="All 4 branches missed.">		if (lastSegment.endsWith(&quot;.yml&quot;) || lastSegment.endsWith(&quot;.yaml&quot;)) {</span>
<span class="nc" id="L1544">			Object yamlObj = DefaultConverter.INSTANCE.loadYAML(uri);</span>
<span class="nc bnc" id="L1545" title="All 2 branches missed.">			if (yamlObj instanceof Map) {</span>
<span class="nc" id="L1546">				semanticMap = (Map&lt;String, Object&gt;) yamlObj;						</span>
			} else {
<span class="nc" id="L1548">				throw new IllegalArgumentException(&quot;Not a YAML map at &quot; + uri); </span>
			}
<span class="nc" id="L1550">		} else {</span>
<span class="nc" id="L1551">			JSONObject jsonObject = DefaultConverter.INSTANCE.loadJSONObject(uri);</span>
<span class="nc" id="L1552">			semanticMap = jsonObject.toMap();</span>
		}
		
<span class="nc" id="L1555">		Map&lt;URI, org.nasdanika.ncore.ModelElement&gt; groupedByLocation = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1556">		Map&lt;org.nasdanika.ncore.ModelElement, Label&gt; ret = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1557" title="All 2 branches missed.">		for (Entry&lt;String, Object&gt; se: semanticMap.entrySet()) {</span>
<span class="nc" id="L1558">			Map&lt;String, Object&gt; value = (Map&lt;String, Object&gt;) se.getValue();</span>
<span class="nc" id="L1559">			Map&lt;String,String&gt; type = (Map&lt;String, String&gt;) value.get(&quot;type&quot;);</span>
<span class="nc" id="L1560">			org.nasdanika.ncore.ModelElement semanticElement = null;</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">			if (type != null) {</span>
<span class="nc" id="L1562">				semanticElement = factory.apply(type.get(&quot;ns-uri&quot;), type.get(&quot;name&quot;));</span>
			}
<span class="nc" id="L1564">			String location = (String) value.get(&quot;location&quot;);</span>
<span class="nc bnc" id="L1565" title="All 2 branches missed.">			if (org.nasdanika.common.Util.isBlank(location)) {</span>
<span class="nc" id="L1566">				Label label = AppFactory.eINSTANCE.createLabel();</span>
<span class="nc" id="L1567">				label.setText((String) value.get(&quot;text&quot;));</span>
<span class="nc" id="L1568">				label.setIcon((String) value.get(&quot;icon&quot;));</span>
<span class="nc" id="L1569">				label.setTooltip((String) value.get(&quot;tooltip&quot;));</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">				if (semanticElement == null) {</span>
<span class="nc" id="L1571">					semanticElement = label;</span>
				}
<span class="nc" id="L1573">				semanticElement.getUris().add(se.getKey());</span>
<span class="nc" id="L1574">				ret.put(semanticElement, label);</span>
<span class="nc" id="L1575">			} else {</span>
<span class="nc" id="L1576">				URI locationURI = URI.createURI(location).resolve(uri);</span>
<span class="nc" id="L1577">				org.nasdanika.ncore.ModelElement semEl = groupedByLocation.get(uri);</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">				if (semEl == null) {</span>
<span class="nc" id="L1579">					Link link = AppFactory.eINSTANCE.createLink();</span>
<span class="nc" id="L1580">					link = AppFactory.eINSTANCE.createLink();</span>
<span class="nc" id="L1581">					link.setText((String) value.get(&quot;text&quot;));</span>
<span class="nc" id="L1582">					link.setIcon((String) value.get(&quot;icon&quot;));</span>
<span class="nc" id="L1583">					link.setTooltip((String) value.get(&quot;tooltip&quot;));</span>
<span class="nc" id="L1584">					link.setLocation(locationURI.toString());</span>
<span class="nc bnc" id="L1585" title="All 2 branches missed.">					if (semanticElement == null) {</span>
<span class="nc" id="L1586">						semanticElement = link;</span>
					}
<span class="nc" id="L1588">					ret.put(semanticElement, link);</span>
<span class="nc" id="L1589">					groupedByLocation.put(locationURI, semanticElement);</span>
<span class="nc" id="L1590">					semEl = semanticElement;</span>
				}
<span class="nc" id="L1592">				semEl.getUris().add(se.getKey());</span>
			}
<span class="nc" id="L1594">		}</span>
		
<span class="nc" id="L1596">		return ret;</span>
	}
	
	/**
	 * Loads a semantic map (EObject -&gt; Label) from JSON or YAML resource. The resource is considered to by YAML if its URI ends with .yml or .yaml case insensitive. 
	 * @param uri Semantic map URI. Link locations in the map are resolved relative to this URI.
	 * @param resouceSet Resource set to use the package registry to create semantic elements.
	 * @return
	 * @throws IOException 
	 */
	public static Map&lt;org.nasdanika.ncore.ModelElement, Label&gt; loadSemanticMap(URI uri, ResourceSet resourceSet) throws IOException {
<span class="nc" id="L1607">		return loadSemanticMap(uri, (nsURI, name) -&gt; createModelElement(resourceSet, nsURI, name));</span>
	}
	
	private static org.nasdanika.ncore.ModelElement createModelElement(ResourceSet resourceSet, String nsURI, String name) {
<span class="nc bnc" id="L1611" title="All 2 branches missed.">		if (resourceSet == null) {</span>
<span class="nc" id="L1612">			return null;</span>
		}
		
<span class="nc" id="L1615">		Registry packageRegisry = resourceSet.getPackageRegistry();</span>
<span class="nc" id="L1616">		EPackage ePkg = packageRegisry.getEPackage(nsURI);</span>
<span class="nc bnc" id="L1617" title="All 2 branches missed.">		if (ePkg == null) {</span>
<span class="nc" id="L1618">			throw new IllegalArgumentException(&quot;EPackage not found for namespace URI: &quot; + nsURI);</span>
		}
		
<span class="nc" id="L1621">		EClassifier eClassifier = ePkg.getEClassifier(name);</span>
<span class="nc bnc" id="L1622" title="All 2 branches missed.">		if (eClassifier instanceof EClass) {</span>
<span class="nc" id="L1623">			return (org.nasdanika.ncore.ModelElement) ePkg.getEFactoryInstance().create((EClass) eClassifier);</span>
		}		
		
<span class="nc" id="L1626">		throw new IllegalArgumentException(&quot;EClass '&quot; + name + &quot;' not found for namespace URI: &quot; + nsURI);</span>
	}
	
	// --- Processing of HTML files, e.g. injection of backlinks

	/**
	 * Processes HTML documents 
	 * @author Pavel
	 *
	 */
	public interface HTMLProcessor {
		
		default boolean isHTML(File file, String path) {
<span class="pc bpc" id="L1639" title="4 of 10 branches missed.">			return file != null &amp;&amp; file.isFile() &amp;&amp; path != null &amp;&amp; (path.toLowerCase().endsWith(&quot;.html&quot;) || path.toLowerCase().endsWith(&quot;.htm&quot;)); </span>
		}

		/**
		 * Processed HTML document and returns true if the document was modified and shall be saved.
		 * @param file
		 * @param path
		 * @param document
		 * @return
		 */
		boolean process(File file, String path, Document document);
		
	}	

	public static void processHTML(HTMLProcessor processor, File... files) {
<span class="fc" id="L1654">		BiConsumer&lt;File, String&gt; listener = new BiConsumer&lt;File, String&gt;() {</span>
			
			@Override
			public void accept(File file, String path) {
<span class="fc bfc" id="L1658" title="All 2 branches covered.">				if (processor.isHTML(file, path)) {</span>
					try {
<span class="fc" id="L1660">						Document document = Jsoup.parse(file, &quot;UTF-8&quot;);		</span>
<span class="pc bpc" id="L1661" title="1 of 2 branches missed.">						if (processor.process(file, path, document)) {</span>
<span class="nc" id="L1662">							Document.OutputSettings outputSettings = new Document.OutputSettings();</span>
<span class="nc" id="L1663">							outputSettings.prettyPrint(false);</span>
<span class="nc" id="L1664">							document.outputSettings(outputSettings);</span>
<span class="nc" id="L1665">							try (Writer writer = new OutputStreamWriter(new FileOutputStream(file), &quot;UTF-8&quot;)) {</span>
<span class="nc" id="L1666">								writer.write(document.html());</span>
							}
						}
<span class="nc" id="L1669">					} catch (IOException e) {</span>
<span class="nc" id="L1670">						throw new NasdanikaException(&quot;Error processing HTML file &quot; + path + &quot; &quot; + file.getAbsolutePath() + &quot; &quot; + e, e);</span>
<span class="fc" id="L1671">					}</span>
				}
<span class="fc" id="L1673">			}</span>
		};
<span class="fc" id="L1675">		org.nasdanika.common.Util.walk(null, listener, files);		</span>
<span class="fc" id="L1676">	}</span>
				
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>